<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="theme-color" content="#0b1220">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>æ’­æ”¾ä¸­</title>
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="apple-touch-icon" href="apple-touch-icon.png">
  <style>
    :root {
      --bg: #0b1220;
      --card: #111b2e;
      --muted: #94a3b8;
      --text: #e5e7eb;
      --accent: #4ade80;
      --accent-dim: rgba(74, 222, 128, 0.15);
      --line: #1e293b;
      --danger: #f87171;
      --warning: #fbbf24;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html { background: #000; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, "PingFang SC", "Microsoft YaHei", sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    /* Header */
    header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      padding-top: calc(12px + env(safe-area-inset-top, 0));
      background: rgba(11, 18, 32, 0.95);
      border-bottom: 1px solid var(--line);
    }
    .back-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 12px;
      border-radius: 10px;
      background: var(--card);
      border: 1px solid var(--line);
      color: var(--text);
      text-decoration: none;
      font-size: 14px;
    }
    .back-btn:active { opacity: 0.7; }
    .header-title {
      flex: 1;
      font-size: 16px;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Video Container */
    .video-container {
      background: #000;
      position: relative;
    }
    video {
      width: 100%;
      height: auto;
      max-height: 56.25vw;
      background: #000;
      display: block;
    }
    @media (min-width: 768px) {
      video { max-height: 480px; }
    }

    /* Status Overlay */
    .status-overlay {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.7);
      color: var(--text);
      gap: 12px;
      transition: opacity 0.3s;
    }
    .status-overlay.hidden {
      opacity: 0;
      pointer-events: none;
    }
    .status-icon { font-size: 48px; }
    .status-text { font-size: 14px; text-align: center; padding: 0 20px; }
    .status-text.error { color: var(--danger); }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--line);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    /* Controls Panel */
    .controls {
      padding: 16px;
      max-width: 800px;
      margin: 0 auto;
    }

    .control-card {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 16px;
      margin-bottom: 12px;
    }

    .control-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .control-label {
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 4px;
    }
    .control-value {
      font-size: 15px;
      font-weight: 500;
    }

    /* Source Selector */
    .source-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 12px;
    }
    .source-btn {
      padding: 8px 16px;
      border-radius: 10px;
      border: 1px solid var(--line);
      background: var(--bg);
      color: var(--text);
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .source-btn:active { opacity: 0.7; }
    .source-btn.active {
      background: var(--accent-dim);
      border-color: var(--accent);
      color: var(--accent);
    }

    /* Action Buttons */
    .action-row {
      display: flex;
      gap: 10px;
      margin-top: 16px;
    }
    .action-btn {
      flex: 1;
      padding: 12px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: var(--card);
      color: var(--text);
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }
    .action-btn:active { opacity: 0.7; }
    .action-btn.primary {
      background: var(--accent-dim);
      border-color: var(--accent);
      color: var(--accent);
    }

    /* Error Details */
    .error-card {
      background: rgba(248, 113, 113, 0.1);
      border: 1px solid rgba(248, 113, 113, 0.3);
      border-radius: 14px;
      padding: 16px;
      margin-bottom: 12px;
    }
    .error-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--danger);
      margin-bottom: 8px;
    }
    .error-msg {
      font-size: 13px;
      color: var(--muted);
      white-space: pre-wrap;
      word-break: break-all;
    }
    .error-tips {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid rgba(248, 113, 113, 0.2);
      font-size: 12px;
      color: var(--muted);
      line-height: 1.6;
    }

    /* URL Display */
    .url-display {
      font-size: 12px;
      color: var(--muted);
      word-break: break-all;
      padding: 10px;
      background: var(--bg);
      border-radius: 8px;
      margin-top: 12px;
    }

    /* Footer Note */
    .footer-note {
      padding: 16px;
      text-align: center;
      font-size: 12px;
      color: var(--muted);
    }
  </style>
</head>
<body>
  <header>
    <a class="back-btn" href="./">â† è¿”å›</a>
    <div class="header-title" id="channelName">åŠ è½½ä¸­...</div>
  </header>

  <div class="video-container">
    <video id="video" controls playsinline></video>
    <div class="status-overlay" id="statusOverlay">
      <div class="spinner" id="spinner"></div>
      <div class="status-text" id="statusText">æ­£åœ¨åŠ è½½...</div>
    </div>
  </div>

  <div class="controls">
    <!-- Channel Info -->
    <div class="control-card" id="infoCard">
      <div class="control-row">
        <div>
          <div class="control-label">åˆ†ç±»</div>
          <div class="control-value" id="channelCategory">-</div>
        </div>
        <div style="text-align:right;">
          <div class="control-label">çŠ¶æ€</div>
          <div class="control-value" id="playStatus">å‡†å¤‡ä¸­</div>
        </div>
      </div>
    </div>

    <!-- Source Selector -->
    <div class="control-card" id="sourceCard" style="display:none;">
      <div class="control-label">é€‰æ‹©çº¿è·¯</div>
      <div class="source-list" id="sourceList"></div>
    </div>

    <!-- Error Display -->
    <div class="error-card" id="errorCard" style="display:none;">
      <div class="error-title">âš ï¸ æ’­æ”¾å¤±è´¥</div>
      <div class="error-msg" id="errorMsg"></div>
      <div class="error-tips">
        <strong>å¯èƒ½çš„åŸå› ï¼š</strong><br>
        â€¢ ç›´æ’­æºå·²å¤±æ•ˆæˆ–ä¸‹çº¿<br>
        â€¢ ç½‘ç»œè¿æ¥é—®é¢˜<br>
        â€¢ è·¨åŸŸé™åˆ¶ï¼ˆCORSï¼‰<br>
        â€¢ æœåŠ¡å™¨æ‹’ç»è®¿é—®<br><br>
        <strong>å»ºè®®æ“ä½œï¼š</strong><br>
        â€¢ å°è¯•åˆ‡æ¢å…¶ä»–çº¿è·¯<br>
        â€¢ æ£€æŸ¥ç½‘ç»œè¿æ¥<br>
        â€¢ æ›´æ¢æœ‰æ•ˆçš„ç›´æ’­æº
      </div>
    </div>

    <!-- Actions -->
    <div class="action-row">
      <button class="action-btn" id="reloadBtn">ğŸ”„ é‡æ–°åŠ è½½</button>
      <button class="action-btn" id="retryBtn" style="display:none;">â­ï¸ å°è¯•ä¸‹ä¸€çº¿è·¯</button>
    </div>

    <!-- URL Display -->
    <div class="url-display" id="urlDisplay">-</div>
  </div>

  <div class="footer-note">
    Safariï¼ˆiPhone/iPad/Macï¼‰åŸç”Ÿæ”¯æŒ HLSã€‚å…¶ä»–æµè§ˆå™¨ä½¿ç”¨ hls.js æ’­æ”¾ã€‚
  </div>

<script>
(function() {
  'use strict';

  // ========== Storage Helpers ==========
  const Storage = {
    get(key, def = null) {
      try {
        const v = localStorage.getItem(key);
        return v ? JSON.parse(v) : def;
      } catch { return def; }
    },
    set(key, val) {
      try { localStorage.setItem(key, JSON.stringify(val)); } catch {}
    }
  };

  // ========== Config ==========
  const MAX_RETRY = 3;
  const RETRY_DELAY = 2000;
  const BAD_TTL_DAYS = 7; // å¤±è´¥çº¿è·¯è®°å½•ä¿ç•™å¤©æ•°
  const BAD_TTL_MS = BAD_TTL_DAYS * 24 * 60 * 60 * 1000;

  // ========== State ==========
  let channel = null;
  let sources = [];
  let currentSourceIndex = 0;
  let retryCount = 0;
  let hlsInstance = null;
  let isPlaying = false;

  // ========== DOM ==========
  const $ = id => document.getElementById(id);
  const video = $('video');
  const channelName = $('channelName');
  const channelCategory = $('channelCategory');
  const playStatus = $('playStatus');
  const statusOverlay = $('statusOverlay');
  const spinner = $('spinner');
  const statusText = $('statusText');
  const sourceCard = $('sourceCard');
  const sourceList = $('sourceList');
  const errorCard = $('errorCard');
  const errorMsg = $('errorMsg');
  const reloadBtn = $('reloadBtn');
  const retryBtn = $('retryBtn');
  const urlDisplay = $('urlDisplay');

  // ========== URL Params ==========
  const params = new URLSearchParams(location.search);
  const channelId = params.get('id');
  // Legacy support
  const legacyName = params.get('name');
  const legacyUrl = params.get('url');

  // ========== Status ==========
  function showStatus(text, isError = false) {
    statusOverlay.classList.remove('hidden');
    spinner.style.display = isError ? 'none' : '';
    statusText.textContent = text;
    statusText.classList.toggle('error', isError);
    playStatus.textContent = text;
    playStatus.style.color = isError ? 'var(--danger)' : '';
  }

  function hideStatus() {
    statusOverlay.classList.add('hidden');
    playStatus.textContent = 'æ’­æ”¾ä¸­';
    playStatus.style.color = 'var(--accent)';
  }

  function showError(title, details) {
    errorCard.style.display = '';
    errorMsg.textContent = details;
    showStatus(title, true);
  }

  function hideError() {
    errorCard.style.display = 'none';
  }

  // ========== Source Selector ==========
  function renderSources() {
    if (sources.length <= 1) {
      sourceCard.style.display = 'none';
      retryBtn.style.display = 'none';
      return;
    }

    sourceCard.style.display = '';
    retryBtn.style.display = '';

    sourceList.innerHTML = sources.map((src, i) => {
      const active = i === currentSourceIndex ? 'active' : '';
      const bad = isUrlBad(src.url) ? ' âš ï¸å¤±æ•ˆ' : '';
      const label = escapeHtml(src.label || `çº¿è·¯${i + 1}`) + bad;
      return `<button class="source-btn ${active}" data-index="${i}">${label}</button>`;
    }).join('');
  }

  function escapeHtml(s) {
    return (s || '').replace(/[&<>"']/g, c => ({
      '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
    }[c]));
  }

  function getBadMap() {
    return Storage.get('tv_bad_sources', {});
  }

  function isUrlBad(url) {
    if (!url) return false;
    const m = getBadMap();
    const it = m[url];
    if (!it || !it.ts) return false;
    const age = Date.now() - it.ts;
    if (age > BAD_TTL_MS) return false;
    return true;
  }

  function markBad(url, reason) {
    if (!url) return;
    const m = getBadMap();
    const prev = m[url] || {};
    m[url] = { ts: Date.now(), count: (prev.count || 0) + 1, reason: String(reason || prev.reason || '') };
    Storage.set('tv_bad_sources', m);
  }

  function findNextGood(fromIndex) {
    if (!sources.length) return -1;
    for (let step = 1; step <= sources.length; step++) {
      const i = (fromIndex + step) % sources.length;
      const u = (sources[i] || {}).url;
      if (!isUrlBad(u)) return i;
    }
    return fromIndex;
  }

  // ========== Player ==========
  function cleanup() {
    if (hlsInstance) {
      try { hlsInstance.destroy(); } catch {}
      hlsInstance = null;
    }
    video.removeAttribute('src');
    try { video.load(); } catch {}
    isPlaying = false;
  }

  async function playSource(index) {
    cleanup();
    hideError();
    
    if (index < 0 || index >= sources.length) {
      showError('æ— å¯ç”¨çº¿è·¯', 'æ²¡æœ‰é…ç½®æœ‰æ•ˆçš„æ’­æ”¾æº');
      return;
    }

    currentSourceIndex = index;
    renderSources();

    const source = sources[index];
    const url = source.url;

    if (!url) {
      showError('æ’­æ”¾åœ°å€ä¸ºç©º', 'è¯·æ£€æŸ¥é¢‘é“é…ç½®');
      return;
    }

    urlDisplay.textContent = url;

    // HTTPS é¡µé¢ä¸‹ç¦æ­¢ http ç›´æ’­æºï¼ˆæ··åˆå†…å®¹ä¼šç›´æ¥å¤±è´¥ï¼‰
    if (location.protocol === 'https:' && /^http:\/\//i.test(url)) {
      markBad(url, 'Mixed Content (http on https)');
      showError('æ’­æ”¾å¤±è´¥', 'è¯¥ç›´æ’­æºä¸º httpï¼Œåœ¨ https é¡µé¢ä¸‹ä¼šè¢«æµè§ˆå™¨æ‹¦æˆªï¼ˆæ··åˆå†…å®¹ï¼‰ã€‚è¯·æ›´æ¢ä¸º https æºã€‚');
      const next = findNextGood(currentSourceIndex);
      if (next !== currentSourceIndex) {
        setTimeout(() => { retryCount = 0; playSource(next); }, 600);
      }
      return;
    }

    // è‡ªåŠ¨è·³è¿‡è¿‘æœŸæ ‡è®°ä¸ºå¤±æ•ˆçš„çº¿è·¯
    if (isUrlBad(url) && sources.length > 1) {
      const next = findNextGood(currentSourceIndex);
      if (next !== currentSourceIndex) {
        showStatus('è¯¥çº¿è·¯è¿‘æœŸå¤±è´¥ï¼Œå·²è‡ªåŠ¨è·³è¿‡ï¼Œæ­£åœ¨å°è¯•ä¸‹ä¸€çº¿è·¯...', true);
        setTimeout(() => { retryCount = 0; playSource(next); }, 600);
        return;
      }
    }

    showStatus('æ­£åœ¨è¿æ¥...');

    // Native HLS (Safari)
    if (video.canPlayType('application/vnd.apple.mpegurl')) {
      video.src = url;
      
      video.onloadeddata = () => {
        hideStatus();
        isPlaying = true;
        retryCount = 0;
      };

      video.onerror = () => {
        handlePlayError('è§†é¢‘åŠ è½½å¤±è´¥', getVideoError(video.error));
      };

      try {
        await video.play();
      } catch (e) {
        // User interaction required, that's ok
        hideStatus();
      }
      return;
    }

    // hls.js fallback
    await loadHlsJs();

    if (!window.Hls) {
      showError('æ’­æ”¾å™¨åŠ è½½å¤±è´¥', 'æ— æ³•åŠ è½½ hls.js åº“');
      return;
    }

    if (!window.Hls.isSupported()) {
      showError('æµè§ˆå™¨ä¸æ”¯æŒ', 'å½“å‰æµè§ˆå™¨ä¸æ”¯æŒ HLS æ’­æ”¾ï¼Œå»ºè®®ä½¿ç”¨ Safari');
      return;
    }

    hlsInstance = new window.Hls({
      enableWorker: true,
      lowLatencyMode: true,
      maxBufferLength: 30,
      maxMaxBufferLength: 60
    });

    hlsInstance.on(window.Hls.Events.MANIFEST_PARSED, () => {
      hideStatus();
      isPlaying = true;
      retryCount = 0;
      video.play().catch(() => {});
    });

    hlsInstance.on(window.Hls.Events.ERROR, (event, data) => {
      if (data.fatal) {
        const errorType = data.type || 'UNKNOWN';
        const errorDetails = data.details || 'Unknown error';
        handlePlayError(`HLS é”™è¯¯ (${errorType})`, errorDetails);
      }
    });

    hlsInstance.loadSource(url);
    hlsInstance.attachMedia(video);
  }

  function getVideoError(error) {
    if (!error) return 'æœªçŸ¥é”™è¯¯';
    const codes = {
      1: 'MEDIA_ERR_ABORTED - æ’­æ”¾è¢«ä¸­æ­¢',
      2: 'MEDIA_ERR_NETWORK - ç½‘ç»œé”™è¯¯',
      3: 'MEDIA_ERR_DECODE - è§£ç é”™è¯¯',
      4: 'MEDIA_ERR_SRC_NOT_SUPPORTED - æ ¼å¼ä¸æ”¯æŒ'
    };
    return codes[error.code] || `é”™è¯¯ä»£ç : ${error.code}`;
  }

  function handlePlayError(title, details) {
    showError(title, details);

    // Auto retry current source
    if (retryCount < MAX_RETRY) {
      retryCount++;
      showStatus(`${title} - ${RETRY_DELAY/1000}ç§’åé‡è¯• (${retryCount}/${MAX_RETRY})...`, true);
      setTimeout(() => {
        if (!isPlaying) playSource(currentSourceIndex);
      }, RETRY_DELAY);
      return;
    }

    // Retries exhausted: record this source as bad
    try { markBad((sources[currentSourceIndex] || {}).url, details || title); } catch {}

    // Try next good source if available
    if (sources.length > 1) {
      const next = findNextGood(currentSourceIndex);
      if (next !== currentSourceIndex) {
        showStatus(`é‡è¯•æ¬¡æ•°å·²ç”¨å®Œï¼Œåˆ‡æ¢åˆ°ä¸‹ä¸€çº¿è·¯...`, true);
        setTimeout(() => {
          retryCount = 0;
          playSource(next);
        }, RETRY_DELAY);
        return;
      }
    }

    showStatus('é‡è¯•æ¬¡æ•°å·²ç”¨å®Œï¼Œè¯·å°è¯•åˆ‡æ¢çº¿è·¯æˆ–ç¨åå†è¯•ã€‚', true);
  }

  function loadHlsJs() {
    return new Promise(resolve => {
      if (window.Hls) return resolve();
      const s = document.createElement('script');
      s.src = 'https://cdn.jsdelivr.net/npm/hls.js@1.5.15/dist/hls.min.js';
      s.onload = resolve;
      s.onerror = resolve;
      document.head.appendChild(s);
    });
  }

  // ========== Load Channel ==========
  async function loadChannel() {
    // Legacy mode: direct URL
    if (legacyUrl && !channelId) {
      channel = {
        id: 'legacy',
        name: legacyName || 'æ’­æ”¾',
        category: '',
        sources: [{ label: 'é»˜è®¤', url: legacyUrl }]
      };
      initPlayer();
      return;
    }

    if (!channelId) {
      showError('å‚æ•°é”™è¯¯', 'ç¼ºå°‘é¢‘é“ IDï¼Œè¯·ä»é¢‘é“åˆ—è¡¨è¿›å…¥');
      channelName.textContent = 'å‚æ•°é”™è¯¯';
      return;
    }

    try {
      showStatus('åŠ è½½é¢‘é“ä¿¡æ¯...');
      const res = await fetch('./channels.json');
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const data = await res.json();
      
      channel = (data.channels || []).find(ch => ch.id === channelId);
      
      if (!channel) {
        showError('é¢‘é“ä¸å­˜åœ¨', `æ‰¾ä¸åˆ° ID ä¸º "${channelId}" çš„é¢‘é“`);
        channelName.textContent = 'é¢‘é“ä¸å­˜åœ¨';
        return;
      }

      initPlayer();
    } catch (err) {
      showError('åŠ è½½å¤±è´¥', err.message);
      channelName.textContent = 'åŠ è½½å¤±è´¥';
    }
  }

  function initPlayer() {
    channelName.textContent = channel.name || 'æœªå‘½åé¢‘é“';
    document.title = channel.name || 'æ’­æ”¾ä¸­';
    channelCategory.textContent = channel.category || 'æœªåˆ†ç±»';

    sources = (channel.sources || []).filter(s => s.url);
    
    // Sort by priority
    sources.sort((a, b) => (a.priority || 99) - (b.priority || 99));

    if (!sources.length) {
      showError('æ— æ’­æ”¾æº', 'è¯¥é¢‘é“æ²¡æœ‰é…ç½®æœ‰æ•ˆçš„æ’­æ”¾åœ°å€');
      return;
    }

    renderSources();
    playSource(0);
  }

  // ========== Events ==========
  sourceList.addEventListener('click', e => {
    const btn = e.target.closest('.source-btn');
    if (!btn) return;
    const index = parseInt(btn.dataset.index, 10);
    if (!isNaN(index) && index !== currentSourceIndex) {
      retryCount = 0;
      playSource(index);
    }
  });

  reloadBtn.addEventListener('click', () => {
    retryCount = 0;
    playSource(currentSourceIndex);
  });

  retryBtn.addEventListener('click', () => {
    retryCount = 0;
    const next = (currentSourceIndex + 1) % sources.length;
    playSource(next);
  });

  // Handle visibility change - pause/resume
  document.addEventListener('visibilitychange', () => {
    if (document.hidden && video) {
      // Optionally pause when hidden
    }
  });

  // ========== Service Worker ==========
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js').catch(() => {});
  }

  // ========== Init ==========
  loadChannel();
})();
</script>
</body>
</html>
