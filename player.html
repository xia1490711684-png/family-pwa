<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0b1220" />
  <title>播放</title>

  <link rel="manifest" href="manifest.webmanifest">
  <link rel="apple-touch-icon" href="apple-touch-icon.png">

  <style>
    :root{--bg:#0b1220;--card:#111b2e;--muted:#94a3b8;--text:#e5e7eb;--accent:#22c55e;}
    *{box-sizing:border-box}
    body{margin:0; font-family:-apple-system,BlinkMacSystemFont,\"Segoe UI\",Roboto,\"Helvetica Neue\",Arial; background:var(--bg); color:var(--text);}
    header{display:flex; align-items:center; gap:10px; padding:14px 16px; border-bottom:1px solid rgba(255,255,255,0.08); position:sticky; top:0; background:var(--bg);}
    a.btn{display:inline-flex; align-items:center; gap:8px; padding:10px 12px; border-radius:12px; background:rgba(255,255,255,0.08); color:var(--text); text-decoration:none}
    .title{font-size:16px; font-weight:700; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;}
    main{max-width:1000px; margin:0 auto; padding:16px;}
    .card{background:var(--card); border:1px solid rgba(255,255,255,0.08); border-radius:16px; padding:12px;}
    video{width:100%; height:auto; background:#000; border-radius:12px;}
    .row{display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:space-between; margin-top:10px}
    .muted{color:var(--muted); font-size:13px}
    input{flex:1; min-width:200px; padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,0.12); background:rgba(0,0,0,0.2); color:var(--text)}
    button{padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,0.12); background:rgba(255,255,255,0.08); color:var(--text); cursor:pointer}
    button.primary{background:rgba(34,197,94,0.18); border-color:rgba(34,197,94,0.35)}
    .err{margin-top:10px; color:#fca5a5; font-size:13px; white-space:pre-wrap;}
  </style>
</head>
<body>
  <header>
    <a class="btn" href="./">← 返回</a>
    <div class="title" id="t">播放</div>
  </header>
  <main>
    <div class="card">
      <video id="v" controls playsinline></video>
      <div class="row">
        <div class="muted" id="u"></div>
        <button class="primary" id="reload">重新加载</button>
      </div>
      <div class="muted" style="margin-top:10px;">
        说明：Safari（iPhone/iPad/Mac）原生支持 HLS（m3u8）。其他浏览器会尝试使用 hls.js。
      </div>
      <div class="err" id="err" hidden></div>
    </div>
  </main>

<script>
  const qs = new URLSearchParams(location.search);
  const name = qs.get('name') || '播放';
  const url = qs.get('url') || '';
  const t = document.getElementById('t');
  const u = document.getElementById('u');
  const v = document.getElementById('v');
  const err = document.getElementById('err');

  t.textContent = name;
  document.title = name;
  u.textContent = url ? ('源：' + url) : '未提供播放源';

  let hlsInstance = null;

  function showErr(msg){
    err.hidden = false;
    err.textContent = msg;
  }
  function clearErr(){
    err.hidden = true;
    err.textContent = '';
  }

  function cleanup(){
    if(hlsInstance){
      try{hlsInstance.destroy();}catch(e){}
      hlsInstance = null;
    }
    v.removeAttribute('src');
    try{v.load();}catch(e){}
  }

  async function loadHls(){
    clearErr();
    cleanup();
    if(!url){
      showErr('没有 url 参数。请从频道列表进入，或手动补全：player.html?url=...');
      return;
    }

    // Native HLS (Safari)
    if(v.canPlayType('application/vnd.apple.mpegurl')){
      v.src = url;
      try{ await v.play(); } catch(e){}
      return;
    }

    // hls.js fallback
    await injectHlsJs();
    if(!window.Hls){
      showErr('当前浏览器不支持 HLS，且 hls.js 加载失败。');
      return;
    }

    if(!window.Hls.isSupported()){
      showErr('hls.js 判断当前环境不支持 MSE/HLS。建议使用 Safari。');
      return;
    }

    hlsInstance = new window.Hls({
      enableWorker: true,
      lowLatencyMode: true
    });

    hlsInstance.on(window.Hls.Events.ERROR, (event, data) => {
      // 尽量给出可读提示
      const details = [
        'HLS 错误：' + (data?.type || ''),
        '原因：' + (data?.details || ''),
        'fatal=' + (data?.fatal ? 'true' : 'false')
      ].join('\n');
      if(data?.fatal){
        showErr(details + '\n\n建议：检查 m3u8 是否可公开访问；或换 Safari；或更换稳定源。');
      }
    });

    hlsInstance.loadSource(url);
    hlsInstance.attachMedia(v);
  }

  function injectHlsJs(){
    return new Promise((resolve) => {
      if(window.Hls){ return resolve(); }
      const s = document.createElement('script');
      // CDN: jsDelivr
      s.src = 'https://cdn.jsdelivr.net/npm/hls.js@1.5.15/dist/hls.min.js';
      s.onload = () => resolve();
      s.onerror = () => resolve();
      document.head.appendChild(s);
    });
  }

  document.getElementById('reload').addEventListener('click', loadHls);

  // Autoload
  loadHls();

  // Register SW
  if('serviceWorker' in navigator){
    navigator.serviceWorker.register('./sw.js').catch(()=>{});
  }
</script>
</body>
</html>
