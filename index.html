<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>çš“ä¼Šæˆé•¿ç§¯åˆ†ï¼ˆPWAï¼‰</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>tailwind.config={theme:{extend:{colors:{primary:'#1a365d',accent:'#d97706'}}}}</script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap');
        *{-webkit-tap-highlight-color:transparent;box-sizing:border-box}
        body{font-family:'Noto Sans SC',sans-serif;margin:0;padding:0;background:linear-gradient(135deg,#f8fafc 0%,#e2e8f0 100%);min-height:100vh}
        .safe-bottom{padding-bottom:env(safe-area-inset-bottom,20px)}
        .tab-active{color:#1a365d;border-bottom:3px solid #1a365d;background:linear-gradient(to top,rgba(26,54,93,0.1),transparent)}
        .card{background:white;border-radius:16px;box-shadow:0 4px 20px rgba(0,0,0,0.08)}
        .btn-primary{background:linear-gradient(135deg,#1a365d 0%,#2d4a7c 100%);color:white}
        .btn-success{background:linear-gradient(135deg,#15803d 0%,#22c55e 100%);color:white}
        .btn-danger{background:linear-gradient(135deg,#b91c1c 0%,#ef4444 100%);color:white}
        .btn-warning{background:linear-gradient(135deg,#d97706 0%,#fbbf24 100%);color:white}
        .slide-in{animation:slideIn 0.3s ease-out}
        @keyframes slideIn{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}
        .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.6);backdrop-filter:blur(4px);display:flex;align-items:flex-start;justify-content:center;z-index:100;padding:16px;overflow-y:auto;-webkit-overflow-scrolling:touch;overscroll-behavior:contain;}

        body.modal-open{overflow:hidden}
        .modal-close{
            position:fixed;top:calc(14px + env(safe-area-inset-top));right:calc(14px + env(safe-area-inset-right));z-index:101;
            width:44px;height:44px;border-radius:9999px;
            background:rgba(255,255,255,0.92);
            border:1px solid rgba(0,0,0,0.08);
            display:flex;align-items:center;justify-content:center;
            box-shadow:0 10px 30px rgba(0,0,0,0.25);
            font-size:16px;line-height:1;cursor:pointer;
        }
        .modal-close:active{transform:scale(0.98)}

/* è¯æ®é¢„è§ˆå±‚ï¼ˆè¿”å›è¯„å®šï¼‰ */
.preview-shell{width:100%;max-width:52rem;margin:18px auto;background:#fff;border-radius:18px;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,0.35)}
.preview-header{display:flex;align-items:center;justify-content:space-between;padding:12px 12px;background:rgba(255,255,255,0.96);border-bottom:1px solid rgba(0,0,0,0.06)}
.preview-back{font-size:14px;padding:10px 12px;border-radius:12px;background:#f3f4f6}
.preview-title{font-weight:700;font-size:15px;color:#111827}
.preview-count{font-weight:600;color:#6b7280;margin-left:6px}
.preview-x{width:44px;height:44px;border-radius:9999px;background:#f3f4f6;display:flex;align-items:center;justify-content:center}
.preview-body{padding:14px;max-height:calc(100vh - 220px);overflow:auto;-webkit-overflow-scrolling:touch}
.preview-media{width:100%;border-radius:14px;max-height:calc(100vh - 240px);object-fit:contain;background:#11182710}
.preview-footer{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:12px 14px;background:#fff;border-top:1px solid rgba(0,0,0,0.06)}
.preview-nav{flex:0 0 auto;padding:10px 12px;border-radius:12px;background:#f3f4f6}
.preview-nav:disabled{opacity:0.45}
.preview-open{flex:1;text-align:center;padding:10px 12px;border-radius:12px;background:#e5f2ff;color:#1d4ed8;font-weight:600}


        .modal-overlay>*:not(.modal-close){width:100%;max-width:28rem;margin:20px auto;max-height:calc(100vh - 80px);overflow-y:auto;-webkit-overflow-scrolling:touch;display:flex;flex-direction:column;}
        .modal-content{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;padding-bottom:80px;}
        .modal-footer{position:sticky;bottom:0;background:white;padding:16px;border-top:1px solid #e5e7eb;margin-top:auto;border-radius:0 0 16px 16px;}
        @media(min-width:768px){.modal-overlay{align-items:center}.modal-overlay>*{max-height:calc(100vh - 64px)}}
        .collapse-content{max-height:0;overflow:hidden;transition:max-height 0.3s ease-out}
        .collapse-content.expanded{max-height:2000px}
        .diff-badge{display:inline-block;padding:2px 6px;border-radius:10px;font-size:10px;font-weight:600}
        .pending-pulse{animation:pulse 2s infinite}
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.6}}
        input:focus,select:focus,textarea:focus{outline:none;border-color:#3b82f6;box-shadow:0 0 0 3px rgba(59,130,246,0.2)}
        .subject-card{border-left:4px solid}
        .late-warning{background:linear-gradient(135deg,#fef2f2 0%,#fee2e2 100%);border:1px solid #fecaca}
        .checkin-badge{font-size:10px;padding:2px 6px;border-radius:8px}
        .quota-card{background:linear-gradient(135deg,#fef3c7 0%,#fde68a 100%)}
    </style>

    <meta name="theme-color" content="#1a365d">
    <meta name="apple-mobile-web-app-title" content="å®¶åº­ç§¯åˆ†">
    <link rel="manifest" href="manifest.webmanifest">
    <link rel=\"apple-touch-icon\" href=\"apple-touch-icon.png\">
    <link rel=\"icon\" type=\"image/png\" sizes=\"512x512\" href=\"icon-512.png\">
</head>
<body>
    <div id="app"></div>
    <div id="modal"></div>

    <script>
    const VERSION = '6.2';
    const DEFAULT_PWD = '123456';
    const BASE_YEARLY_QUOTA = 5000; // åŸºç¡€å¹´åº¦é¢åº¦
    
    // ==================== é…ç½® ====================
    const CONFIG = {
        // 10ä¸ªç§‘ç›®
        subjects: [
            { key: 'chinese', name: 'è¯­æ–‡', icon: 'ğŸ“–', color: '#dc2626' },
            { key: 'math', name: 'æ•°å­¦', icon: 'ğŸ”¢', color: '#2563eb' },
            { key: 'english', name: 'è‹±è¯­', icon: 'ğŸ”¤', color: '#7c3aed' },
            { key: 'philosophy', name: 'å“²å­¦', icon: 'ğŸ§ ', color: '#059669' },
            { key: 'logic', name: 'é€»è¾‘', icon: 'ğŸ§©', color: '#d97706' },
            { key: 'other', name: 'å…¶å®ƒ', icon: 'ğŸŒŸ', color: '#6b7280' },
            { key: 'other1', name: 'å…¶å®ƒ1', icon: 'ğŸ“Œ', color: '#0891b2' },
            { key: 'other2', name: 'å…¶å®ƒ2', icon: 'ğŸ“', color: '#be185d' },
            { key: 'other3', name: 'å…¶å®ƒ3', icon: 'ğŸ¯', color: '#4f46e5' },
            { key: 'other4', name: 'å…¶å®ƒ4', icon: 'ğŸ’¡', color: '#84cc16' },
        ],
        
        // æ¯æ—¥ä»»åŠ¡ï¼ˆæŒ‰æ˜ŸæœŸè®¾ç½®ä¸åŒæ‰“å¡æ—¶é—´ï¼‰
        dailyTasks: [
            { 
                key: 'wakeUp', 
                label: 'æŒ‰æ—¶èµ·åºŠ', 
                icon: 'ğŸŒ…',
                deadlines: {
                    weekday: '07:00',
                    weekend: '08:30',
                },
                // æ‰“å¡æ—¶é—´æ®µé™åˆ¶ï¼ˆé˜²æ­¢å‡Œæ™¨æ‰“å¡ï¼‰
                validTimeRange: {
                    weekday: { earliest: '05:00', latest: '12:00' },
                    weekend: { earliest: '05:00', latest: '12:00' },
                },
                lateDeductions: [
                    { minutes: 15, pts: 1, label: 'è¿Ÿ15åˆ†é’Ÿ' },
                    { minutes: 30, pts: 2, label: 'è¿Ÿ30åˆ†é’Ÿ' },
                    { minutes: 60, pts: 3, label: 'è¿Ÿ1å°æ—¶' },
                    { minutes: 120, pts: 4, label: 'è¿Ÿ2å°æ—¶ä»¥ä¸Š' },
                ]
            },
            { key: 'homework', label: 'å½“æ—¥ä½œä¸šç‹¬ç«‹å®Œæˆ', icon: 'ğŸ“š' },
            { key: 'organize', label: 'æ•´ç†ä¹¦åŒ…ä¸å­¦ä¹ åŒº', icon: 'ğŸ’' },
            { key: 'chore', label: 'å®Œæˆä¸€é¡¹å®¶åŠ¡', icon: 'ğŸ ' },
        ],
        
        extraModules: [
            { key: 'learning', label: 'ğŸ“–å­¦ä¹ çªç ´', items: ['å®ŒæˆæŒ‘æˆ˜ç›®æ ‡+4', 'ä½œä¸šå…¨å¯¹/é«˜è´¨é‡+2', 'ä¸»åŠ¨é¢„ä¹ /å¤ä¹ +2'] },
            { key: 'habit', label: 'ğŸƒä¹ æƒ¯å…»æˆ', items: ['ä¸“æ³¨å­¦ä¹ 25åˆ†é’Ÿ+2', 'æ—©ç¡æ—©èµ·+1', 'è¿åŠ¨30åˆ†é’Ÿ+1'] },
            { key: 'character', label: 'ğŸ’–å“æ ¼é—ªå…‰', items: ['ä¸»åŠ¨å¸®åŠ©ä»–äºº+2', 'æ‰¿è®¤é”™è¯¯+2', 'ç¤¼è²Œå¾…äºº+1'] },
            { key: 'family', label: 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§å®¶åº­è´¡çŒ®', items: ['ä¸»åŠ¨åšå®¶åŠ¡+2', 'ç…§é¡¾å¼Ÿå¦¹+3', 'é™ªä¼´è€äºº+2'] },
            { key: 'parent', label: 'ğŸç‰¹åˆ«å¥–åŠ±', items: ['å®¶é•¿ç‰¹æ‰¹+3', 'æ„å¤–æƒŠå–œ+2'] },
        ],
        a3Limits: { 1: 10, 2: 10, 3: 10, 4: 10 }, // æ¯å‘¨ä¸Šé™10åˆ†
        noteScoreLimits: { 1: 10, 2: 10, 3: 10, 4: 10 }, // å¿ƒå¾—è¯„åˆ†æ¯å‘¨ä¸Šé™10åˆ†
        appealPolicy: { windowHours: 48, weeklyLimit: 2 }, // ç”³è¯‰çª—å£ï¼š48å°æ—¶å†…ã€æ¯å‘¨æœ€å¤š2æ¬¡ï¼ˆå¯æŒ‰éœ€è°ƒæ•´ï¼‰

        
        difficulties: [
            { v: 1.0, label: 'æ™®é€š', color: 'bg-gray-100 text-gray-600' },
            { v: 1.2, label: 'è¾ƒéš¾', color: 'bg-blue-100 text-blue-700' },
            { v: 1.5, label: 'å›°éš¾', color: 'bg-yellow-100 text-yellow-700' },
            { v: 1.8, label: 'æŒ‘æˆ˜', color: 'bg-orange-100 text-orange-700' },
            { v: 2.0, label: 'æéš¾', color: 'bg-red-100 text-red-700' },
            { v: 2.5, label: 'è¶…è¶Š', color: 'bg-purple-100 text-purple-700' },
            { v: 3.0, label: 'å°é¡¶', color: 'bg-fuchsia-100 text-fuchsia-700' },
        ],

        // ä»»åŠ¡ç±»å‹ï¼ˆç”¨äºæ ‡å‡†é‡åŒ–éš¾åº¦ç³»æ•°ï¼šé€‰æ‹©ç±»å‹â†’è‡ªåŠ¨å»ºè®®å€æ•°ï¼‰
        taskTypes: [
            { key: 'practice', label: 'ç»ƒä¹ /å·©å›ºï¼ˆåŸºç¡€é¢˜ã€å¤ä¹ ï¼‰', coeff: 1.0, hint: 'ç†Ÿç»ƒåº¦å¯¼å‘ï¼Œé‡å¤è®­ç»ƒ' },
            { key: 'homework_plus', label: 'ä½œä¸šåŠ æ·±ï¼ˆæé«˜é¢˜ã€é”™é¢˜æ•´ç†ï¼‰', coeff: 1.2, hint: 'åœ¨å¸¸è§„ä»»åŠ¡ä¸ŠåŠ æ·±ä¸€å±‚' },
            { key: 'new_knowledge', label: 'æ–°çŸ¥è¯†ç‚¹å­¦ä¹ ï¼ˆæ¦‚å¿µç†è§£/é¢„ä¹ /æ–°ç« èŠ‚ï¼‰', coeff: 1.3, hint: 'ä»¥ç†è§£æ–°æ¦‚å¿µä¸ºä¸»ï¼Œè®¤çŸ¥è´Ÿè·æ›´é«˜' },

            { key: 'challenge', label: 'æŒ‘æˆ˜é¢˜/å¥¥æ•°/æ‹”é«˜', coeff: 1.5, hint: 'éœ€è¦æ›´é«˜æ¨ç†æˆ–æŠ€å·§' },
            { key: 'project', label: 'é¡¹ç›®å‹ï¼ˆå†™ä½œ/å®éªŒ/ä½œå“/æ¼”è®²ï¼‰', coeff: 1.8, hint: 'ç»¼åˆèƒ½åŠ›+æŒç»­æŠ•å…¥' },
            { key: 'competition', label: 'ç«èµ›/é«˜å¼ºåº¦è®­ç»ƒ/é•¿æ—¶ä»»åŠ¡', coeff: 2.0, hint: 'å¼ºå‹åŠ›æˆ–é«˜éš¾åº¦è¦æ±‚' },
            { key: 'beyond', label: 'è¶…è¶Šï¼ˆåŸåˆ›/è·¨å­¦ç§‘/é•¿æœŸç¡¬éª¨å¤´ï¼‰', coeff: 2.5, hint: 'ç½•è§éš¾åº¦æˆ–å¼ºåˆ›æ–°' },
        ],

        // å››å› å­éš¾åº¦æ¨¡å‹ï¼šéš¾åº¦ç³»æ•° = ç±»å‹ç³»æ•° Ã— æ—¶é•¿ç³»æ•° Ã— è¯æ®ç³»æ•° Ã— æ–°é¢–åº¦ç³»æ•°ï¼ˆæœ€ç»ˆå°é¡¶åˆ° 1.0~3.0 å¹¶æ˜ å°„åˆ°æ¡£ä½ï¼‰
        durationFactors: [
            { key: 'm0_15',    label: 'â‰¤15åˆ†é’Ÿ',  coeff: 0.90, hint: 'çŸ­ä»»åŠ¡' },
            { key: 'm15_30',   label: '15-30åˆ†é’Ÿ', coeff: 1.00, hint: 'å¸¸è§„æ—¶é•¿' },
            { key: 'm30_60',   label: '30-60åˆ†é’Ÿ', coeff: 1.10, hint: 'éœ€è¦æŒç»­æŠ•å…¥' },
            { key: 'm60_120',  label: '1-2å°æ—¶',   coeff: 1.20, hint: 'é•¿æ—¶ä»»åŠ¡' },
            { key: 'm120_plus',label: 'â‰¥2å°æ—¶',   coeff: 1.30, hint: 'é«˜æ—¶é—´æˆæœ¬' },
        ],
        evidenceFactors: [
            { key: 'none',     label: 'æ— è¯æ®ï¼ˆä¸å»ºè®®ï¼‰', coeff: 0.90, hint: 'ä»…å£å¤´æè¿°' },
            { key: 'oral',     label: 'å£å¤´/æ–‡å­—è¯´æ˜',     coeff: 1.00, hint: 'å¯å¤è¿°è¦ç‚¹' },
            { key: 'photo',    label: 'ç…§ç‰‡',             coeff: 1.05, hint: 'å¯æ ¸éªŒ' },
            { key: 'video',    label: 'è§†é¢‘/å½•éŸ³',         coeff: 1.10, hint: 'è¿‡ç¨‹å¯è¿½æº¯' },
            { key: 'artifact', label: 'ä½œå“/ä½œä¸š/è¾“å‡ºç‰©',   coeff: 1.12, hint: 'æœ‰å¯è¯„ä¼°æˆæœ' },
            { key: 'multi',    label: 'å¤šè¯æ®ï¼ˆç…§ç‰‡+è¯´æ˜ç­‰ï¼‰', coeff: 1.15, hint: 'è¯æ®å……åˆ†' },
        ],
        noveltyFactors: [
            { key: 'routine',  label: 'å¸¸è§„é‡å¤ï¼ˆå¤ä¹ /ç†Ÿç»ƒï¼‰', coeff: 0.95, hint: 'ä½æ–°é¢–åº¦' },
            { key: 'normal',   label: 'æ­£å¸¸æ–°é¢–åº¦',           coeff: 1.00, hint: 'å¸¸è§„å­¦ä¹ ' },
            { key: 'new',      label: 'æ–°çŸ¥è¯†ç‚¹/æ–°æŠ€èƒ½',        coeff: 1.08, hint: 'éœ€è¦é€‚åº”' },
            { key: 'first',    label: 'é¦–æ¬¡æ”»å…‹/è‡ªä¸»è§„åˆ’',       coeff: 1.15, hint: 'é«˜æ–°é¢–åº¦' },
        ],

        taskScores:
 {
            weekly: { done: 10, partial: 5 },      // å‘¨ä»»åŠ¡ï¼šå®Œæˆ+10Ã—ç³»æ•°ï¼Œéƒ¨åˆ†+5Ã—ç³»æ•°
            monthly: { done: 25, partial: 12 },    // æœˆä»»åŠ¡ï¼šå®Œæˆ+25Ã—ç³»æ•°ï¼Œéƒ¨åˆ†+12Ã—ç³»æ•°
            quarterly: { done: 50, partial: 25 },  // å­£åº¦ä»»åŠ¡ï¼šå®Œæˆ+50Ã—ç³»æ•°ï¼ˆä¸»è¦é é‡Œç¨‹ç¢‘å¥–é‡‘ï¼‰
            yearly: { done: 80, partial: 40 },     // å¹´åº¦ä»»åŠ¡ï¼šå®Œæˆ+80Ã—ç³»æ•°ï¼ˆä¸»è¦é å¹´ç»ˆå¥–é‡‘ï¼‰
        },
        
        incompleteReasons: [
            { key: 'justified', label: 'æ­£å½“ç†ç”±(ç”Ÿç—…)', pts: -1 },
            { key: 'communicated', label: 'å·²æå‰æ²Ÿé€š', pts: -2 },
            { key: 'no_reason', label: 'æ— ç†ç”±/å¿˜è®°', pts: -3 },
            { key: 'refused', label: 'æ‹’ç»æ‰§è¡Œ', pts: -5 },
            { key: 'custom', label: 'è‡ªå®šä¹‰ç†ç”±', pts: 0 }, // å®¶é•¿å¯è‡ªç”±å¡«å†™å¹¶æŒ‡å®šæ‰£åˆ†
        ],
        
        deductionRules: [
            { label: 'æ•·è¡/æŠ„è¢­', pts: 4, isEmotion: false },
            { label: 'å¿…åšæœªå®Œæˆ', pts: 2, isEmotion: false },
            { label: 'æƒ…ç»ªå¤±æ§', pts: 2, isEmotion: true },
            { label: 'å‘è„¾æ°”/æ‘”ä¸œè¥¿', pts: 3, isEmotion: true },
            { label: 'å¤§å¼/é¡¶å˜´', pts: 2, isEmotion: true },
            { label: 'åŸåˆ™æ€§æ’’è°', pts: 6, isEmotion: false },
            { label: 'å±¡æ•™ä¸æ”¹', pts: 4, isEmotion: false },
        ],
        
        // å…‘æ¢å•†åŸï¼ˆå¢åŠ æ›´å¤šæ¿€åŠ±é¡¹ç›®ï¼‰
        redemptionCats: [
            { key: 'tiny', name: 'ğŸ­å°æƒŠå–œ', freq: 'daily', freqLabel: 'æ¯æ—¥1æ¬¡', items: [
                { name: 'ç³–æœ/å°é›¶é£Ÿ', pts: 3 },
                { name: 'å¤šçœ‹5åˆ†é’ŸåŠ¨ç”»', pts: 5 },
                { name: 'é€‰æ‹©ä»Šå¤©çš„æ°´æœ', pts: 2 },
                { name: 'è´´çº¸å¥–åŠ±', pts: 3 },
            ]},
            { key: 'small_joy', name: 'ğŸ¬å°ç¡®å¹¸', freq: 'weekly', freqLabel: 'æ¯å‘¨1æ¬¡', items: [
                { name: 'å–œçˆ±é›¶é£Ÿ/é¥®å“', pts: 10 },
                { name: 'æ¸¸æˆ+30åˆ†é’Ÿ', pts: 12 },
                { name: 'æ™šç¡30åˆ†é’Ÿ', pts: 15 },
                { name: 'é€‰æ‹©æ™šé¤èœå“', pts: 8 },
                { name: 'å’Œçˆ¸å¦ˆç©æ¡Œæ¸¸', pts: 10 },
                { name: 'çœ‹ä¸€é›†å–œæ¬¢çš„åŠ¨ç”»', pts: 12 },
            ]},
            { key: 'small_happy', name: 'ğŸ‰å°æ¬¢å–œ', freq: 'weekly', freqLabel: 'æ¯å‘¨1æ¬¡', exclusive: 'small_joy', items: [
                { name: 'å®¶åº­å½±é™¢ä¹‹å¤œ', pts: 30 },
                { name: 'å¤–å‡ºç”œå“', pts: 35 },
                { name: 'æ–°ä¹¦/æ–‡å…·', pts: 50 },
                { name: 'å’Œæœ‹å‹è§†é¢‘èŠå¤©', pts: 20 },
                { name: 'è‡ªé€‰æ—©é¤', pts: 25 },
                { name: 'å…åšä¸€é¡¹å®¶åŠ¡', pts: 40 },
            ]},
            { key: 'medium', name: 'ğŸˆä¸­æ»¡è¶³', freq: 'biweekly', freqLabel: 'ä¸¤å‘¨1æ¬¡', items: [
                { name: 'ç”µå½±é™¢', pts: 100 },
                { name: 'æ–°ç©å…·50å…ƒå†…', pts: 50 },
                { name: 'å¤–å‡ºå¤§é¤', pts: 150 },
                { name: 'æ¸¸ä¹åœº/è¹¦åºŠå…¬å›­', pts: 120 },
                { name: 'æ¸¸æ³³/æ»‘å†°', pts: 80 },
                { name: 'é‚€è¯·æœ‹å‹æ¥å®¶ç©', pts: 50 },
                { name: 'ç‚¹å¤–å–è‡ªé€‰', pts: 50 },
            ]},
            { key: 'big', name: 'ğŸå¤§æ»¡è¶³', freq: 'monthly', freqLabel: 'æ¯æœˆ1æ¬¡', items: [
                { name: 'ä¹é«˜å¥—è£…(å°)', pts: 250 },
                { name: 'ç§‘å­¦å®éªŒå¥—è£…', pts: 150 },
                { name: 'è¿åŠ¨è£…å¤‡', pts: 250 },
                { name: 'å¯†å®¤é€ƒè„±/å‰§æœ¬æ€', pts: 200 },
                { name: 'åŠ¨ç‰©å›­/æµ·æ´‹é¦†', pts: 180 },
                { name: 'ä¸»é¢˜ä¹å›­åŠæ—¥', pts: 400 },
                { name: 'æ–°è¡£æœè‡ªé€‰', pts: 200 },
            ]},
            { key: 'super', name: 'ğŸŒŸè¶…æ»¡è¶³', freq: 'monthly', freqLabel: 'æ¯æœˆ1æ¬¡', items: [
                { name: 'ä¹é«˜å¥—è£…(å¤§)', pts: 600 },
                { name: 'å„¿ç«¥æ‰‹è¡¨', pts: 800 },
                { name: 'ä¸»é¢˜ä¹å›­å…¨æ—¥', pts: 700 },
                { name: 'æ¼”å”±ä¼š/èˆå°å‰§', pts: 500 },
                { name: 'éœ²è¥ä½“éªŒ', pts: 400 },
                { name: 'å­¦ä¹ ä¸€é¡¹æ–°æŠ€èƒ½è¯¾', pts: 500 },
            ]},
            { key: 'experience', name: 'ğŸªç‰¹åˆ«ä½“éªŒ', freq: 'monthly', freqLabel: 'æ¯æœˆ1æ¬¡', items: [
                { name: 'å¡ä¸è½¦ä½“éªŒ', pts: 200 },
                { name: 'æ”€å²©ä½“éªŒ', pts: 250 },
                { name: 'é™¶è‰º/æ‰‹å·¥è¯¾', pts: 200 },
                { name: 'çƒ˜ç„™è¯¾ç¨‹', pts: 250 },
                { name: 'éª‘é©¬ä½“éªŒ', pts: 350 },
                { name: 'å°„ç®­ä½“éªŒ', pts: 150 },
            ]},
            { key: 'travel', name: 'âœˆï¸æ—…è¡Œæ¢¦æƒ³', freq: 'quarterly', freqLabel: 'å­£åº¦1æ¬¡', items: [
                { name: 'å‘¨è¾¹1æ—¥æ¸¸', pts: 800 },
                { name: 'å‘¨è¾¹2æ—¥æ¸¸', pts: 1500 },
                { name: 'è·¨çœæ—…è¡Œ', pts: 4000 },
                { name: 'ä¸»é¢˜é…’åº—ä½å®¿', pts: 1000 },
                { name: 'é«˜é“/é£æœºå‡ºè¡Œ', pts: 1000 },
            ]},
            { key: 'dream', name: 'ğŸ†æ¢¦æƒ³æˆçœŸ', freq: 'quarterly', freqLabel: 'å­£åº¦1æ¬¡', items: [
                { name: 'å…¥é—¨å¹³æ¿', pts: 2000 },
                { name: 'æ¸¸æˆæœº', pts: 2500 },
                { name: 'æ— äººæœº(å…¥é—¨)', pts: 1000 },
                { name: 'ä¸“ä¸šè¿åŠ¨è£…å¤‡', pts: 800 },
                { name: 'ä¹å™¨(å…¥é—¨)', pts: 2000 },
            ]},
            { key: 'ultimate', name: 'ğŸ‘‘ç»ˆææ¢¦æƒ³', freq: 'yearly', freqLabel: 'å¹´åº¦1æ¬¡', items: [
                { name: 'å‡ºå›½æ—…è¡Œ', pts: 20000 },
                { name: 'é«˜ç«¯è®¾å¤‡', pts: 6000 },
                { name: 'è¿ªå£«å°¼/ç¯çƒå½±åŸ', pts: 5000 },
                { name: 'å¤ä»¤è¥/å†¬ä»¤è¥', pts: 5000 },
                { name: 'ç”Ÿæ—¥å¤§æ´¾å¯¹', pts: 3000 },
            ]},
            { key: 'special', name: 'ğŸ–ï¸ç‰¹æƒå¡', freq: 'monthly', freqLabel: 'æ¯æœˆ1æ¬¡', items: [
                { name: 'å®¶åŠ¡å‡è´Ÿå¡(1é¡¹/ä¸å«å«ç”Ÿåº•çº¿)', pts: 30 },
                { name: 'ä½œä¸šå»¶æœŸå¡(1å¤©/éœ€å®¶é•¿ç¡®è®¤)', pts: 50 },
                { name: 'ç¡æ‡’è§‰å¡(å‘¨æœ«/æœ€å¤š+1.5å°æ—¶)', pts: 40 },
                { name: 'é›¶é£Ÿè‡ªç”±æ—¥(é™é¢/éœ€å®¶é•¿åŒæ„)', pts: 60 },
                { name: 'å±å¹•æ—¶é—´+1å°æ—¶(ä¸å ç¡çœ /è¿åŠ¨)', pts: 80 },
                { name: 'é€‰æ‹©å‘¨æœ«æ´»åŠ¨(å®¶é•¿æ‰¿æ‹…ç°é‡‘60%/é™ªåŒ75%)', pts: 100 },
            ]},
        ],
        
        cashTiers: [
            { name: 'é›¶èŠ±é’±', pts: 25, cash: 20 },
            { name: 'å°ç¡®å¹¸çº§', pts: 50, cash: 40 },
            { name: 'å¤§æ»¡è¶³çº§', pts: 200, cash: 160 },
            { name: 'æ¢¦æƒ³çº§', pts: 800, cash: 640 },
        ],
    };

    // ==================== æ•°æ®å­˜å‚¨ ====================
    const DB = {
        get(k, def = null) {
            try {
                const d = localStorage.getItem('fp45_' + k);
                if (!d) return def;
                const v = JSON.parse(d);
                return (v === null && def !== null) ? def : v;
            } catch(e) { return def; }
        },
        set(k, v) { localStorage.setItem('fp45_' + k, JSON.stringify(v)); },
        today() { return formatYMD(new Date()); },
        month() { return this.today().substring(0, 7); },
        week() { return Math.min(Math.ceil(new Date().getDate() / 7), 4); },
        quarter() { return Math.floor(new Date().getMonth() / 3) + 1; },
        year() { return new Date().getFullYear(); },
        pwd() { return this.get('pwd', DEFAULT_PWD); },
        getDayOfWeek(dateStr) {
            return parseDateLocal(dateStr).getDay();
        },
        // è·å–å­©å­å¹´é¾„
        getChildAge() {
            const birthday = this.get('childBirthday', null);
            if (!birthday) return null;
            const today = new Date();
            const birth = parseDateLocal(birthday);
            let age = today.getFullYear() - birth.getFullYear();
            const m = today.getMonth() - birth.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < birth.getDate())) {
                age--;
            }
            return age;
        },
        // è·å–å¹´åº¦é¢åº¦å€æ•°
        getYearlyMultiplier() {
            const age = this.getChildAge();
            if (age === null) return 1.0;
            // å¹´é¾„ * 0.1ï¼Œä¾‹å¦‚8å²=0.8+1=1.8ï¼›æœ€ç»ˆä¸Šé™ä¸º3.0å€
            return Math.min(age / 10 + 1, 3.0); // æœ€é«˜3å€
        },
        // è·å–å¹´åº¦æ€»é¢åº¦
        getYearlyQuota() {
            return Math.round(BASE_YEARLY_QUOTA * this.getYearlyMultiplier());
        },
        exportAll() {
            const keys = ['daily','tasks','plan','milestoneBonuses','taskRequests','redemptions','exemptions','emotionCards',
                         'customItems','appeals','catChildReqs','remedies','cashTiers','initialBalance','pwd','childBirthday','childName','notifications',
                         'syncEvents'];
            const data = { version: VERSION, exportedAt: new Date().toISOString() };
            keys.forEach(k => { data[k] = this.get(k); });
            return data;
        },
        importAll(data) {
            if (!data) return false;
            const keys = ['daily','tasks','plan','milestoneBonuses','taskRequests','redemptions','exemptions','emotionCards',
                         'customItems','appeals','catChildReqs','remedies','cashTiers','initialBalance','pwd','childBirthday','childName','notifications',
                         'syncEvents'];
            keys.forEach(k => { if (data[k] !== undefined) this.set(k, data[k]); });
            return true;
        },
        getSyncCode() { return btoa(encodeURIComponent(JSON.stringify(this.exportAll()))); },
        loadSyncCode(code) {
            try {
                const json = decodeURIComponent(atob(code));
                return this.importAll(JSON.parse(json));
            } catch (e) {
                return false;
            }
        }
    };
// ==================== è¯æ®é™„ä»¶ï¼ˆå›¾ç‰‡/è§†é¢‘/éŸ³é¢‘/æ–‡ä»¶ï¼‰æ”¯æŒ ====================
    // è¯´æ˜ï¼šå¤§æ–‡ä»¶å­˜ IndexedDBï¼ˆæ›´é€‚åˆæ‰‹æœºæ‹ç…§/è§†é¢‘ï¼‰ï¼Œå°æ–‡ä»¶å¯ç›´æ¥ä»¥ dataURL å­˜å‚¨ã€‚
    // æ³¨æ„ï¼šå¯¼å‡º/åŒæ­¥ç é»˜è®¤åªåŒ…å« tasks/daily ç­‰ JSONï¼Œä¸åŒ…å« IndexedDB ä¸­çš„å¤§é™„ä»¶ã€‚
    const EvidenceDB = (() => {
        const DB_NAME = 'fp45_evidence';
        const STORE = 'files';
        let _db = null;

        function open() {
            if (_db) return Promise.resolve(_db);
            return new Promise((resolve, reject) => {
                const req = indexedDB.open(DB_NAME, 1);
                req.onupgradeneeded = (e) => {
                    const db = e.target.result;
                    if (!db.objectStoreNames.contains(STORE)) {
                        db.createObjectStore(STORE, { keyPath: 'id' });
                    }
                };
                req.onsuccess = () => { _db = req.result; resolve(_db); };
                req.onerror = () => reject(req.error);
            });
        }

        async function putFile(file) {
            const db = await open();
            const id = 'ev_' + Math.random().toString(36).slice(2, 10) + '_' + Date.now().toString(36);
            const rec = { id, name: file.name, type: file.type || 'application/octet-stream', size: file.size, createdAt: new Date().toISOString(), blob: file };
            return new Promise((resolve, reject) => {
                const tx = db.transaction(STORE, 'readwrite');
                tx.objectStore(STORE).put(rec);
                tx.oncomplete = () => resolve(rec);
                tx.onerror = () => reject(tx.error);
            });
        }

        async function getFile(id) {
            const db = await open();
            return new Promise((resolve, reject) => {
                const tx = db.transaction(STORE, 'readonly');
                const req = tx.objectStore(STORE).get(id);
                req.onsuccess = () => resolve(req.result || null);
                req.onerror = () => reject(req.error);
            });
        }

        async function removeFile(id) {
            const db = await open();
            return new Promise((resolve, reject) => {
                const tx = db.transaction(STORE, 'readwrite');
                tx.objectStore(STORE).delete(id);
                tx.oncomplete = () => resolve(true);
                tx.onerror = () => reject(tx.error);
            });
        }

        return { putFile, getFile, removeFile };
    })();

    function fileToDataUrl(file) {
        return new Promise((resolve, reject) => {
            const fr = new FileReader();
            fr.onload = () => resolve(fr.result);
            fr.onerror = () => reject(fr.error);
            fr.readAsDataURL(file);
        });
    }

    async function collectEvidenceFromInputs(textId, linkId, fileId, wechatId) {
        const text = document.getElementById(textId)?.value?.trim() || '';
        const linkRaw = document.getElementById(linkId)?.value?.trim() || '';
        const links = linkRaw ? linkRaw.split(/\n|,|ï¼Œ/).map(s => s.trim()).filter(Boolean) : [];
        const files = Array.from(document.getElementById(fileId)?.files || []);
        const staged = (window.__evidenceStaging && Array.isArray(window.__evidenceStaging[fileId])) ? window.__evidenceStaging[fileId] : [];
        const outFiles = [];
        const SMALL_LIMIT = 700 * 1024; // çº¦700KBï¼Œä¾¿äº localStorage æ‰¿è½½

        for (const f of files) {
            const meta = { name: f.name, type: f.type || 'application/octet-stream', size: f.size };
            try {
                if ((meta.type || '').startsWith('image/')) {
                    // å°½é‡å‹ç¼©åˆ° SMALL_LIMIT å†…ï¼Œä¾¿äºè·¨è®¾å¤‡åŒæ­¥ï¼ˆåŒæ­¥ç ä»…æºå¸¦JSONæ•°æ®ï¼‰
                    try {
                        const raw = await fileToDataUrl(f);
                        meta.dataUrl = await compressDataUrlImageToJpeg(raw, SMALL_LIMIT);
                    } catch(e) {
                        // å‹ç¼©å¤±è´¥åˆ™å›é€€åˆ° IndexedDB
                        const rec = await EvidenceDB.putFile(f);
                        meta.idbId = rec.id;
                    }
                } else if (f.size <= SMALL_LIMIT && (meta.type || '').startsWith('audio/')) {
                    meta.dataUrl = await fileToDataUrl(f);
                } else {
                    const rec = await EvidenceDB.putFile(f);
                    meta.idbId = rec.id;
                }
                outFiles.push(meta);
            } catch (e) {
                console.warn('evidence file save failed', e);
                outFiles.push({ ...meta, error: true });
            }
        }

        // åˆå¹¶ stagedï¼ˆå¤šæ¬¡æ·»åŠ ï¼‰ä¸æœ¬æ¬¡inputé€‰æ‹©çš„æ–‡ä»¶
        const merged = [...(staged || []), ...outFiles];
        if (window.__evidenceStaging && Array.isArray(window.__evidenceStaging[fileId])) window.__evidenceStaging[fileId] = [];
        const wechat = (wechatId ? (document.getElementById(wechatId)?.value?.trim() || '') : '');
        return { text, links, wechat, files: merged };
    }

    function evidenceBadge(meta) {
        const t = meta.type || '';
        if (t.startsWith('image/')) return 'ğŸ–¼ï¸';
        if (t.startsWith('video/')) return 'ğŸ¬';
        if (t.startsWith('audio/')) return 'ğŸ§';
        return 'ğŸ“';
    }


    // è¯æ®é€‰æ‹©ï¼šæ”¯æŒâ€œå¤šæ¬¡æ·»åŠ â€ï¼Œè§£å†³æ‰‹æœºç›¸å†Œ/æ‹ç…§ä¸€æ¬¡åªèƒ½é€‰1ä¸ªçš„é—®é¢˜
    function triggerEvidencePick(fileInputId) {
        const el = document.getElementById(fileInputId);
        if (el) el.click();
    }

    function initEvidenceStaging(fileInputId, listContainerId) {
        window.__evidenceStaging = window.__evidenceStaging || {};
        window.__evidenceStaging[fileInputId] = window.__evidenceStaging[fileInputId] || [];

        const input = document.getElementById(fileInputId);
        if (!input) return;

        input.onchange = async () => {
            const files = Array.from(input.files || []);
            if (files.length === 0) return;
            await stageEvidenceFiles(fileInputId, files);
            // æ¸…ç©ºinputå€¼ï¼Œå…è®¸å†æ¬¡é€‰æ‹©ç›¸åŒæ–‡ä»¶
            input.value = '';
            renderStagedEvidenceList(fileInputId, listContainerId);
        };

        // åˆå§‹æ¸²æŸ“
        renderStagedEvidenceList(fileInputId, listContainerId);
    }

    function renderStagedEvidenceList(fileInputId, listContainerId) {
        const box = document.getElementById(listContainerId);
        if (!box) return;
        const staged = (window.__evidenceStaging && Array.isArray(window.__evidenceStaging[fileInputId])) ? window.__evidenceStaging[fileInputId] : [];
        if (staged.length === 0) {
            box.innerHTML = '<div class="text-xs text-gray-400">æœªæ·»åŠ é™„ä»¶</div>';
            return;
        }
        box.innerHTML = staged.map((m, i) => {
            const label = `${evidenceBadge(m)} ${m.name || 'é™„ä»¶'} (${Math.round((m.size||0)/1024)}KB)`;
            return `<div class="flex items-center justify-between px-2 py-1 bg-gray-50 rounded text-xs">
                        <div class="text-gray-700 truncate pr-2">${label}</div>
                        <button type="button" onclick="removeStagedEvidence('${fileInputId}', ${i}, '${listContainerId}')" class="text-red-500">åˆ é™¤</button>
                    </div>`;
        }).join('');
    }

    function removeStagedEvidence(fileInputId, idx, listContainerId) {
        const staged = (window.__evidenceStaging && Array.isArray(window.__evidenceStaging[fileInputId])) ? window.__evidenceStaging[fileInputId] : [];
        staged.splice(idx, 1);
        if (window.__evidenceStaging) window.__evidenceStaging[fileInputId] = staged;
        renderStagedEvidenceList(fileInputId, listContainerId);
    }

    async function compressDataUrlImageToJpeg(dataUrl, maxBytes) {
        // ç›®æ ‡ï¼šå°½é‡æŠŠå›¾ç‰‡å‹åˆ° maxBytes ä»¥å†…ï¼Œä»¥ä¾¿éšæ•°æ®åŒæ­¥ï¼ˆlocalStorage/åŒæ­¥ç ï¼‰
        return await new Promise((resolve, reject) => {
            const img = new Image();
            img.onload = () => {
                try {
                    let w = img.naturalWidth || img.width;
                    let h = img.naturalHeight || img.height;
                    const maxSide = 1600;
                    if (w > maxSide || h > maxSide) {
                        const scale = Math.min(maxSide / w, maxSide / h);
                        w = Math.round(w * scale);
                        h = Math.round(h * scale);
                    }
                    const canvas = document.createElement('canvas');
                    canvas.width = w;
                    canvas.height = h;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, w, h);

                    // é€æ­¥é™ä½è´¨é‡ï¼Œç›´åˆ°æ»¡è¶³å¤§å°è¦æ±‚æˆ–è¾¾åˆ°ä¸‹é™
                    let q = 0.85;
                    let out = canvas.toDataURL('image/jpeg', q);
                    while (out && out.length > maxBytes * 1.37 && q > 0.45) {
                        q -= 0.08;
                        out = canvas.toDataURL('image/jpeg', q);
                    }
                    resolve(out);
                } catch (e) {
                    reject(e);
                }
            };
            img.onerror = () => reject(new Error('image load failed'));
            img.src = dataUrl;
        });
    }

    async function stageEvidenceFiles(fileInputId, files) {
        window.__evidenceStaging = window.__evidenceStaging || {};
        const staged = window.__evidenceStaging[fileInputId] = window.__evidenceStaging[fileInputId] || [];

        const SMALL_LIMIT = 700 * 1024; // ä¸ collectEvidenceFromInputs ä¸€è‡´
        for (const f of files) {
            const meta = { name: f.name, type: f.type || 'application/octet-stream', size: f.size };
            try {
                if ((meta.type || '').startsWith('image/')) {
                    const raw = await fileToDataUrl(f);
                    meta.dataUrl = await compressDataUrlImageToJpeg(raw, SMALL_LIMIT);
                } else if (f.size <= SMALL_LIMIT && (meta.type || '').startsWith('audio/')) {
                    meta.dataUrl = await fileToDataUrl(f);
                } else {
                    const rec = await EvidenceDB.putFile(f);
                    meta.idbId = rec.id;
                }
                staged.push(meta);
            } catch (e) {
                console.warn('stage evidence failed', e);
                staged.push({ ...meta, error: true });
            }
        }
    }

    async function openEvidencePreview(listOrMeta, startIndex = 0) {
    try {
        const list = Array.isArray(listOrMeta) ? listOrMeta : [listOrMeta];
        if (!list || list.length === 0) { alert('é™„ä»¶ä¸å­˜åœ¨'); return; }

        // å…¨å±€çŠ¶æ€ï¼ˆç”¨äºä¸Šä¸€å¼ /ä¸‹ä¸€å¼ ï¼‰
        window.__evidencePreview = {
            list,
            index: Math.max(0, Math.min(startIndex || 0, list.length - 1)),
            objUrl: null
        };

        async function resolveUrl(meta) {
            let url = meta.dataUrl || null;
            let mime = meta.type || 'application/octet-stream';
            let name = meta.name || 'é™„ä»¶';

            if (!url && meta.idbId) {
                const rec = await EvidenceDB.getFile(meta.idbId);
                if (!rec) { alert('é™„ä»¶ä¸å­˜åœ¨ï¼šè¯¥é™„ä»¶å¯èƒ½ä»…ä¿å­˜åœ¨ä¸Šä¼ è®¾å¤‡/æµè§ˆå™¨æœ¬åœ°ï¼ˆå¤§æ–‡ä»¶å­˜IndexedDBï¼Œè·¨è®¾å¤‡åŒæ­¥ç ä¸åŒ…å«ï¼‰ã€‚è¯·åœ¨å½“å‰è®¾å¤‡é‡æ–°ä¸Šä¼ ï¼Œæˆ–æ”¹ç”¨é“¾æ¥/å‹ç¼©å›¾ç‰‡ã€‚'); return null; }
                mime = rec.type || mime;
                name = rec.name || name;

                // é‡Šæ”¾æ—§ objectURLï¼Œé¿å…å†…å­˜æ³„æ¼
                try { if (window.__evidencePreview.objUrl) URL.revokeObjectURL(window.__evidencePreview.objUrl); } catch(e) {}
                window.__evidencePreview.objUrl = URL.createObjectURL(rec.blob);
                url = window.__evidencePreview.objUrl;
            }

            if (!url) { alert('é™„ä»¶ä¸å¯ç”¨'); return null; }
            return { url, mime, name };
        }

        async function render() {
            const state = window.__evidencePreview;
            const meta = state.list[state.index];
            const info = await resolveUrl(meta);
            if (!info) return;

            const { url, mime, name } = info;
            const total = state.list.length;
            const idxText = `${state.index + 1}/${total}`;

            const canPrev = state.index > 0;
            const canNext = state.index < total - 1;

            let bodyHtml = '';
            if (mime.startsWith('image/')) {
                bodyHtml = `<img src="${url}" class="preview-media" alt="${name}" />`;
            } else if (mime.startsWith('video/')) {
                bodyHtml = `<video src="${url}" class="preview-media" controls playsinline></video>`;
            } else if (mime.startsWith('audio/')) {
                bodyHtml = `<audio src="${url}" class="w-full" controls></audio>`;
            } else {
                bodyHtml = `
                    <div class="text-sm text-gray-600">
                        <div class="font-semibold text-gray-900 mb-1">ğŸ“ ${name}</div>
                        <div>ç±»å‹ï¼š${mime}</div>
                        <div>å¤§å°ï¼š${Math.round((meta.size || 0) / 1024)} KB</div>
                    </div>`;
            }

            const html = `
                <div class="preview-shell" onclick="event.stopPropagation()">
                    <div class="preview-header">
                        <button class="preview-back" type="button" onclick="closeEvidencePreview()">â† è¿”å›è¯„å®š</button>
                        <div class="preview-title">é™„ä»¶é¢„è§ˆ <span class="preview-count">${idxText}</span></div>
                        <button class="preview-x" type="button" aria-label="å…³é—­" onclick="closeEvidencePreview()">âœ•</button>
                    </div>

                    <div class="preview-body">
                        ${bodyHtml}
                    </div>

                    <div class="preview-footer">
                        <button class="preview-nav" type="button" onclick="previewPrev()" ${canPrev ? '' : 'disabled'}>ä¸Šä¸€å¼ </button>
                        <a class="preview-open" href="${url}" target="_blank" rel="noopener">åŸæ–‡ä»¶</a>
                        <button class="preview-nav" type="button" onclick="previewNext()" ${canNext ? '' : 'disabled'}>ä¸‹ä¸€å¼ </button>
                    </div>
                </div>
            `;

            showModal(html, { showClose: false, pushHistory: false, stack: true });
        }

        // æš´éœ²ç»™æŒ‰é’®
        window.previewPrev = async function () {
            const s = window.__evidencePreview;
            if (!s || s.index <= 0) return;
            s.index -= 1;
            await render();
        };

        window.previewNext = async function () {
            const s = window.__evidencePreview;
            if (!s || s.index >= s.list.length - 1) return;
            s.index += 1;
            await render();
        };

        window.closeEvidencePreview = function () {
            try { if (window.__evidencePreview && window.__evidencePreview.objUrl) URL.revokeObjectURL(window.__evidencePreview.objUrl); } catch(e) {}
            window.__evidencePreview = null;
            hideModal(false, { stackPop: true, skipHistory: true });
        };

        await render();
    } catch (e) {
        console.error('openEvidencePreview error', e);
        alert('æ‰“å¼€é™„ä»¶å¤±è´¥');
    }
}

    function renderEvidenceInline(evi, openFnName, openFnArgsPrefix) {
        if (!evi) return '';
        const t = (evi.text || '').trim();
        const links = (evi.links || []).filter(Boolean);
        const files = (evi.files || []).filter(Boolean);
        const wechat = (evi.wechat || '').trim();
        const wechatHtml = wechat ? `<div class="text-xs text-gray-600 mt-2 whitespace-pre-wrap">ğŸ“± å¾®ä¿¡ç¾¤ï¼š${wechat}</div>` : '';

        const linksHtml = links.length ? `
            <div class="mt-2 text-xs">
                <div class="text-gray-500 mb-1">ğŸ”— é“¾æ¥</div>
                ${links.map(u => `<div class="truncate"><a class="text-blue-600 underline" href="${u}" target="_blank">${u}</a></div>`).join('')}
            </div>` : '';

        const filesHtml = files.length ? `
            <div class="mt-2 text-xs">
                <div class="text-gray-500 mb-1">ğŸ“ é™„ä»¶</div>
                <div class="flex flex-wrap gap-2">
                    ${files.map((f, i) => `
                        <button onclick="${openFnName}(${openFnArgsPrefix}${i})" class="px-2 py-1 bg-gray-100 rounded-lg text-gray-700">
                            ${evidenceBadge(f)} ${f.name ? f.name.slice(0, 12) : 'é™„ä»¶'}${(f.name && f.name.length>12)?'â€¦':''}
                        </button>
                    `).join('')}
                </div>
            </div>` : '';

        const textHtml = t ? `<div class="text-xs text-gray-600 mt-2 whitespace-pre-wrap">ğŸ§¾ è¯´æ˜ï¼š${t}</div>` : '';

        return `${textHtml}${wechatHtml}${linksHtml}${filesHtml}`;
    }



    // æ‰“å¼€ä»»åŠ¡æäº¤çš„é™„ä»¶é¢„è§ˆ
    function openTaskEvidence(type, periodKey, subjectKey, fileIdx) {
        const allTasks = DB.get('tasks', {});
        const taskKey = `${type}_${periodKey}`;
        const t = (allTasks[taskKey] || {})[subjectKey] || {};
        const files = (t.childEvidence && t.childEvidence.files) ? t.childEvidence.files : [];
        const meta = files[fileIdx];
        if (!meta) { alert('é™„ä»¶ä¸å­˜åœ¨'); return; }
        openEvidencePreview(files, fileIdx);
    }

    // ==================== æ‰“å¡æ—¶é—´å·¥å…· ====================
    const CheckinHelper = {
        getDeadline(taskKey, dateStr) {
            const task = CONFIG.dailyTasks.find(t => t.key === taskKey);
            if (!task || !task.deadlines) return null;
            const dow = DB.getDayOfWeek(dateStr);
            const isWeekend = dow === 0 || dow === 6;
            // ä¼˜å…ˆä½¿ç”¨è‡ªå®šä¹‰è®¾ç½®
            if (taskKey === 'wakeUp') {
                const customSettings = DB.get('wakeUpSettings', null);
                if (customSettings) {
                    return isWeekend ? customSettings.weekend : customSettings.weekday;
                }
            }
            return isWeekend ? task.deadlines.weekend : task.deadlines.weekday;
        },
        
        getValidTimeRange(taskKey, dateStr) {
            const task = CONFIG.dailyTasks.find(t => t.key === taskKey);
            const dow = DB.getDayOfWeek(dateStr);
            const isWeekend = dow === 0 || dow === 6;
            // ä¼˜å…ˆä½¿ç”¨è‡ªå®šä¹‰è®¾ç½®
            if (taskKey === 'wakeUp') {
                const customSettings = DB.get('wakeUpSettings', null);
                if (customSettings && customSettings.validRange) {
                    return isWeekend ? customSettings.validRange.weekend : customSettings.validRange.weekday;
                }
            }
            // ä½¿ç”¨é»˜è®¤é…ç½®
            if (task && task.validTimeRange) {
                return isWeekend ? task.validTimeRange.weekend : task.validTimeRange.weekday;
            }
            return null;
        },
        
        isValidCheckinTime(taskKey, dateStr, checkinTime) {
            const range = this.getValidTimeRange(taskKey, dateStr);
            if (!range || !checkinTime) return true; // æ²¡æœ‰é™åˆ¶åˆ™å…è®¸
            
            const [ch, cm] = checkinTime.split(':').map(Number);
            const checkinMinutes = ch * 60 + cm;
            
            const [eh, em] = (range.earliest || '00:00').split(':').map(Number);
            const [lh, lm] = (range.latest || '23:59').split(':').map(Number);
            const earliestMinutes = eh * 60 + em;
            const latestMinutes = lh * 60 + lm;
            
            return checkinMinutes >= earliestMinutes && checkinMinutes <= latestMinutes;
        },
        
        calcLateDeduction(taskKey, dateStr, checkinTime) {
            const task = CONFIG.dailyTasks.find(t => t.key === taskKey);
            if (!task || !task.lateDeductions || !checkinTime) return null;
            
            const deadline = this.getDeadline(taskKey, dateStr);
            if (!deadline) return null;
            
            const [dh, dm] = deadline.split(':').map(Number);
            const [ch, cm] = checkinTime.split(':').map(Number);
            const deadlineMinutes = dh * 60 + dm;
            const checkinMinutes = ch * 60 + cm;
            const lateMinutes = checkinMinutes - deadlineMinutes;
            
            if (lateMinutes <= 0) return null;
            
            let deduction = null;
            for (const d of task.lateDeductions) {
                if (lateMinutes >= d.minutes) {
                    deduction = d;
                }
            }
            return deduction;
        },
        
        formatTime(timeStr) {
            if (!timeStr) return '--:--';
            return timeStr;
        },
        
        getCurrentTime() {
            const now = new Date();
            return `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
        }
    };


    // ============= èµ·åºŠè§„åˆ™ï¼šç»Ÿä¸€å£å¾„ï¼ˆå·¥ä½œæ—¥/å‘¨æœ«æˆªæ­¢æ—¶é—´ + å¯æ‰“å¡æ—¶é—´æ®µï¼‰ =============
    function getWakeUpPreview() {
        const base = (CONFIG.dailyTasks || []).find(t => t.key === 'wakeUp') || {};
        const custom = DB.get('wakeUpSettings', null) || {};

        const weekdayDeadline = custom.weekday || (base.deadlines ? base.deadlines.weekday : null) || '07:00';
        const weekendDeadline = custom.weekend || (base.deadlines ? base.deadlines.weekend : null) || '08:30';

        const defRange = (base.validTimeRange || {});
        const weekdayRange = (custom.validRange && custom.validRange.weekday) ? custom.validRange.weekday : (defRange.weekday || { earliest: '05:00', latest: '12:00' });
        const weekendRange = (custom.validRange && custom.validRange.weekend) ? custom.validRange.weekend : (defRange.weekend || { earliest: '05:00', latest: '12:00' });

        return {
            weekdayDeadline,
            weekendDeadline,
            weekdayRange: {
                earliest: weekdayRange.earliest || '05:00',
                latest: weekdayRange.latest || '12:00',
            },
            weekendRange: {
                earliest: weekendRange.earliest || '05:00',
                latest: weekendRange.latest || '12:00',
            }
        };
    }

    function editWakeUpSettingsModal() {
        const p = getWakeUpPreview();
        showModal(`
            <div class="card p-4 w-full max-w-md" onclick="event.stopPropagation()">
                <h3 class="text-lg font-bold mb-2">â° èµ·åºŠæ‰“å¡æ—¶é—´è§„åˆ™ï¼ˆå®¶é•¿è®¾ç½®ï¼‰</h3>
                <div class="text-xs text-gray-500 mb-4">å­©å­ç«¯ä¸å®¶é•¿ç«¯å°†æŒ‰æ­¤è§„åˆ™ä¸€è‡´æ ¡éªŒï¼šåœ¨â€œå¯æ‰“å¡æ—¶é—´æ®µâ€å¤–æ— æ³•æ‰“å¡ï¼›è¶…è¿‡â€œæˆªæ­¢æ—¶é—´â€å°†è‡ªåŠ¨åˆ¤å®šè¿Ÿåˆ°æ‰£åˆ†ã€‚</div>

                <div class="rounded-xl p-3 mb-3" style="background:#eff6ff">
                    <div class="font-bold text-gray-700 mb-2">å·¥ä½œæ—¥ï¼ˆå‘¨ä¸€â€”å‘¨äº”ï¼‰</div>
                    <div class="grid grid-cols-3 gap-2">
                        <div>
                            <div class="text-xs text-gray-500 mb-1">æœ€æ—©</div>
                            <input id="wkEarliest" type="time" class="w-full border rounded px-2 py-2" value="${p.weekdayRange.earliest}">
                        </div>
                        <div>
                            <div class="text-xs text-gray-500 mb-1">æˆªæ­¢</div>
                            <input id="wkDeadline" type="time" class="w-full border rounded px-2 py-2" value="${p.weekdayDeadline}">
                        </div>
                        <div>
                            <div class="text-xs text-gray-500 mb-1">æœ€æ™š</div>
                            <input id="wkLatest" type="time" class="w-full border rounded px-2 py-2" value="${p.weekdayRange.latest}">
                        </div>
                    </div>
                </div>

                <div class="rounded-xl p-3 mb-3" style="background:#fff7ed">
                    <div class="font-bold text-gray-700 mb-2">å‘¨æœ«ï¼ˆå‘¨å…­ã€å‘¨æ—¥ï¼‰</div>
                    <div class="grid grid-cols-3 gap-2">
                        <div>
                            <div class="text-xs text-gray-500 mb-1">æœ€æ—©</div>
                            <input id="weEarliest" type="time" class="w-full border rounded px-2 py-2" value="${p.weekendRange.earliest}">
                        </div>
                        <div>
                            <div class="text-xs text-gray-500 mb-1">æˆªæ­¢</div>
                            <input id="weDeadline" type="time" class="w-full border rounded px-2 py-2" value="${p.weekendDeadline}">
                        </div>
                        <div>
                            <div class="text-xs text-gray-500 mb-1">æœ€æ™š</div>
                            <input id="weLatest" type="time" class="w-full border rounded px-2 py-2" value="${p.weekendRange.latest}">
                        </div>
                    </div>
                </div>

                <div class="text-xs text-gray-400 mb-3">å»ºè®®ï¼šæœ€æ—©ä¸è¦æ—©äº 05:00ï¼Œæœ€æ™šä¸è¦æ™šäº 12:00ï¼Œé¿å…å‡Œæ™¨/æ·±å¤œå¼‚å¸¸æ‰“å¡ã€‚</div>

                <div class="flex space-x-3 mt-4">
                    <button onclick="hideModal()" class="flex-1 py-3 bg-gray-100 rounded-xl">å–æ¶ˆ</button>
                    <button onclick="saveWakeUpSettingsFromModal()" class="flex-1 py-3 btn-primary rounded-xl">ä¿å­˜</button>
                </div>
            </div>
        `);
    }

    function saveWakeUpSettingsFromModal() {
        const wkEarliest = document.getElementById('wkEarliest')?.value || '05:00';
        const wkDeadline = document.getElementById('wkDeadline')?.value || '07:00';
        const wkLatest = document.getElementById('wkLatest')?.value || '12:00';
        const weEarliest = document.getElementById('weEarliest')?.value || '05:00';
        const weDeadline = document.getElementById('weDeadline')?.value || '08:30';
        const weLatest = document.getElementById('weLatest')?.value || '12:00';

        showPwdModal('ä¿å­˜èµ·åºŠè§„åˆ™éœ€è¦å¯†ç ', () => {
            DB.set('wakeUpSettings', {
                weekday: wkDeadline,
                weekend: weDeadline,
                validRange: {
                    weekday: { earliest: wkEarliest, latest: wkLatest },
                    weekend: { earliest: weEarliest, latest: weLatest },
                }
            });
            hideModal();
            alert('âœ… èµ·åºŠæ‰“å¡è§„åˆ™å·²ä¿å­˜ï¼ˆå­©å­ç«¯/å®¶é•¿ç«¯ä¸€è‡´ç”Ÿæ•ˆï¼‰');
            render();
        });
    }

    // å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼ˆç”¨äºå¾®ä¿¡ç¾¤æ¶ˆæ¯æ¨¡æ¿ï¼‰
    async function copyToClipboard(text) {
        try {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                await navigator.clipboard.writeText(text);
                return true;
            }
        } catch (e) {}
        // fallback
        try {
            const ta = document.createElement('textarea');
            ta.value = text;
            ta.style.position = 'fixed';
            ta.style.left = '-9999px';
            document.body.appendChild(ta);
            ta.focus();
            ta.select();
            const ok = document.execCommand('copy');
            document.body.removeChild(ta);
            return ok;
        } catch (e) {
            return false;
        }
    }

    function copyWeChatEvidenceTemplate(subjectName) {
        const ds = State.date || DB.today();
        const note = document.getElementById('completionNote')?.value?.trim() || '';
        const extra = document.getElementById('completionEvidenceText')?.value?.trim() || '';
        const msg = `ã€ä»»åŠ¡å®Œæˆè¯æ®ã€‘\næ—¥æœŸï¼š${ds}\nä»»åŠ¡ï¼š${subjectName || ''}\nè¯´æ˜ï¼š${extra || '(æ— )'}\nè‡ªè¯„è¯´æ˜ï¼š${note || '(æ— )'}\nï¼ˆè¯·æŠŠç…§ç‰‡/è§†é¢‘å‘ç¾¤é‡Œï¼Œä¸Šé¢è¿™æ®µæ–‡å­—ä¸€èµ·å‘ï¼Œä¾¿äºå®¶é•¿æ£€ç´¢ï¼‰`;
        copyToClipboard(msg).then(ok => alert(ok ? 'âœ… å·²å¤åˆ¶ï¼Œå¯ç›´æ¥ç²˜è´´åˆ°å¾®ä¿¡ç¾¤' : 'å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶'));
    }

    // ==================== ç§¯åˆ†å¼•æ“ ====================
    const Engine = {
        dailyBase(r) {
            // A2æ¯æ—¥åŸºç¡€åˆ†ï¼šæœ€é«˜5åˆ†
            // å®Œæˆåº¦å£å¾„ï¼šdone=1ï¼Œpartial=0.5ï¼Œincomplete=0
            // 4é¡¹å…¨å®Œæˆ=5åˆ†ï¼›å®Œæˆåº¦>=3=3åˆ†ï¼›å®Œæˆåº¦>=2=1åˆ†ï¼›å¦åˆ™=0åˆ†
            // æ¯é¡¹æœªå®Œæˆé¢å¤–-1åˆ†ï¼ˆç”¨äºä½“ç°â€œç¼ºå£â€æƒ©ç½šï¼‰
            const tasks = ['wakeUp', 'homework', 'organize', 'chore'];
            const done = tasks.filter(t => r[t] === true || r[t] === 'done').length;
            const inc = tasks.filter(t => r[t] === false || r[t] === 'incomplete').length;
            const partial = tasks.filter(t => r[t] === 'partial').length;
            const equiv = done + partial * 0.5;

            let base = 0;
            if (done === 4) base = 5;
            else if (equiv >= 3) base = 3;
            else if (equiv >= 2) base = 1;

            return Math.max(0, base - inc);
        },
        a3Extra(r, w) {
            // è¿”å›å½“å¤©å½•å…¥çš„A3æ€»å’Œï¼ˆä¸å«å‘¨ä¸Šé™é™åˆ¶ï¼Œå‘¨ä¸Šé™åœ¨æ±‡æ€»æ—¶å¤„ç†ï¼‰
            // P0é—¨æ§›è§„åˆ™ï¼šå½“æ—¥A2åŸºç¡€åˆ†>=3æ—¶A3æ‰è®¡å…¥ï¼Œå¦åˆ™A3è®°å½•ä¿ç•™ä½†ä¸è®¡åˆ†
            const base = this.dailyBase(r);
            if (base < 3) return 0; // é—¨æ§›ï¼šå¿…åšè‡³å°‘å®Œæˆ3é¡¹ï¼ŒA3æ‰èƒ½è®¡å…¥
            const extra = (r.learningExtra||0) + (r.habitExtra||0) + (r.characterExtra||0) + (r.familyExtra||0) + (r.parentExtra||0);
            return extra;
        },
        // è®¡ç®—æŸå‘¨çš„A3æ€»åˆ†ï¼ˆå«å‘¨ä¸Šé™é™åˆ¶ï¼‰
        getWeekA3Capped(dateStr) {
            // ç»Ÿä¸€å£å¾„ï¼šA3â€œå‘¨ä¸Šé™â€æŒ‰å½“æœˆåˆ†æ®µå‘¨è®¡ç®—ï¼ˆ1-7 / 8-14 / 15-21 / 22-æœˆåº•ï¼Œä¸”æœ€å¤š4æ®µï¼‰
            // è¿™æ ·â€œæœ¬å‘¨A3â€ä¸æœˆåº¦ä½™é¢/ç»Ÿè®¡çš„åˆ†ç»„å£å¾„ä¸€è‡´ï¼Œé¿å…è·¨æœˆå‘¨å¯¼è‡´å¯¹è´¦ä¸ä¸€è‡´
            const daily = DB.get('daily', {});
            const [yStr, mStr, dStr] = dateStr.split('-');
            const y = parseInt(yStr, 10);
            const m = parseInt(mStr, 10);
            const day = parseInt(dStr, 10);

            const w = Math.min(Math.ceil(day / 7), 4);
            const limit = CONFIG.a3Limits[w] || 10;

            const daysInMonth = new Date(y, m, 0).getDate();
            const startDay = (w - 1) * 7 + 1;
            const endDay = (w === 4) ? daysInMonth : Math.min(w * 7, daysInMonth);

            let total = 0;
            for (let dd = startDay; dd <= endDay; dd++) {
                const dt = new Date(y, m - 1, dd);
                const ds = formatYMD(dt);
                const r = daily[ds];
                if (r) total += this.a3Extra(r, w);
            }
            return Math.min(total, limit); // åº”ç”¨å‘¨ä¸Šé™
        },
        calcTaskScore(t, type) {
            if (!t || !t.status || !t.confirmed) return 0;
            const scores = CONFIG.taskScores[type];
            const diff = t.difficulty || 1.0;
            if (t.status === 'done') return Math.round(scores.done * diff);
            if (t.status === 'partial') return Math.round(scores.partial * diff);
            if (t.status === 'incomplete') {
                // å¤„ç†è‡ªå®šä¹‰ç†ç”±
                if (t.incompleteReason === 'custom') {
                    const baseNeg = type === 'weekly' ? 1 : (type === 'monthly' ? 2 : (type === 'quarterly' ? 4 : 10));
                    return (t.customReasonPts || -2) * baseNeg;
                }
                const r = CONFIG.incompleteReasons.find(x => x.key === t.incompleteReason);
                const baseNeg = type === 'weekly' ? 1 : (type === 'monthly' ? 2 : (type === 'quarterly' ? 4 : 10));
                return r ? r.pts * baseNeg : -3 * baseNeg;
            }
            return 0;
        },
        getTasksTotal(type, periodKey) {
            const allTasks = DB.get('tasks', {});
            const key = `${type}_${periodKey}`;
            const taskData = allTasks[key] || {};
            let total = 0;
            CONFIG.subjects.forEach(sub => {
                const t = taskData[sub.key];
                if (t) total += this.calcTaskScore(t, type);
            });
            return total;
        },
        getTasksConfirmedInMonthTotal(type, ym) {
            // å°†å­£åº¦/å¹´åº¦ä»»åŠ¡çš„ç§¯åˆ†â€œè®°è´¦â€åˆ°ç¡®è®¤å‘ç”Ÿçš„æœˆä»½ï¼Œé¿å…åªåœ¨ä»»åŠ¡é¡µæ˜¾ç¤ºä½†ä¸å½±å“æœˆåº¦ç§¯åˆ†
            const allTasks = DB.get('tasks', {});
            let total = 0;
            Object.keys(allTasks).forEach(k => {
                if (!k.startsWith(type + '_')) return;
                const taskData = allTasks[k] || {};
                CONFIG.subjects.forEach(sub => {
                    const t = taskData[sub.key];
                    if (!t || !t.confirmed) return;
                    const c = (t.confirmedAtLocal || t.confirmedAt || '');
                    if (c.substring(0, 7) !== ym) return;
                    total += this.calcTaskScore(t, type);
                });
            });
            return total;
        },
        // ä½™é¢ï¼šè®¡ç®—åˆ°æŸæœˆ(ä¸å«è¯¥æœˆ)ä¸ºæ­¢çš„ç´¯è®¡ç§¯åˆ†ï¼ˆè·¨å¹´è‡ªåŠ¨ç»“è½¬ï¼Œä¸ä¾èµ–æœˆç»“ç®—ï¼‰
        balanceUntilMonth(ym) {
            const monthStart = `${ym}-01`;
            let bal = DB.get('initialBalance', 0);
            const daily = DB.get('daily', {});
            const exemptions = DB.get('exemptions', {});
            const emotionCards = DB.get('emotionCards', {});
            const remedies = DB.get('remedies', []);
            const milestoneBonuses = (DB.get('milestoneBonuses', []) || []);
            const redemptions = DB.get('redemptions', []);
            const allTasks = DB.get('tasks', {});

            // æŒ‰æœˆ-å‘¨åˆ†ç»„è®¡ç®—A3ï¼ˆåº”ç”¨å‘¨ä¸Šé™ï¼‰
            const a3ByMonthWeek = {};
            Object.entries(daily).forEach(([date, r]) => {
                if (!r || !r.confirmed || date >= monthStart) return;
                bal += this.dailyBase(r);
                bal -= (r.deduction || 0);
                // A3åˆ†ç»„åˆ°æœˆ-å‘¨
                const m = date.substring(0, 7);
                const w = Math.min(Math.ceil(parseInt(date.split('-')[2]) / 7), 4);
                const key = `${m}-W${w}`;
                if (!a3ByMonthWeek[key]) a3ByMonthWeek[key] = { total: 0, w };
                a3ByMonthWeek[key].total += this.a3Extra(r, w);
            });
            // æ¯å‘¨åº”ç”¨ä¸Šé™åç´¯åŠ 
            Object.values(a3ByMonthWeek).forEach(wk => {
                const limit = CONFIG.a3Limits[wk.w] || 10;
                bal += Math.min(wk.total, limit);
            });

            // é‡Œç¨‹ç¢‘å¥–åŠ±ï¼ˆå·²ç¡®è®¤ï¼‰
            milestoneBonuses.forEach(b => {
                if (b && b.confirmed && b.date && b.date < monthStart) bal += (b.points || 0);
            });

            // ä»»åŠ¡ï¼ˆæŒ‰ç¡®è®¤å‘ç”Ÿçš„æ—¥æœŸè®°è´¦ï¼Œæ”¯æŒè·¨æœˆ/è·¨å¹´ï¼‰
            Object.entries(allTasks).forEach(([k, taskData]) => {
                const type = (k || '').split('_')[0];
                if (!['weekly','monthly','quarterly','yearly'].includes(type)) return;
                CONFIG.subjects.forEach(sub => {
                    const t = taskData?.[sub.key];
                    if (!t || !t.confirmed || !t.confirmedAt) return;
                    if (t.confirmedAt < monthStart) bal += this.calcTaskScore(t, type);
                });
            });

            // å…æ‰£/è¿”è¿˜ï¼ˆæŒ‰æœˆï¼‰
            Object.entries(exemptions).forEach(([k, ex]) => {
                if (k < ym && ex?.confirmed) bal += (ex.value || 0);
            });
            Object.entries(emotionCards).forEach(([k, ec]) => {
                if (k < ym && ec?.confirmed && ec.refundPoints) bal += (ec.refundPoints || 0);
            });
            remedies.forEach(r => {
                if (r?.confirmed && r.date && r.date < monthStart) bal += (r.refundPoints || 0);
            });

            // å…‘æ¢ï¼ˆå·²ç¡®è®¤æ‰£é™¤ï¼‰
            redemptions.forEach(r => {
                if (r?.confirmed && r.date && r.date < monthStart) bal -= (r.pts || 0);
            });
            return bal;
        },

        summary(ym) {
            const daily = DB.get('daily', {});
            const redemptions = DB.get('redemptions', []);
            const exemptions = DB.get('exemptions', {});
            const emotionCards = DB.get('emotionCards', {});
            const remedies = DB.get('remedies', []);            const opening = this.balanceUntilMonth(ym);
            let a1 = 0;
            for (let w = 1; w <= 4; w++) { a1 += this.getTasksTotal('weekly', `${ym}-W${w}`); }
            
            const milestoneBonuses = (DB.get('milestoneBonuses', [])||[])
                .filter(b=>b.confirmed && b.date && b.date.startsWith(ym))
                .reduce((s,b)=>s+(b.points||0),0);
            
            // A2å’ŒDé€æ—¥è®¡ç®—ï¼ŒA3æŒ‰å‘¨è®¡ç®—ï¼ˆåº”ç”¨å‘¨ä¸Šé™ï¼‰
            let a2 = 0, d = 0;
            let weekA3 = {1:0, 2:0, 3:0, 4:0}; // æ¯å‘¨A3åŸå§‹ç´¯è®¡
            Object.entries(daily).forEach(([date, r]) => {
                if (date.startsWith(ym) && r.confirmed) {
                    a2 += this.dailyBase(r);
                    const w = Math.min(Math.ceil(parseInt(date.split('-')[2]) / 7), 4);
                    weekA3[w] += this.a3Extra(r, w);
                    d += (r.deduction || 0);
                }
            });
            // æ¯å‘¨åº”ç”¨ä¸Šé™åç´¯åŠ 
            let a3 = 0;
            for (let w = 1; w <= 4; w++) {
                const limit = CONFIG.a3Limits[w] || 10;
                a3 += Math.min(weekA3[w], limit);
            }
            
            const ex = exemptions[ym];
            const b = (ex?.confirmed) ? (ex.value || 0) : 0;
            const ec = emotionCards[ym];
            const emotionRefund = (ec?.confirmed && ec.refundPoints) ? ec.refundPoints : 0;
            let remedyRefund = 0;
            remedies.filter(r => r.date?.startsWith(ym) && r.confirmed).forEach(r => { remedyRefund += r.refundPoints || 0; });
            let e = 0;
            redemptions.filter(r => r.confirmed && r.date?.startsWith(ym)).forEach(r => { e += r.pts; });
            
            const closing = opening + a1 + milestoneBonuses + a2 + a3 + b + emotionRefund + remedyRefund - d - e;
            return { ym, opening, a1, milestoneBonuses, a2, a3, b, emotionRefund, remedyRefund, d, e, closing };
        },
        prevMonth(ym) {
            const [y, m] = ym.split('-').map(Number);
            const d = new Date(y, m - 2, 1);
            return d.toISOString().substring(0, 7);
        },
        total() { return this.summary(DB.month()).closing; },
        // è·å–å¹´åº¦å·²ç”¨é¢åº¦
        getYearlyUsed() {
            const year = DB.year();
            const redemptions = DB.get('redemptions', []);
            let used = 0;
            redemptions
                .filter(r => r && r.confirmed)
                .forEach(r => {
                    // quotaYear ä¼˜å…ˆï¼›å¦åˆ™å…¼å®¹æ—§æ•°æ®ï¼šnextYear ä¸è®¡å…¥æœ¬å¹´
                    const qy = (r.quotaYear !== undefined && r.quotaYear !== null) ? Number(r.quotaYear) : null;
                    const dy = r.date ? Number(String(r.date).substring(0,4)) : null;
                    const quotaYear = qy || (r.quotaStrategy === 'nextYear' ? (dy ? dy + 1 : null) : dy);
                    if (quotaYear === year) used += (r.pts || 0);
                });
            return used;
        },
        checkRedemption(catKey, date) {
            const redemptions = DB.get('redemptions', []).filter(r => r.confirmed);
            const cat = CONFIG.redemptionCats.find(c => c.key === catKey);
            if (!cat) return { ok: true };
            const [y, m, day] = date.split('-').map(Number);
            const dateObj = new Date(y, m - 1, day);
            let count = 0;
            
            if (cat.freq === 'daily') {
                count = redemptions.filter(r => r.category === catKey && r.date === date).length;
            } else if (cat.freq === 'weekly') {
                const ws = new Date(y, m - 1, day - dateObj.getDay()).getTime();
                count = redemptions.filter(r => {
                    if (r.category !== catKey) return false;
                    const rd = parseDateLocal(r.date);
                    return new Date(rd.getFullYear(), rd.getMonth(), rd.getDate() - rd.getDay()).getTime() === ws;
                }).length;
            } else if (cat.freq === 'biweekly') {
                const bw = Math.floor((day - 1) / 14);
                count = redemptions.filter(r => {
                    if (r.category !== catKey) return false;
                    const [ry, rm, rd] = r.date.split('-').map(Number);
                    return ry === y && rm === m && Math.floor((rd - 1) / 14) === bw;
                }).length;
            } else if (cat.freq === 'monthly') {
                count = redemptions.filter(r => r.category === catKey && r.date.startsWith(`${y}-${String(m).padStart(2,'0')}`)).length;
            } else if (cat.freq === 'quarterly') {
                const q = Math.floor((m - 1) / 3) + 1;
                count = redemptions.filter(r => {
                    if (r.category !== catKey) return false;
                    const [ry, rm] = r.date.split('-').map(Number);
                    return ry === y && Math.floor((rm - 1) / 3) + 1 === q;
                }).length;
            } else if (cat.freq === 'yearly') {
                count = redemptions.filter(r => r.category === catKey && r.date.startsWith(String(y))).length;
            }
            
            if (count >= 1) return { ok: false, reason: `å·²å…‘æ¢` };
            if (cat.exclusive) {
                const exCat = CONFIG.redemptionCats.find(c => c.key === cat.exclusive);
                if (exCat && cat.freq === 'weekly') {
                    const ws = new Date(y, m - 1, day - dateObj.getDay()).getTime();
                    const exCount = redemptions.filter(r => {
                        if (r.category !== cat.exclusive) return false;
                        const rd = parseDateLocal(r.date);
                        return new Date(rd.getFullYear(), rd.getMonth(), rd.getDate() - rd.getDay()).getTime() === ws;
                    }).length;
                    if (exCount > 0) return { ok: false, reason: 'æœ¬å‘¨å·²é€‰' + exCat.name };
                }
            }
            return { ok: true };
        }
    };

    // ==================== çŠ¶æ€ ====================
    const State = {
        role: DB.get('role', null),
        tab: 'daily',
        date: DB.today(),
        week: DB.week(),
        expanded: {},
        taskTab: 'weekly',
    };

    
    function isParent(){ return State.role === 'parent'; }
    function requireParent(msg='ä»…å®¶é•¿å¯æ“ä½œ'){ if(!isParent()){ alert(msg); return false; } return true; }

  // å®‰å…¨è°ƒç”¨ï¼šé¿å…æŒ‰é’®â€œç‚¹äº†æ²¡ååº”â€ï¼ˆå‡½æ•°æœªå®šä¹‰/è¿è¡ŒæŠ¥é”™æ—¶ç»™å‡ºæ˜ç¡®æç¤ºï¼‰
  function safeCall(fnName, ...args){
      try{
          const fn = window[fnName];
          if (typeof fn !== 'function'){
              alert(`âŒ åŠŸèƒ½æœªåŠ è½½ï¼š${fnName}\n\nè¯·åˆ·æ–°é¡µé¢ï¼›è‹¥ä»ä¸è¡Œï¼Œè¯·æ‰“å¼€å¼€å‘è€…å·¥å…·(Console)æŸ¥çœ‹æŠ¥é”™ã€‚`);
              return;
          }
          return fn(...args);
      }catch(e){
          console.error(e);
          alert(`âŒ æ“ä½œå¤±è´¥ï¼š${fnName}\n\n${e && e.message ? e.message : e}`);
      }
  }
// ==================== æ¨¡æ€æ¡† ====================
    let _modalOpen = false;
    let _modalPushed = false;

    
    let _modalStack = [];
    function closeTopModal(){
        if (_modalStack.length>0) {
            hideModal(false,{stackPop:true,skipHistory:true});
        } else {
            hideModal();
        }
    }
function showModal(html, opts) {
    const options = (opts && typeof opts === 'object') ? opts : { pushHistory: opts !== false };
    const stack = options.stack === true;

    // æ ˆå¼å¼¹çª—ï¼šæŠŠå½“å‰å¼¹çª—å†…å®¹å‹æ ˆï¼ˆç”¨äºâ€œé¢„è§ˆ â†’ è¿”å›è¯„å®šâ€ï¼‰
    if (stack && document.getElementById('modal').innerHTML) {
        _modalStack.push({
            html: document.getElementById('modal').innerHTML,
            pushed: _modalPushed,
            open: _modalOpen
        });
    }

    // æ ˆå¼å¼¹çª—ä¸å† pushHistoryï¼ˆé¿å… iOS / WebView é€€å›å¯¼è‡´é€€å‡ºé¡µé¢ï¼‰
    const pushHistory = (options.pushHistory !== false) && !stack;
    const showClose = options.showClose !== false;

    const closeBtn = showClose ? `
        <button class="modal-close" type="button" aria-label="å…³é—­" onclick="closeTopModal()">
            âœ•
        </button>` : '';

    // overlay ç‚¹å‡»å…³é—­ï¼šæ ˆé¡¶åˆ™è¿”å›ä¸Šä¸€å±‚ï¼Œå¦åˆ™å…³é—­å¼¹çª—
    document.getElementById('modal').innerHTML =
        `<div class="modal-overlay" onclick="event.target===this&&closeTopModal()">${closeBtn}${html}</div>`;

    document.body.classList.add('modal-open');
    _modalOpen = true;

    if (pushHistory && !_modalPushed) {
        try {
            history.pushState({ __modal: true }, '', location.href);
            _modalPushed = true;
        } catch (e) {
            // æŸäº›ç¯å¢ƒ pushState å¯èƒ½å¤±è´¥ï¼šå¿½ç•¥å³å¯
        }
    }
}

function hideModal(fromPopstate = false, opts) {
    const options = (opts && typeof opts === 'object') ? opts : {};
    const skipHistory = options.skipHistory === true;
    const stackPop = options.stackPop === true;
    const forceClose = options.force === true;

    // å…³é—­å‰ç½®æ‹¦æˆªï¼šç”¨äºâ€œæœªä¿å­˜ä¿®æ”¹â€æç¤ºç­‰ï¼ˆä¸å½±å“æ ˆé¡¶é¢„è§ˆå±‚å…³é—­ï¼‰
    if (!fromPopstate && !stackPop && !forceClose && window.__modalCtx && typeof window.__modalCtx.beforeClose === 'function') {
        try {
            const ok = window.__modalCtx.beforeClose();
            if (ok === false) return;
        } catch (e) { /* ignore */ }
    }


    // å¦‚æœæ˜¯å…³é—­â€œé¢„è§ˆå±‚â€ç­‰æ ˆé¡¶å¼¹çª—ï¼šæ¢å¤ä¸Šä¸€å±‚å¼¹çª—å†…å®¹
    if (stackPop && _modalStack.length > 0) {
        const prev = _modalStack.pop();
        document.getElementById('modal').innerHTML = prev.html || '';
        document.body.classList.add('modal-open');
        _modalOpen = true;
        // æ ˆå¼å¼¹çª—ä¸æ”¹å˜ history çŠ¶æ€
        return;
    }

    // å…³é—­ä¸»å¼¹çª—ï¼šæ¸…ç©ºæ ˆ
    _modalStack = [];

    document.getElementById('modal').innerHTML = '';
    // å…³é—­ä»»ä½•ä¸»å¼¹çª—åæ¸…ç†ä¸Šä¸‹æ–‡
    if (!stackPop) { try { clearModalContext(); } catch(e){} }

    document.body.classList.remove('modal-open');
    _modalOpen = false;

    if (_modalPushed) {
        // ç”±å¼¹çª—è‡ªå·±è§¦å‘çš„å…³é—­ï¼šé»˜è®¤å›é€€ä¸€æ­¥ä»¥æ¢å¤å¼¹çª—å‰ç•Œé¢çŠ¶æ€ï¼›
        // ä½†åœ¨æŸäº›ç¯å¢ƒä¸‹ history.back() å¯èƒ½ç›´æ¥é€€å‡º/é—ªé€€ï¼Œå› æ­¤å¢åŠ ä¸¥æ ¼åˆ¤å®šä¸å…œåº•ã€‚
        if (!fromPopstate && !skipHistory) {
            _modalPushed = false;
            try {
                // åªæœ‰å½“å½“å‰ history.state ç¡®è®¤æ˜¯æˆ‘ä»¬æ¨å…¥çš„ modal çŠ¶æ€æ—¶ï¼Œæ‰å…è®¸ back
                if (history.state && history.state.__modal) {
                    history.back();
                } else {
                    // å…œåº•ï¼šä¸å›é€€ï¼Œåªæ¸…ç†çŠ¶æ€ï¼Œé¿å…ç¦»å¼€é¡µé¢
                    history.replaceState(null, '', location.href);
                }
            } catch (e) {
                // å…œåº•ï¼šä¸åš history æ“ä½œ
            }
            return;
        }
        _modalPushed = false;
    }
}
// ==================== å¼¹çª—ä¸Šä¸‹æ–‡ï¼ˆæœªä¿å­˜ä¿®æ”¹æ‹¦æˆª / è¯„å®šè”åŠ¨ / å®¡è®¡æ—¥å¿—ï¼‰ ====================
window.__modalCtx = null;

function setModalContext(ctx){
    window.__modalCtx = ctx || null;
}

function clearModalContext(){
    window.__modalCtx = null;
}

function setModalDirty(dirty){
    if (!window.__modalCtx) return;
    window.__modalCtx.dirty = !!dirty;
}

// è¯„å®šå¼¹çª—ï¼šåˆå§‹åŒ–è”åŠ¨ã€è„æ•°æ®è·Ÿè¸ªã€æç¤ºæ–‡æ¡ˆ
function initEvalModalContext(cfg){
    const ctx = {
        type: 'eval',
        dirty: false,
        data: cfg || {},
        beforeClose: function(){
            if (!this.dirty) return true;
            return confirm('ä½ æœ‰æœªæäº¤çš„ä¿®æ”¹ï¼Œç¡®å®šè¦å…³é—­å¹¶æ”¾å¼ƒå—ï¼Ÿ');
        }
    };
    setModalContext(ctx);

    const markDirty = () => setModalDirty(true);
    ['evalStatus','evalReason','evalNote'].forEach(id=>{
        const el = document.getElementById(id);
        if (el) {
            el.addEventListener('change', markDirty);
            el.addEventListener('input', markDirty);
        }
    });

    // åˆå§‹åŒ–ä¸€æ¬¡è”åŠ¨ä¸æç¤º
    try { toggleEvalReason(); } catch(e){}
    try { updateEvalScoreHint(); } catch(e){}
}

function appendEvalNote(text){
    const el = document.getElementById('evalNote');
    if(!el) return;
    const val = (el.value || '').trim();
    el.value = val ? (val + (val.endsWith('ã€‚') || val.endsWith('.') ? '' : 'ã€‚') + text) : text;
    el.dispatchEvent(new Event('input'));
}

// è®¡ç®—å¹¶å±•ç¤ºâ€œæœ¬æ¬¡é¢„è®¡ç§¯åˆ†/æ‰£åˆ†â€
function updateEvalScoreHint(){
    const hintEl = document.getElementById('evalScoreHint');
    const statusEl = document.getElementById('evalStatus');
    if(!hintEl || !statusEl) return;

    const status = statusEl.value;
    const cfg = (window.__modalCtx && window.__modalCtx.type==='eval') ? (window.__modalCtx.data || {}) : {};
    const diff = Number(cfg.difficulty || 1) || 1;
    const baseDone = Number(cfg.baseDone || 0) || 0;
    const basePartial = Number(cfg.basePartial || 0) || 0;

    let text = '';
    if(status === 'done'){
        const pts = Math.round(baseDone * diff);
        text = `æœ¬æ¬¡é¢„è®¡ç§¯åˆ†ï¼š+${pts}ï¼ˆéš¾åº¦ç³»æ•° ${diff.toFixed(2)}ï¼‰`;
    } else if(status === 'partial'){
        const pts = Math.round(basePartial * diff);
        text = `æœ¬æ¬¡é¢„è®¡ç§¯åˆ†ï¼š+${pts}ï¼ˆéš¾åº¦ç³»æ•° ${diff.toFixed(2)}ï¼‰`;
    } else if(status === 'incomplete'){
        const reasonEl = document.getElementById('evalReason');
        const opt = reasonEl ? reasonEl.options[reasonEl.selectedIndex] : null;
        const label = opt ? (opt.textContent || '') : '';
        const m = label.match(/\((-?\d+)\)/);
        const pts = m ? Number(m[1]) : 0;
        const sign = pts>0?'+':'';
        text = `æœ¬æ¬¡æ‰£åˆ†ï¼š${sign}${pts}ï¼ˆè¯·é€‰æ‹©åŸå› ï¼‰`;
        const wrap = document.getElementById('evalReasonWrap');
        if (wrap) wrap.classList.remove('hidden');
    }
    hintEl.textContent = text;
}


// ESC å…³é—­ï¼ˆä¼˜å…ˆå…³é—­æ ˆé¡¶é¢„è§ˆå±‚ï¼‰
window.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && _modalOpen) {
        closeTopModal();
    }
});

// æµè§ˆå™¨â€œåé€€/è¿”å›â€å…³é—­å¼¹çª—ï¼ˆå…³é—­ä¸»å¼¹çª—ï¼‰
window.addEventListener('popstate', () => {
    if (_modalOpen) {
        hideModal(true, { skipHistory: true });
    }
});

    function showPwdModal(title, cb) {
        // ä»¥â€œæ ˆå¼å¼¹çª—â€æ‰“å¼€ï¼šä¸ pushStateï¼Œä¸è§¦å‘ history.backï¼Œå…³é—­åå¯å›åˆ°ä¸Šä¸€å±‚
        window._pwdCb = cb;
        showModal(`
            <div class="card p-6 w-80" onclick="event.stopPropagation()">
                <h3 class="text-lg font-bold text-center mb-4">ğŸ” ${title}</h3>
                <input type="password" id="pwdInput" class="w-full border rounded-xl px-4 py-3 mb-4" placeholder="å¯†ç " autofocus
                       onkeyup="if(event.key==='Enter')verifyPwd()">
                <div class="flex space-x-3">
                    <button onclick="closeTopModal()" class="flex-1 py-3 bg-gray-100 rounded-xl font-medium">å–æ¶ˆ</button>
                    <button onclick="verifyPwd()" class="flex-1 py-3 btn-primary rounded-xl font-medium">ç¡®è®¤</button>
                </div>
                <p class="text-xs text-gray-400 text-center mt-3">é»˜è®¤: 123456</p>
            </div>
        `, { stack: true, pushHistory: false, showClose: false });
        setTimeout(() => document.getElementById('pwdInput')?.focus(), 80);
    }

    function verifyPwd() {
        const input = (document.getElementById('pwdInput')?.value || '');
        const ok = (input === DB.pwd());
        if (!ok) { alert('âŒ å¯†ç é”™è¯¯'); return; }

        // å…³é—­â€œå¯†ç å±‚â€ä¸èµ° history.backï¼ˆç”¨æ ˆé¡¶å…³é—­ï¼‰
        closeTopModal();

        // æ‰§è¡Œå›è°ƒï¼šç”¨ try/catch é˜²æ­¢é™é»˜å¤±è´¥
        const cb = window._pwdCb;
        window._pwdCb = null;
        if (typeof cb === 'function') {
            setTimeout(() => {
                try { cb(); }
                catch (e) {
                    console.error('PWD callback error:', e);
                    alert('âš ï¸ æ“ä½œå¤±è´¥ï¼š' + (e?.message || e));
                }
            }, 0);
        }
    }
    // ==================== éš¾åº¦é‡åŒ–å·¥å…·ï¼ˆæŒ‰ç±»å‹è‡ªåŠ¨å»ºè®®ï¼‰ ====================
    function clamp(n, a, b) { return Math.max(a, Math.min(b, n)); }

    // è§£æ YYYY-MM-DD ä¸ºæœ¬åœ°æ—¥æœŸï¼ˆé¿å…æµè§ˆå™¨æŒ‰ UTC è§£æå¯¼è‡´çš„è·¨æ—¥/è·¨å‘¨åç§»ï¼‰
    function parseDateLocal(ymd) {
        if (!ymd) return new Date(NaN);
        if (typeof ymd === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(ymd)) {
            return new Date(ymd + 'T00:00:00');
        }
        return new Date(ymd);
    }

    function formatYMD(d) {
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        return `${y}-${m}-${day}`;
    }
    function nearestDifficulty(v) {
        const ds = CONFIG.difficulties.map(d => d.v).sort((a,b)=>a-b);
        let best = ds[0], bestGap = Math.abs(v - best);
        ds.forEach(x => { const g = Math.abs(v - x); if (g < bestGap) { best = x; bestGap = g; } });
        return best;
    }
    function getFactor(cfgArr, key, fallbackKey) {
        const arr = cfgArr || [];
        if (!arr.length) return { key: fallbackKey || '', label: '', coeff: 1.0, hint: '' };
        const found = arr.find(x => x.key === key) || arr.find(x => x.key === fallbackKey) || arr[0];
        return found || { key: fallbackKey || '', label: '', coeff: 1.0, hint: '' };
    }

    function calcDifficultyModel(typeKey, durKey, eviKey, novKey) {
        const t = getFactor(CONFIG.taskTypes, typeKey, 'practice');
        const d = getFactor(CONFIG.durationFactors, durKey, 'm15_30');
        const e = getFactor(CONFIG.evidenceFactors, eviKey, 'oral');
        const n = getFactor(CONFIG.noveltyFactors, novKey, 'normal');

        const raw = (t.coeff || 1.0) * (d.coeff || 1.0) * (e.coeff || 1.0) * (n.coeff || 1.0);
        const clamped = clamp(raw, 1.0, 3.0);
        const nd = nearestDifficulty(clamped);

        const parts = [
            `ç±»å‹ ${t.coeff.toFixed(2)}`,
            `æ—¶é•¿ ${d.coeff.toFixed(2)}`,
            `è¯æ® ${e.coeff.toFixed(2)}`,
            `æ–°é¢–åº¦ ${n.coeff.toFixed(2)}`
        ].join(' Ã— ');

        const detail = `${parts} = ${raw.toFixed(2)}ï¼Œå°é¡¶å ${clamped.toFixed(2)} â†’ å»ºè®®æ¡£ä½ Ã—${nd}`;
        const hints = `ç±»å‹ï¼š${t.hint || t.label}ï¼›æ—¶é•¿ï¼š${d.hint || d.label}ï¼›è¯æ®ï¼š${e.hint || e.label}ï¼›æ–°é¢–åº¦ï¼š${n.hint || n.label}`;

        return { type: t, dur: d, evi: e, nov: n, raw, clamped, nd, detail, hints };
    }

    // å…¼å®¹æ—§è°ƒç”¨ï¼šä»ç”¨ applyTaskTypeToDiff(typeSelId, diffSelId, hintId)
    // è‹¥å­˜åœ¨åŒåå‰ç¼€çš„ Dur/Evi/Nov é€‰æ‹©å™¨ï¼Œåˆ™æŒ‰â€œå››å› å­æ¨¡å‹â€è®¡ç®—å»ºè®®ï¼›å¦åˆ™åªæŒ‰ç±»å‹å»ºè®®ã€‚
    function applyTaskTypeToDiff(typeSelId, diffSelId, hintId) {
        const typeKey = document.getElementById(typeSelId)?.value;
        const durSelId = typeSelId.replace('Type', 'Dur');
        const eviSelId = typeSelId.replace('Type', 'Evi');
        const novSelId = typeSelId.replace('Type', 'Nov');

        const durKey = document.getElementById(durSelId)?.value;
        const eviKey = document.getElementById(eviSelId)?.value;
        const novKey = document.getElementById(novSelId)?.value;

        // è‹¥å››å› å­æ§ä»¶ä¸å­˜åœ¨ï¼Œåˆ™é€€åŒ–ä¸ºâ€œä»…ç±»å‹â€
        const has4 = !!(document.getElementById(durSelId) && document.getElementById(eviSelId) && document.getElementById(novSelId));
        const model = has4
            ? calcDifficultyModel(typeKey, durKey, eviKey, novKey)
            : calcDifficultyModel(typeKey, 'm15_30', 'oral', 'normal');

        const diffEl = document.getElementById(diffSelId);
        if (diffEl) diffEl.value = String(model.nd);

        const hintEl = document.getElementById(hintId);
        if (hintEl) {
            // ç”¨ innerHTML ä¾¿äºä¸¤è¡Œå±•ç¤º
            hintEl.innerHTML = `å»ºè®®ï¼š${model.detail}<br><span class="text-gray-500">${model.hints}</span>`;
        }
    }

    // ==================== æ¸²æŸ“ ====================

    function render() {
        const app = document.getElementById('app');
        if (!State.role) { app.innerHTML = renderRoleSelect(); }
        else { app.innerHTML = renderHeader() + renderContent() + renderTabBar(); }
    
        updatePendingBadge();
    }

    function renderRoleSelect() {
        const childName = DB.get('childName', '');
        const age = DB.getChildAge();
        return `
        <div class="min-h-screen flex flex-col items-center justify-center p-6" style="background:linear-gradient(135deg,#1a365d 0%,#3b82f6 100%)">
            <div class="text-center text-white mb-10">
                <div class="text-6xl mb-4">â­</div>
                <h1 class="text-3xl font-bold mb-2">å®¶åº­æˆé•¿ç§¯åˆ†</h1>
                <p class="text-blue-200">è®°å½•åŠªåŠ›ï¼Œåº†ç¥è¿›æ­¥</p>
                ${childName ? `<p class="text-yellow-300 mt-2">${childName} ${age !== null ? `(${age}å²)` : ''}</p>` : ''}
                <p class="text-blue-300 text-xs mt-2">v${VERSION}</p>
            </div>
            <div class="w-full max-w-sm space-y-4">
                <button onclick="selectRole('child')" class="w-full card p-5 flex items-center space-x-4 active:scale-95 transition">
                    <div class="w-14 h-14 bg-amber-100 rounded-full flex items-center justify-center text-2xl">ğŸ‘¦</div>
                    <div class="text-left"><div class="text-lg font-bold">æˆ‘æ˜¯å­©å­</div><div class="text-gray-500 text-sm">æ‰“å¡ã€ç”³è¯·ä»»åŠ¡ã€ç”³è¯·å…‘æ¢</div></div>
                </button>
                <button onclick="selectRole('parent')" class="w-full card p-5 flex items-center space-x-4 active:scale-95 transition">
                    <div class="w-14 h-14 bg-blue-100 rounded-full flex items-center justify-center text-2xl">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§</div>
                    <div class="text-left"><div class="text-lg font-bold">æˆ‘æ˜¯å®¶é•¿</div><div class="text-gray-500 text-sm">å®¡æ ¸ã€è®¾ç½®ã€ç®¡ç†è§„åˆ™</div></div>
                </button>
            </div>
            <button onclick="showSyncModal()" class="mt-8 text-white/70 text-sm underline">ğŸ”„ æ•°æ®åŒæ­¥</button>
        </div>`;
    }

    function selectRole(role) {
        if (role === 'parent') {
            showPwdModal('è¯·è¾“å…¥å®¶é•¿å¯†ç ', () => { State.role = 'parent'; DB.set('role', 'parent'); render(); });
        } else { State.role = 'child'; DB.set('role', 'child'); render(); }
    }

    function switchRole() { State.role = null; DB.set('role', null); render(); }

    function renderHeader() {
        const pts = Engine.total();
        const pending = getPendingCount();
        const unreadNotifs = getUnreadNotifCount();
        const emoji = State.role === 'parent' ? 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§' : 'ğŸ‘¦';
        const childName = DB.get('childName', '');
        const age = DB.getChildAge();
        return `
        <header class="sticky top-0 z-40 px-4 py-3" style="background:linear-gradient(135deg,#1a365d 0%,#2d4a7c 100%)">
            <div class="flex items-center justify-between text-white">
                <div class="flex items-center space-x-2">
                    <span class="text-2xl">${emoji}</span>
                    <div>
                        <div class="font-medium text-sm">${State.role === 'parent' ? 'å®¶é•¿' : (childName || 'å­©å­')}ç«¯</div>
                        <div class="text-xs text-blue-200">ç¬¬${DB.week()}å‘¨ ${age !== null ? `Â· ${age}å²` : ''}</div>
                    </div>
                </div>
                <button onclick="showPointsLedger()" class="flex items-center space-x-1 bg-white/20 rounded-full px-4 py-1 hover:bg-white/25 active:bg-white/30" title="æŸ¥çœ‹ç§¯åˆ†å˜åŠ¨æ˜ç»†">
                    <span class="text-yellow-300 text-xl">â­</span>
                    <span class="font-bold text-2xl">${pts}</span>
                    <span class="text-xs text-blue-100/80 ml-1">æ˜ç»†</span>
                </button>
                <div class="flex items-center space-x-2">
                    <button onclick="showNotifications()" class="relative text-white/80 text-xs px-2 py-1 bg-white/10 rounded">ğŸ””${unreadNotifs > 0 ? `<span class="absolute -top-1 -right-1 bg-red-500 text-white text-xs w-4 h-4 rounded-full flex items-center justify-center">${unreadNotifs > 9 ? '9+' : unreadNotifs}</span>` : ''}</button>
                    ${State.role === 'parent' && pending > 0 ? `<button onclick="showPending()" class="bg-red-500 px-2 py-1 rounded text-xs font-bold pending-pulse">å¾…å®¡${pending}</button>` : ''}
                    <button onclick="showSyncModal()" class="text-white/80 text-xs px-2 py-1 bg-white/10 rounded">ğŸ”„</button>
                    <button onclick="switchRole()" class="text-white/80 text-xs px-2 py-1 bg-white/10 rounded">åˆ‡æ¢</button>
                </div>
            </div>
        </header>`;
    }

    function getPendingCount() {
        let c = 0;
        c += Object.values(DB.get('daily', {})).filter(r => r.submitted && !r.confirmed).length;
        c += DB.get('redemptions', []).filter(r => !r.confirmed && !r.rejected).length;
        c += DB.get('taskRequests', []).filter(r => !r.resolved).length;
        c += DB.get('appeals', []).filter(a => !a.resolved).length;
        c += DB.get('remedies', []).filter(r => !r.confirmed && !r.rejected).length;
        c += DB.get('catChildReqs', []).filter(r => !r.resolved).length;
        // ç»Ÿè®¡å°å­©æäº¤çš„ä»»åŠ¡å®ŒæˆæŠ¥å‘Šï¼ˆå¾…å®¶é•¿è¯„å®šï¼‰
        const allTasks = DB.get('tasks', {});
        Object.values(allTasks).forEach(taskData => {
            Object.values(taskData).forEach(t => {
                if (t.childSubmitted && !t.confirmed) c++;
            });
        });
        return c;
    }

    
    function updatePendingBadge() {
        try {
            const pending = getPendingCount();
            const btn = document.querySelector('button[onclick="showPending()"]');
            if (btn) {
                if (pending > 0) {
                    btn.style.display = '';
                    btn.textContent = `å¾…å®¡${pending}`;
                } else {
                    btn.remove();
                }
            }
        } catch (e) { /* ignore */ }
    }

// ==================== é€šçŸ¥ç³»ç»Ÿ ====================
    function getUnreadNotifCount() {
        const notifs = DB.get('notifications', []);
        const lastRead = DB.get('lastReadNotif_' + State.role, 0);
        return notifs.filter(n => new Date(n.time).getTime() > lastRead).length;
    }

    // approved æ”¯æŒä¸‰æ€ï¼štrue/'positive'(ç»¿), 'neutral'(é»„), false/'negative'(çº¢)
    function addNotification(type, title, content, approved, reason = '') {
        const notifs = DB.get('notifications', []);
        // ç»Ÿä¸€è½¬æ¢ä¸ºä¸‰æ€å­—ç¬¦ä¸²
        let status = 'positive';
        if (approved === false || approved === 'negative') status = 'negative';
        else if (approved === 'neutral') status = 'neutral';
        else if (approved === true || approved === 'positive') status = 'positive';
        
        notifs.unshift({
            id: Date.now(),
            type, // 'taskReq', 'redemption', 'appeal', 'remedy', 'catReq', 'daily', 'taskEval'
            title,
            content,
            status, // 'positive'(ç»¿), 'neutral'(é»„), 'negative'(çº¢)
            approved: status !== 'negative', // å‘åå…¼å®¹
            reason,
            time: new Date().toISOString(),
        });
        // åªä¿ç•™æœ€è¿‘100æ¡
        if (notifs.length > 100) notifs.length = 100;
        DB.set('notifications', notifs);
    }

    function formatNotifTime(isoStr) {
        const d = new Date(isoStr);
        const now = new Date();
        const diff = now - d;
        if (diff < 60000) return 'åˆšåˆš';
        if (diff < 3600000) return Math.floor(diff / 60000) + 'åˆ†é’Ÿå‰';
        if (diff < 86400000) return Math.floor(diff / 3600000) + 'å°æ—¶å‰';
        if (diff < 604800000) return Math.floor(diff / 86400000) + 'å¤©å‰';
        return `${d.getMonth()+1}/${d.getDate()} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
    }

    function getNotifStyle(n) {
        // æ”¯æŒä¸‰æ€ï¼špositive(ç»¿), neutral(é»„), negative(çº¢)
        const status = n.status || (n.approved ? 'positive' : 'negative');
        if (status === 'positive') return { bg: 'bg-green-50 border-l-4 border-green-500', icon: 'âœ…', textColor: 'text-green-600' };
        if (status === 'neutral') return { bg: 'bg-yellow-50 border-l-4 border-yellow-500', icon: 'âš ï¸', textColor: 'text-yellow-600' };
        return { bg: 'bg-red-50 border-l-4 border-red-500', icon: 'âŒ', textColor: 'text-red-600' };
    }

    function showNotifications() {
        const notifs = DB.get('notifications', []);
        // æ ‡è®°å·²è¯»
        DB.set('lastReadNotif_' + State.role, Date.now());
        
        // ä½¿ç”¨è‡ªå®šä¹‰çš„ overlayï¼Œç‚¹å‡»å¤–éƒ¨æ—¶è°ƒç”¨ closeNotifications
        document.getElementById('modal').innerHTML = `
            <div class="modal-overlay" onclick="event.target===this&&closeNotifications()">
                <div class="card p-4 w-full max-w-md max-h-[80vh] overflow-y-auto" onclick="event.stopPropagation()">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold">ğŸ”” å®¡æ‰¹è®°å½•</h3>
                        ${notifs.length > 0 ? `<button onclick="clearNotifications()" class="text-xs text-red-500">æ¸…ç©º</button>` : ''}
                    </div>
                    
                    ${notifs.length === 0 ? '<div class="text-gray-400 text-center py-8">æš‚æ— å®¡æ‰¹è®°å½•</div>' : ''}
                    
                    ${notifs.slice(0, 50).map(n => {
                        const style = getNotifStyle(n);
                        return `
                        <div class="p-3 ${style.bg} rounded mb-2">
                            <div class="flex justify-between items-start">
                                <div class="font-medium text-sm">${style.icon} ${n.title}</div>
                                <div class="text-xs text-gray-400">${formatNotifTime(n.time)}</div>
                            </div>
                            <div class="text-sm text-gray-600 mt-1">${n.content}</div>
                            ${n.reason ? `<div class="text-xs ${style.textColor} mt-1 bg-white/50 p-1 rounded">${n.status === 'positive' ? 'å¤‡æ³¨' : n.status === 'neutral' ? 'è¯´æ˜' : 'åŸå› '}ï¼š${n.reason}</div>` : ''}
                        </div>`;
                    }).join('')}
                    
                    <button onclick="closeNotifications()" class="w-full mt-4 py-3 bg-gray-100 rounded-xl">å…³é—­</button>
                </div>
            </div>
        `;
    }

    function closeNotifications() {
        hideModal();
        render(); // é‡æ–°æ¸²æŸ“ä»¥æ›´æ–°è§’æ ‡
    }

    function clearNotifications() {
        if (confirm('ç¡®å®šæ¸…ç©ºæ‰€æœ‰å®¡æ‰¹è®°å½•ï¼Ÿ')) {
            DB.set('notifications', []);
            hideModal();
            render();
        }
    }


    // ==================== ç§¯åˆ†å˜åŠ¨æ˜ç»†ï¼ˆè´¦æœ¬ï¼‰ ====================
    function _fmtDelta(n){
        const v = Number(n||0);
        const sign = v >= 0 ? '+' : '';
        return sign + v;
    }
    function _safeDateStr(s){
        // å…è®¸ï¼šYYYY-MM-DD æˆ– YYYY-MM
        if (!s) return '';
        if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
        if (/^\d{4}-\d{2}$/.test(s)) return s + '-01';
        return '';
    }
    function _extractIsoDate(iso){
        if (!iso) return '';
        if (typeof iso !== 'string') return '';
        // æ”¯æŒï¼š2026-01-14 / 2026-01-14T12:34:56.000Z
        return iso.substring(0,10);
    }
    function buildPointsLedger(){
        const entries = [];
        const initial = DB.get('initialBalance', 0) || 0;
        entries.push({
            date: '0000-00-00',
            time: '',
            title: 'æœŸåˆä½™é¢',
            detail: 'åˆå§‹è®¾ç½®',
            delta: initial,
            type: 'initial'
        });

        // 1) æ¯æ—¥æ‰“å¡ï¼šA2åŸºç¡€åˆ†ã€æ‰£åˆ†æ˜ç»†ã€A3é¢å¤–åŠ åˆ†ï¼ˆå…ˆæŒ‰åŸå§‹åŠ åˆ†è®¡å…¥ï¼Œå‘¨ä¸Šé™é€šè¿‡â€œè°ƒæ•´é¡¹â€æŠµæ¶ˆï¼‰
        const daily = DB.get('daily', {}) || {};
        const a3WeekRaw = {}; // key: ym-Ww -> { raw, w, lastDate }
        Object.entries(daily).forEach(([date, r])=>{
            if (!r || !r.confirmed) return;

            // A2åŸºç¡€åˆ†
            const base = Engine.dailyBase(r);
            if (base){
                entries.push({
                    date, time:'', title:'A2 æ¯æ—¥å¿…åš', detail:'åŸºç¡€åˆ†', delta: base, type:'daily'
                });
            }

            // æ‰£åˆ†ï¼ˆé€æ¡åˆ—å‡ºï¼‰
            const dlist = (r.deductionList || []).filter(x => (x.pts||0) > 0);
            dlist.forEach(d=>{
                entries.push({
                    date, time:'', title:'æ‰£åˆ†', detail: d.label || 'æ‰£åˆ†é¡¹', delta: -(d.pts||0), type:'deduction'
                });
            });

            // A3ï¼ˆåŸå§‹ï¼‰
            const w = Math.min(Math.ceil(parseInt(date.split('-')[2],10) / 7), 4);
            const a3 = Engine.a3Extra(r, w) || 0;
            if (a3){
                const parts = [
                    ['å­¦ä¹ çªç ´', r.learningExtra||0],
                    ['ä¹ æƒ¯åŸºçŸ³', r.habitExtra||0],
                    ['å“æ ¼é—ªå…‰', r.characterExtra||0],
                    ['å®¶åº­è´¡çŒ®', r.familyExtra||0],
                    ['å®¶é•¿æ¿€åŠ±', r.parentExtra||0],
                ].filter(x=>x[1]);
                const detail = parts.length ? parts.map(x=>`${x[0]}+${x[1]}`).join('ï¼Œ') : 'A3é¢å¤–åŠ åˆ†';
                entries.push({
                    date, time:'', title:'A3 é¢å¤–åŠ åˆ†', detail, delta: a3, type:'a3'
                });

                const ym = date.substring(0,7);
                const key = `${ym}-W${w}`;
                if (!a3WeekRaw[key]) a3WeekRaw[key] = { raw:0, w, lastDate: date };
                a3WeekRaw[key].raw += a3;
                // æ›´æ–°è¯¥â€œæœˆå†…å‘¨æ®µâ€çš„æœ€åæ—¥æœŸï¼ˆç”¨äºè®°è´¦è°ƒæ•´é¡¹ï¼‰
                if (date > a3WeekRaw[key].lastDate) a3WeekRaw[key].lastDate = date;
            }
        });

        // 1.1) A3 å‘¨ä¸Šé™è°ƒæ•´ï¼šæŠŠè¶…è¿‡ä¸Šé™çš„éƒ¨åˆ†ä»¥è´Ÿæ•°â€œå†²å›â€ï¼Œä¿è¯è´¦æœ¬åˆè®¡=å¼•æ“å£å¾„
        Object.entries(a3WeekRaw).forEach(([key, obj])=>{
            const limit = CONFIG.a3Limits[obj.w] || 10;
            const over = (obj.raw || 0) - limit;
            if (over > 0){
                entries.push({
                    date: obj.lastDate,
                    time:'',
                    title:'A3 å‘¨ä¸Šé™è°ƒæ•´',
                    detail:`${key} åŸå§‹${obj.raw}åˆ†ï¼Œä¸Šé™${limit}åˆ†ï¼Œè¶…å‡º-${over}åˆ†`,
                    delta: -over,
                    type:'a3_cap'
                });
            }
        });

        // 2) é‡Œç¨‹ç¢‘å¥–åŠ±
        (DB.get('milestoneBonuses', []) || []).forEach(b=>{
            if (!b || !b.confirmed) return;
            const date = b.date || DB.today();
            const pts = b.points || 0;
            if (!pts) return;
            entries.push({
                date, time:'', title:'é‡Œç¨‹ç¢‘å¥–åŠ±', detail: b.title || (b.level || 'é‡Œç¨‹ç¢‘'), delta: pts, type:'milestone'
            });
        });

        // 3) ä»»åŠ¡ç¡®è®¤ï¼ˆå‘¨/æœˆ/å­£/å¹´ï¼‰
        const allTasks = DB.get('tasks', {}) || {};
        const typeLabel = { weekly:'å‘¨ä»»åŠ¡', monthly:'æœˆä»»åŠ¡', quarterly:'å­£åº¦ä»»åŠ¡', yearly:'å¹´åº¦ä»»åŠ¡' };
        Object.entries(allTasks).forEach(([k, taskData])=>{
            const type = (k || '').split('_')[0];
            if (!['weekly','monthly','quarterly','yearly'].includes(type)) return;
            if (!taskData) return;
            CONFIG.subjects.forEach(sub=>{
                const t = taskData[sub.key];
                if (!t || !t.confirmed) return;
                const score = Engine.calcTaskScore(t, type);
                if (!score) return;
                const dt = _extractIsoDate(t.confirmedAtLocal || t.confirmedAt) || DB.today();
                const period = k.split('_').slice(1).join('_'); // e.g. 2026-01-W2
                const statusLabel = t.status==='done'?'å®Œæˆ':(t.status==='partial'?'éƒ¨åˆ†å®Œæˆ':'æœªå®Œæˆ');
                const diff = (t.difficulty || 1).toFixed ? (t.difficulty || 1).toFixed(2) : (t.difficulty || 1);
                entries.push({
                    date: dt,
                    time:'',
                    title:`${typeLabel[type] || 'ä»»åŠ¡'}ï¼š${sub.name || sub.key}`,
                    detail:`${period} Â· ${statusLabel} Â· éš¾åº¦Ã—${diff}`,
                    delta: score,
                    type:'task'
                });
            });
        });

        // 4) æœˆåº¦å…æ‰£/è¿”è¿˜ï¼ˆexemptions / emotionCardsï¼‰
        const exemptions = DB.get('exemptions', {}) || {};
        Object.entries(exemptions).forEach(([ym, ex])=>{
            if (!ex || !ex.confirmed) return;
            const v = ex.value || 0;
            if (!v) return;
            entries.push({
                date: _safeDateStr(ym),
                time:'',
                title:'å…æ‰£/è¿”è¿˜',
                detail:`${ym} Â· ${ex.reason || 'å…æ‰£/è¿”è¿˜'}`,
                delta: v,
                type:'exemption'
            });
        });
        const emotionCards = DB.get('emotionCards', {}) || {};
        Object.entries(emotionCards).forEach(([ym, ec])=>{
            if (!ec || !ec.confirmed) return;
            const v = ec.refundPoints || 0;
            if (!v) return;
            entries.push({
                date: _safeDateStr(ym),
                time:'',
                title:'æƒ…ç»ªå¡è¿”è¿˜',
                detail:`${ym} Â· ${ec.reason || 'æƒ…ç»ªå¡'}`,
                delta: v,
                type:'emotion'
            });
        });

        // 5) ä¸»åŠ¨å¼¥è¡¥è¿”è¿˜ï¼ˆremediesï¼‰
        (DB.get('remedies', []) || []).forEach(r=>{
            if (!r || !r.confirmed) return;
            const v = r.refundPoints || 0;
            if (!v) return;
            entries.push({
                date: r.date || DB.today(),
                time:'',
                title:'ä¸»åŠ¨å¼¥è¡¥è¿”è¿˜',
                detail: r.reason || 'å¼¥è¡¥è¿”è¿˜',
                delta: v,
                type:'remedy'
            });
        });

        // 6) å…‘æ¢æ‰£é™¤ï¼ˆredemptionsï¼‰
        (DB.get('redemptions', []) || []).forEach(r=>{
            if (!r || !r.confirmed) return;
            const v = r.pts || 0;
            if (!v) return;
            entries.push({
                date: r.date || DB.today(),
                time:'',
                title:'å…‘æ¢æ”¯å‡º',
                detail: r.name || r.title || 'å…‘æ¢',
                delta: -v,
                type:'redeem'
            });
        });

        // æ’åºï¼ˆæœŸåˆä½™é¢å›ºå®šåœ¨æœ€å‰ï¼‰
        const head = entries.filter(e=>e.type==='initial');
        const rest = entries.filter(e=>e.type!=='initial');
        rest.sort((a,b)=>{
            const ad = (a.date || '9999-99-99') + ' ' + (a.time||'');
            const bd = (b.date || '9999-99-99') + ' ' + (b.time||'');
            if (ad < bd) return -1;
            if (ad > bd) return 1;
            return 0;
        });
        return head.concat(rest);
    }

    function showPointsLedger(){
        const all = buildPointsLedger();

        // month options from entries
        const months = Array.from(new Set(all
            .filter(e=>e.date && /^\d{4}-\d{2}-\d{2}$/.test(e.date))
            .map(e=>e.date.substring(0,7))
        )).sort();
        const curYm = DB.month();
        if (months.length === 0) months.push(curYm);
        if (!months.includes(curYm)) months.push(curYm);
        months.sort();

        State.ledgerYm = State.ledgerYm || curYm;

        const renderList = (ym) => {
            const list = all.filter(e=>{
                if (e.type === 'initial') return true;
                if (!ym) return true;
                if (!e.date || !/^\d{4}-\d{2}-\d{2}$/.test(e.date)) return true;
                return e.date.startsWith(ym);
            });

            // running balance
            let bal = 0;
            const rows = list.map(e=>{
                bal += (e.delta || 0);
                const dateLabel = e.type === 'initial' ? 'æœŸåˆ' : (e.date || '--');
                const delta = e.delta || 0;
                const deltaCls = delta >= 0 ? 'text-green-600' : 'text-red-600';
                return `
                    <div class="py-3 border-b">
                        <div class="flex justify-between items-start">
                            <div class="min-w-0">
                                <div class="text-sm font-medium">${dateLabel} Â· ${e.title}</div>
                                <div class="text-xs text-gray-500 mt-1 break-words">${e.detail || ''}</div>
                            </div>
                            <div class="text-right ml-3 shrink-0">
                                <div class="text-sm font-bold ${deltaCls}">${_fmtDelta(delta)}</div>
                                <div class="text-xs text-gray-400">ä½™é¢ ${bal}</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            return { rows, bal };
        };

        const { rows, bal } = renderList(State.ledgerYm);

        showModal(`
            <div class="modal-overlay" onclick="event.target===this&&closeTopModal()">
                <div class="card p-4 w-full max-w-md max-h-[85vh] overflow-y-auto" onclick="event.stopPropagation()">
                    <div class="flex items-center justify-between mb-3">
                        <div>
                            <div class="text-lg font-bold">â­ ç§¯åˆ†å˜åŠ¨æ˜ç»†</div>
                            <div class="text-xs text-gray-500">ç”¨äºå¯¹è´¦ï¼šæ¯ä¸€æ¬¡â€œåŠ åˆ†/æ‰£åˆ†/å…‘æ¢/è¿”è¿˜/ä¸Šé™è°ƒæ•´â€éƒ½ä¼šåœ¨è¿™é‡Œä½“ç°</div>
                        </div>
                        <button onclick="closeTopModal()" class="px-3 py-1 bg-gray-100 rounded-lg text-sm">å…³é—­</button>
                    </div>

                    <div class="flex items-center justify-between gap-2 mb-3">
                        <div class="flex items-center gap-2">
                            <div class="text-sm text-gray-600">æœˆä»½</div>
                            <select onchange="State.ledgerYm=this.value;showPointsLedger();" class="px-3 py-2 bg-gray-50 rounded-lg text-sm">
                                ${months.map(m=>`<option value="${m}" ${m===State.ledgerYm?'selected':''}>${m}</option>`).join('')}
                            </select>
                        </div>
                        <div class="text-right">
                            <div class="text-xs text-gray-500">å½“å‰æ€»ç§¯åˆ†</div>
                            <div class="text-2xl font-bold">${Engine.total()}</div>
                        </div>
                    </div>

                    <div class="bg-gray-50 rounded-xl px-3 py-2 text-sm text-gray-700 mb-2">
                        è¯¥æœˆè´¦æœ¬ä½™é¢ï¼ˆå«æœŸåˆï¼‰ï¼š<span class="font-bold">${bal}</span>
                    </div>

                    <div class="divide-y">
                        ${rows || '<div class="text-gray-400 text-center py-8">æš‚æ— è®°å½•</div>'}
                    </div>

                    <div class="text-xs text-gray-400 mt-3">
                        æ³¨ï¼šA3 é‡‡ç”¨â€œå…ˆæŒ‰åŸå§‹åŠ åˆ†è®°å…¥ï¼Œå†ç”¨å‘¨ä¸Šé™è°ƒæ•´é¡¹å†²å›è¶…å‡ºéƒ¨åˆ†â€çš„æ–¹å¼å±•ç¤ºï¼Œä¿è¯åˆè®¡ä¸ç³»ç»Ÿå£å¾„ä¸€è‡´ã€‚
                    </div>
                </div>
            </div>
        `, { pushHistory: true });
    }


    function renderContent() {
        let content = '';
        switch (State.tab) {
            case 'daily': content = renderDaily(); break;
            case 'tasks': content = renderTasks(); break;
            case 'shop': content = renderShop(); break;
            case 'stats': content = renderStats(); break;
        }
        return `<main class="pb-24 px-4 py-4">${content}</main>`;
    }

    function renderTabBar() {
        const tabs = [
            { id: 'daily', icon: 'ğŸ“‹', label: 'æ¯æ—¥' },
            { id: 'tasks', icon: 'ğŸ“', label: 'ä»»åŠ¡' },
            { id: 'shop', icon: 'ğŸ', label: 'å…‘æ¢' },
            { id: 'stats', icon: 'ğŸ“Š', label: 'ç»Ÿè®¡' },
        ];
        return `
        <nav class="fixed bottom-0 left-0 right-0 bg-white border-t safe-bottom z-40">
            <div class="flex">${tabs.map(t => `
                <button onclick="State.tab='${t.id}';render();" class="flex-1 py-3 text-center ${State.tab === t.id ? 'tab-active' : 'text-gray-400'}">
                    <div class="text-xl">${t.icon}</div><div class="text-xs">${t.label}</div>
                </button>`).join('')}
            </div>
        </nav>`;
    }

    // ==================== æ¯æ—¥æ‰“å¡ ==================

    // é¦–é¡µå†…åµŒï¼šèµ·åºŠæ‰“å¡æ—¶é—´è§„åˆ™ï¼ˆé¿å…å¼¹çª—ï¼Œä¾¿äºå­©å­/å®¶é•¿éšæ—¶å¯¹ç…§ï¼‰
    function getDailyTaskCfg(key) {
        return (CONFIG.dailyTasks || []).find(t => t.key === key) || null;
    }
    function renderWakeUpRulesCard() {
        const t = getDailyTaskCfg('wakeUp');
        if (!t) return '';
        const p = getWakeUpPreview();
        const rules = Array.isArray(t.lateDeductions) ? t.lateDeductions : [];
        const isParent = State.role === 'parent';

        return `
        <details id="wakeRulesDetails" class="card p-4 mb-4">
            <summary class="flex items-center justify-between cursor-pointer select-none">
                <div class="flex items-center space-x-2">
                    <span class="text-lg">â°</span>
                    <div>
                        <div class="font-bold text-gray-800">èµ·åºŠæ‰“å¡æ—¶é—´è§„åˆ™</div>
                        <div class="text-xs text-gray-500">å­©å­ç«¯/å®¶é•¿ç«¯æŒ‰åŒä¸€æ—¶é—´æ®µæ ¡éªŒ</div>
                    </div>
                </div>
                <div class="text-xs text-gray-500 text-right">
                    <div>å·¥ä½œæ—¥ <span class="font-semibold text-blue-600">${p.weekdayDeadline}</span></div>
                    <div>å‘¨æœ« <span class="font-semibold text-amber-600">${p.weekendDeadline}</span></div>
                </div>
            </summary>

            <div class="mt-4 space-y-3" id="wakeRulesCard">
                <div class="rounded-xl p-3" style="background:#eff6ff">
                    <div class="text-sm text-gray-600">å·¥ä½œæ—¥ï¼ˆå‘¨ä¸€â€”å‘¨äº”ï¼‰</div>
                    <div class="text-2xl font-extrabold text-blue-600">${p.weekdayDeadline}</div>
                    <div class="text-xs text-gray-500 mt-1">å¯æ‰“å¡ï¼š${p.weekdayRange.earliest}-${p.weekdayRange.latest}</div>
                </div>

                <div class="rounded-xl p-3" style="background:#fff7ed">
                    <div class="text-sm text-gray-600">å‘¨æœ«ï¼ˆå‘¨å…­ã€å‘¨æ—¥ï¼‰</div>
                    <div class="text-2xl font-extrabold text-amber-600">${p.weekendDeadline}</div>
                    <div class="text-xs text-gray-500 mt-1">å¯æ‰“å¡ï¼š${p.weekendRange.earliest}-${p.weekendRange.latest}</div>
                </div>

                ${isParent ? `
                    <button onclick="editWakeUpSettingsModal()" class="w-full py-2 bg-gray-50 rounded-lg text-sm text-gray-700">âš™ï¸ å®¶é•¿ä¿®æ”¹æ—¶é—´æ®µ</button>
                ` : ''}

                <div class="rounded-xl p-3" style="background:#fef2f2">
                    <div class="flex items-center space-x-2 mb-2">
                        <span>âš ï¸</span>
                        <div class="font-bold text-red-600">è¿Ÿåˆ°æ‰£åˆ†è§„åˆ™</div>
                    </div>
                    <ul class="text-sm text-red-600 space-y-1">
                        ${rules.map(r => `<li>â€¢ ${r.label || (`è¿Ÿåˆ°${r.minutes}åˆ†é’Ÿ`)}ï¼š-${r.pts}åˆ†</li>`).join('')}
                    </ul>
                </div>

                <div class="text-xs text-gray-400">
                    è¯´æ˜ï¼šä¸åœ¨â€œå¯æ‰“å¡æ—¶é—´æ®µâ€å†…æ— æ³•æ‰“å¡ï¼›è¶…è¿‡â€œæˆªæ­¢æ—¶é—´â€å°†è‡ªåŠ¨æŒ‰ä¸Šè¡¨æ‰£åˆ†ï¼›å¦‚æœ‰ç‰¹æ®Šæƒ…å†µï¼Œå¯ç”±å®¶é•¿åœ¨å½“æ—¥è®°å½•ä¸­æ‰‹åŠ¨è°ƒæ•´ã€‚
                </div>
            </div>
        </details>`;
    }
    function getWeekA3Total(dateStr) {
        // è®¡ç®—dateStræ‰€åœ¨å‘¨çš„A3ç´¯è®¡
        const daily = DB.get('daily', {});
        const date = parseDateLocal(dateStr);
        const dayOfWeek = date.getDay(); // 0=å‘¨æ—¥
        const weekStart = new Date(date);
        weekStart.setDate(date.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1)); // å‘¨ä¸€å¼€å§‹
        
        let total = 0;
        for (let i = 0; i < 7; i++) {
            const d = new Date(weekStart);
            d.setDate(weekStart.getDate() + i);
            const ds = formatYMD(d);
            const r = daily[ds];
            if (r) {
                const w = Math.min(Math.ceil(parseInt(ds.split('-')[2]) / 7), 4);
                total += Engine.a3Extra(r, w);
            }
        }
        return total;
    }

    function getWeekNoteScoreTotal(dateStr) {
        // è®¡ç®—dateStræ‰€åœ¨å‘¨çš„å¿ƒå¾—è¯„åˆ†ç´¯è®¡
        const daily = DB.get('daily', {});
        const date = parseDateLocal(dateStr);
        const dayOfWeek = date.getDay(); // 0=å‘¨æ—¥
        const weekStart = new Date(date);
        weekStart.setDate(date.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1)); // å‘¨ä¸€å¼€å§‹
        
        let total = 0;
        for (let i = 0; i < 7; i++) {
            const d = new Date(weekStart);
            d.setDate(weekStart.getDate() + i);
            const ds = formatYMD(d);
            const r = daily[ds];
            if (r && r.noteScore) {
                total += r.noteScore;
            }
        }
        return total;
    }

    function renderDaily() {
        const r = DB.get('daily', {})[State.date] || {};
        const isToday = State.date === DB.today();
        const w = Math.min(Math.ceil(parseInt(State.date.split('-')[2]) / 7), 4);
        const base = Engine.dailyBase(r);
        const a3Raw = Engine.a3Extra(r, w); // å½“æ—¥å½•å…¥çš„A3ï¼ˆå·²è¿‡é—¨æ§›ï¼Œä½†æœªåº”ç”¨å‘¨ä¸Šé™ï¼‰
        const weekA3Raw = getWeekA3Total(State.date); // æœ¬å‘¨A3åŸå§‹ç´¯è®¡ï¼ˆæœªåº”ç”¨å‘¨ä¸Šé™ï¼‰
        const limit = CONFIG.a3Limits[w] || 10;
        const weekA3Capped = Math.min(weekA3Raw, limit);
        // ä»Šæ—¥A3å¯è®¡å…¥ = min(ä»Šæ—¥A3, å‘¨ä¸Šé™å‰©ä½™é¢åº¦)ã€‚è¶…å‡ºéƒ¨åˆ†ä»…è®°å½•ä¸è®¡åˆ†ã€‚
        const remainingForToday = Math.max(0, limit - Math.max(0, weekA3Raw - a3Raw));
        const a3Counted = Math.min(a3Raw, remainingForToday);
        const weekRemain = Math.max(0, limit - weekA3Capped);
        const ded = r.deduction || 0;
        // å¿ƒå¾—è¯„åˆ†
        const noteScore = r.noteScore || 0;
        const noteScoreLimit = CONFIG.noteScoreLimits?.[w] || 10;
        const weekNoteScore = getWeekNoteScoreTotal(State.date);
        const weekNoteScoreCapped = Math.min(weekNoteScore, noteScoreLimit);
        const noteScoreRemaining = Math.max(0, noteScoreLimit - Math.max(0, weekNoteScore - noteScore));
        const noteScoreCounted = Math.min(noteScore, noteScoreRemaining);
        const total = base + a3Counted + noteScoreCounted - ded;
        const canEdit = State.role === 'child' && isToday && !r.submitted;
        const canConfirm = State.role === 'parent' && r.submitted && !r.confirmed;
        const canPEdit = State.role === 'parent' && !r.confirmed;
        const dow = DB.getDayOfWeek(State.date);
        const isWeekend = dow === 0 || dow === 6;

        return `
        <div class="slide-in">
            <div class="flex items-center justify-between mb-4">
                <button onclick="changeDate(-1)" class="p-2 text-gray-500 text-xl">â—€</button>
                <div class="text-center">
                    <div class="text-lg font-bold">${formatDate(State.date)}</div>
                    <div class="text-xs text-gray-500">ç¬¬${w}å‘¨ Â· <span class="${isWeekend ? 'text-orange-500' : 'text-blue-500'}">${isWeekend ? 'å‘¨æœ«' : 'å·¥ä½œæ—¥'}</span></div>
                </div>
                <button onclick="changeDate(1)" class="p-2 text-gray-500 text-xl" ${isToday ? 'style="opacity:0.3"' : ''}>â–¶</button>
            </div>
            
            ${r.confirmed ? `<div class="bg-green-100 text-green-700 text-center py-2 rounded-lg mb-4 text-sm">âœ… å·²ç¡®è®¤å…¥è´¦ ${r.batchApproved ? '<span class="bg-green-200 px-2 py-0.5 rounded text-xs ml-1">æ‰¹é‡é€šè¿‡</span>' : '<span class="bg-blue-100 text-blue-600 px-2 py-0.5 rounded text-xs ml-1">äººå·¥ç¡®è®¤</span>'}</div>` :
              r.submitted ? '<div class="bg-yellow-100 text-yellow-700 text-center py-2 rounded-lg mb-4 text-sm">â³ ç­‰å¾…å®¶é•¿ç¡®è®¤ (ç§¯åˆ†å¾…ç”Ÿæ•ˆ)</div>' :
              isToday && State.role === 'child' ? '<div class="bg-blue-50 text-blue-600 text-center py-2 rounded-lg mb-4 text-sm">ğŸ“ å®Œæˆä»Šæ—¥æ‰“å¡</div>' : 
              State.role === 'parent' && !r.submitted ? '<div class="bg-purple-50 text-purple-600 text-center py-2 rounded-lg mb-4 text-sm">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ å®¶é•¿å¯ç›´æ¥è®°å½•</div>' : ''}
            
            ${renderWakeUpRulesCard()}
            <div class="card p-4 mb-4">
                <div class="flex justify-between items-center mb-1">
                    <h3 class="font-bold text-gray-700">ğŸ“‹ æ¯æ—¥å¿…åš</h3>
                    <span class="text-lg font-bold ${base >= 0 ? 'text-green-600' : 'text-red-500'}">${base >= 0 ? '+' : ''}${base}</span>
                </div>
                <div class="text-xs text-gray-400 mb-2">4é¡¹å…¨å®Œæˆ+5 | 3é¡¹+3 | 2é¡¹+1 | æœªå®Œæˆ-1/é¡¹</div>
                <div class=\"text-xs text-gray-500 mb-3\">â° èµ·åºŠï¼šå·¥ä½œæ—¥ ${getWakeUpPreview().weekdayDeadline}ï¼ˆå¯æ‰“å¡ ${getWakeUpPreview().weekdayRange.earliest}-${getWakeUpPreview().weekdayRange.latest}ï¼‰ / å‘¨æœ« ${getWakeUpPreview().weekendDeadline}ï¼ˆå¯æ‰“å¡ ${getWakeUpPreview().weekendRange.earliest}-${getWakeUpPreview().weekendRange.latest}ï¼‰</div>
                ${CONFIG.dailyTasks.map(task => {
                    const v = r[task.key];
                    const done = v === true || v === 'done';
                    const partial = v === 'partial';
                    const inc = v === false || v === 'incomplete';
                    const checkinTime = r[task.key + '_time'];
                    const deadline = CheckinHelper.getDeadline(task.key, State.date);
                    const lateInfo = checkinTime ? CheckinHelper.calcLateDeduction(task.key, State.date, checkinTime) : null;
                    
                    return `
                    <div class="py-3 border-b border-gray-100 last:border-0">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <span class="text-xl">${task.icon}</span>
                                <div>
                                    <span>${task.label}</span>
                                    ${deadline ? `<div class="text-xs text-gray-400">æˆªæ­¢ ${deadline} ${isWeekend ? '(å‘¨æœ«)' : '(å·¥ä½œæ—¥)'}</div>` : ''}
                                </div>
                            </div>
                            ${canEdit || canPEdit ? `
                            <div class="flex space-x-1">
                                <button onclick="setTask('${task.key}',true)" class="w-8 h-8 rounded-full border-2 flex items-center justify-center text-sm ${done ? 'bg-green-500 border-green-500 text-white' : 'border-gray-300'}">âœ“</button>
                                <button onclick="setTask('${task.key}','partial')" class="w-8 h-8 rounded-full border-2 flex items-center justify-center text-sm ${partial ? 'bg-yellow-500 border-yellow-500 text-white' : 'border-gray-300'}">â–³</button>
                                <button onclick="setTask('${task.key}',false)" class="w-8 h-8 rounded-full border-2 flex items-center justify-center text-sm ${inc ? 'bg-red-500 border-red-500 text-white' : 'border-gray-300'}">âœ—</button>
                            </div>` : `<span class="text-lg">${done ? 'âœ…' : partial ? 'âš ï¸' : inc ? 'âŒ' : 'â¬œ'}</span>`}
                        </div>
                        ${task.deadlines && (done || checkinTime) ? `
                        <div class="mt-2 flex items-center space-x-2 text-xs">
                            <span class="text-gray-500">æ‰“å¡æ—¶é—´:</span>
                            ${checkinTime ? `
                                <span class="checkin-badge ${lateInfo ? 'bg-red-100 text-red-600' : 'bg-green-100 text-green-600'}">${checkinTime}</span>
                                ${lateInfo ? `<span class="text-red-500 font-medium">${lateInfo.label} -${lateInfo.pts}åˆ†</span>` : '<span class="text-green-500">å‡†æ—¶ âœ“</span>'} ${task.key==='wakeUp' && lateInfo && State.role==='child' ? `<button onclick=\"showAppealForm(${(r.deductionList||[]).findIndex(d=>d.isLateDeduction)})\" class=\"ml-2 px-2 py-0.5 rounded bg-blue-100 text-blue-600\">ç”³è¯‰</button>` : ''}
                            ` : `<span class="text-gray-400">æœªè®°å½•</span>`}
                        </div>` : ''}
                    </div>`;
                }).join('')}
                ${State.role === 'child' && isToday && !r.submitted ? `
                <div class="mt-3 pt-3 border-t">
                    <button onclick="showDailyExemptRequest()" class="w-full py-2 bg-purple-50 text-purple-600 rounded-lg text-sm">ğŸ“ ç”³è¯·ä»»åŠ¡è°ƒæ•´ï¼ˆç‰¹æ®Šæƒ…å†µè±å…ï¼‰</button>
                </div>` : ''}
            </div>
            
            <div class="card p-4 mb-4">
                <div class="flex justify-between items-start mb-1">
                    <h3 class="font-bold text-gray-700">âœ¨ A3é¢å¤–åŠ åˆ†</h3>
                    <div class="text-right">
                        <div class="text-lg font-bold ${base < 3 ? 'text-gray-400' : (a3Counted > 0 ? 'text-green-600' : 'text-gray-500')}">ä»Šæ—¥è®¡å…¥+${a3Counted}</div>
                        ${(base >= 3 && a3Raw !== a3Counted) ? `<div class="text-xs text-gray-500">ä»Šæ—¥è®°å½•+${a3Raw}ï¼ˆæœ¬å‘¨å·²è¾¾ä¸Šé™ï¼Œè¶…å‡ºéƒ¨åˆ†ä¸è®¡åˆ†ï¼‰</div>` : ''}
                    </div>
                </div>
                ${base < 3 ? `<div class="bg-orange-100 text-orange-700 text-xs p-2 rounded mb-2">
                    <div>âš ï¸ é—¨æ§›è§„åˆ™ï¼šA2æ¯æ—¥å¿…åšè‡³å°‘å®Œæˆ3é¡¹(å½“å‰${Engine.dailyBase(r)}åˆ†)ï¼ŒA3æ‰èƒ½è®¡å…¥ã€‚</div>
                    <div class="mt-1 font-medium">ğŸ’¡ æŠŠã€å¿…åšã€‘å†å®Œæˆ${3 - base}é¡¹ï¼ˆæˆ–æŠŠ"éƒ¨åˆ†"è¡¥æˆ"å®Œæˆ"ï¼‰ï¼ŒA3ç«‹åˆ»ç”Ÿæ•ˆï¼</div>
                </div>` : ''}
                <div class="flex justify-between items-center text-xs text-gray-500 mb-2">
                    <span>æ¯å‘¨ä¸Šé™${limit}åˆ†</span>
                    <span class="px-2 py-0.5 rounded font-medium ${weekRemain === 0 ? 'bg-orange-100 text-orange-700' : 'bg-green-100 text-green-700'}">æœ¬å‘¨è®¡å…¥${weekA3Capped}/${limit} Â· å‰©ä½™${weekRemain}</span>
                </div>
                ${(weekRemain === 0 && base >= 3) ? `<div class="bg-orange-50 text-orange-700 text-xs p-2 rounded mb-2">æœ¬å‘¨A3å·²è¾¾ä¸Šé™ï¼Œåç»­åŠ åˆ†ä»…è®°å½•ä¸è®¡åˆ†ã€‚</div>` : ''}
                ${CONFIG.extraModules.map(m => {
                    const v = r[m.key + 'Extra'] || 0;
                    const reason = r[m.key + 'ExtraReason'] || '';
                    return `
                    <div class="py-2 border-b border-gray-100 last:border-0">
                        <div class="flex items-center justify-between">
                            <div><span class="font-medium">${m.label}</span><div class="text-xs text-gray-400">${m.items.join(' | ')}</div></div>
                            ${canEdit || canPEdit ? `
                            <div class="flex items-center space-x-2">
                                <button onclick="adjustExtra('${m.key}Extra',-1)" class="w-8 h-8 bg-gray-100 rounded-full text-lg">-</button>
                                <span class="w-8 text-center font-bold">${v}</span>
                                <button onclick="showExtraReasonInput('${m.key}Extra')" class="w-8 h-8 btn-primary rounded-full text-lg">+</button>
                            </div>` : `<span class="font-bold text-green-600">+${v}</span>`}
                        </div>
                        ${reason ? `<div class="text-xs text-gray-500 mt-1 bg-gray-50 p-1 rounded">ğŸ“ ${reason}</div>` : ''}
                    </div>`;
                }).join('')}
            </div>
            
            <div class="card p-4 mb-4">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="font-bold text-gray-700">âš ï¸ DçŠ¯é”™æ‰£åˆ†</h3>
                    <span class="text-lg font-bold text-red-500">-${ded}</span>
                </div>
                ${(r.deductionList || []).map((item, i) => `
                    <div class="flex items-center justify-between py-2 px-3 bg-red-50 rounded mb-1">
                        <span class="text-sm">${item.label} <span class="font-bold text-red-500">-${item.pts}</span>${item.isEmotion ? '<span class="text-xs bg-purple-100 text-purple-600 px-1 rounded ml-1">æƒ…ç»ª</span>' : ''}</span>
                        ${canPEdit ? `<button onclick="removeDed(${i})" class="text-red-500 text-xs px-2 py-1 bg-white rounded">æ’¤é”€</button>` : ''}
                    </div>`).join('')}
                ${State.role === 'child' && (r.deductionList || []).length > 0 && !r.confirmed ? `<button onclick="showAppealForm()" class="w-full py-2 bg-blue-50 text-blue-600 rounded-lg text-sm mt-2">ğŸ“ å¯¹æ‰£åˆ†é¡¹ç”³è¯‰</button>` : ''}
                ${canPEdit ? `
                <div class="border-t pt-3 mt-2">
                    <div class="text-sm text-gray-600 mb-2">æ·»åŠ æ‰£åˆ†ï¼š</div>
                    ${CONFIG.deductionRules.map(rule => `
                        <button onclick="addDed(${rule.pts},'${rule.label}',${rule.isEmotion})" class="w-full text-left p-2 bg-gray-50 hover:bg-red-50 rounded text-sm mb-1 flex justify-between">
                            <span>${rule.label}${rule.isEmotion ? ' <span class="text-xs bg-purple-100 text-purple-600 px-1 rounded">æƒ…ç»ª</span>' : ''}</span>
                            <span class="text-red-500 font-bold">-${rule.pts}</span>
                        </button>`).join('')}
                    <div class="flex space-x-2 mt-3">
                        <input type="number" id="customDedPts" class="w-20 border rounded px-2 py-1 text-sm" placeholder="åˆ†æ•°">
                        <input type="text" id="customDedNote" class="flex-1 border rounded px-2 py-1 text-sm" placeholder="åŸå› ">
                        <button onclick="addCustomDed()" class="px-3 py-1 btn-danger rounded text-sm">æ·»åŠ </button>
                    </div>
                    ${ded > 0 ? `<button onclick="showRemedyForm()" class="w-full mt-3 py-2 bg-green-100 text-green-700 rounded-lg text-sm">âœ¨ ä¸»åŠ¨å¼¥è¡¥(è¿”è¿˜50%: +${Math.floor(ded * 0.5)})</button>` : ''}
                </div>` : ''}
            </div>
            
            <div class="card p-4 mb-4 text-center" style="background:linear-gradient(135deg,#1a365d 0%,#3b82f6 100%);color:white">
                <div class="text-sm opacity-80">ä»Šæ—¥ç§¯åˆ† ${r.confirmed ? '' : '(å¾…ç¡®è®¤)'}</div>
                <div class="text-3xl font-bold">${total >= 0 ? '+' : ''}${total}</div>
            </div>
            
            <div class="card p-4 mb-4">
                <div class="flex justify-between items-start mb-2">
                    <div>
                        <h3 class="font-bold text-gray-700">ğŸ“ ä»Šæ—¥å¿ƒå¾—ä¸æ€»ç»“</h3>
                        <div class="text-xs text-gray-400">å®¶é•¿å¯æ ¹æ®å†…å®¹è´¨é‡ç»™åˆ† (1-4åˆ†ï¼Œæ¯å‘¨ä¸Šé™${noteScoreLimit}åˆ†)</div>
                    </div>
                    <div class="text-right">
                        <div class="text-lg font-bold ${noteScoreCounted > 0 ? 'text-green-600' : 'text-gray-500'}">+${noteScoreCounted}</div>
                        <div class="text-xs text-gray-500">æœ¬å‘¨${weekNoteScoreCapped}/${noteScoreLimit}</div>
                    </div>
                </div>
                <textarea id="noteInput" class="w-full border rounded-lg p-2 text-sm mb-2" rows="3" placeholder="ä»Šæ—¥å¿ƒå¾—ä¸æ€»ç»“ï¼šå­¦åˆ°äº†ä»€ä¹ˆï¼Ÿæœ‰ä»€ä¹ˆæ”¶è·ï¼Ÿé‡åˆ°äº†ä»€ä¹ˆå›°éš¾ï¼Ÿæ˜å¤©æ‰“ç®—æ€ä¹ˆåšï¼Ÿ..." ${!canEdit && !canPEdit ? 'disabled' : ''}>${r.note || ''}</textarea>
                ${canPEdit ? `
                <div class="flex items-center justify-between bg-green-50 p-3 rounded-lg">
                    <div>
                        <div class="text-sm font-medium text-green-700">å¿ƒå¾—è¯„åˆ† (å®¶é•¿è¯„å®š)</div>
                        <div class="text-xs text-green-600">æ ¹æ®å†…å®¹è´¨é‡ï¼š0=æ— /1=ç®€å•/2=ä¸€èˆ¬/3=è¾ƒå¥½/4=ä¼˜ç§€</div>
                    </div>
                    <select id="noteScoreInput" class="border rounded px-3 py-2 text-sm" onchange="saveNoteScore()">
                        <option value="0" ${(r.noteScore || 0) === 0 ? 'selected' : ''}>0 - æ— </option>
                        <option value="1" ${(r.noteScore || 0) === 1 ? 'selected' : ''}>1 - ç®€å•</option>
                        <option value="2" ${(r.noteScore || 0) === 2 ? 'selected' : ''}>2 - ä¸€èˆ¬</option>
                        <option value="3" ${(r.noteScore || 0) === 3 ? 'selected' : ''}>3 - è¾ƒå¥½</option>
                        <option value="4" ${(r.noteScore || 0) === 4 ? 'selected' : ''}>4 - ä¼˜ç§€</option>
                    </select>
                </div>` : ''}
            </div>
            
            ${canEdit ? `<button onclick="submitDaily()" class="w-full py-4 btn-primary rounded-2xl text-lg font-bold">ğŸ“¤ æäº¤æ‰“å¡ (ç­‰å¾…å®¶é•¿å®¡æ ¸)</button>` : ''}
            ${State.role === 'parent' && !r.submitted && !r.confirmed ? `<button onclick="parentDirectConfirm()" class="w-full py-4 btn-success rounded-2xl text-lg font-bold mb-3">âœ… å®¶é•¿ç›´æ¥ç¡®è®¤å…¥è´¦</button>` : ''}
            ${canConfirm ? `
            <div class="flex space-x-3">
                <button onclick="confirmDaily(false)" class="flex-1 py-4 bg-gray-200 text-gray-700 rounded-2xl font-bold">â†©ï¸ é€€å›ä¿®æ”¹</button>
                <button onclick="confirmDaily(true)" class="flex-1 py-4 btn-success rounded-2xl font-bold">âœ… ç¡®è®¤å…¥è´¦</button>
            </div>` : ''}
        </div>`;
    }

    function changeDate(d) {
        const date = parseDateLocal(State.date);
        date.setDate(date.getDate() + d);
        if (date <= new Date()) { State.date = formatYMD(date); render(); }
    }
    
    function setTask(key, val) {
        const daily = DB.get('daily', {});
        const r = daily[State.date] || {};
        if (r.confirmed || (State.role === 'child' && r.submitted)) return;
        r[key] = val;
        
        const task = CONFIG.dailyTasks.find(t => t.key === key);
        if (task && task.deadlines && val === true && State.role === 'child' && State.date === DB.today()) {
            const nowT = CheckinHelper.getCurrentTime();
            // èµ·åºŠæ‰“å¡æ—¶é—´æ®µæ ¡éªŒï¼ˆä¸å®¶é•¿ç«¯è®¾ç½®ä¿æŒä¸€è‡´ï¼‰
            if (key === 'wakeUp') {
                const range = CheckinHelper.getValidTimeRange('wakeUp', State.date);
                if (range && !CheckinHelper.isValidCheckinTime('wakeUp', State.date, nowT)) {
                    alert(`â›” å½“å‰æ—¶é—´ ${nowT} ä¸åœ¨å…è®¸çš„æ‰“å¡æ—¶é—´æ®µ ${range.earliest || '05:00'}-${range.latest || '12:00'} å†…ï¼Œæ— æ³•æ‰“å¡ã€‚`);
                    r[key] = false;
                    delete r[key + '_time'];
                    daily[State.date] = r;
                    DB.set('daily', daily);
                    render();
                    return;
                }
            }
            r[key + '_time'] = nowT;
        }
        
        // è¿Ÿåˆ°æ‰£åˆ†è‡ªåŠ¨é—­ç¯ï¼šå½“èµ·åºŠæ‰“å¡å®Œæˆæ—¶ï¼Œè‡ªåŠ¨è®¡ç®—å¹¶å†™å…¥è¿Ÿåˆ°æ‰£åˆ†
        if (key === 'wakeUp' && task && task.lateDeductions) {
            // å…ˆç§»é™¤ä¹‹å‰çš„ç³»ç»Ÿè¿Ÿåˆ°æ‰£åˆ†ï¼ˆé¿å…é‡å¤ï¼‰
            if (!r.deductionList) r.deductionList = [];
            r.deductionList = r.deductionList.filter(d => !d.isLateDeduction);
            
            if (val === true || val === 'done') {
                const checkinTime = r[key + '_time'];
                const lateInfo = CheckinHelper.calcLateDeduction(key, State.date, checkinTime);
                if (lateInfo) {
                    // è‡ªåŠ¨æ·»åŠ è¿Ÿåˆ°æ‰£åˆ†ï¼ˆæ ‡è®°ä¸ºç³»ç»Ÿæ‰£åˆ†ï¼‰
                    r.deductionList.push({
                        label: `èµ·åºŠè¿Ÿåˆ°(${lateInfo.label})`,
                        pts: lateInfo.pts,
                        isLateDeduction: true, // æ ‡è®°ä¸ºç³»ç»Ÿè¿Ÿåˆ°æ‰£åˆ†
                        isEmotion: false,
                        autoGenerated: true
                    });
                }
            }
            // é‡æ–°è®¡ç®—æ€»æ‰£åˆ†
            r.deduction = r.deductionList.reduce((s, i) => s + (i.pts || 0), 0);
        }
        
        daily[State.date] = r;
        DB.set('daily', daily);
        render();
    }
    
    function adjustExtra(key, d) {
        const daily = DB.get('daily', {});
        const r = daily[State.date] || {};
        if (r.confirmed) return;
        r[key] = Math.max(0, (r[key] || 0) + d);
        daily[State.date] = r;
        DB.set('daily', daily);
        render();
    }

    function showExtraReasonInput(key) {
        const daily = DB.get('daily', {})[State.date] || {};
        const currentReason = daily[key + 'Reason'] || '';
        const moduleKey = key.replace('Extra', '');
        const module = CONFIG.extraModules.find(m => m.key === moduleKey);
        const moduleName = module ? module.label : 'åŠ åˆ†';

        showModal(`
            <div class="card p-4 w-full max-w-sm" onclick="event.stopPropagation()">
                <h3 class="text-lg font-bold mb-3">âœ¨ ${moduleName}</h3>
                <div class="text-sm text-gray-600 mb-3">${module ? module.items.join(' | ') : ''}</div>

                <div class="mb-3">
                    <label class="block text-sm text-gray-600 mb-1">æœ¬æ¬¡åŠ åˆ†ï¼ˆå¯è‡ªç”±è°ƒæ•´ï¼‰</label>
                    <div class="flex items-center space-x-2">
                        <button class="w-10 h-10 bg-gray-100 rounded-xl text-lg" onclick="(function(){const el=document.getElementById('extraPtsInput'); const v=Math.max(1,(parseInt(el.value)||1)-1); el.value=v; const b=document.getElementById('extraConfirmBtn'); if(b) b.innerText='ç¡®è®¤åŠ åˆ† +' + v;})()">-</button>
                        <input type="number" min="1" step="1" id="extraPtsInput" class="flex-1 border rounded-xl px-3 py-2 text-sm" value="1" oninput="(function(){const v=Math.max(1,parseInt(this.value)||1); this.value=v; const b=document.getElementById('extraConfirmBtn'); if(b) b.innerText='ç¡®è®¤åŠ åˆ† +' + v;}).call(this)">
                        <button class="w-10 h-10 bg-gray-100 rounded-xl text-lg" onclick="(function(){const el=document.getElementById('extraPtsInput'); const v=Math.max(1,(parseInt(el.value)||1)+1); el.value=v; const b=document.getElementById('extraConfirmBtn'); if(b) b.innerText='ç¡®è®¤åŠ åˆ† +' + v;})()">+</button>
                    </div>
                    <div class="text-xs text-gray-400 mt-1">è¯´æ˜ï¼šç†ç”±å†™ä¸€æ¬¡å³å¯ï¼Œæœ¬æ¬¡ä¼šä¸€æ¬¡æ€§åŠ ä¸Šå¯¹åº”åˆ†æ•°ã€‚</div>
                </div>

                <div class="mb-3">
                    <label class="block text-sm text-gray-600 mb-1">è·å¾—ç†ç”±ï¼ˆè¯·æè¿°å…·ä½“åšäº†ä»€ä¹ˆï¼‰</label>
                    <textarea id="extraReasonInput" class="w-full border rounded-xl px-3 py-2 text-sm" rows="2" placeholder="ä¾‹å¦‚ï¼šä»Šå¤©ä¸»åŠ¨å¸®å¦ˆå¦ˆæ´—ç¢—...">${currentReason}</textarea>
                </div>

                <div class="flex space-x-3">
                    <button onclick="hideModal()" class="flex-1 py-3 bg-gray-100 rounded-xl">å–æ¶ˆ</button>
                    <button id="extraConfirmBtn" onclick="confirmExtraWithReason('${key}')" class="flex-1 py-3 btn-success rounded-xl">ç¡®è®¤åŠ åˆ† +1</button>
                </div>
            </div>
        `);
    }

    function confirmExtraWithReason(key) {
        const reason = document.getElementById('extraReasonInput')?.value?.trim() || '';
        const pts = Math.max(1, parseInt(document.getElementById('extraPtsInput')?.value || '1', 10) || 1);

        const daily = DB.get('daily', {});
        const r = daily[State.date] || {};
        if (r.confirmed) { hideModal(); return; }

        r[key] = (r[key] || 0) + pts;

        // è¿½åŠ ç†ç”±ï¼ˆå¤šæ¬¡åŠ åˆ†å¯ä»¥è®°å½•å¤šæ¡ç†ç”±ï¼›æ¯æ¡ç†ç”±ä¼šæ ‡æ³¨æœ¬æ¬¡åŠ åˆ†å€¼ï¼‰
        const prevReason = r[key + 'Reason'] || '';
        if (reason) {
            const stamp = `(+${pts}) ${reason}`;
            r[key + 'Reason'] = prevReason ? (prevReason + 'ï¼›' + stamp) : stamp;
        }

        daily[State.date] = r;
        DB.set('daily', daily);
        hideModal();
        render();
    }

    function showDailyExemptRequest() {
        showModal(`
            <div class="card p-4 w-full max-w-md" onclick="event.stopPropagation()">
                <h3 class="text-lg font-bold mb-3">ğŸ“ ç”³è¯·ä»»åŠ¡è°ƒæ•´</h3>
                <div class="bg-purple-50 p-3 rounded-lg mb-3 text-sm">
                    <div class="font-medium text-purple-700">ç‰¹æ®Šæƒ…å†µè¯´æ˜</div>
                    <div class="text-purple-600 text-xs mt-1">å¦‚æœ‰ç‰¹æ®Šæƒ…å†µï¼ˆç”Ÿç—…ã€å¤–å‡ºã€ç‰¹æ®Šå®‰æ’ç­‰ï¼‰ï¼Œå¯ä»¥ç”³è¯·æŸé¡¹ä»»åŠ¡çš„è±å…æˆ–è°ƒæ•´ã€‚ç”³è¯·éœ€è¦å®¶é•¿å®¡æ ¸ã€‚</div>
                </div>
                <div class="mb-3">
                    <label class="block text-sm text-gray-600 mb-1">é€‰æ‹©è¦ç”³è¯·çš„ä»»åŠ¡</label>
                    <select id="exemptTaskSelect" class="w-full border rounded px-3 py-2">
                        ${CONFIG.dailyTasks.map(t => `<option value="${t.key}">${t.icon} ${t.label}</option>`).join('')}
                    </select>
                    <div class="text-xs text-gray-500 mt-1">éš¾åº¦ç³»æ•°ç”±ä¸Šæ–¹å››å› å­è‡ªåŠ¨è®¡ç®—ï¼›å®¶é•¿å®¡æ ¸æ—¶å¯è°ƒæ•´ã€‚</div>
                </div>
                <div class="mb-3">
                    <label class="block text-sm text-gray-600 mb-1">ç”³è¯·ç±»å‹</label>
                    <select id="exemptTypeSelect" class="w-full border rounded px-3 py-2">
                        <option value="exempt">å®Œå…¨è±å…ï¼ˆä¸è®¡å…¥è¯„åˆ†ï¼‰</option>
                        <option value="adjust">è°ƒæ•´æ—¶é—´ï¼ˆä¿®æ”¹æˆªæ­¢æ—¶é—´ï¼‰</option>
                        <option value="partial">é™ä½è¦æ±‚ï¼ˆéƒ¨åˆ†å®Œæˆå³å¯ï¼‰</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="block text-sm text-gray-600 mb-1">ç”³è¯·ç†ç”±ï¼ˆè¯·è¯¦ç»†è¯´æ˜ï¼‰</label>
                    <textarea id="exemptReasonInput" class="w-full border rounded px-3 py-2 text-sm" rows="3" placeholder="è¯·è¯´æ˜ç‰¹æ®Šæƒ…å†µï¼Œä¾‹å¦‚ï¼šä»Šå¤©èº«ä½“ä¸èˆ’æœï¼Œéœ€è¦å¤šä¼‘æ¯..."></textarea>
                </div>
                <div class="flex space-x-3">
                    <button onclick="hideModal()" class="flex-1 py-3 bg-gray-100 rounded-xl">å–æ¶ˆ</button>
                    <button onclick="submitDailyExemptRequest()" class="flex-1 py-3 btn-primary rounded-xl">æäº¤ç”³è¯·</button>
                </div>
            </div>
        `);
    }

    function submitDailyExemptRequest() {
        const taskKey = document.getElementById('exemptTaskSelect')?.value;
        const exemptType = document.getElementById('exemptTypeSelect')?.value;
        const reason = document.getElementById('exemptReasonInput')?.value?.trim();
        
        if (!reason) { alert('è¯·å¡«å†™ç”³è¯·ç†ç”±'); return; }
        
        const task = CONFIG.dailyTasks.find(t => t.key === taskKey);
        const taskName = task ? task.label : taskKey;
        
        const requests = DB.get('dailyExemptRequests', []);
        requests.push({
            date: State.date,
            taskKey,
            taskName,
            exemptType,
            reason,
            resolved: false,
            createdAt: new Date().toISOString()
        });
        DB.set('dailyExemptRequests', requests);
        
        hideModal();
        alert('ğŸ“¤ ç”³è¯·å·²æäº¤ï¼Œç­‰å¾…å®¶é•¿å®¡æ ¸');
        render();
    }
    
    function addDed(pts, label, isEmotion) {
        const daily = DB.get('daily', {});
        const r = daily[State.date] || {};
        if (!r.deductionList) r.deductionList = [];
        r.deductionList.push({ pts, label, isEmotion });
        r.deduction = r.deductionList.reduce((s, i) => s + (i.pts || 0), 0);
        daily[State.date] = r;
        DB.set('daily', daily);
        render();
    }
    
    function removeDed(idx) {
        const daily = DB.get('daily', {});
        const r = daily[State.date] || {};
        if (r.deductionList) {
            r.deductionList.splice(idx, 1);
            r.deduction = r.deductionList.reduce((s, i) => s + (i.pts || 0), 0);
            daily[State.date] = r;
            DB.set('daily', daily);
            render();
        }
    }
    
    function addCustomDed() {
        const pts = parseInt(document.getElementById('customDedPts')?.value) || 0;
        const note = document.getElementById('customDedNote')?.value || 'è‡ªå®šä¹‰';
        if (pts > 0) { addDed(pts, note, false); document.getElementById('customDedPts').value = ''; document.getElementById('customDedNote').value = ''; }
    }
    
    // å®¶é•¿ç›´æ¥ç¡®è®¤å…¥è´¦ï¼ˆä¸éœ€è¦å­©å­æäº¤ï¼‰
    function parentDirectConfirm() {
        showPwdModal('ç¡®è®¤å…¥è´¦éœ€è¦å¯†ç ', () => {
            const daily = DB.get('daily', {});
            const r = daily[State.date] || {};
            r.note = document.getElementById('noteInput')?.value || r.note;
            r.confirmed = true;
            r.confirmedAt = new Date().toISOString();
            r.confirmedAtLocal = formatYMD(new Date());
                r.parentDirect = true; // æ ‡è®°ä¸ºå®¶é•¿ç›´æ¥æ“ä½œ
            daily[State.date] = r;
            DB.set('daily', daily);
            alert('âœ… å·²ç¡®è®¤å…¥è´¦ï¼ç§¯åˆ†å·²ç”Ÿæ•ˆ');
            render();
        });
    }

    function saveNoteScore() {
        const daily = DB.get('daily', {});
        const r = daily[State.date] || {};
        const score = parseInt(document.getElementById('noteScoreInput')?.value) || 0;
        r.noteScore = Math.max(0, Math.min(4, score));
        daily[State.date] = r;
        DB.set('daily', daily);
        render();
    }
    
    function submitDaily() {
        const daily = DB.get('daily', {});
        const r = daily[State.date] || {};
        
        r.submitted = true;
        r.submittedAt = new Date().toISOString();
        r.note = document.getElementById('noteInput')?.value || '';
        daily[State.date] = r;
        DB.set('daily', daily);
        alert('âœ… æ‰“å¡å·²æäº¤ï¼ç­‰å¾…å®¶é•¿å®¡æ ¸åç§¯åˆ†æ‰ä¼šç”Ÿæ•ˆ');
        render();
    }
    
    function confirmDaily(approved) {
        if (approved) {
            showPwdModal('ç¡®è®¤å…¥è´¦éœ€è¦å¯†ç ', () => {
                const daily = DB.get('daily', {});
                const r = daily[State.date] || {};
                r.confirmed = true; 
                r.confirmedAt = new Date().toISOString();
                r.confirmedAtLocal = formatYMD(new Date());
                r.note = document.getElementById('noteInput')?.value || r.note;
                daily[State.date] = r;
                DB.set('daily', daily);
                
                const base = Engine.dailyBase(r);
                const w = Math.min(Math.ceil(parseInt(State.date.split('-')[2]) / 7), 4);
                const a3 = Engine.a3Extra(r, w);
                const ded = r.deduction || 0;
                const total = base + a3 - ded;
                addNotification('daily', 'æ‰“å¡å·²ç¡®è®¤', `${formatDate(State.date)} è·å¾— ${total >= 0 ? '+' : ''}${total}åˆ†`, true);
                
                alert('âœ… å·²ç¡®è®¤å…¥è´¦ï¼ç§¯åˆ†å·²ç”Ÿæ•ˆ');
                render();
            });
        } else {
            // é€€å›éœ€è¦å¡«å†™åŸå› 
            showModal(`
                <div class="card p-4 w-full max-w-sm" onclick="event.stopPropagation()">
                    <h3 class="text-lg font-bold mb-4">â†©ï¸ é€€å›æ‰“å¡</h3>
                    <div class="bg-gray-50 p-3 rounded-lg mb-3 text-sm">
                        <div class="font-medium">${formatDate(State.date)}</div>
                    </div>
                    <textarea id="rejectDailyReason" class="w-full border rounded px-3 py-2" rows="2" placeholder="è¯·è¾“å…¥é€€å›åŸå› ï¼ˆå¿…å¡«ï¼‰"></textarea>
                    
                <div class="bg-gray-50 rounded-lg p-3 mt-3">
                    <div class="text-sm font-medium text-gray-700 mb-2">è¯„å®šå¤‡æ³¨ï¼ˆå¯é€‰ï¼‰</div>
                    <div class="flex flex-wrap gap-2 mb-2">
                        <button type="button" class="px-3 py-1 text-xs rounded-full bg-gray-200" onclick="appendEvalNote('è¯æ®å¯ä¿¡')">è¯æ®å¯ä¿¡</button>
                        <button type="button" class="px-3 py-1 text-xs rounded-full bg-gray-200" onclick="appendEvalNote('è¯æ®ä¸æ¸…æ™°')">è¯æ®ä¸æ¸…æ™°</button>
                        <button type="button" class="px-3 py-1 text-xs rounded-full bg-gray-200" onclick="appendEvalNote('éœ€è¡¥å……è¯æ®')">éœ€è¡¥å……è¯æ®</button>
                    </div>
                    <textarea id="evalNote" class="w-full border rounded px-3 py-2 text-sm" rows="2" placeholder="ä¾‹å¦‚ï¼šå®Œæˆè´¨é‡å¾ˆå¥½/æ­¥éª¤æ¸…æ™°/éœ€è¦è¡¥å……è¿‡ç¨‹ç…§ç‰‡ç­‰"></textarea>
                </div>

                <div class="flex space-x-3 mt-4">
                        <button onclick="closeTopModal()" class="flex-1 py-3 bg-gray-100 rounded-xl">å–æ¶ˆ</button>
                        <button onclick="execRejectDaily()" class="flex-1 py-3 btn-warning rounded-xl">ç¡®è®¤é€€å›</button>
                    </div>
                </div>
            `);
        }
    }

    function execRejectDaily() {
        const reason = document.getElementById('rejectDailyReason')?.value?.trim();
        if (!reason) { alert('è¯·å¡«å†™é€€å›åŸå› '); return; }
        showPwdModal('é€€å›éœ€è¦å¯†ç ', () => {
            const daily = DB.get('daily', {});
            const r = daily[State.date] || {};
            r.submitted = false;
            r.rejectReason = reason;
            r.rejectedAt = new Date().toISOString();
            daily[State.date] = r;
            DB.set('daily', daily);
            
            addNotification('daily', 'æ‰“å¡è¢«é€€å›', `${formatDate(State.date)}`, false, reason);
            
            hideModal();
            alert('â†©ï¸ å·²é€€å›ï¼Œå­©å­å¯é‡æ–°ä¿®æ”¹æäº¤');
            render();
        });
    }
    
    function showRemedyForm() {
        const r = DB.get('daily', {})[State.date] || {};
        const refund = Math.floor((r.deduction || 0) * 0.5);
        showModal(`
            <div class="card p-4 w-full max-w-sm" onclick="event.stopPropagation()">
                <h3 class="text-lg font-bold mb-4">âœ¨ ä¸»åŠ¨å¼¥è¡¥ç”³è¯·</h3>
                <p class="text-sm text-gray-600 mb-3">å½“æ—¥æ‰£åˆ†: ${r.deduction || 0}åˆ†ï¼Œå¯è¿”è¿˜: +${refund}åˆ†</p>
                <input type="text" id="remedyAction" class="w-full border rounded px-3 py-2 mb-2" placeholder="æˆ‘åšäº†ä»€ä¹ˆå¼¥è¡¥ï¼Ÿ">
                <textarea id="remedyReflection" class="w-full border rounded px-3 py-2" rows="2" placeholder="åæ€ä¸æ”¹è¿›æ‰¿è¯º"></textarea>
                <div class="flex space-x-3 mt-4">
                    <button onclick="hideModal()" class="flex-1 py-3 bg-gray-100 rounded-xl">å–æ¶ˆ</button>
                    <button onclick="submitRemedy('${State.date}',${refund})" class="flex-1 py-3 btn-success rounded-xl">æäº¤</button>
                </div>
            </div>
        `);
    }
    
    function submitRemedy(date, refund) {
        const action = document.getElementById('remedyAction')?.value?.trim();
        const reflection = document.getElementById('remedyReflection')?.value?.trim();
        if (!action || !reflection) { alert('è¯·å¡«å†™å®Œæ•´'); return; }
        const remedies = DB.get('remedies', []);
        remedies.push({ date, action, reflection, refundPoints: refund, confirmed: false });
        DB.set('remedies', remedies);
        hideModal();
        alert('ğŸ“¤ å¼¥è¡¥ç”³è¯·å·²æäº¤');
        render();
    }
    
    
    function weekKeyOf(dateStr) {
        const d = parseDateLocal(dateStr);
        // ä»¥å‘¨ä¸€ä¸ºä¸€å‘¨å¼€å§‹
        const day = (d.getDay() + 6) % 7;
        d.setDate(d.getDate() - day);
        return formatYMD(d); // å‘¨ä¸€æ—¥æœŸ
    }

    function isWithinAppealWindow(dateStr) {
        const policy = (CONFIG.appealPolicy || { windowHours: 48 });
        const end = parseDateLocal(dateStr);
        end.setHours(23, 59, 59, 999);
        const deadline = new Date(end.getTime() + (policy.windowHours || 48) * 3600 * 1000);
        return new Date() <= deadline;
    }

function showAppealForm(preselectIdx=null) {
        const r = DB.get('daily', {})[State.date] || {};
        const list = (r.deductionList || []).filter(d => d.pts > 0);
        // ç”³è¯‰ç­–ç•¥ï¼šæ—¶é—´çª—å£ + æ¯å‘¨æ¬¡æ•°é™åˆ¶ + å»é‡
        if (!isWithinAppealWindow(State.date)) {
            const h = (CONFIG.appealPolicy && CONFIG.appealPolicy.windowHours) || 48;
            alert(`è¶…è¿‡ç”³è¯‰æ—¶é™ï¼šä»…æ”¯æŒ${h}å°æ—¶å†…ç”³è¯‰`);
            return;
        }
        const appealsAll = DB.get('appeals', []);
        const wk = weekKeyOf(State.date);
        const used = appealsAll.filter(a => weekKeyOf(a.date) === wk).length;
        const limit = (CONFIG.appealPolicy && CONFIG.appealPolicy.weeklyLimit) || 2;
        if (used >= limit) {
            alert(`æœ¬å‘¨ç”³è¯‰æ¬¡æ•°å·²è¾¾ä¸Šé™ï¼ˆ${limit}æ¬¡ï¼‰`);
            return;
        }
        if (!list.length) { alert('æ²¡æœ‰å¯ç”³è¯‰çš„æ‰£åˆ†'); return; }
        showModal(`
            <div class="card p-4 w-full max-w-sm" onclick="event.stopPropagation()">
                <h3 class="text-lg font-bold mb-4">ğŸ“ æ‰£åˆ†ç”³è¯‰</h3>
                <select id="appealItem" class="w-full border rounded px-3 py-2 mb-2">
                    ${list.map((d, i) => `<option value="${i}">${d.label} (-${d.pts}åˆ†)</option>`).join('')}
                </select>
                <textarea id="appealReason" class="w-full border rounded px-3 py-2" rows="3" placeholder="ç”³è¯‰ç†ç”±..."></textarea>
                <div class="flex space-x-3 mt-4">
                    <button onclick="hideModal()" class="flex-1 py-3 bg-gray-100 rounded-xl">å–æ¶ˆ</button>
                    <button onclick="submitAppeal()" class="flex-1 py-3 btn-primary rounded-xl">æäº¤</button>
                </div>
            </div>
        `);
    }
    
    function submitAppeal() {
        const idx = parseInt(document.getElementById('appealItem')?.value);
        const reason = document.getElementById('appealReason')?.value?.trim();
        if (!reason) { alert('è¯·å¡«å†™ç†ç”±'); return; }
        const r = DB.get('daily', {})[State.date] || {};
        const item = (r.deductionList || [])[idx];
        if (!item) return;
        const appeals = DB.get('appeals', []);
        appeals.push({ date: State.date, dedIdx: idx, dedLabel: item.label, dedPts: item.pts, reason, resolved: false });
        DB.set('appeals', appeals);
        hideModal();
        alert('ğŸ“¤ ç”³è¯‰å·²æäº¤');
        render();
    }

    // ==================== ä»»åŠ¡é¡µé¢ ====================
    // ==================== PLAN / ç›®æ ‡æ ‘ï¼ˆå¹´æ€»çº²â†’å­£é‡Œç¨‹ç¢‘â†’æœˆå†²åˆºâ†’å‘¨è¡ŒåŠ¨ï¼‰ ====================
    function uid(prefix='id') { return prefix + '_' + Math.random().toString(36).slice(2, 10) + '_' + Date.now().toString(36); }

    function getPlan() { return DB.get('plan', { years: {} }); }
    function savePlan(plan) { DB.set('plan', plan); }

    function ensureYearPlan(year) {
        const plan = getPlan();
        if (!plan.years[year]) plan.years[year] = { objectives: [], quarters: [], months: [] };
        savePlan(plan);
        return plan;
    }
    function getYearPlan(year) {
        const plan = getPlan();
        return plan.years[year] || { objectives: [], quarters: [], months: [] };
    }

    function getMilestoneBonuses() { return DB.get('milestoneBonuses', []); }
    function addMilestoneBonus(entry) {
        const arr = getMilestoneBonuses();
        arr.push(entry);
        DB.set('milestoneBonuses', arr);
    }

    function monthToQuarter(ym) { const m = parseInt(ym.split('-')[1], 10); return Math.ceil(m / 3); }
    function quarterMonths(year, q) {
        const startM = (q - 1) * 3 + 1;
        const pad = (n) => (n < 10 ? '0' + n : '' + n);
        return [ `${year}-${pad(startM)}`, `${year}-${pad(startM+1)}`, `${year}-${pad(startM+2)}` ];
    }

    function calcWeeklyCompletionForMonth(ym, parentMonthId=null) {
        const allTasks = DB.get('tasks', {});
        let denom = 0, numer = 0;
        for (let w = 1; w <= 4; w++) {
            const key = `weekly_${ym}-W${w}`;
            const taskData = allTasks[key] || {};
            CONFIG.subjects.forEach(sub => {
                const t = taskData[sub.key];
                if (!t || !(t.description && t.description.trim())) return;
                if (parentMonthId && t.parentMonthId && t.parentMonthId !== parentMonthId) return;
                denom += 1;
                if (t.confirmed) {
                    if (t.status === 'done') numer += 1;
                    else if (t.status === 'partial') numer += 0.5;
                }
            });
        }
        return denom === 0 ? 0 : numer / denom;
    }

    function attachMonthToWeeks(ym, monthId) {
        if (!requireParent('ä»…å®¶é•¿å¯æ“ä½œ')) return;
        const allTasks = DB.get('tasks', {});
        for (let w = 1; w <= 4; w++) {
            const key = `weekly_${ym}-W${w}`;
            if (!allTasks[key]) continue;
            CONFIG.subjects.forEach(sub => {
                const t = allTasks[key][sub.key];
                if (t && t.description && t.description.trim()) t.parentMonthId = monthId;
            });
        }
        DB.set('tasks', allTasks);
    }

    function currentYear() { return new Date().getFullYear().toString(); }
    State.planYear = State.planYear || currentYear();
    State.planObjectiveId = State.planObjectiveId || null;
    State.planQuarter = State.planQuarter || null; // 1~4
    State.planMonthId = State.planMonthId || null; // æœˆå†²åˆº idï¼ˆç”¨äºå‘¨ä»»åŠ¡å½’å±ï¼‰

    function renderWeekSprintBanner() {
        if (State.role !== 'parent') return '';
        const year = State.planYear || currentYear();
        const yp = getYearPlan(year);
        const obj = yp.objectives.find(o=>o.id===State.planObjectiveId) || null;
        if (!obj) {
            return `<div class="card p-3 mb-4 text-gray-600">
                <div class="font-bold mb-1">æœ¬å‘¨ä»»åŠ¡å¯å…ˆç…§å¸¸è®¾ç½®</div>
                <div class="text-sm">å»ºè®®åœ¨â€œå¹´åº¦æ€»çº²/å­£åº¦/æœˆå†²åˆºâ€å…ˆå»ºç«‹æ€»çº²ä¸åˆ†æ´¾ï¼Œå‘¨ä»»åŠ¡ä¼šè‡ªåŠ¨å½’å±åˆ°æœˆå†²åˆºç”¨äºè¿›åº¦ç»Ÿè®¡ã€‚</div>
                <button onclick="State.taskTab='yearly';render();" class="mt-2 w-full py-2 btn-primary rounded-lg text-sm">å»å»ºç«‹å¹´åº¦æ€»çº²</button>
            </div>`;
        }
        const m = yp.months.find(x=>x.objectiveId===obj.id && x.ym===DB.month()) || null;
        if (!m) {
            return `<div class="card p-3 mb-4 text-gray-600">
                <div class="font-bold mb-1">æœ¬æœˆå°šæœªè®¾ç½®æœˆå†²åˆº</div>
                <div class="text-sm">æœˆå†²åˆºç”¨äºæ‰¿æ¥å­£åº¦é‡Œç¨‹ç¢‘ä¸äº¤ä»˜ç‰©éªŒæ”¶ï¼Œå¹¶åœ¨éªŒæ”¶æ—¶å‘æ”¾ä¸€æ¬¡æ€§å¥–é‡‘ï¼ˆä¸é‡å¤è®¡åˆ†ï¼‰ã€‚</div>
                <button onclick="State.taskTab='monthly';render();" class="mt-2 w-full py-2 btn-primary rounded-lg text-sm">å»è®¾ç½®æœˆå†²åˆº</button>
            </div>`;
        }
        if (!State.planMonthId) State.planMonthId = m.id;
        const prog = calcWeeklyCompletionForMonth(m.ym, m.id);
        const pct = Math.round(prog*100);
        return `<div class="card p-3 mb-4">
            <div class="flex justify-between items-center">
                <div>
                    <div class="text-sm font-bold">å½“å‰å½’å±æœˆå†²åˆºï¼š${m.ym}ï½œ${m.title||'æœˆå†²åˆº'}</div>
                    <div class="text-xs text-gray-500 mt-1">å‘¨ä»»åŠ¡ä¿å­˜æ—¶å°†è‡ªåŠ¨å½’å±åˆ°è¯¥æœˆå†²åˆºï¼Œç”¨äºç»Ÿè®¡æœˆ/å­£/å¹´è¿›åº¦ï¼ˆä¸Šå±‚ä»…éªŒæ”¶å‘å¥–é‡‘ï¼‰ã€‚</div>
                </div>
                <div class="text-right">
                    <div class="text-xs text-gray-500">è¿›åº¦</div>
                    <div class="text-xl font-bold">${pct}%</div>
                </div>
            </div>
            <div class="flex space-x-2 mt-2">
                <button onclick="State.taskTab='monthly';render();" class="flex-1 py-2 bg-purple-100 text-purple-700 rounded-lg text-sm">æŸ¥çœ‹æœˆå†²åˆº</button>
                <button onclick="attachMonthToWeeks('${m.ym}','${m.id}');alert('âœ… å·²å°†æœ¬æœˆå‘¨ä»»åŠ¡ä¸€é”®å½’å±åˆ°è¯¥æœˆå†²åˆº');render();" class="flex-1 py-2 bg-gray-100 rounded-lg text-sm">ä¸€é”®å½’å±</button>
            </div>
        </div>`;
    }

    
    function renderTasks() {
        const tabs = [
            { key: 'weekly', label: 'ğŸ“… å‘¨è¡ŒåŠ¨ï¼ˆå¶å­æ‰§è¡Œï¼‰', desc: '+6Ã—ç³»æ•°/ç§‘' },
            { key: 'monthly', label: 'ğŸš€ æœˆå†²åˆºï¼ˆäº¤ä»˜ç‰©+å¥–é‡‘ï¼‰', desc: 'é‡Œç¨‹ç¢‘å¥–é‡‘ï¼ˆä¸é‡å¤è®¡åˆ†ï¼‰' },
            { key: 'quarterly', label: 'ğŸ—“ï¸ å­£é‡Œç¨‹ç¢‘ï¼ˆåˆ†é˜¶æ®µç»“æœï¼‰', desc: 'é‡Œç¨‹ç¢‘å¥–é‡‘ï¼ˆä¸é‡å¤è®¡åˆ†ï¼‰' },
            { key: 'yearly', label: 'ğŸ¯ å¹´æ€»çº²ï¼ˆç›®æ ‡+KRï¼‰', desc: 'å¹´ç»ˆå¥–é‡‘ï¼ˆæ€»çº²ï¼‰' },
        ];
        
        const now = new Date();
        let periodKey, periodLabel;
        if (State.taskTab === 'weekly') {
            periodKey = `${DB.month()}-W${State.week}`;
            periodLabel = `${now.getMonth()+1}æœˆç¬¬${State.week}å‘¨`;
        } else if (State.taskTab === 'monthly') {
            periodKey = DB.month();
            periodLabel = `${now.getFullYear()}å¹´${now.getMonth()+1}æœˆ`;
        } else if (State.taskTab === 'quarterly') {
            periodKey = `${now.getFullYear()}-Q${DB.quarter()}`;
            periodLabel = `${now.getFullYear()}å¹´Q${DB.quarter()}`;
        } else {
            periodKey = String(now.getFullYear());
            periodLabel = `${now.getFullYear()}å¹´`;
        }

        const allTasks = DB.get('tasks', {});
        const taskKey = `${State.taskTab}_${periodKey}`;
        const taskData = allTasks[taskKey] || {};
        const scores = CONFIG.taskScores[State.taskTab];

        // é¡¶éƒ¨åˆ‡æ¢æ ï¼ˆæ‰€æœ‰è§’è‰²éƒ½æ˜¾ç¤ºï¼‰
        const tabBarHtml = `
            <div class="flex bg-gray-100 rounded-xl p-1 mb-4 overflow-x-auto">
                ${tabs.map(t => `<button onclick="State.taskTab='${t.key}';render();" class="flex-1 py-2 text-xs rounded-lg whitespace-nowrap px-2 ${State.taskTab === t.key ? 'bg-white shadow font-bold text-primary' : 'text-gray-500'}">${t.label}</button>`).join('')}
            </div>`;

        // éå‘¨ä»»åŠ¡ï¼šé‡‡ç”¨"å¹´æ€»çº²â†’å­£é‡Œç¨‹ç¢‘â†’æœˆå†²åˆºâ†’å‘¨è¡ŒåŠ¨"çš„ç›®æ ‡æ ‘ï¼ˆä¸Šå±‚åªå‘å¥–é‡‘ï¼Œé¿å…ä¸å‘¨ä»»åŠ¡é‡å¤è®¡åˆ†ï¼‰
        if (State.taskTab !== 'weekly') {
            if (State.role !== 'parent') {
                return `
                <div class="slide-in">
                    ${tabBarHtml}
                    <div class="card p-4 text-gray-600">
                        <div class="text-4xl text-center mb-3">ğŸ”’</div>
                        <div class="font-bold mb-2 text-center">ä»…å®¶é•¿å¯ç»´æŠ¤"å¹´æ€»çº² / å­£é‡Œç¨‹ç¢‘ / æœˆå†²åˆº"</div>
                        <div class="text-sm text-center mb-4">å­©å­ç«¯åªéœ€è¦ä¸“æ³¨æ‰§è¡Œ"å‘¨è¡ŒåŠ¨"å’Œæ¯æ—¥æ‰“å¡ã€‚è‹¥éœ€è¦è°ƒæ•´æ–¹å‘ï¼Œè¯·ä¸å®¶é•¿åå•†ã€‚</div>
                        <button onclick="State.taskTab='weekly';render();" class="w-full py-3 btn-primary rounded-xl font-medium">ğŸ“… è¿”å›å‘¨è¡ŒåŠ¨</button>
                    </div>
                </div>`;
            }
            if (State.taskTab === 'yearly') return renderPlanYearly();
            if (State.taskTab === 'quarterly') return renderPlanQuarterly();
            return renderPlanMonthly();
        }

        let total = 0;
        CONFIG.subjects.forEach(sub => {
            const t = taskData[sub.key];
            if (t) total += Engine.calcTaskScore(t, State.taskTab);
        });

        return `
        <div class="slide-in">
            <div class="flex bg-gray-100 rounded-xl p-1 mb-4 overflow-x-auto">
                ${tabs.map(t => `<button onclick="State.taskTab='${t.key}';render();" class="flex-1 py-2 text-xs rounded-lg whitespace-nowrap px-2 ${State.taskTab === t.key ? 'bg-white shadow font-bold text-primary' : 'text-gray-500'}">${t.label}</button>`).join('')}
            </div>
            
            ${State.taskTab === 'weekly' ? `
            <div class="flex items-center justify-between mb-4">
                <button onclick="changeWeek(-1)" class="p-2 text-gray-500 text-xl" ${State.week <= 1 ? 'style="opacity:0.3"' : ''}>â—€</button>
                <div class="text-lg font-bold">${periodLabel}</div>
                <button onclick="changeWeek(1)" class="p-2 text-gray-500 text-xl" ${State.week >= 4 ? 'style="opacity:0.3"' : ''}>â–¶</button>
            </div>` : `<div class="text-center text-lg font-bold mb-4">${periodLabel}</div>`}
            
            ${renderWeekSprintBanner()}
            <div class="card p-4 mb-4 text-center" style="background:linear-gradient(135deg,#7c3aed 0%,#a78bfa 100%);color:white">
                <div class="text-sm opacity-80">${tabs.find(t=>t.key===State.taskTab)?.label} æ€»åˆ†</div>
                <div class="text-3xl font-bold">${total >= 0 ? '+' : ''}${total}</div>
                <div class="text-xs opacity-70">å®Œæˆ+${scores.done}Ã—ç³»æ•° | éƒ¨åˆ†+${scores.partial}Ã—ç³»æ•°</div>
            </div>
            
            ${CONFIG.subjects.map(sub => {
                const t = taskData[sub.key] || {};
                const score = Engine.calcTaskScore(t, State.taskTab);
                const diffCfg = CONFIG.difficulties.find(d => d.v === (t.difficulty || 1.0)) || CONFIG.difficulties[0];
                const hasTask = t.description && t.description.trim();
                const hasPending = hasPendingRequest(State.taskTab, periodKey, sub.key);
                const hasChildSubmit = t.childSubmitted && !t.confirmed;
                
                return `
                <div class="card p-4 mb-3 subject-card" style="border-left-color:${sub.color}">
                    <div class="flex justify-between items-center mb-2">
                        <div class="flex items-center space-x-2 flex-wrap gap-1">
                            <span class="text-xl">${sub.icon}</span>
                            <span class="font-bold">${sub.name}</span>
                            ${t.difficulty > 1 ? `<span class="diff-badge ${diffCfg.color}">Ã—${t.difficulty}</span>` : ''}
                            ${hasPending ? '<span class="text-xs bg-yellow-100 text-yellow-700 px-2 py-0.5 rounded">å¾…å®¡æ ¸</span>' : ''}
                            ${hasChildSubmit && State.role === 'parent' ? '<span class="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded pending-pulse">ğŸ“¤å¾…è¯„å®š</span>' : ''}
                        </div>
                        ${t.confirmed ? `<span class="text-sm font-bold ${score >= 0 ? 'text-green-600' : 'text-red-500'}">${score >= 0 ? '+' : ''}${score}</span>` : ''}
                    </div>
                    
                    ${hasTask ? `
                    <div class="bg-gray-50 rounded-lg p-3 mb-2">
                        <div class="font-medium text-sm whitespace-pre-wrap">${t.description}</div>
                        ${t.standard ? `<div class="text-xs text-gray-500 mt-2 pt-2 border-t border-gray-200 whitespace-pre-wrap">ğŸ“‹ éªŒæ”¶æ ‡å‡†: ${t.standard}</div>` : ''}
                    </div>
                    ${t.confirmed ? `
                    <div class="text-sm ${t.status === 'done' ? 'text-green-600' : t.status === 'partial' ? 'text-yellow-600' : 'text-red-600'}">
                        çŠ¶æ€: ${t.status === 'done' ? 'âœ…å®Œæˆ' : t.status === 'partial' ? 'â–³éƒ¨åˆ†' : 'Ã—æœªå®Œæˆ'}
                    </div>` : `
                    ${State.role === 'parent' ? `
                    <div class="flex space-x-2 mt-2">
                        <button onclick="editSubjectTask('${State.taskTab}','${periodKey}','${sub.key}')" class="flex-1 py-2 bg-blue-100 text-blue-700 rounded-lg text-sm">âœï¸ ç¼–è¾‘</button>
                        <button onclick="safeCall('evaluateTask','${State.taskTab}','${periodKey}','${sub.key}')" class="flex-1 py-2 btn-success rounded-lg text-sm">âœ… è¯„å®š</button>
                    </div>` : `
                    <div class="mt-2">
                        ${t.childSubmitted ? `<div class="text-xs text-yellow-600 bg-yellow-50 px-3 py-2 rounded-lg text-center">â³ å·²æäº¤ï¼Œç­‰å¾…å®¶é•¿è¯„å®š</div>` : `<button onclick="submitTaskCompletion('${State.taskTab}','${periodKey}','${sub.key}','${sub.name}')" class="w-full py-2 bg-green-100 text-green-700 rounded-lg text-sm">ğŸ“¤ æäº¤å®ŒæˆæŠ¥å‘Š</button>`}
                    </div>`}`}
                    ` : `
                    <div class="text-gray-400 text-sm mb-2">æš‚æ— ä»»åŠ¡</div>
                    ${State.role === 'child' ? `
                    <button onclick="requestTask('${State.taskTab}','${periodKey}','${sub.key}','${sub.name}')" class="w-full py-2 bg-blue-50 text-blue-600 rounded-lg text-sm">ğŸ“ ç”³è¯·ä»»åŠ¡</button>
                    ` : `
                    <button onclick="editSubjectTask('${State.taskTab}','${periodKey}','${sub.key}')" class="w-full py-2 btn-primary rounded-lg text-sm">â• è®¾ç½®ä»»åŠ¡</button>
                    `}`}
                </div>`;
            }).join('')}
        </div>`;
    }

    // ==================== ç›®æ ‡æ ‘ï¼šå¹´æ€»çº² / å­£é‡Œç¨‹ç¢‘ / æœˆå†²åˆº ====================
    function objectiveProgress(year, objectiveId) {
        const yp = getYearPlan(year);
        const qs = yp.quarters.filter(q => q.objectiveId === objectiveId);
        if (qs.length === 0) return 0;
        let sum = 0;
        qs.forEach(q => {
            sum += quarterProgress(year, objectiveId, q.q);
        });
        return sum / qs.length;
    }

    function quarterProgress(year, objectiveId, qNum) {
        const yp = getYearPlan(year);
        const months = quarterMonths(year, qNum);
        const ms = yp.months.filter(m => m.objectiveId === objectiveId && m.q === qNum && months.includes(m.ym));
        if (ms.length === 0) return 0;
        let sum = 0;
        ms.forEach(m => {
            const p = calcWeeklyCompletionForMonth(m.ym, m.id);
            sum += p;
        });
        return sum / ms.length;
    }

    function showAddObjectiveModal() {
        if (!requireParent('ä»…å®¶é•¿å¯æ“ä½œ')) return;
        const year = State.planYear;
        ensureYearPlan(year);
        showModal(`
            <div class="card p-4 w-full max-w-md" onclick="event.stopPropagation()">
                <h3 class="text-lg font-bold mb-3">ğŸ¯ æ–°å»ºå¹´åº¦æ€»çº²ï¼ˆ${year}ï¼‰</h3>
                <div class="mb-3">
                    <label class="block text-sm text-gray-600 mb-1">ç›®æ ‡æ ‡é¢˜ï¼ˆObjectiveï¼‰</label>
                    <input id="objTitle" class="w-full border rounded px-3 py-2" placeholder="ä¾‹å¦‚ï¼šæ•°å­¦æ ¸å¿ƒèƒ½åŠ›ç³»ç»Ÿæå‡">
                </div>
                <div class="mb-3">
                    <label class="block text-sm text-gray-600 mb-1">é¢†åŸŸ</label>
                    <select id="objDomain" class="w-full border rounded px-3 py-2">
                        <option value="ç»¼åˆ">ç»¼åˆ</option>
                        ${CONFIG.subjects.map(s=>`<option value="${s.name}">${s.name}</option>`).join('')}
                    </select>
                </div>
                <div class="mb-3">
                    <label class="block text-sm text-gray-600 mb-1">å…³é”®æˆæœ KRï¼ˆæ¯è¡Œä¸€æ¡ï¼‰</label>
                    <textarea id="objKRs" class="w-full border rounded px-3 py-2" rows="4" placeholder="ä¾‹å¦‚ï¼š\n- æœŸæœ«è¾¾åˆ°xxåˆ†\n- å®Œæˆxxå¥—é¢˜å¹¶å¤ç›˜\n- è®²è§£xxæ¬¡"></textarea>
                </div>
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">æƒé‡(1~5)</label>
                        <input id="objWeight" type="number" min="1" max="5" value="3" class="w-full border rounded px-3 py-2">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">å¹´ç»ˆå¥–é‡‘</label>
                        <input id="objBonus" type="number" min="0" value="300" class="w-full border rounded px-3 py-2">
                    </div>
                </div>
                <div class="flex space-x-3 mt-4">
                    <button onclick="hideModal()" class="flex-1 py-3 bg-gray-100 rounded-xl">å–æ¶ˆ</button>
                    <button onclick="saveObjective()" class="flex-1 py-3 btn-primary rounded-xl">ä¿å­˜</button>
                </div>
            </div>
        `);
    }

    function saveObjective() {
        if (!requireParent('ä»…å®¶é•¿å¯æ“ä½œ')) return;
        const year = State.planYear;
        const title = document.getElementById('objTitle')?.value?.trim() || '';
        if (!title) return alert('è¯·è¾“å…¥ç›®æ ‡æ ‡é¢˜');
        const domain = document.getElementById('objDomain')?.value || 'ç»¼åˆ';
        const krs = (document.getElementById('objKRs')?.value || '').split('\n').map(s=>s.trim()).filter(Boolean);
        const weight = Math.max(1, Math.min(5, parseInt(document.getElementById('objWeight')?.value || '3', 10)));
        const bonusPoints = Math.max(0, parseInt(document.getElementById('objBonus')?.value || '0', 10));
        showPwdModal('ä¿å­˜å¹´åº¦æ€»çº²éœ€è¦å¯†ç ', () => {
            const plan = ensureYearPlan(year);
            const yp = plan.years[year];
            const obj = { id: uid('obj'), title, domain, krs, weight, bonusPoints, createdAt: new Date().toISOString(), confirmed:false, confirmedAt:null };
            yp.objectives.push(obj);
            // è‡ªåŠ¨ä¸º4ä¸ªå­£åº¦ç”Ÿæˆå ä½é‡Œç¨‹ç¢‘ï¼ˆå¯åœ¨å­£åº¦é¡µå†ç¼–è¾‘ï¼‰
            for (let q=1;q<=4;q++) {
                yp.quarters.push({ id: uid('q'), year, objectiveId: obj.id, q, title: `${obj.title} - Q${q}é‡Œç¨‹ç¢‘`, criteria: [], threshold: 0.8, bonusPoints: 150, confirmed:false, confirmedAt:null });
                const months = quarterMonths(year, q);
                months.forEach(ym=>{
                    yp.months.push({ id: uid('m'), year, objectiveId: obj.id, q, ym, title: `${ym}æœˆå†²åˆº`, deliverable:'', threshold:0.8, bonusPoints:50, confirmed:false, confirmedAt:null });
                });
            }
            savePlan(plan);
            State.planObjectiveId = obj.id;
            hideModal();
            render();
        });
    }

    function renderPlanYearly() {
        const year = State.planYear || currentYear();
        ensureYearPlan(year);
        const yp = getYearPlan(year);

        // é¡¶éƒ¨åˆ‡æ¢æ 
        const tabs = [
            { key: 'weekly', label: 'ğŸ“… å‘¨è¡ŒåŠ¨' },
            { key: 'monthly', label: 'ğŸš€ æœˆå†²åˆº' },
            { key: 'quarterly', label: 'ğŸ—“ï¸ å­£é‡Œç¨‹ç¢‘' },
            { key: 'yearly', label: 'ğŸ¯ å¹´æ€»çº²' },
        ];
        const tabBarHtml = `
            <div class="flex bg-gray-100 rounded-xl p-1 mb-4 overflow-x-auto">
                ${tabs.map(t => `<button onclick="State.taskTab='${t.key}';render();" class="flex-1 py-2 text-xs rounded-lg whitespace-nowrap px-2 ${State.taskTab === t.key ? 'bg-white shadow font-bold text-primary' : 'text-gray-500'}">${t.label}</button>`).join('')}
            </div>`;

        // é»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ªç›®æ ‡
        if (!State.planObjectiveId && yp.objectives.length) State.planObjectiveId = yp.objectives[0].id;

        const objs = yp.objectives.map(o => {
            const p = objectiveProgress(year, o.id);
            const pct = Math.round(p*100);
            return `
            <div class="card p-4 mb-3">
                <div class="flex justify-between items-start">
                    <div>
                        <div class="font-bold text-lg">${o.title}</div>
                        <div class="text-xs text-gray-500 mt-1">é¢†åŸŸï¼š${o.domain}ï½œæƒé‡ï¼š${o.weight}ï½œå¹´ç»ˆå¥–é‡‘ï¼š${o.bonusPoints}</div>
                    </div>
                    <div class="text-right">
                        <div class="text-sm text-gray-500">è¿›åº¦</div>
                        <div class="text-2xl font-bold">${pct}%</div>
                    </div>
                </div>
                ${o.krs && o.krs.length ? `<div class="mt-2 text-sm bg-gray-50 rounded-lg p-3">
                    <div class="text-xs text-gray-500 mb-1">KRï¼š</div>
                    <ul class="list-disc pl-5">${o.krs.slice(0,6).map(k=>`<li>${k.replace(/</g,'&lt;').replace(/>/g,'&gt;')}</li>`).join('')}</ul>
                </div>` : ''}
                <div class="flex space-x-2 mt-3">
                    <button onclick="State.planObjectiveId='${o.id}';State.taskTab='quarterly';render();" class="flex-1 py-2 btn-primary rounded-lg text-sm">è¿›å…¥å­£åº¦åˆ†è§£</button>
                    <button onclick="confirmYearObjective('${o.id}')" class="flex-1 py-2 bg-green-100 text-green-700 rounded-lg text-sm">å¹´ç»ˆéªŒæ”¶å‘å¥–é‡‘</button>
                </div>
                ${o.confirmed ? `<div class="text-xs text-green-600 mt-2">å·²éªŒæ”¶ï¼š${o.confirmedAt || ''}</div>` : ''}
            </div>`;
        }).join('');

        return `
        <div class="slide-in">
            ${tabBarHtml}
            <div class="card p-4 mb-4">
                <div class="flex items-center justify-between mb-2">
                    <div class="font-bold">ğŸ¯ å¹´åº¦æ€»çº²</div>
                    <button onclick="State.taskTab='weekly';render();" class="px-3 py-1 bg-gray-100 rounded-lg text-sm text-gray-600">â† è¿”å›å‘¨è¡ŒåŠ¨</button>
                </div>
                <div class="flex items-center space-x-2">
                    <input value="${year}" onchange="State.planYear=this.value.trim()||currentYear();State.planObjectiveId=null;State.planQuarter=null;State.planMonthId=null;render();" class="border rounded px-2 py-1 w-24 text-sm">
                    <button onclick="showAddObjectiveModal()" class="px-3 py-1 btn-primary rounded-lg text-sm">â• æ–°å»ºæ€»çº²</button>
                </div>
                <div class="text-xs text-gray-500 mt-2">å¹´ä»»åŠ¡ç”¨äºå®šæ–¹å‘ä¸KRã€‚ä¸è¦åƒå‘¨ä»»åŠ¡ä¸€æ ·é€æ¡åŠ åˆ†ï¼›æ‰§è¡Œå¾—åˆ†åœ¨â€œå‘¨è¡ŒåŠ¨â€ï¼Œä¸Šå±‚åªåœ¨éªŒæ”¶æ—¶å‘å¥–é‡‘ã€‚</div>
            </div>
            ${yp.objectives.length ? objs : `<div class="card p-4 text-gray-600">æš‚æ— å¹´åº¦æ€»çº²ã€‚å»ºè®®å…ˆåˆ›å»º 1~3 ä¸ªæ ¸å¿ƒç›®æ ‡ï¼ˆæ¯ä¸ªå« 3~6 æ¡ KRï¼‰ã€‚</div>`}
        </div>`;
    }

    function confirmYearObjective(objId) {
        if (!requireParent('ä»…å®¶é•¿å¯æ“ä½œ')) return;
        const year = State.planYear || currentYear();
        const plan = ensureYearPlan(year);
        const yp = plan.years[year];
        const obj = yp.objectives.find(o=>o.id===objId);
        if (!obj) return;
        // è§„åˆ™ï¼šå››ä¸ªå­£åº¦é‡Œç¨‹ç¢‘å‡å·²éªŒæ”¶
        const qs = yp.quarters.filter(q=>q.objectiveId===objId);
        const ok = qs.length && qs.every(q=>q.confirmed);
        if (!ok) return alert('è¯¥å¹´åº¦æ€»çº²çš„å­£åº¦é‡Œç¨‹ç¢‘å°šæœªå…¨éƒ¨éªŒæ”¶ã€‚å»ºè®®å…ˆå®Œæˆå­£åº¦éªŒæ”¶å†å‘å¹´ç»ˆå¥–é‡‘ã€‚');
        showPwdModal('å¹´ç»ˆéªŒæ”¶éœ€è¦å¯†ç ', () => {
            obj.confirmed = true;
            obj.confirmedAt = DB.today();
            addMilestoneBonus({ id: uid('bonus'), level:'year', refId: obj.id, title: obj.title, points: obj.bonusPoints||0, date: DB.today(), confirmed:true });
            savePlan(plan);
            alert('âœ… å¹´ç»ˆå¥–é‡‘å·²å…¥è´¦');
            render();
        });
    }

    function renderPlanQuarterly() {
        const year = State.planYear || currentYear();
        ensureYearPlan(year);
        const yp = getYearPlan(year);

        // é¡¶éƒ¨åˆ‡æ¢æ 
        const tabs = [
            { key: 'weekly', label: 'ğŸ“… å‘¨è¡ŒåŠ¨' },
            { key: 'monthly', label: 'ğŸš€ æœˆå†²åˆº' },
            { key: 'quarterly', label: 'ğŸ—“ï¸ å­£é‡Œç¨‹ç¢‘' },
            { key: 'yearly', label: 'ğŸ¯ å¹´æ€»çº²' },
        ];
        const tabBarHtml = `
            <div class="flex bg-gray-100 rounded-xl p-1 mb-4 overflow-x-auto">
                ${tabs.map(t => `<button onclick="State.taskTab='${t.key}';render();" class="flex-1 py-2 text-xs rounded-lg whitespace-nowrap px-2 ${State.taskTab === t.key ? 'bg-white shadow font-bold text-primary' : 'text-gray-500'}">${t.label}</button>`).join('')}
            </div>`;

        const objId = State.planObjectiveId || (yp.objectives[0] ? yp.objectives[0].id : null);
        State.planObjectiveId = objId;
        const obj = yp.objectives.find(o=>o.id===objId);

        const objSelector = `
            <select onchange="State.planObjectiveId=this.value;State.planQuarter=null;State.planMonthId=null;render();" class="border rounded px-3 py-2 w-full">
                ${yp.objectives.map(o=>`<option value="${o.id}" ${o.id===objId?'selected':''}>${o.title}</option>`).join('')}
            </select>`;

        if (!obj) {
            return `<div class="slide-in">
                ${tabBarHtml}
                <div class="card p-4 text-gray-600">
                    <div class="text-center mb-4">è¯·å…ˆåœ¨"å¹´åº¦æ€»çº²"åˆ›å»ºè‡³å°‘ä¸€ä¸ªç›®æ ‡ã€‚</div>
                    <button onclick="State.taskTab='yearly';render();" class="w-full py-2 btn-primary rounded-lg">å»åˆ›å»ºå¹´åº¦æ€»çº²</button>
                </div>
            </div>`;
        }

        const cards = [1,2,3,4].map(qNum=>{
            const q = yp.quarters.find(x=>x.objectiveId===objId && x.q===qNum);
            const prog = quarterProgress(year, objId, qNum);
            const pct = Math.round(prog*100);
            return `
            <div class="card p-4 mb-3">
                <div class="flex justify-between items-start">
                    <div>
                        <div class="font-bold">Q${qNum} é‡Œç¨‹ç¢‘</div>
                        <div class="text-sm mt-1">${(q?.title||`Q${qNum} é‡Œç¨‹ç¢‘`).replace(/</g,'&lt;').replace(/>/g,'&gt;')}</div>
                        <div class="text-xs text-gray-500 mt-1">é˜ˆå€¼ï¼š${Math.round((q?.threshold||0.8)*100)}%ï½œå¥–é‡‘ï¼š${q?.bonusPoints||150}</div>
                    </div>
                    <div class="text-right">
                        <div class="text-xs text-gray-500">è¿›åº¦</div>
                        <div class="text-2xl font-bold">${pct}%</div>
                    </div>
                </div>
                <div class="flex space-x-2 mt-3">
                    <button onclick="editQuarterMilestone(${qNum})" class="flex-1 py-2 bg-blue-100 text-blue-700 rounded-lg text-sm">âœï¸ ç¼–è¾‘é‡Œç¨‹ç¢‘</button>
                    <button onclick="State.planQuarter=${qNum};State.taskTab='monthly';render();" class="flex-1 py-2 btn-primary rounded-lg text-sm">è¿›å…¥æœˆå†²åˆº</button>
                    <button onclick="confirmQuarterMilestone(${qNum})" class="flex-1 py-2 bg-green-100 text-green-700 rounded-lg text-sm">éªŒæ”¶å‘å¥–é‡‘</button>
                </div>
                ${(q&&q.confirmed) ? `<div class="text-xs text-green-600 mt-2">å·²éªŒæ”¶ï¼š${q.confirmedAt||''}</div>` : ''}
            </div>`;
        }).join('');

        return `
        <div class="slide-in">
            ${tabBarHtml}
            <div class="card p-4 mb-4">
                <div class="flex items-center justify-between mb-2">
                    <div class="font-bold">ğŸ—“ï¸ å­£åº¦é‡Œç¨‹ç¢‘</div>
                    <button onclick="State.taskTab='weekly';render();" class="px-3 py-1 bg-gray-100 rounded-lg text-sm text-gray-600">â† è¿”å›å‘¨è¡ŒåŠ¨</button>
                </div>
                ${objSelector}
                <div class="text-xs text-gray-500 mt-2">å­£åº¦ä¸æŒ‰â€œæ¯ç§‘ä»»åŠ¡â€åŠ åˆ†ï¼›ä¸»è¦åœ¨æœˆå†²åˆºæ¨è¿›ï¼Œå­£åº¦éªŒæ”¶é€šè¿‡åä¸€æ¬¡æ€§å‘æ”¾å¥–é‡‘ã€‚</div>
            </div>
            ${cards}
        </div>`;
    }

    function editQuarterMilestone(qNum) {
        if (!requireParent('ä»…å®¶é•¿å¯æ“ä½œ')) return;
        const year = State.planYear || currentYear();
        const plan = ensureYearPlan(year);
        const yp = plan.years[year];
        const objId = State.planObjectiveId;
        const q = yp.quarters.find(x=>x.objectiveId===objId && x.q===qNum);
        if (!q) return;
        showModal(`
            <div class="card p-4 w-full max-w-md" onclick="event.stopPropagation()">
                <h3 class="text-lg font-bold mb-3">âœï¸ ç¼–è¾‘ Q${qNum} é‡Œç¨‹ç¢‘</h3>
                <div class="mb-3">
                    <label class="block text-sm text-gray-600 mb-1">é‡Œç¨‹ç¢‘æ ‡é¢˜</label>
                    <input id="qTitle" class="w-full border rounded px-3 py-2" value="${(q.title||'').replace(/"/g,'&quot;')}">
                </div>
                <div class="mb-3">
                    <label class="block text-sm text-gray-600 mb-1">éªŒæ”¶è¦ç‚¹ï¼ˆæ¯è¡Œä¸€æ¡ï¼‰</label>
                    <textarea id="qCriteria" class="w-full border rounded px-3 py-2" rows="4">${(q.criteria||[]).join('\n')}</textarea>
                </div>
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">é˜ˆå€¼(0.5~1.0)</label>
                        <input id="qThr" type="number" min="0.5" max="1" step="0.05" value="${q.threshold||0.8}" class="w-full border rounded px-3 py-2">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">å­£åº¦å¥–é‡‘</label>
                        <input id="qBonus" type="number" min="0" value="${q.bonusPoints||150}" class="w-full border rounded px-3 py-2">
                    </div>
                </div>
                <div class="flex space-x-3 mt-4">
                    <button onclick="hideModal()" class="flex-1 py-3 bg-gray-100 rounded-xl">å–æ¶ˆ</button>
                    <button onclick="saveQuarterMilestone(${qNum})" class="flex-1 py-3 btn-primary rounded-xl">ä¿å­˜</button>
                </div>
            </div>
        `);
    }

    function saveQuarterMilestone(qNum) {
        if (!requireParent('ä»…å®¶é•¿å¯æ“ä½œ')) return;
        const year = State.planYear || currentYear();
        showPwdModal('ä¿å­˜é‡Œç¨‹ç¢‘éœ€è¦å¯†ç ', () => {
            const plan = ensureYearPlan(year);
            const yp = plan.years[year];
            const objId = State.planObjectiveId;
            const q = yp.quarters.find(x=>x.objectiveId===objId && x.q===qNum);
            if (!q) return;
            q.title = document.getElementById('qTitle')?.value?.trim() || q.title;
            q.criteria = (document.getElementById('qCriteria')?.value||'').split('\n').map(s=>s.trim()).filter(Boolean);
            q.threshold = Math.max(0.5, Math.min(1.0, parseFloat(document.getElementById('qThr')?.value || '0.8')));
            q.bonusPoints = Math.max(0, parseInt(document.getElementById('qBonus')?.value || '0', 10));
            savePlan(plan);
            hideModal();
            alert('âœ… å·²ä¿å­˜');
            render();
        });
    }

    function confirmQuarterMilestone(qNum) {
        if (!requireParent('ä»…å®¶é•¿å¯æ“ä½œ')) return;
        const year = State.planYear || currentYear();
        const plan = ensureYearPlan(year);
        const yp = plan.years[year];
        const objId = State.planObjectiveId;
        const q = yp.quarters.find(x=>x.objectiveId===objId && x.q===qNum);
        if (!q) return;

        // è§„åˆ™ï¼šè¯¥å­£åº¦çš„3ä¸ªæœˆå†²åˆºå‡å·²éªŒæ”¶ï¼›ä¸”å¹³å‡è¿›åº¦è¾¾åˆ°é˜ˆå€¼
        const months = quarterMonths(year, qNum);
        const ms = yp.months.filter(m=>m.objectiveId===objId && m.q===qNum && months.includes(m.ym));
        const allConfirmed = ms.length && ms.every(m=>m.confirmed);
        const prog = quarterProgress(year, objId, qNum);
        if (!allConfirmed) return alert('æœ¬å­£åº¦çš„æœˆå†²åˆºå°šæœªå…¨éƒ¨éªŒæ”¶ã€‚å»ºè®®å…ˆå®Œæˆæœˆå†²åˆºéªŒæ”¶ã€‚');
        if (prog < (q.threshold||0.8)) return alert(`å­£åº¦å¹³å‡å®Œæˆç‡ ${Math.round(prog*100)}% æœªè¾¾åˆ°é˜ˆå€¼ ${Math.round((q.threshold||0.8)*100)}%`);
        showPwdModal('å­£åº¦éªŒæ”¶éœ€è¦å¯†ç ', () => {
            q.confirmed = true;
            q.confirmedAt = DB.today();
            addMilestoneBonus({ id: uid('bonus'), level:'quarter', refId: q.id, title: q.title, points: q.bonusPoints||0, date: DB.today(), confirmed:true });
            savePlan(plan);
            alert('âœ… å­£åº¦å¥–é‡‘å·²å…¥è´¦');
            render();
        });
    }

    function renderPlanMonthly() {
        const year = State.planYear || currentYear();
        ensureYearPlan(year);
        const yp = getYearPlan(year);

        // é¡¶éƒ¨åˆ‡æ¢æ 
        const tabs = [
            { key: 'weekly', label: 'ğŸ“… å‘¨è¡ŒåŠ¨' },
            { key: 'monthly', label: 'ğŸš€ æœˆå†²åˆº' },
            { key: 'quarterly', label: 'ğŸ—“ï¸ å­£é‡Œç¨‹ç¢‘' },
            { key: 'yearly', label: 'ğŸ¯ å¹´æ€»çº²' },
        ];
        const tabBarHtml = `
            <div class="flex bg-gray-100 rounded-xl p-1 mb-4 overflow-x-auto">
                ${tabs.map(t => `<button onclick="State.taskTab='${t.key}';render();" class="flex-1 py-2 text-xs rounded-lg whitespace-nowrap px-2 ${State.taskTab === t.key ? 'bg-white shadow font-bold text-primary' : 'text-gray-500'}">${t.label}</button>`).join('')}
            </div>`;

        const objId = State.planObjectiveId || (yp.objectives[0] ? yp.objectives[0].id : null);
        State.planObjectiveId = objId;
        const obj = yp.objectives.find(o=>o.id===objId);
        if (!obj) return `<div class="slide-in">${tabBarHtml}<div class="card p-4 text-gray-600">è¯·å…ˆåˆ›å»ºå¹´åº¦æ€»çº²ã€‚<button onclick="State.taskTab='yearly';render();" class="block mt-2 w-full py-2 btn-primary rounded-lg">å»åˆ›å»ºå¹´åº¦æ€»çº²</button></div></div>`;

        const qNum = State.planQuarter || monthToQuarter(DB.month());
        State.planQuarter = qNum;
        const months = quarterMonths(year, qNum);
        const ms = months.map(ym => yp.months.find(m=>m.objectiveId===objId && m.q===qNum && m.ym===ym)).filter(Boolean);

        const cards = ms.map(m => {
            const prog = calcWeeklyCompletionForMonth(m.ym, m.id);
            const pct = Math.round(prog*100);
            const isCurrent = (m.ym === DB.month());
            return `
            <div class="card p-4 mb-3 ${isCurrent ? 'ring-2 ring-purple-200' : ''}">
                <div class="flex justify-between items-start">
                    <div>
                        <div class="font-bold">${m.ym} æœˆå†²åˆº</div>
                        <div class="text-sm mt-1">${(m.title||'').replace(/</g,'&lt;').replace(/>/g,'&gt;')}</div>
                        <div class="text-xs text-gray-500 mt-1">é˜ˆå€¼ï¼š${Math.round((m.threshold||0.8)*100)}%ï½œå¥–é‡‘ï¼š${m.bonusPoints||50}</div>
                    </div>
                    <div class="text-right">
                        <div class="text-xs text-gray-500">è¿›åº¦</div>
                        <div class="text-2xl font-bold">${pct}%</div>
                    </div>
                </div>
                <div class="mt-2 bg-gray-50 rounded-lg p-3">
                    <div class="text-xs text-gray-500 mb-1">äº¤ä»˜ç‰©ï¼ˆç”¨äºéªŒæ”¶ï¼Œä¸ä¸å‘¨ä»»åŠ¡é‡å¤è®¡åˆ†ï¼‰ï¼š</div>
                    <div class="text-sm whitespace-pre-wrap">${(m.deliverable||'ï¼ˆæœªå¡«å†™ï¼‰').replace(/</g,'&lt;').replace(/>/g,'&gt;')}</div>
                </div>
                <div class="grid grid-cols-2 gap-2 mt-3">
                    <button onclick="editMonthSprint('${m.id}')" class="py-2 bg-blue-100 text-blue-700 rounded-lg text-sm">âœï¸ ç¼–è¾‘å†²åˆº</button>
                    <button onclick="setActiveMonthSprint('${m.id}','${m.ym}')" class="py-2 btn-primary rounded-lg text-sm">è®¾ä¸ºæœ¬æœˆæ‰§è¡Œ</button>
                    <button onclick="attachMonthToWeeks('${m.ym}','${m.id}');State.planMonthId='${m.id}';alert('âœ… å·²å°†è¯¥æœˆå‘¨ä»»åŠ¡å½’å±åˆ°æœ¬å†²åˆº');render();" class="py-2 bg-purple-100 text-purple-700 rounded-lg text-sm">å½’å±å‘¨ä»»åŠ¡</button>
                    <button onclick="confirmMonthSprint('${m.id}')" class="py-2 bg-green-100 text-green-700 rounded-lg text-sm">éªŒæ”¶å‘å¥–é‡‘</button>
                </div>
                ${m.confirmed ? `<div class="text-xs text-green-600 mt-2">å·²éªŒæ”¶ï¼š${m.confirmedAt||''}</div>` : ''}
            </div>`;
        }).join('');

        return `
        <div class="slide-in">
            ${tabBarHtml}
            <div class="card p-4 mb-4">
                <div class="font-bold mb-2">ğŸš€ æœˆå†²åˆºï¼ˆæŠŠå­£åº¦é‡Œç¨‹ç¢‘è½åˆ°å¯äº¤ä»˜æˆæœï¼‰</div>
                <div class="text-sm text-gray-700 mb-2">ç›®æ ‡ï¼š${obj.title}</div>
                <div class="flex space-x-2">
                    <button onclick="State.taskTab='quarterly';render();" class="flex-1 py-2 bg-gray-100 rounded-lg text-sm">è¿”å›å­£åº¦</button>
                    <button onclick="State.taskTab='weekly';render();" class="flex-1 py-2 btn-primary rounded-lg text-sm">å»æ‰§è¡Œå‘¨è¡ŒåŠ¨</button>
                </div>
                <div class="text-xs text-gray-500 mt-2">æç¤ºï¼šå‘¨è¡ŒåŠ¨å¾—åˆ†æ¥è‡ªæ¯ç§‘ä»»åŠ¡ï¼›æœˆå†²åˆºåªåœ¨éªŒæ”¶é€šè¿‡æ—¶å‘ä¸€æ¬¡æ€§å¥–é‡‘ï¼Œç”¨äºä½“ç°â€œäº¤ä»˜ç‰©å®Œæˆâ€ã€‚</div>
            </div>
            ${cards}
        </div>`;
    }

    function setActiveMonthSprint(monthId, ym) {
        if (!requireParent('ä»…å®¶é•¿å¯æ“ä½œ')) return;
        State.planMonthId = monthId;
        // ä¸ºäº†å‡å°‘è¯¯æ“ä½œï¼Œåªåœ¨å½“å‰æœˆä¸€è‡´æ—¶è‡ªåŠ¨å½’å±åç»­ä¿å­˜çš„å‘¨ä»»åŠ¡
        if (ym === DB.month()) {
            alert('âœ… å·²è®¾ä¸ºæœ¬æœˆæ‰§è¡Œå†²åˆºï¼šåç»­ä¿å­˜å‘¨ä»»åŠ¡ä¼šè‡ªåŠ¨å½’å±åˆ°è¯¥å†²åˆºï¼ˆå¯åœ¨æœˆå†²åˆºé¡µâ€œå½’å±å‘¨ä»»åŠ¡â€ä¸€é”®è¡¥é½ï¼‰ã€‚');
        } else {
            alert('âœ… å·²è®¾ç½®ã€‚æ³¨æ„ï¼šå½“å‰ä¸æ˜¯æœ¬æœˆï¼Œå‘¨ä»»åŠ¡è‡ªåŠ¨å½’å±åªå¯¹æœ¬æœˆç”Ÿæ•ˆã€‚');
        }
        render();
    }

    function editMonthSprint(monthId) {
        if (!requireParent('ä»…å®¶é•¿å¯æ“ä½œ')) return;
        const year = State.planYear || currentYear();
        const plan = ensureYearPlan(year);
        const yp = plan.years[year];
        const m = yp.months.find(x=>x.id===monthId);
        if (!m) return;
        showModal(`
            <div class="card p-4 w-full max-w-md" onclick="event.stopPropagation()">
                <h3 class="text-lg font-bold mb-3">âœï¸ ç¼–è¾‘ ${m.ym} æœˆå†²åˆº</h3>
                <div class="mb-3">
                    <label class="block text-sm text-gray-600 mb-1">å†²åˆºæ ‡é¢˜</label>
                    <input id="mTitle" class="w-full border rounded px-3 py-2" value="${(m.title||'').replace(/"/g,'&quot;')}">
                </div>
                <div class="mb-3">
                    <label class="block text-sm text-gray-600 mb-1">äº¤ä»˜ç‰©æè¿°ï¼ˆè¶Šå…·ä½“è¶Šå®¹æ˜“éªŒæ”¶ï¼‰</label>
                    <textarea id="mDel" class="w-full border rounded px-3 py-2" rows="4">${(m.deliverable||'')}</textarea>
                </div>
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">é˜ˆå€¼(0.5~1.0)</label>
                        <input id="mThr" type="number" min="0.5" max="1" step="0.05" value="${m.threshold||0.8}" class="w-full border rounded px-3 py-2">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">æœˆå¥–é‡‘</label>
                        <input id="mBonus" type="number" min="0" value="${m.bonusPoints||50}" class="w-full border rounded px-3 py-2">
                    </div>
                </div>
                <div class="flex space-x-3 mt-4">
                    <button onclick="hideModal()" class="flex-1 py-3 bg-gray-100 rounded-xl">å–æ¶ˆ</button>
                    <button onclick="saveMonthSprint('${monthId}')" class="flex-1 py-3 btn-primary rounded-xl">ä¿å­˜</button>
                </div>
            </div>
        `);
    }

    function saveMonthSprint(monthId) {
        if (!requireParent('ä»…å®¶é•¿å¯æ“ä½œ')) return;
        const year = State.planYear || currentYear();
        showPwdModal('ä¿å­˜æœˆå†²åˆºéœ€è¦å¯†ç ', () => {
            const plan = ensureYearPlan(year);
            const yp = plan.years[year];
            const m = yp.months.find(x=>x.id===monthId);
            if (!m) return;
            m.title = document.getElementById('mTitle')?.value?.trim() || m.title;
            m.deliverable = document.getElementById('mDel')?.value?.trim() || '';
            m.threshold = Math.max(0.5, Math.min(1.0, parseFloat(document.getElementById('mThr')?.value || '0.8')));
            m.bonusPoints = Math.max(0, parseInt(document.getElementById('mBonus')?.value || '0', 10));
            savePlan(plan);
            hideModal();
            alert('âœ… å·²ä¿å­˜');
            render();
        });
    }

    function confirmMonthSprint(monthId) {
        if (!requireParent('ä»…å®¶é•¿å¯æ“ä½œ')) return;
        const year = State.planYear || currentYear();
        const plan = ensureYearPlan(year);
        const yp = plan.years[year];
        const m = yp.months.find(x=>x.id===monthId);
        if (!m) return;
        const prog = calcWeeklyCompletionForMonth(m.ym, m.id);
        if (!(m.deliverable && m.deliverable.trim())) return alert('è¯·å…ˆå¡«å†™æœˆå†²åˆºäº¤ä»˜ç‰©æè¿°ï¼Œå†è¿›è¡ŒéªŒæ”¶ã€‚');
        if (prog < (m.threshold||0.8)) return alert(`æœ¬æœˆå‘¨è¡ŒåŠ¨å®Œæˆç‡ ${Math.round(prog*100)}% æœªè¾¾åˆ°é˜ˆå€¼ ${Math.round((m.threshold||0.8)*100)}%`);
        showPwdModal('æœˆå†²åˆºéªŒæ”¶éœ€è¦å¯†ç ', () => {
            m.confirmed = true;
            m.confirmedAt = DB.today();
            addMilestoneBonus({ id: uid('bonus'), level:'month', refId: m.id, title: `${m.ym}æœˆå†²åˆº`, points: m.bonusPoints||0, date: DB.today(), confirmed:true });
            savePlan(plan);
            alert('âœ… æœˆå¥–é‡‘å·²å…¥è´¦');
            render();
        });
    }


    function changeWeek(d) {
        const nw = State.week + d;
        if (nw >= 1 && nw <= 4) { State.week = nw; render(); }
    }

    function hasPendingRequest(type, periodKey, subjectKey) {
        const requests = DB.get('taskRequests', []);
        return requests.some(r => !r.resolved && r.type === type && r.periodKey === periodKey && r.subjectKey === subjectKey);
    }

    function requestTask(type, periodKey, subjectKey, subjectName) {
        showModal(`
            <div class="card p-4 w-full max-w-md" onclick="event.stopPropagation()">
                <h3 class="text-lg font-bold mb-4">ğŸ“ ç”³è¯·${subjectName}ä»»åŠ¡</h3>
                
                <!-- é«˜éš¾åº¦æç¤ºåŒºåŸŸï¼ˆåŠ¨æ€æ˜¾ç¤ºï¼‰ -->
                <div id="reqHighDiffWarning" class="hidden bg-orange-100 text-orange-700 text-sm p-3 rounded-lg mb-4">
                    <div class="font-medium">âš ï¸ é«˜éš¾åº¦ä»»åŠ¡æç¤º</div>
                    <div id="reqHighDiffText" class="text-xs mt-1"></div>
                </div>
                
                <div class="mb-3">
                    <label class="block text-sm text-gray-600 mb-1">ä»»åŠ¡æè¿°ï¼ˆæˆ‘æƒ³å®Œæˆä»€ä¹ˆï¼‰</label>
                    <textarea id="reqDesc" class="w-full border rounded px-3 py-2 text-sm" rows="4" placeholder="è¯¦ç»†æè¿°ä»»åŠ¡å†…å®¹."></textarea>
                </div>
                <div class="mb-3">
                    <label class="block text-sm text-gray-600 mb-1">éªŒæ”¶æ ‡å‡†ï¼ˆæ€æ ·ç®—å®Œæˆï¼‰</label>
                    <textarea id="reqStd" class="w-full border rounded px-3 py-2 text-sm" rows="3" placeholder="æ˜ç¡®çš„éªŒæ”¶æ ‡å‡†."></textarea>
                </div>

                
                <div class="mb-3">
                    <label class="block text-sm text-gray-600 mb-2">éš¾åº¦æ ‡å‡†åŒ–ï¼ˆå››å› å­æ¨¡å‹è‡ªåŠ¨å»ºè®®ï¼Œå¯æ‰‹åŠ¨è¦†ç›–ï¼‰</label>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div>
                            <div class="text-xs text-gray-500 mb-1">ä»»åŠ¡ç±»å‹ï¼ˆç±»å‹ç³»æ•°ï¼‰</div>
                            <select id="reqType" class="w-full border rounded px-3 py-2" onchange="applyTaskTypeToDiff('reqType','reqDiff','reqTypeHint');checkReqHighDiff()">
                                ${(CONFIG.taskTypes||[]).map(tt => `<option value="${tt.key}">${tt.label}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <div class="text-xs text-gray-500 mb-1">é¢„è®¡æ—¶é•¿ï¼ˆæ—¶é•¿ç³»æ•°ï¼‰</div>
                            <select id="reqDur" class="w-full border rounded px-3 py-2" onchange="applyTaskTypeToDiff('reqType','reqDiff','reqTypeHint');checkReqHighDiff()">
                                ${(CONFIG.durationFactors||[]).map(d => `<option value="${d.key}" ${d.key==='m15_30' ? 'selected' : ''}>${d.label}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <div class="text-xs text-gray-500 mb-1">è¯æ®ç±»å‹ï¼ˆè¯æ®ç³»æ•°ï¼‰</div>
                            <select id="reqEvi" class="w-full border rounded px-3 py-2" onchange="applyTaskTypeToDiff('reqType','reqDiff','reqTypeHint');checkReqHighDiff()">
                                ${(CONFIG.evidenceFactors||[]).map(e => `<option value="${e.key}" ${e.key==='oral' ? 'selected' : ''}>${e.label}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <div class="text-xs text-gray-500 mb-1">æ–°é¢–åº¦ï¼ˆæ–°é¢–åº¦ç³»æ•°ï¼‰</div>
                            <select id="reqNov" class="w-full border rounded px-3 py-2" onchange="applyTaskTypeToDiff('reqType','reqDiff','reqTypeHint');checkReqHighDiff()">
                                ${(CONFIG.noveltyFactors||[]).map(n => `<option value="${n.key}" ${n.key==='normal' ? 'selected' : ''}>${n.label}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                    <div id="reqTypeHint" class="text-xs text-gray-600 mt-2"></div>
                    <button onclick="applyTaskTypeToDiff('reqType','reqDiff','reqTypeHint');checkReqHighDiff()" class="mt-2 w-full py-2 bg-gray-50 rounded-lg text-sm text-gray-700">æŒ‰å››å› å­åˆ·æ–°å»ºè®®å€æ•°</button>
                </div>


                <div class="mb-3">
                    <label class="block text-sm text-gray-600 mb-1">éš¾åº¦ç³»æ•°ï¼ˆè‡ªåŠ¨è®¡ç®—ï¼Œå®¶é•¿å®¡æ ¸å¯è°ƒæ•´ï¼‰</label>
                    <select id="reqDiff" disabled class="w-full border rounded px-3 py-2" onchange="checkReqHighDiff()">
                        ${CONFIG.difficulties.map(d => `<option value="${d.v}">${d.label} Ã—${d.v}</option>`).join('')}
                    </select>
                    <div class="text-xs text-gray-400 mt-1">æç¤ºï¼šè¿™é‡Œä¸èƒ½æ‰‹åŠ¨é€‰æ‹©å€æ•°ï¼›è¯·é€šè¿‡ä¸Šé¢çš„â€œå››å› å­â€é€‰æ‹©è‡ªåŠ¨è®¡ç®—ã€‚æœ€ç»ˆå€æ•°ç”±å®¶é•¿å®¡æ ¸æ—¶ç¡®è®¤ã€‚</div>
                </div>

                <div class="mb-3">
                    <label class="block text-sm text-gray-600 mb-1">ä¸ºä»€ä¹ˆæƒ³åšè¿™ä¸ªä»»åŠ¡ï¼Ÿ</label>
                    <textarea id="reqReason" class="w-full border rounded px-3 py-2 text-sm" rows="2" placeholder="ç†ç”±."></textarea>
                </div>
                <div class="flex space-x-3 mt-4">
                    <button onclick="hideModal()" class="flex-1 py-3 bg-gray-100 rounded-xl">å–æ¶ˆ</button>
                    <button onclick="submitTaskRequest('${type}','${periodKey}','${subjectKey}','${subjectName}')" class="flex-1 py-3 btn-primary rounded-xl">æäº¤</button>
                </div>
            </div>
        `);
        setTimeout(() => { applyTaskTypeToDiff('reqType','reqDiff','reqTypeHint'); checkReqHighDiff(); }, 50);
    }

    // æ£€æŸ¥å­©å­ç”³è¯·ä»»åŠ¡æ—¶çš„é«˜éš¾åº¦æç¤º
    function checkReqHighDiff() {
        const diff = parseFloat(document.getElementById('reqDiff')?.value) || 1.0;
        const evi = document.getElementById('reqEvi')?.value || 'oral';
        const warnEl = document.getElementById('reqHighDiffWarning');
        const textEl = document.getElementById('reqHighDiffText');
        if (!warnEl || !textEl) return;
        
        let warnings = [];
        
        if (diff >= 1.8 && ['none', 'oral'].includes(evi)) {
            warnings.push('éš¾åº¦ç³»æ•°â‰¥1.8æ—¶ï¼Œå¿…é¡»æä¾›å®è´¨è¯æ®ï¼ˆç…§ç‰‡/è§†é¢‘/ä½œå“ç­‰ï¼‰ï¼Œä»…å£å¤´è¯´æ˜ä¼šè¢«å®¶é•¿æ‹’ç»');
        }
        if (diff >= 2.5) {
            warnings.push('éš¾åº¦ç³»æ•°â‰¥2.5æ˜¯"è¶…é«˜éš¾åº¦"ï¼Œå®¶é•¿å®¡æ‰¹æ—¶ä¼šè¦æ±‚äºŒæ¬¡ç¡®è®¤ï¼Œè¯·ç¡®ä¿ä»»åŠ¡çœŸçš„å¾ˆéš¾');
        }
        
        if (warnings.length > 0) {
            warnEl.classList.remove('hidden');
            textEl.innerHTML = warnings.map(w => `â€¢ ${w}`).join('<br>');
        } else {
            warnEl.classList.add('hidden');
        }
    }


    function submitTaskRequest(type, periodKey, subjectKey, subjectName) {
        const desc = document.getElementById('reqDesc')?.value?.trim();
        if (!desc) { alert('è¯·å¡«å†™ä»»åŠ¡æè¿°'); return; }
        const requests = DB.get('taskRequests', []);
        requests.push({
            type, periodKey, subjectKey, subjectName,
            description: desc,
            standard: document.getElementById('reqStd')?.value?.trim(),
            suggestedType: document.getElementById('reqType')?.value || 'practice',
            suggestedDur: document.getElementById('reqDur')?.value || 'm15_30',
            suggestedEvi: document.getElementById('reqEvi')?.value || 'oral',
            suggestedNov: document.getElementById('reqNov')?.value || 'normal',
            suggestedCoeffRaw: (function(){ 
                const model = calcDifficultyModel(
                    document.getElementById('reqType')?.value || 'practice',
                    document.getElementById('reqDur')?.value || 'm15_30',
                    document.getElementById('reqEvi')?.value || 'oral',
                    document.getElementById('reqNov')?.value || 'normal'
                );
                return model.raw;
            })(),
            suggestedDiff: parseFloat(document.getElementById('reqDiff')?.value) || 1.0,
            reason: document.getElementById('reqReason')?.value?.trim(),
            resolved: false,
            createdAt: new Date().toISOString()
        });
        DB.set('taskRequests', requests);
        hideModal();
        alert('ğŸ“¤ ä»»åŠ¡ç”³è¯·å·²æäº¤ï¼Œç­‰å¾…å®¶é•¿å®¡æ ¸');
        render();
    }

    // å°å­©æäº¤ä»»åŠ¡å®ŒæˆæŠ¥å‘Š
    function submitTaskCompletion(type, periodKey, subjectKey, subjectName) {
        const allTasks = DB.get('tasks', {});
        const taskKey = `${type}_${periodKey}`;
        const taskData = allTasks[taskKey] || {};
        const t = taskData[subjectKey] || {};
        
        showModal(`
            <div class="card p-4 w-full max-w-md" onclick="event.stopPropagation()">
                <h3 class="text-lg font-bold mb-4">ğŸ“¤ æäº¤${subjectName}å®ŒæˆæŠ¥å‘Š</h3>
                <div class="bg-gray-50 rounded-lg p-3 mb-3">
                    <div class="text-sm font-medium">ä»»åŠ¡ï¼š</div>
                    <div class="text-sm text-gray-700 whitespace-pre-wrap">${(t.description || 'æ— æè¿°').replace(/</g,'&lt;').replace(/>/g,'&gt;')}</div>
                    ${t.standard ? `<div class="text-xs text-gray-500 mt-2 pt-2 border-t border-gray-200">éªŒæ”¶æ ‡å‡†ï¼š${t.standard.replace(/</g,'&lt;').replace(/>/g,'&gt;')}</div>` : ''}
                </div>
                <div class="mb-3">
                    <label class="block text-sm text-gray-600 mb-1">å®Œæˆæƒ…å†µï¼ˆè‡ªè¯„ï¼‰</label>
                    <select id="completionStatus" class="w-full border rounded px-3 py-2">
                        <option value="done">âœ… å·²å®Œæˆ</option>
                        <option value="partial">â–³ éƒ¨åˆ†å®Œæˆ</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="block text-sm text-gray-600 mb-1">å®Œæˆè¯´æ˜ï¼ˆå¯é€‰ï¼‰</label>
                    <textarea id="completionNote" class="w-full border rounded px-3 py-2 text-sm" rows="3" placeholder="æè¿°ä½ å®Œæˆçš„æƒ…å†µï¼Œé‡åˆ°çš„å›°éš¾ç­‰..."></textarea>
                </div>
                <div class="mb-3">
                    <label class="block text-sm text-gray-600 mb-1">è¯æ®ï¼ˆå¯é€‰ï¼šç…§ç‰‡/è§†é¢‘/éŸ³é¢‘/é“¾æ¥/è¯´æ˜ï¼‰</label>
                    <textarea id="completionEvidenceText" class="w-full border rounded px-3 py-2 text-sm mb-2" rows="2" placeholder="è¡¥å……è¯´æ˜ï¼šåšäº†ä»€ä¹ˆã€æ€ä¹ˆåšçš„ã€å…³é”®è¦ç‚¹..."></textarea>
                    <input id="completionEvidenceLink" class="w-full border rounded px-3 py-2 text-sm mb-2" placeholder="å¯ç²˜è´´é“¾æ¥ï¼ˆå¤šä¸ªç”¨é€—å·æˆ–æ¢è¡Œåˆ†éš”ï¼‰" />
                    <input id="completionEvidenceWechat" class="w-full border rounded px-3 py-2 text-sm mb-2" placeholder="ä¹Ÿå¯è®©å­©å­æŠŠç…§ç‰‡/è§†é¢‘å‘å¾®ä¿¡ç¾¤ï¼šåœ¨è¿™é‡Œå¡«â€˜å·²å‘å¾®ä¿¡ç¾¤ + å…³é”®è¯/ç®€è¿°â€™ä¾¿äºæ£€ç´¢" />
                    <button type="button" onclick="copyWeChatEvidenceTemplate('${subjectName}')" class="w-full border rounded px-3 py-2 text-sm bg-gray-50 mb-2">å¤åˆ¶å¾®ä¿¡ç¾¤æ¶ˆæ¯æ¨¡æ¿</button>
                    <div class="flex gap-2 items-center">
                        <input id="completionEvidenceFiles" type="file" class="hidden" multiple accept="image/*,video/*,audio/*" />
                        <button type="button" onclick="triggerEvidencePick('completionEvidenceFiles')" class="w-full border rounded px-3 py-2 text-sm bg-gray-50">é€‰æ‹©/æ·»åŠ é™„ä»¶ï¼ˆå¯å¤šæ¬¡æ·»åŠ ï¼‰</button>
                    </div>
                    <div id="completionEvidenceFiles_list" class="mt-2 space-y-1"></div>
                    <div class="text-xs text-gray-400 mt-1">æ‰‹æœºç«¯ç‚¹â€œé€‰æ‹©æ–‡ä»¶â€é€šå¸¸ä¼šå‡ºç°â€œæ‹ç…§/å½•åƒ/ç›¸å†Œâ€ç­‰é€‰é¡¹ï¼›å¤§è§†é¢‘å°†å­˜åˆ°æœ¬æœºæµè§ˆå™¨ï¼ˆIndexedDBï¼‰ï¼ŒåŒæ­¥ç ä¸åŒ…å«å¤§é™„ä»¶ã€‚</div>
                </div>
                <div class="flex space-x-3 mt-4">
                    <button onclick="hideModal()" class="flex-1 py-3 bg-gray-100 rounded-xl">å–æ¶ˆ</button>
                    <button onclick="doSubmitTaskCompletion('${type}','${periodKey}','${subjectKey}')" class="flex-1 py-3 btn-success rounded-xl">æäº¤æŠ¥å‘Š</button>
                </div>
            </div>
        `);
        setTimeout(() => initEvidenceStaging('completionEvidenceFiles', 'completionEvidenceFiles_list'), 0);
    }

    async function doSubmitTaskCompletion(type, periodKey, subjectKey) {
        const status = document.getElementById('completionStatus')?.value || 'done';
        const note = document.getElementById('completionNote')?.value?.trim() || '';
        const evidence = await collectEvidenceFromInputs('completionEvidenceText','completionEvidenceLink','completionEvidenceFiles','completionEvidenceWechat');

        const allTasks = DB.get('tasks', {});
        const taskKey = `${type}_${periodKey}`;
        if (!allTasks[taskKey]) allTasks[taskKey] = {};
        if (!allTasks[taskKey][subjectKey]) allTasks[taskKey][subjectKey] = {};

        allTasks[taskKey][subjectKey].childSubmitted = true;
        allTasks[taskKey][subjectKey].childSubmittedAt = new Date().toISOString();
        allTasks[taskKey][subjectKey].childStatus = status;
        allTasks[taskKey][subjectKey].childNote = note;
        allTasks[taskKey][subjectKey].childEvidence = evidence;

        DB.set('tasks', allTasks);
        hideModal();
        alert('ğŸ“¤ å®ŒæˆæŠ¥å‘Šå·²æäº¤ï¼Œç­‰å¾…å®¶é•¿è¯„å®š');
        render();
    }

    function editSubjectTask(type, periodKey, subjectKey) {
        const allTasks = DB.get('tasks', {});
        const taskKey = `${type}_${periodKey}`;
        const taskData = allTasks[taskKey] || {};
        const t = taskData[subjectKey] || {};
        const sub = CONFIG.subjects.find(s => s.key === subjectKey);

        showModal(`
            <div class="card p-4 w-full max-w-md" onclick="event.stopPropagation()">
                <h3 class="text-lg font-bold mb-4">${sub.icon} è®¾ç½®${sub.name}ä»»åŠ¡</h3>
                
                <!-- é«˜éš¾åº¦æç¤ºåŒºåŸŸï¼ˆåŠ¨æ€æ˜¾ç¤ºï¼‰ -->
                <div id="editHighDiffWarning" class="hidden bg-orange-100 text-orange-700 text-sm p-3 rounded-lg mb-4">
                    <div class="font-medium">âš ï¸ é«˜éš¾åº¦ä»»åŠ¡æç¤º</div>
                    <div id="editHighDiffText" class="text-xs mt-1"></div>
                </div>
                
                <div class="mb-3">
                    <label class="block text-sm text-gray-600 mb-1">ä»»åŠ¡æè¿°</label>
                    <textarea id="editDesc" class="w-full border rounded px-3 py-2 text-sm" rows="5" placeholder="è¯¦ç»†æè¿°ä»»åŠ¡å†…å®¹.">${(t.description||'').replace(/</g,'&lt;').replace(/>/g,'&gt;')}</textarea>
                </div>
                <div class="mb-3">
                    <label class="block text-sm text-gray-600 mb-1">éªŒæ”¶æ ‡å‡†</label>
                    <textarea id="editStd" class="w-full border rounded px-3 py-2 text-sm" rows="4" placeholder="æ˜ç¡®çš„éªŒæ”¶æ ‡å‡†.">${(t.standard||'').replace(/</g,'&lt;').replace(/>/g,'&gt;')}</textarea>
                </div>

                
                <div class="mb-3">
                    <label class="block text-sm text-gray-600 mb-2">éš¾åº¦æ ‡å‡†åŒ–ï¼ˆå››å› å­æ¨¡å‹è‡ªåŠ¨å»ºè®®ï¼Œå¯æ‰‹åŠ¨è¦†ç›–ï¼‰</label>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div>
                            <div class="text-xs text-gray-500 mb-1">ä»»åŠ¡ç±»å‹ï¼ˆç±»å‹ç³»æ•°ï¼‰</div>
                            <select id="editType" class="w-full border rounded px-3 py-2" onchange="applyTaskTypeToDiff('editType','editDiff','editTypeHint');checkEditHighDiff()">
                                ${(CONFIG.taskTypes||[]).map(tt => `<option value="${tt.key}" ${(t.diffType||'practice')===tt.key ? 'selected' : ''}>${tt.label}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <div class="text-xs text-gray-500 mb-1">é¢„è®¡æ—¶é•¿ï¼ˆæ—¶é•¿ç³»æ•°ï¼‰</div>
                            <select id="editDur" class="w-full border rounded px-3 py-2" onchange="applyTaskTypeToDiff('editType','editDiff','editTypeHint');checkEditHighDiff()">
                                ${(CONFIG.durationFactors||[]).map(d => `<option value="${d.key}" ${(t.diffDur||'m15_30')===d.key ? 'selected' : ''}>${d.label}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <div class="text-xs text-gray-500 mb-1">è¯æ®ç±»å‹ï¼ˆè¯æ®ç³»æ•°ï¼‰</div>
                            <select id="editEvi" class="w-full border rounded px-3 py-2" onchange="applyTaskTypeToDiff('editType','editDiff','editTypeHint');checkEditHighDiff()">
                                ${(CONFIG.evidenceFactors||[]).map(e => `<option value="${e.key}" ${(t.diffEvi||'oral')===e.key ? 'selected' : ''}>${e.label}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <div class="text-xs text-gray-500 mb-1">æ–°é¢–åº¦ï¼ˆæ–°é¢–åº¦ç³»æ•°ï¼‰</div>
                            <select id="editNov" class="w-full border rounded px-3 py-2" onchange="applyTaskTypeToDiff('editType','editDiff','editTypeHint');checkEditHighDiff()">
                                ${(CONFIG.noveltyFactors||[]).map(n => `<option value="${n.key}" ${(t.diffNov||'normal')===n.key ? 'selected' : ''}>${n.label}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                    <div id="editTypeHint" class="text-xs text-gray-600 mt-2"></div>
                    <button onclick="applyTaskTypeToDiff('editType','editDiff','editTypeHint');checkEditHighDiff()" class="mt-2 w-full py-2 bg-gray-50 rounded-lg text-sm text-gray-700">æŒ‰å››å› å­åˆ·æ–°å»ºè®®å€æ•°</button>
                </div>


                <div class="mb-3">
                    <label class="block text-sm text-gray-600 mb-1">éš¾åº¦ç³»æ•°ï¼ˆå¯æ‰‹åŠ¨è¦†ç›–ï¼‰</label>
                    <select id="editDiff" class="w-full border rounded px-3 py-2" onchange="checkEditHighDiff()">
                        ${CONFIG.difficulties.map(d => `<option value="${d.v}" ${(t.difficulty||1.0)===d.v ? 'selected' : ''}>Ã—${d.v} ${d.label}</option>`).join('')}
                    </select>
                </div>

                <div class="flex space-x-3 mt-4">
                    <button onclick="hideModal()" class="flex-1 py-3 bg-gray-100 rounded-xl">å–æ¶ˆ</button>
                    <button onclick="saveSubjectTask('${type}','${periodKey}','${subjectKey}')" class="flex-1 py-3 btn-primary rounded-xl">ä¿å­˜</button>
                </div>
            </div>
        `);
        setTimeout(() => { applyTaskTypeToDiff('editType','editDiff','editTypeHint'); checkEditHighDiff(); }, 50);
    }

    // æ£€æŸ¥å®¶é•¿ç¼–è¾‘ä»»åŠ¡æ—¶çš„é«˜éš¾åº¦æç¤º
    function checkEditHighDiff() {
        const diff = parseFloat(document.getElementById('editDiff')?.value) || 1.0;
        const evi = document.getElementById('editEvi')?.value || 'oral';
        const warnEl = document.getElementById('editHighDiffWarning');
        const textEl = document.getElementById('editHighDiffText');
        if (!warnEl || !textEl) return;
        
        let warnings = [];
        
        if (diff >= 1.8 && ['none', 'oral'].includes(evi)) {
            warnings.push('éš¾åº¦ç³»æ•°â‰¥1.8æ—¶ï¼Œéœ€è¦å®è´¨è¯æ®ï¼ˆç…§ç‰‡/è§†é¢‘/ä½œå“ç­‰ï¼‰ï¼Œå½“å‰é€‰æ‹©çš„è¯æ®ç±»å‹ä¸è¶³');
        }
        if (diff >= 2.5) {
            warnings.push('éš¾åº¦ç³»æ•°â‰¥2.5æ˜¯"è¶…é«˜éš¾åº¦"ï¼Œè¯·ç¡®ä¿ä»»åŠ¡è®¾è®¡åˆç†');
        }
        
        if (warnings.length > 0) {
            warnEl.classList.remove('hidden');
            textEl.innerHTML = warnings.map(w => `â€¢ ${w}`).join('<br>');
        } else {
            warnEl.classList.add('hidden');
        }
    }


    function saveSubjectTask(type, periodKey, subjectKey) {
        // å…ˆè¯»å–è¾“å…¥ï¼ˆå¦åˆ™å¯†ç æ¡†ä¼šè¦†ç›–å½“å‰æ¨¡æ€æ¡†ï¼Œå¯¼è‡´è¯»ä¸åˆ°å€¼ï¼‰
        const desc = document.getElementById('editDesc')?.value?.trim() || '';
        const std = document.getElementById('editStd')?.value?.trim() || '';
        const diff = parseFloat(document.getElementById('editDiff')?.value) || 1.0;
        const diffType = document.getElementById('editType')?.value || 'practice';
        const diffDur = document.getElementById('editDur')?.value || 'm15_30';
        const diffEvi = document.getElementById('editEvi')?.value || 'oral';
        const diffNov = document.getElementById('editNov')?.value || 'normal';
        const diffCoeffRaw = (function(){
            const model = calcDifficultyModel(diffType, diffDur, diffEvi, diffNov);
            return model.raw;
        })();

        showPwdModal('ä¿å­˜ä»»åŠ¡éœ€è¦å¯†ç ', () => {
            const old = (function(){
                const all = DB.get('tasks', {});
                const k = `${type}_${periodKey}`;
                return (all[k] && all[k][subjectKey]) ? all[k][subjectKey] : {};
            })();
            const allTasks = DB.get('tasks', {});
            const taskKey = `${type}_${periodKey}`;
            if (!allTasks[taskKey]) allTasks[taskKey] = {};

            allTasks[taskKey][subjectKey] = {
                ...allTasks[taskKey][subjectKey],
                description: desc,
                standard: std,
                difficulty: diff,
                diffType: diffType,
                diffDur: diffDur,
                diffEvi: diffEvi,
                diffNov: diffNov,
                diffCoeffRaw: diffCoeffRaw,
                parentMonthId: (type === 'weekly' ? (State.planMonthId || old.parentMonthId || null) : (old.parentMonthId || null)),
            };
            DB.set('tasks', allTasks);
            alert('âœ… ä»»åŠ¡å·²ä¿å­˜');
            render();
        });
    }


    function evaluateTask(type, periodKey, subjectKey) {
        const allTasks = DB.get('tasks', {});
        const taskKey = `${type}_${periodKey}`;
        const taskData = allTasks[taskKey] || {};
        const t = taskData[subjectKey] || {};
        const sub = CONFIG.subjects.find(s => s.key === subjectKey);
        const scores = CONFIG.taskScores[type];
        
        // å­©å­æäº¤çš„è¯æ®ï¼ˆè¯´æ˜/é“¾æ¥/é™„ä»¶ï¼‰
        const childEvidenceHtml = (t.childEvidence) ? renderEvidenceInline(t.childEvidence, 'openTaskEvidence', `'${type}','${periodKey}','${subjectKey}',`) : '';

        // å°å­©æäº¤çš„æŠ¥å‘Šä¿¡æ¯
        const childReportHtml = t.childSubmitted ? `
            <div class="bg-green-50 border border-green-200 rounded-lg p-3 mb-3">
                <div class="text-sm font-medium text-green-700 mb-1">ğŸ“¤ å­©å­å·²æäº¤å®ŒæˆæŠ¥å‘Š</div>
                <div class="text-xs text-green-600">è‡ªè¯„ï¼š${t.childStatus === 'done' ? 'âœ…å·²å®Œæˆ' : 'â–³éƒ¨åˆ†å®Œæˆ'}</div>
                ${t.childNote ? `<div class="text-xs text-gray-600 mt-1">è¯´æ˜ï¼š${t.childNote}</div>` : ''}
                ${childEvidenceHtml}
                <div class="text-xs text-gray-400 mt-1">æäº¤æ—¶é—´ï¼š${t.childSubmittedAt ? new Date(t.childSubmittedAt).toLocaleString('zh-CN') : 'æœªçŸ¥'}</div>
            </div>` : '';
        
        showModal(`
            <div class="card p-4 w-full max-w-md" onclick="event.stopPropagation()">
                <h3 class="text-lg font-bold mb-4">${sub.icon} è¯„å®š${sub.name}ä»»åŠ¡</h3>
                <div class="bg-gray-50 rounded-lg p-3 mb-3">
                    <div class="font-medium whitespace-pre-wrap">${t.description || 'æ— æè¿°'}</div>
                    <div class="text-xs text-gray-500 mt-2 pt-2 border-t border-gray-200 whitespace-pre-wrap">${t.standard || 'æ— æ ‡å‡†'}</div>
                </div>
                ${childReportHtml}
                <select id="evalStatus" class="w-full border rounded px-3 py-2 mb-2" onchange="toggleEvalReason()">
                    <option value="done" ${t.childStatus === 'done' ? 'selected' : ''}>âœ… å®Œæˆ (+${Math.round(scores.done * (t.difficulty||1))})</option>
                    <option value="partial" ${t.childStatus === 'partial' ? 'selected' : ''}>â–³ éƒ¨åˆ†å®Œæˆ (+${Math.round(scores.partial * (t.difficulty||1))})</option>
                    <option value="incomplete">Ã— æœªå®Œæˆ</option>
                </select>
                <div id="evalScoreHint" class="text-xs text-gray-500 mb-2"></div>
                <div id="evalReasonWrap" class="hidden">
                    <select id="evalReason" class="w-full border rounded px-3 py-2 mb-2" onchange="toggleCustomReason()">
                        ${CONFIG.incompleteReasons.map(r => `<option value="${r.key}">${r.label} (${r.pts === 0 ? 'è‡ªå®š' : r.pts})</option>`).join('')}
                    </select>
                    <div id="customReasonWrap" class="hidden">
                        <div class="grid grid-cols-2 gap-2 mb-2">
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">æ‰£åˆ†å€¼</label>
                                <input type="number" id="customReasonPts" class="w-full border rounded px-2 py-1 text-sm" placeholder="-1~-5" min="-10" max="0" value="-2">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">ç†ç”±ç®€è¿°</label>
                                <input type="text" id="customReasonText" class="w-full border rounded px-2 py-1 text-sm" placeholder="å¦‚ï¼šæ—¶é—´ä¸è¶³">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 rounded-lg p-3 mb-3">
                    <div class="text-sm font-medium text-gray-700 mb-2">ğŸ“ å®¶é•¿è¯„å®šè¯´æ˜ï¼ˆå¯é€‰ï¼‰</div>
                    <div class="flex flex-wrap gap-2 mb-2">
                        <button type="button" class="px-3 py-1 text-xs rounded-full bg-gray-200" onclick="appendEvalNote('å®Œæˆè´¨é‡å¥½')">å®Œæˆè´¨é‡å¥½</button>
                        <button type="button" class="px-3 py-1 text-xs rounded-full bg-gray-200" onclick="appendEvalNote('éœ€è¦æ”¹è¿›')">éœ€è¦æ”¹è¿›</button>
                        <button type="button" class="px-3 py-1 text-xs rounded-full bg-gray-200" onclick="appendEvalNote('ç»§ç»­ä¿æŒ')">ç»§ç»­ä¿æŒ</button>
                    </div>
                    <textarea id="evalNote" class="w-full border rounded px-3 py-2 text-sm" rows="2" placeholder="å®¶é•¿å¯¹æœ¬æ¬¡ä»»åŠ¡çš„çœ‹æ³•ä¸å»ºè®®...">${t.evalNote || ''}</textarea>
                </div>
                <div class="flex space-x-3 mt-4">
                    <button onclick="hideModal()" class="flex-1 py-3 bg-gray-100 rounded-xl">å–æ¶ˆ</button>
                    <button onclick="confirmEvaluate('${type}','${periodKey}','${subjectKey}')" class="flex-1 py-3 btn-success rounded-xl">ç¡®è®¤</button>
                </div>
            </div>
        `);
        initEvalModalContext({ difficulty: (t.difficulty||1), baseDone: scores.done, basePartial: scores.partial, task: { type, periodKey, subjectKey, subjectName: sub && sub.name } });
    
    }

    function toggleEvalReason() {
        const status = document.getElementById('evalStatus')?.value;
        document.getElementById('evalReasonWrap')?.classList.toggle('hidden', status !== 'incomplete');
        toggleCustomReason();
        try { updateEvalScoreHint(); } catch(e){}
    }

    function toggleCustomReason() {
        const reason = document.getElementById('evalReason')?.value;
        const wrap = document.getElementById('customReasonWrap');
        if (wrap) {
            wrap.classList.toggle('hidden', reason !== 'custom');
        }
    }

    function confirmEvaluate(type, periodKey, subjectKey) {
        // å…ˆæ•è·è¯„å®šè¾“å…¥ï¼šå¯†ç å¼¹çª—ä¼šè¦†ç›– modal å†…å®¹
        const _status = document.getElementById('evalStatus')?.value;
        const _reason = document.getElementById('evalReason')?.value || 'no_reason';
        const _note = document.getElementById('evalNote')?.value || '';
        const _customPts = parseInt(document.getElementById('customReasonPts')?.value) || -2;
        const _customText = document.getElementById('customReasonText')?.value?.trim() || '';
        
        if (_status === 'incomplete' && !_reason) { alert('è¯·é€‰æ‹©"æœªå®ŒæˆåŸå› "'); return; }
        if (_status === 'incomplete' && _reason === 'custom' && !_customText) { alert('è¯·å¡«å†™è‡ªå®šä¹‰ç†ç”±'); return; }

        showPwdModal('ç¡®è®¤è¯„å®šéœ€è¦å¯†ç ', () => {
            const allTasks = DB.get('tasks', {});
            const taskKey = `${type}_${periodKey}`;
            if (!allTasks[taskKey]) allTasks[taskKey] = {};
            if (!allTasks[taskKey][subjectKey]) allTasks[taskKey][subjectKey] = {};
            
            const oldStatus = allTasks[taskKey][subjectKey].status || '';
            const oldReason = allTasks[taskKey][subjectKey].incompleteReason || '';
            const oldNote = allTasks[taskKey][subjectKey].evalNote || '';

            const status = _status;
            const reason = _reason;
            const note = _note;
            allTasks[taskKey][subjectKey].status = status;
            allTasks[taskKey][subjectKey].incompleteReason = reason;
            allTasks[taskKey][subjectKey].evalNote = note;
            // å­˜å‚¨è‡ªå®šä¹‰ç†ç”±æ•°æ®
            if (reason === 'custom') {
                allTasks[taskKey][subjectKey].customReasonPts = _customPts;
                allTasks[taskKey][subjectKey].customReasonText = _customText;
            }
            allTasks[taskKey][subjectKey].confirmed = true;
            allTasks[taskKey][subjectKey].confirmedAt = new Date().toISOString();
            
            allTasks[taskKey][subjectKey].confirmedAtLocal = formatYMD(new Date());
            DB.set('tasks', allTasks);
            const score = Engine.calcTaskScore(allTasks[taskKey][subjectKey], type);

            // è¯„å®šå®¡è®¡æ—¥å¿—ï¼ˆä¾¿äºå¤ç›˜ä¸äº‰è®®å¤„ç†ï¼‰
            try {
                const logs = DB.get('evaluationLogs', []);
                logs.unshift({
                    ts: new Date().toISOString(),
                    taskKey,
                    type,
                    periodKey,
                    subjectKey,
                    subjectName: (sub && sub.name) || subjectKey,
                    oldStatus,
                    newStatus: status,
                    oldReason,
                    newReason: reason,
                    oldNote,
                    newNote: note,
                    score
                });
                DB.set('evaluationLogs', logs.slice(0, 500)); // æœ€å¤šä¿ç•™ 500 æ¡
            } catch (e) { /* ignore */ }

            
            // æ·»åŠ é€šçŸ¥ï¼ˆä¸‰æ€ï¼šç»¿/é»„/çº¢ï¼‰
            const sub = CONFIG.subjects.find(s => s.key === subjectKey);
            const typeLabel = type === 'weekly' ? 'å‘¨ä»»åŠ¡' : type === 'monthly' ? 'æœˆä»»åŠ¡' : type === 'quarterly' ? 'å­£åº¦ä»»åŠ¡' : 'å¹´åº¦ä»»åŠ¡';
            const statusLabel = status === 'done' ? 'å®Œæˆ' : status === 'partial' ? 'éƒ¨åˆ†å®Œæˆ' : 'æœªå®Œæˆ';
            const desc = allTasks[taskKey][subjectKey].description || '';
            
            // ä¸‰æ€é€»è¾‘ï¼š
            // ç»¿(positive): done æˆ– partialï¼ˆæ­£å‘ç§¯åˆ†ï¼‰
            // é»„(neutral): incomplete + justified/communicatedï¼ˆå¯æ¥å—ä½†æ‰£åˆ†ï¼‰
            // çº¢(negative): incomplete + no_reason/refusedï¼ˆå¼ºè´Ÿå‘ï¼‰
            let notifStatus = 'positive';
            let reasonText = '';
            if (status === 'incomplete') {
                const reasonLabel = CONFIG.incompleteReasons.find(r => r.key === reason)?.label || reason;
                reasonText = reasonLabel;
                if (reason === 'justified' || reason === 'communicated') {
                    notifStatus = 'neutral'; // é»„è‰²ï¼šæœ‰æ­£å½“ç†ç”±æˆ–å·²æ²Ÿé€š
                } else {
                    notifStatus = 'negative'; // çº¢è‰²ï¼šæ— ç†ç”±æˆ–æ‹’ç»æ‰§è¡Œ
                }
            }
            
            addNotification('taskEval', `${typeLabel}å·²è¯„å®š`, `${sub?.name || subjectKey}: ${desc.substring(0,20)}${desc.length>20?'...':''} (${statusLabel} ${score >= 0 ? '+' : ''}${score}åˆ†)`, notifStatus, reasonText);
            
            setModalDirty(false); clearModalContext();
            hideModal(false,{force:true});
            alert(`âœ… å·²è¯„å®šï¼å¾—åˆ†: ${score >= 0 ? '+' : ''}${score}`);
            render();
        });
    }

    // ==================== å…‘æ¢å•†åŸ ====================
    function renderShop() {
        const pts = Engine.total();
        const redemptions = DB.get('redemptions', []);
        const pending = redemptions.filter(r => !r.confirmed && !r.rejected);
        const customItems = DB.get('customItems', {});
        const catChildReqs = DB.get('catChildReqs', []).filter(r => !r.resolved);
        
        // å¹´åº¦é¢åº¦ä¿¡æ¯
        const yearlyQuota = DB.getYearlyQuota();
        const yearlyUsed = Engine.getYearlyUsed();
        const yearlyRemain = yearlyQuota - yearlyUsed;
        const age = DB.getChildAge();
        const multiplier = DB.getYearlyMultiplier();

        return `
        <div class="slide-in">
            <div class="card p-4 mb-4 text-center" style="background:linear-gradient(135deg,#d97706 0%,#fbbf24 100%);color:white">
                <div class="text-sm opacity-80">å¯ç”¨ç§¯åˆ†</div>
                <div class="text-4xl font-bold">â­ ${pts}</div>
            </div>
            
            <div class="text-xs text-gray-500 text-center mb-3">è¯´æ˜ï¼šç§¯åˆ†ä½™é¢è·¨æœˆ/è·¨å¹´è‡ªåŠ¨ç´¯ç§¯ï¼Œä¸æ¸…é›¶ï¼›â€œç»ˆææ¢¦æƒ³â€å¯å¤šå¹´æ”’åˆ†ã€‚æ¶‰åŠå®¶é•¿é™ªåŒ/èŠ±è´¹çš„å¥–åŠ±ï¼Œé»˜è®¤æŒ‰â€œå®¶é•¿æ‰¿æ‹…â€ä¸ºä¸»æ‰§è¡Œï¼ˆå¦‚æœ‰äº‰è®®ä»¥å®¶é•¿å®¡æ ¸ä¸ºå‡†ï¼‰ã€‚</div>
            
            <!-- å¹´åº¦é¢åº¦å¡ç‰‡ -->
            <div class="card p-4 mb-4 quota-card">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="font-bold text-amber-800">ğŸ¯ ${DB.year()}å¹´åº¦é¢åº¦</h3>
                    ${age !== null ? `<span class="text-xs bg-amber-200 text-amber-800 px-2 py-1 rounded-full">${age}å² Â· Ã—${multiplier.toFixed(1)}</span>` : ''}
                </div>
                <div class="flex justify-between text-sm mb-2">
                    <span class="text-amber-700">æ€»é¢åº¦</span>
                    <span class="font-bold text-amber-800">${yearlyQuota} åˆ†</span>
                </div>
                <div class="flex justify-between text-sm mb-2">
                    <span class="text-amber-700">å·²ä½¿ç”¨</span>
                    <span class="font-bold text-red-600">-${yearlyUsed} åˆ†</span>
                </div>
                <div class="flex justify-between text-sm">
                    <span class="text-amber-700">å‰©ä½™é¢åº¦</span>
                    <span class="font-bold ${yearlyRemain > 0 ? 'text-green-600' : 'text-red-600'}">${yearlyRemain} åˆ†</span>
                </div>
                <div class="mt-2 bg-amber-200 rounded-full h-2 overflow-hidden">
                    <div class="bg-amber-600 h-full transition-all" style="width:${Math.min(100, yearlyUsed/yearlyQuota*100)}%"></div>
                </div>
                <div class="text-xs text-amber-600 mt-1 text-center">åŸºç¡€é¢åº¦ ${BASE_YEARLY_QUOTA} Ã— ${multiplier.toFixed(1)} å€æ•° = ${yearlyQuota}</div>
            </div>
            
            ${State.role === 'parent' && (pending.length + catChildReqs.length) > 0 ? `
            <div class="bg-yellow-50 rounded-xl p-3 mb-4">
                <div class="font-bold text-yellow-700 mb-2">â³ å¾…å®¡æ‰¹ (${pending.length + catChildReqs.length})</div>
                ${catChildReqs.slice(0, 3).map((r, i) => `
                    <div class="card p-3 mb-2">
                        <div class="flex justify-between items-center">
                            <div><div class="text-sm font-medium">${r.item}</div><div class="text-xs text-gray-500">${r.catName} Â· å»ºè®®${r.suggestedPts}åˆ†</div></div>
                            <div class="flex space-x-1">
                                <button onclick="safeCall('doRejectCatReq',${i})" class="px-2 py-1 bg-red-100 text-red-600 rounded text-xs">æ‹’ç»</button>
                                <button onclick="safeCall('approveCatReq',${i})" class="px-2 py-1 btn-success rounded text-xs">å®¡æ‰¹</button>
                            </div>
                        </div>
                    </div>`).join('')}
                ${pending.slice(0, 3).map(r => {
                    const idx = redemptions.indexOf(r);
                    return `
                    <div class="card p-3 mb-2 flex justify-between items-center">
                        <div><div class="text-sm font-medium">${r.item}</div><div class="text-xs text-gray-500">${r.date} Â· ${r.pts}åˆ†</div></div>
                        <div class="flex space-x-1">
                            <button onclick="safeCall('doRejectRed',${idx})" class="px-2 py-1 bg-red-100 text-red-600 rounded text-xs">æ‹’ç»</button>
                            <button onclick="safeCall('approveRed',${idx})" class="px-2 py-1 btn-success rounded text-xs">æ‰¹å‡†</button>
                        </div>
                    </div>`;
                }).join('')}
            </div>` : ''}
            
            ${CONFIG.redemptionCats.map(cat => renderCat(cat, pts, customItems)).join('')}
            ${renderCash(pts)}
            
            <div class="mt-4">
                <h3 class="font-bold text-gray-700 mb-2">ğŸ“œ å…‘æ¢è®°å½•</h3>
                <div class="card p-4">
                    ${redemptions.length === 0 ? '<div class="text-gray-400 text-center py-4">æš‚æ— è®°å½•</div>' :
                    redemptions.slice(-10).reverse().map(r => `
                        <div class="flex justify-between py-2 border-b border-gray-100 last:border-0 text-sm">
                            <div>
                                <span>${r.item}</span>
                                <span class="text-xs ml-1 ${r.confirmed ? 'text-green-500' : r.rejected ? 'text-red-500' : 'text-yellow-500'}">${r.confirmed ? 'âœ“' : r.rejected ? 'âœ—' : 'â³'}</span>
                                <div class="text-xs text-gray-400">${r.date}</div>
                            </div>
                            <span class="font-bold ${r.confirmed ? 'text-red-500' : 'text-gray-400'}">${r.confirmed ? '-' : ''}${r.pts}</span>
                        </div>`).join('')}
                </div>
            </div>
        </div>`;
    }

    function renderCat(cat, pts, customItems) {
        const check = Engine.checkRedemption(cat.key, DB.today());
        const exp = State.expanded[cat.key];
        const custom = customItems[cat.key] || {};
        return `
        <div class="mb-3">
            <button onclick="State.expanded['${cat.key}']=!State.expanded['${cat.key}'];render();" class="w-full flex items-center justify-between card px-4 py-3 ${exp ? 'rounded-t-2xl rounded-b-none' : 'rounded-2xl'}">
                <h3 class="font-bold text-gray-700">${cat.name}</h3>
                <div class="flex items-center space-x-2">
                    <span class="text-xs ${check.ok ? 'text-green-600' : 'text-red-500'}">${check.ok ? cat.freqLabel : check.reason}</span>
                    <span class="text-gray-400">${exp ? 'â–¼' : 'â–¶'}</span>
                </div>
            </button>
            <div class="card rounded-t-none overflow-hidden collapse-content ${exp ? 'expanded' : ''}">
                ${cat.items.map(item => {
                    const canAfford = pts >= item.pts;
                    const disabled = !canAfford || !check.ok;
                    return `
                    <div class="flex items-center justify-between p-3 border-b border-gray-100">
                        <div><div class="font-medium text-sm">${item.name}</div><div class="text-xs text-accent font-bold">${item.pts} åˆ†</div></div>
                        ${State.role === 'child' ? `
                        <button onclick="reqRed('${cat.key}','${item.name}',${item.pts})" class="px-3 py-1.5 rounded-full text-xs font-bold ${disabled ? 'bg-gray-100 text-gray-400' : 'btn-primary'}" ${disabled ? 'disabled' : ''}>
                            ${!canAfford ? 'ä¸è¶³' : !check.ok ? 'ä¸Šé™' : 'ç”³è¯·'}
                        </button>` : '<span class="text-xs text-gray-400">å­©å­æ“ä½œ</span>'}
                    </div>`;
                }).join('')}
                ${custom.name ? `
                <div class="flex items-center justify-between p-3 border-b border-gray-100 bg-blue-50">
                    <div><div class="font-medium text-sm">${custom.name} <span class="text-xs text-blue-600">è‡ªå®šä¹‰</span></div><div class="text-xs text-accent font-bold">${custom.pts}åˆ†</div></div>
                    ${State.role === 'child' ? `
                    <button onclick="reqRed('${cat.key}','${custom.name}(è‡ªå®šä¹‰)',${custom.pts})" class="px-3 py-1.5 rounded-full text-xs font-bold ${pts >= custom.pts && check.ok ? 'btn-primary' : 'bg-gray-100 text-gray-400'}" ${pts >= custom.pts && check.ok ? '' : 'disabled'}>
                        ${pts < custom.pts ? 'ä¸è¶³' : !check.ok ? 'ä¸Šé™' : 'ç”³è¯·'}
                    </button>` : `<button onclick="editCustomItem('${cat.key}')" class="px-2 py-1 bg-blue-100 text-blue-600 rounded text-xs">ç¼–è¾‘</button>`}
                </div>` : ''}
                <div class="p-3 bg-purple-50">
                    ${State.role === 'child' ? `
                    <button onclick="showCatChildReq('${cat.key}','${cat.name}')" class="w-full py-2 bg-purple-100 text-purple-700 rounded-lg text-sm font-medium">âœ¨ æˆ‘æƒ³è¦å…¶ä»–å¥–åŠ±...</button>
                    ` : `
                    <div class="flex space-x-2">
                        <input type="text" id="c_${cat.key}_name" class="flex-1 border rounded px-2 py-1 text-sm" placeholder="è‡ªå®šä¹‰åç§°" value="${(custom.name||'').replace(/"/g,'&quot;')}">
                        <input type="number" id="c_${cat.key}_pts" class="w-16 border rounded px-2 py-1 text-sm" placeholder="ç§¯åˆ†" value="${custom.pts||''}">
                        <button onclick="saveCustomItem('${cat.key}')" class="px-3 py-1 btn-primary rounded text-xs">ä¿å­˜</button>
                    </div>`}
                </div>
            </div>
        </div>`;
    }

    function renderCash(pts) {
        const tiers = DB.get('cashTiers', CONFIG.cashTiers);
        const exp = State.expanded['cash'];
        return `
        <div class="mb-3">
            <button onclick="State.expanded['cash']=!State.expanded['cash'];render();" class="w-full flex items-center justify-between card px-4 py-3 ${exp ? 'rounded-t-2xl rounded-b-none' : 'rounded-2xl'}">
                <h3 class="font-bold text-gray-700">ğŸ’° ç§¯åˆ†æ¢é’±</h3>
                <span class="text-gray-400">${exp ? 'â–¼' : 'â–¶'}</span>
            </button>
            <div class="card rounded-t-none overflow-hidden collapse-content ${exp ? 'expanded' : ''}">
                ${tiers.map(t => `
                    <div class="flex items-center justify-between p-3 border-b border-gray-100">
                        <div><div class="font-medium text-sm">${t.name}</div><div class="text-xs"><span class="text-accent font-bold">${t.pts}åˆ†</span> â†’ <span class="text-green-600 font-bold">${t.cash}å…ƒ</span></div></div>
                        <button onclick="reqCash(${t.pts},${t.cash})" class="px-3 py-1.5 rounded-full text-xs font-bold ${pts >= t.pts ? 'bg-yellow-500 text-white' : 'bg-gray-100 text-gray-400'}" ${pts >= t.pts ? '' : 'disabled'}>
                            ${pts >= t.pts ? 'ç”³è¯·' : 'ä¸è¶³'}
                        </button>
                    </div>`).join('')}
            </div>
        </div>`;
    }

    function showCatChildReq(catKey, catName) {
        showModal(`
            <div class="card p-4 w-full max-w-sm" onclick="event.stopPropagation()">
                <h3 class="text-lg font-bold mb-2">âœ¨ ç”³è¯·è‡ªå®šä¹‰å¥–åŠ±</h3>
                <p class="text-sm text-gray-500 mb-4">ç±»åˆ«: ${catName}</p>
                <input type="text" id="catReqItem" class="w-full border rounded px-3 py-2 mb-2" placeholder="æˆ‘æƒ³è¦çš„å¥–åŠ±">
                <input type="number" id="catReqPts" class="w-full border rounded px-3 py-2 mb-2" placeholder="å»ºè®®æ‰£é™¤ç§¯åˆ†ï¼ˆå…‘æ¢æˆæœ¬ï¼‰">
                <textarea id="catReqReason" class="w-full border rounded px-3 py-2" rows="2" placeholder="ä¸ºä»€ä¹ˆæƒ³è¦ï¼Ÿ"></textarea>
                <div class="flex space-x-3 mt-4">
                    <button onclick="hideModal()" class="flex-1 py-3 bg-gray-100 rounded-xl">å–æ¶ˆ</button>
                    <button onclick="submitCatChildReq('${catKey}','${catName}')" class="flex-1 py-3 btn-primary rounded-xl">æäº¤</button>
                </div>
            </div>
        `);
    }

    function submitCatChildReq(catKey, catName) {
        const item = document.getElementById('catReqItem')?.value?.trim();
        const pts = parseInt(document.getElementById('catReqPts')?.value) || 0;
        if (!item || pts <= 0) { alert('è¯·å¡«å†™å®Œæ•´'); return; }
        const reqs = DB.get('catChildReqs', []);
        reqs.push({ catKey, catName, item, suggestedPts: pts, reason: document.getElementById('catReqReason')?.value?.trim(), resolved: false });
        DB.set('catChildReqs', reqs);
        hideModal();
        alert('ğŸ“¤ ç”³è¯·å·²æäº¤');
        render();
    }

    function approveCatReq(idx) {
        const reqs = DB.get('catChildReqs', []);
        const r = reqs[idx];
        if (!r) return;
        showModal(`
            <div class="card p-4 w-full max-w-sm" onclick="event.stopPropagation()">
                <h3 class="text-lg font-bold mb-4">âœ… å®¡æ‰¹è‡ªå®šä¹‰å¥–åŠ±</h3>
                <div class="bg-purple-50 p-3 rounded-lg mb-3">
                    <div class="font-medium">${r.item}</div>
                    <div class="text-sm text-gray-500">${r.catName} Â· å»ºè®®${r.suggestedPts}åˆ†</div>
                </div>
                <input type="number" id="apCatPts" class="w-full border rounded px-3 py-2" value="${r.suggestedPts}" placeholder="ç¡®è®¤ç§¯åˆ†">
                <div class="flex space-x-3 mt-4">
                    <button onclick="hideModal()" class="flex-1 py-3 bg-gray-100 rounded-xl">å–æ¶ˆ</button>
                    <button onclick="execApproveCatReq(${idx})" class="flex-1 py-3 btn-success rounded-xl">æ‰¹å‡†</button>
                </div>
            </div>
        `);
    }

    function execApproveCatReq(idx) {
        // å…ˆæ•è·è¾“å…¥ï¼šå¯†ç å¼¹çª—ä¼šè¦†ç›– modal å†…å®¹
        const reqs0 = DB.get('catChildReqs', []);
        const r0 = reqs0[idx];
        if (!r0) return;
        const pts0 = parseInt(document.getElementById('apCatPts')?.value) || r0.suggestedPts;

        showPwdModal('æ‰¹å‡†éœ€è¦å¯†ç ', () => {
            // äºŒæ¬¡è¯»å–ï¼Œç¡®ä¿æœ€æ–°
            const reqs = DB.get('catChildReqs', []);
            const r = reqs[idx];
            if (!r) return;
            const pts = pts0;

            // è‡ªå®šä¹‰å¥–åŠ± = å…‘æ¢æ”¯å‡ºï¼ˆæ‰£åˆ†ï¼‰ï¼Œæ‰¹å‡†å³è§†ä¸ºå·²å…‘æ¢
            if (Engine.total() < pts) { alert('âŒ ç§¯åˆ†ä¸è¶³ï¼Œæ— æ³•æ‰¹å‡†'); return; }

            // å¹´åº¦é¢åº¦æ ¡éªŒï¼ˆä¸å…‘æ¢é€»è¾‘ä¸€è‡´ï¼‰
            const yearlyQuota = DB.getYearlyQuota();
            const yearlyUsed = Engine.getYearlyUsed();
            const yearlyRemain = yearlyQuota - yearlyUsed;

            State.pendingCatReqApprove = { idx, pts };

            if (yearlyRemain < pts) {
                showModal(`
                    <div class="card p-4 w-full max-w-sm" onclick="event.stopPropagation()">
                        <h3 class="text-lg font-bold mb-3">âš ï¸ å¹´åº¦é¢åº¦ä¸è¶³</h3>
                        <div class="bg-orange-50 p-3 rounded-lg mb-4 text-sm">
                            <div class="font-medium">${r.item}</div>
                            <div class="text-gray-600 mt-1">éœ€è¦ ${pts} åˆ†ï¼Œå¹´åº¦å‰©ä½™ ${yearlyRemain} åˆ†</div>
                            <div class="text-orange-600 mt-1">å·®é¢ï¼š${pts - yearlyRemain} åˆ†</div>
                        </div>
                        <div class="space-y-2 mb-4">
                            <button onclick="finalizeCatReqApprove('queue')" class="w-full p-3 bg-blue-50 text-left rounded-lgnd-lg text-sm hover:bg-blue-100">
                                <div class="font-medium text-blue-700">ğŸ“‹ æ’é˜Ÿç­‰å¾…</div>
                                <div class="text-xs text-gray-500">æœ¬æ¬¡åŒæ„æ’é˜Ÿï¼šä¸æ‰£åˆ†ï¼Œç­‰å¾…é¢åº¦å……è¶³åå†â€œç¡®è®¤æ‰£åˆ†â€</div>
                            </button>
                            <button onclick="finalizeCatReqApprove('nextYear')" class="w-full p-3 bg-purple-50 text-left rounded-lg text-sm hover:bg-purple-100">
                                <div class="font-medium text-purple-700">ğŸ“… ä½¿ç”¨ä¸‹å¹´é¢åº¦</div>
                                <div class="text-xs text-gray-500">ç¡®è®¤åç«‹å³æ‰£åˆ†ï¼Œä½†è®¡å…¥ä¸‹ä¸€å¹´åº¦é¢åº¦</div>
                            </button>
                            <button onclick="hideModal();State.pendingCatReqApprove=null" class="w-full p-3 bg-gray-50 text-left rounded-lg text-sm hover:bg-gray-100">
                                <div class="font-medium text-gray-600">âŒ å–æ¶ˆ</div>
                                <div class="text-xs text-gray-500">è¿”å›ä¿®æ”¹ç§¯åˆ†æˆ–æš‚ä¸æ‰¹å‡†</div>
                            </button>
                        </div>
                    </div>
                `);
                return;
            }

            finalizeCatReqApprove('normal');
        });
    }

    function finalizeCatReqApprove(strategy){
        const pending = State.pendingCatReqApprove || {};
        const idx = pending.idx;
        const pts = pending.pts;
        if (idx === undefined || !pts) { alert('å‚æ•°é”™è¯¯'); return; }

        const reqs = DB.get('catChildReqs', []);
        const r = reqs[idx];
        if (!r) { State.pendingCatReqApprove = null; return; }

        const dy = DB.year();
        const st = strategy || 'normal';
        const quotaYear = (st === 'nextYear') ? (dy + 1) : dy;

        // ç”Ÿæˆå…‘æ¢è®°å½•ï¼šcustom reward = å…‘æ¢æ”¯å‡º
        const redemptions = DB.get('redemptions', []);
        const rec = {
            category: r.catKey,
            item: r.item,
            pts: pts,
            date: DB.today(),
            quotaStrategy: st,
            quotaYear: quotaYear,
            from: 'catReq'
        };

        if (st === 'queue') {
            rec.confirmed = false;
            rec.queueApproved = true;
            rec.queueApprovedAt = new Date().toISOString();
            redemptions.push(rec);
            DB.set('redemptions', redemptions);

            r.resolved = true;
            r.approved = true;
            r.approvedPts = pts;
            r.quotaStrategy = st;
            r.resolvedAt = new Date().toISOString();
            DB.set('catChildReqs', reqs);

            addNotification('redemption', 'è‡ªå®šä¹‰å¥–åŠ±å·²åŠ å…¥æ’é˜Ÿ', `${r.item} (${pts}åˆ†) Â· æ’é˜Ÿç­‰å¾…é¢åº¦`, 'neutral');

            State.pendingCatReqApprove = null;
            hideModal();
            alert(`ğŸ“‹ å·²åŒæ„æ’é˜Ÿï¼š${r.item} (${pts}åˆ†)`);
            render();
            return;
        }

        // normal / nextYearï¼šç¡®è®¤å¹¶æ‰£åˆ†
        rec.confirmed = true;
        rec.confirmedAt = new Date().toISOString();
        redemptions.push(rec);
        DB.set('redemptions', redemptions);

        r.resolved = true;
        r.approved = true;
        r.approvedPts = pts;
        r.quotaStrategy = st;
        r.resolvedAt = new Date().toISOString();
        DB.set('catChildReqs', reqs);

        addNotification('redemption', 'è‡ªå®šä¹‰å¥–åŠ±å·²æ‰¹å‡†', `${r.item} (-${pts}åˆ†)`, true);

        State.pendingCatReqApprove = null;
        hideModal();
        alert(`âœ… å·²æ‰¹å‡†å¹¶æ‰£é™¤ç§¯åˆ†ï¼š${r.item} (-${pts}åˆ†)`);
        render();
    }

    function doRejectCatReq(idx) {
        const reqs = DB.get('catChildReqs', []);
        const r = reqs[idx];
        if (!r) return;
        showModal(`
            <div class="card p-4 w-full max-w-sm" onclick="event.stopPropagation()">
                <h3 class="text-lg font-bold mb-4">âŒ æ‹’ç»è‡ªå®šä¹‰å¥–åŠ±</h3>
                <div class="bg-gray-50 p-3 rounded-lg mb-3 text-sm">
                    <div class="font-medium">${r.item}</div>
                    <div class="text-gray-600">${r.catName} Â· å»ºè®®${r.suggestedPts}åˆ†</div>
                </div>
                <textarea id="rejectCatReason" class="w-full border rounded px-3 py-2" rows="2" placeholder="è¯·è¾“å…¥æ‹’ç»åŸå› ï¼ˆå¿…å¡«ï¼‰"></textarea>
                <div class="flex space-x-3 mt-4">
                    <button onclick="hideModal()" class="flex-1 py-3 bg-gray-100 rounded-xl">å–æ¶ˆ</button>
                    <button onclick="execRejectCatReq(${idx})" class="flex-1 py-3 btn-danger rounded-xl">ç¡®è®¤æ‹’ç»</button>
                </div>
            </div>
        `);
    }

    function execRejectCatReq(idx) {
        const reason = document.getElementById('rejectCatReason')?.value?.trim();
        if (!reason) { alert('è¯·å¡«å†™æ‹’ç»åŸå› '); return; }
        showPwdModal('æ‹’ç»éœ€è¦å¯†ç ', () => {
            const reqs = DB.get('catChildReqs', []);
            const r = reqs[idx];
            if (r) {
                r.resolved = true;
                r.approved = false;
                r.resolvedAt = new Date().toISOString();
                r.rejectReason = reason;
                DB.set('catChildReqs', reqs);
                
                addNotification('catReq', 'è‡ªå®šä¹‰å¥–åŠ±è¢«æ‹’ç»', `${r.item}`, false, reason);
                
                hideModal();
                alert('âŒ å·²æ‹’ç»');
                render();
            }
        });
    }

    function reqRed(cat, item, pts) {
        if (Engine.total() < pts) { alert('âŒ ç§¯åˆ†ä¸è¶³'); return; }
        
        // æ£€æŸ¥å¹´åº¦é¢åº¦
        const yearlyQuota = DB.getYearlyQuota();
        const yearlyUsed = Engine.getYearlyUsed();
        const yearlyRemain = yearlyQuota - yearlyUsed;
        
        if (yearlyRemain < pts) {
            // å¹´åº¦é¢åº¦ä¸è¶³ï¼Œå¼¹å‡ºç­–ç•¥é€‰æ‹©
            showModal(`
                <div class="card p-4 w-full max-w-sm" onclick="event.stopPropagation()">
                    <h3 class="text-lg font-bold mb-3">âš ï¸ å¹´åº¦é¢åº¦ä¸è¶³</h3>
                    <div class="bg-orange-50 p-3 rounded-lg mb-4 text-sm">
                        <div class="font-medium">${item}</div>
                        <div class="text-gray-600 mt-1">éœ€è¦ ${pts} åˆ†ï¼Œå¹´åº¦å‰©ä½™ ${yearlyRemain} åˆ†</div>
                        <div class="text-orange-600 mt-1">å·®é¢ï¼š${pts - yearlyRemain} åˆ†</div>
                    </div>
                    <div class="space-y-2 mb-4">
                        <button onclick="reqRedWithStrategy('${cat}','${item.replace(/'/g,"\\'")}',${pts},'queue')" class="w-full p-3 bg-blue-50 text-left rounded-lg text-sm hover:bg-blue-100">
                            <div class="font-medium text-blue-700">ğŸ“‹ æ’é˜Ÿç­‰å¾…</div>
                            <div class="text-xs text-gray-500">ç”³è¯·è¿›å…¥æ’é˜Ÿï¼Œä¸‹æ¬¡é¢åº¦å……è¶³æ—¶ä¼˜å…ˆå¤„ç†</div>
                        </button>
                        <button onclick="reqRedWithStrategy('${cat}','${item.replace(/'/g,"\\'")}',${pts},'nextYear')" class="w-full p-3 bg-purple-50 text-left rounded-lg text-sm hover:bg-purple-100">
                            <div class="font-medium text-purple-700">ğŸ“… ä½¿ç”¨ä¸‹å¹´é¢åº¦</div>
                            <div class="text-xs text-gray-500">æå‰ä½¿ç”¨ä¸‹ä¸€å¹´åº¦çš„é¢åº¦ï¼ˆéœ€å®¶é•¿ç¡®è®¤ï¼‰</div>
                        </button>
                        <button onclick="hideModal()" class="w-full p-3 bg-gray-50 text-left rounded-lg text-sm hover:bg-gray-100">
                            <div class="font-medium text-gray-600">âŒ å–æ¶ˆ</div>
                            <div class="text-xs text-gray-500">æš‚ä¸å…‘æ¢ï¼Œç»§ç»­æ”’åˆ†</div>
                        </button>
                    </div>
                </div>
            `);
            return;
        }
        
        const redemptions = DB.get('redemptions', []);
        redemptions.push({ category: cat, item, pts, date: DB.today(), confirmed: false });
        DB.set('redemptions', redemptions);
        alert(`ğŸ“¤ å…‘æ¢ç”³è¯·å·²æäº¤ï¼ç­‰å¾…å®¶é•¿å®¡æ ¸`);
        render();
    }

    function reqRedWithStrategy(cat, item, pts, strategy) {
        const redemptions = DB.get('redemptions', []);
        redemptions.push({
            category: cat,
            item,
            pts,
            date: DB.today(),
            confirmed: false,
            quotaStrategy: strategy, // 'queue' æˆ– 'nextYear'
            quotaNote: strategy === 'queue' ? 'æ’é˜Ÿç­‰å¾…é¢åº¦' : 'ä½¿ç”¨ä¸‹å¹´é¢åº¦'
        });
        DB.set('redemptions', redemptions);
        hideModal();
        alert(strategy === 'queue' 
            ? `ğŸ“‹ å·²åŠ å…¥æ’é˜Ÿï¼é¢åº¦å……è¶³åä¼˜å…ˆå¤„ç†` 
            : `ğŸ“… å·²ç”³è¯·ä½¿ç”¨ä¸‹å¹´é¢åº¦ï¼Œç­‰å¾…å®¶é•¿ç¡®è®¤`);
        render();
    }

    function reqCash(pts, cash) {
        if (Engine.total() < pts) { alert('âŒ ç§¯åˆ†ä¸è¶³'); return; }
        
        // æ£€æŸ¥å¹´åº¦é¢åº¦
        const yearlyQuota = DB.getYearlyQuota();
        const yearlyUsed = Engine.getYearlyUsed();
        const yearlyRemain = yearlyQuota - yearlyUsed;
        
        if (yearlyRemain < pts) {
            showModal(`
                <div class="card p-4 w-full max-w-sm" onclick="event.stopPropagation()">
                    <h3 class="text-lg font-bold mb-3">âš ï¸ å¹´åº¦é¢åº¦ä¸è¶³</h3>
                    <div class="bg-orange-50 p-3 rounded-lg mb-4 text-sm">
                        <div class="font-medium">ç§¯åˆ†æ¢é’±(${cash}å…ƒ)</div>
                        <div class="text-gray-600 mt-1">éœ€è¦ ${pts} åˆ†ï¼Œå¹´åº¦å‰©ä½™ ${yearlyRemain} åˆ†</div>
                        <div class="text-orange-600 mt-1">å·®é¢ï¼š${pts - yearlyRemain} åˆ†</div>
                    </div>
                    <div class="space-y-2 mb-4">
                        <button onclick="reqCashWithStrategy(${pts},${cash},'queue')" class="w-full p-3 bg-blue-50 text-left rounded-lg text-sm hover:bg-blue-100">
                            <div class="font-medium text-blue-700">ğŸ“‹ æ’é˜Ÿç­‰å¾…</div>
                            <div class="text-xs text-gray-500">ç”³è¯·è¿›å…¥æ’é˜Ÿï¼Œä¸‹æ¬¡é¢åº¦å……è¶³æ—¶ä¼˜å…ˆå¤„ç†</div>
                        </button>
                        <button onclick="reqCashWithStrategy(${pts},${cash},'nextYear')" class="w-full p-3 bg-purple-50 text-left rounded-lg text-sm hover:bg-purple-100">
                            <div class="font-medium text-purple-700">ğŸ“… ä½¿ç”¨ä¸‹å¹´é¢åº¦</div>
                            <div class="text-xs text-gray-500">æå‰ä½¿ç”¨ä¸‹ä¸€å¹´åº¦çš„é¢åº¦ï¼ˆéœ€å®¶é•¿ç¡®è®¤ï¼‰</div>
                        </button>
                        <button onclick="hideModal()" class="w-full p-3 bg-gray-50 text-left rounded-lg text-sm hover:bg-gray-100">
                            <div class="font-medium text-gray-600">âŒ å–æ¶ˆ</div>
                            <div class="text-xs text-gray-500">æš‚ä¸å…‘æ¢ï¼Œç»§ç»­æ”’åˆ†</div>
                        </button>
                    </div>
                </div>
            `);
            return;
        }
        
        const redemptions = DB.get('redemptions', []);
        redemptions.push({ category: 'cash', item: `ç§¯åˆ†æ¢é’±(${cash}å…ƒ)`, pts, cash, date: DB.today(), confirmed: false });
        DB.set('redemptions', redemptions);
        alert(`ğŸ“¤ æç°ç”³è¯·å·²æäº¤ï¼ç­‰å¾…å®¶é•¿å®¡æ ¸`);
        render();
    }

    function reqCashWithStrategy(pts, cash, strategy) {
        const redemptions = DB.get('redemptions', []);
        redemptions.push({
            category: 'cash',
            item: `ç§¯åˆ†æ¢é’±(${cash}å…ƒ)`,
            pts,
            cash,
            date: DB.today(),
            confirmed: false,
            quotaStrategy: strategy,
            quotaNote: strategy === 'queue' ? 'æ’é˜Ÿç­‰å¾…é¢åº¦' : 'ä½¿ç”¨ä¸‹å¹´é¢åº¦'
        });
        DB.set('redemptions', redemptions);
        hideModal();
        alert(strategy === 'queue' 
            ? `ğŸ“‹ å·²åŠ å…¥æ’é˜Ÿï¼é¢åº¦å……è¶³åä¼˜å…ˆå¤„ç†` 
            : `ğŸ“… å·²ç”³è¯·ä½¿ç”¨ä¸‹å¹´é¢åº¦ï¼Œç­‰å¾…å®¶é•¿ç¡®è®¤`);
        render();
    }

    function approveRed(idx) {
        showPwdModal('æ‰¹å‡†å…‘æ¢éœ€è¦å¯†ç ', () => {
            const redemptions = DB.get('redemptions', []);
            const r = redemptions[idx];
            if (!r) return;
            showModal(`
                <div class="card p-5 w-full max-w-sm" onclick="event.stopPropagation()">
                    <h3 class="text-lg font-bold mb-4">âœ… æ‰¹å‡†å…‘æ¢</h3>
                    <input id="ap_item" class="w-full border rounded px-3 py-2 mb-2" value="${(r.item||'').replace(/"/g,'&quot;')}">
                    <input id="ap_pts" type="number" class="w-full border rounded px-3 py-2" value="${r.pts||0}">
                    <div class="flex space-x-3 mt-4">
                        <button onclick="hideModal()" class="flex-1 py-3 bg-gray-100 rounded-xl">å–æ¶ˆ</button>
                        <button onclick="execApprove(${idx})" class="flex-1 py-3 btn-success rounded-xl">ç¡®è®¤</button>
                    </div>
                </div>
            `);
        });
    }

    function execApprove(idx) {
        const redemptions = DB.get('redemptions', []);
        const r = redemptions[idx];
        if (!r) return;
        const newItem = document.getElementById('ap_item')?.value?.trim();
        const newPts = parseInt(document.getElementById('ap_pts')?.value) || 0;
        if (!newItem || newPts <= 0) { alert('è¯·å¡«å†™å®Œæ•´'); return; }
        if (Engine.total() < newPts) { alert('âŒ ç§¯åˆ†ä¸è¶³'); return; }

        r.item = newItem;
        r.pts = newPts;

        const strategy = r.quotaStrategy || 'normal';
        const dy = r.date ? Number(String(r.date).substring(0,4)) : DB.year();
        r.quotaYear = (strategy === 'nextYear') ? (dy + 1) : dy;

        if (strategy === 'queue') {
            // æ’é˜Ÿï¼šä¸ç¡®è®¤ã€ä¸æ‰£åˆ†ï¼Œåªæ ‡è®°ä¸ºå·²åŒæ„æ’é˜Ÿ
            r.queueApproved = true;
            r.queueApprovedAt = new Date().toISOString();
            r.confirmed = false;
            redemptions[idx] = r;
            DB.set('redemptions', redemptions);

            addNotification('redemption', 'å…‘æ¢å·²åŠ å…¥æ’é˜Ÿ', `${newItem} (${newPts}åˆ†) Â· æ’é˜Ÿç­‰å¾…é¢åº¦`, 'neutral');
            hideModal();
            alert('ğŸ“‹ å·²åŒæ„æ’é˜Ÿï¼šé¢åº¦å……è¶³åå†ç¡®è®¤æ‰£åˆ†');
            render();
            return;
        }

        // normal / nextYearï¼šç¡®è®¤å¹¶æ‰£åˆ†
        r.confirmed = true;
        r.confirmedAt = new Date().toISOString();
        redemptions[idx] = r;
        DB.set('redemptions', redemptions);

        addNotification('redemption', 'å…‘æ¢å·²æ‰¹å‡†', `${newItem} (-${newPts}åˆ†)`, true);

        hideModal();
        alert('âœ… å·²æ‰¹å‡†ï¼Œç§¯åˆ†å·²æ‰£é™¤');
        render();
    }

    function doRejectRed(idx) {
        const redemptions = DB.get('redemptions', []);
        const r = redemptions[idx];
        if (!r) return;
        showModal(`
            <div class="card p-4 w-full max-w-sm" onclick="event.stopPropagation()">
                <h3 class="text-lg font-bold mb-4">âŒ æ‹’ç»å…‘æ¢</h3>
                <div class="bg-gray-50 p-3 rounded-lg mb-3 text-sm">
                    <div class="font-medium">${r.item}</div>
                    <div class="text-gray-600">${r.pts}åˆ†</div>
                </div>
                <textarea id="rejectRedReason" class="w-full border rounded px-3 py-2" rows="2" placeholder="è¯·è¾“å…¥æ‹’ç»åŸå› ï¼ˆå¿…å¡«ï¼‰"></textarea>
                <div class="flex space-x-3 mt-4">
                    <button onclick="hideModal()" class="flex-1 py-3 bg-gray-100 rounded-xl">å–æ¶ˆ</button>
                    <button onclick="execRejectRed(${idx})" class="flex-1 py-3 btn-danger rounded-xl">ç¡®è®¤æ‹’ç»</button>
                </div>
            </div>
        `);
    }

    function execRejectRed(idx) {
        const reason = document.getElementById('rejectRedReason')?.value?.trim();
        if (!reason) { alert('è¯·å¡«å†™æ‹’ç»åŸå› '); return; }
        showPwdModal('æ‹’ç»å…‘æ¢éœ€è¦å¯†ç ', () => {
            const redemptions = DB.get('redemptions', []);
            const r = redemptions[idx];
            if (r) {
                r.rejected = true;
                r.rejectedAt = new Date().toISOString();
                r.rejectReason = reason;
                DB.set('redemptions', redemptions);
                
                addNotification('redemption', 'å…‘æ¢è¢«æ‹’ç»', `${r.item} (${r.pts}åˆ†)`, false, reason);
                
                hideModal();
                alert('âŒ å·²æ‹’ç»');
                render();
            }
        });
    }

    function saveCustomItem(catKey) {
        // å…ˆè¯»å–è¾“å…¥ï¼ˆå¦åˆ™å¯†ç å¼¹çª—ä¼šè¦†ç›– modalï¼Œå¯¼è‡´è¯»ä¸åˆ°å€¼ï¼‰
        const name = document.getElementById(`c_${catKey}_name`)?.value?.trim();
        const pts = parseInt(document.getElementById(`c_${catKey}_pts`)?.value) || 0;
        if (!name || pts <= 0) { alert('è¯·å¡«å†™å®Œæ•´'); return; }

        showPwdModal('ä¿å­˜éœ€è¦å¯†ç ', () => {
            const customItems = DB.get('customItems', {});
            customItems[catKey] = { name, pts };
            DB.set('customItems', customItems);
            alert('âœ… å·²ä¿å­˜');
            render();
        });
    }

    function editCustomItem(catKey) { State.expanded[catKey] = true; render(); }

    // ==================== ç»Ÿè®¡é¡µ ====================

    // ==================== ç»Ÿè®¡å·¥å…·ï¼ˆæŒ‰é¡¹ç›®æ‹†è§£å®Œæˆæƒ…å†µï¼‰ ====================
    const StatsHelper = {
        monthConfirmedRecords(ym) {
            const daily = DB.get('daily', {});
            return Object.entries(daily)
                .filter(([date, r]) => date.startsWith(ym) && r && r.confirmed)
                .sort((a,b)=>a[0].localeCompare(b[0]))
                .map(([date, r]) => ({ date, r }));
        },
        dailyTaskStats(ym) {
            const records = this.monthConfirmedRecords(ym);
            const res = {};
            (CONFIG.dailyTasks||[]).forEach(t => {
                res[t.key] = { key: t.key, label: t.label, icon: t.icon, done: 0, partial: 0, incomplete: 0, total: 0, ontime: 0, late: 0 };
            });
            records.forEach(({date, r}) => {
                (CONFIG.dailyTasks||[]).forEach(t => {
                    const v = r[t.key];
                    const s = res[t.key];
                    s.total += 1;
                    if (v === true || v === 'done') s.done += 1;
                    else if (v === 'partial') s.partial += 1;
                    else s.incomplete += 1;
                    if (t.key === 'wakeUp' && (v === true || v === 'done')) {
                        const lateInfo = CheckinHelper.calcLateDeduction('wakeUp', date, r.wakeUp_time);
                        if (lateInfo) s.late += 1; else s.ontime += 1;
                    }
                });
            });
            return { totalDays: records.length, items: Object.values(res) };
        },
        a3Stats(ym) {
            const records = this.monthConfirmedRecords(ym);
            const keys = ['learningExtra','habitExtra','characterExtra','familyExtra','parentExtra'];
            const m = { learningExtra:0, habitExtra:0, characterExtra:0, familyExtra:0, parentExtra:0, rawTotal:0 };
            records.forEach(({r}) => {
                keys.forEach(k => { m[k] += (r[k] || 0); });
            });
            m.rawTotal = keys.reduce((s,k)=>s+m[k],0);
            return m;
        },
        deductionStats(ym) {
            const records = this.monthConfirmedRecords(ym);
            const map = {};
            let total = 0;
            records.forEach(({r}) => {
                (r.deductionList || []).forEach(d => {
                    const key = d.label || 'æœªå‘½å';
                    if (!map[key]) map[key] = { label: key, pts: 0, count: 0, isEmotion: !!d.isEmotion };
                    map[key].pts += (d.pts || 0);
                    map[key].count += 1;
                    total += (d.pts || 0);
                });
            });
            const items = Object.values(map).sort((a,b)=>b.pts-a.pts);
            return { total, items };
        },
        // ä»»åŠ¡å®Œæˆï¼šæŒ‰ç§‘ç›®ç»Ÿè®¡æœ¬æœˆå„å‘¨æœŸï¼ˆå‘¨+æœˆï¼‰ï¼Œå¹¶ç»™å‡ºæœ¬å­£åº¦/å¹´åº¦æ‘˜è¦
        taskStats(ym) {
            const all = DB.get('tasks', {});
            const year = parseInt(ym.split('-')[0]);
            const month = parseInt(ym.split('-')[1]);
            const q = Math.floor((month - 1) / 3) + 1;

            const periods = [];
            for (let w=1; w<=4; w++) periods.push({ type:'weekly', key:`${ym}-W${w}`, label:`ç¬¬${w}å‘¨` });
            periods.push({ type:'monthly', key:ym, label:`æœˆä»»åŠ¡` });
            periods.push({ type:'quarterly', key:`${year}-Q${q}`, label:`æœ¬å­£åº¦` });
            periods.push({ type:'yearly', key:`${year}`, label:`æœ¬å¹´åº¦` });

            const perSubject = {};
            CONFIG.subjects.forEach(s => { perSubject[s.key] = { subject:s, done:0, partial:0, incomplete:0, unset:0, pts:0 }; });
            const perPeriod = [];

            periods.forEach(p => {
                const k = `${p.type}_${p.key}`;
                const taskData = all[k] || {};
                let pts = 0, done=0, partial=0, incomplete=0, unset=0;
                CONFIG.subjects.forEach(sub => {
                    const t = taskData[sub.key];
                    if (!t) { unset += 1; return; }
                    if (t.confirmed) {
                        if (t.status === 'done') done += 1;
                        else if (t.status === 'partial') partial += 1;
                        else if (t.status === 'incomplete') incomplete += 1;
                    }
                    const sPts = Engine.calcTaskScore(t, p.type);
                    pts += sPts;
                    // ä»…å¯¹â€œå‘¨+æœˆâ€è®¡å…¥æœ¬æœˆç§‘ç›®æ˜ç»†ï¼ˆå­£åº¦/å¹´åº¦ä¼šé‡å¤è®¡ç®—ï¼Œä¸çº³å…¥ perSubjectï¼‰
                    if (p.type === 'weekly' || p.type === 'monthly') {
                        const ps = perSubject[sub.key];
                        if (t && t.confirmed) {
                            if (t.status === 'done') ps.done += 1;
                            else if (t.status === 'partial') ps.partial += 1;
                            else if (t.status === 'incomplete') ps.incomplete += 1;
                        } else if (!t) {
                            ps.unset += 1;
                        }
                        ps.pts += sPts;
                    }
                });
                perPeriod.push({ ...p, pts, done, partial, incomplete, unset });
            });

            return { perPeriod, perSubject: Object.values(perSubject) };
        },
        redemptionStats(ym) {
            const redemptions = DB.get('redemptions', []).filter(r => r.confirmed);
            const items = redemptions.filter(r => r.date?.startsWith(ym));
            const total = items.reduce((s,i)=>s+(i.pts||0),0);
            const byCat = {};
            items.forEach(i => {
                const k = i.category || 'unknown';
                if (!byCat[k]) byCat[k] = { category:k, count:0, pts:0, name:(CONFIG.redemptionCats.find(c=>c.key===k)?.name || k) };
                byCat[k].count += 1;
                byCat[k].pts += (i.pts || 0);
            });
            return { total, items, byCat: Object.values(byCat).sort((a,b)=>b.pts-a.pts) };
        }
    };

    function renderStats() {
        const ym = DB.month();
        const sum = Engine.summary(ym);
        const age = DB.getChildAge();
        const childName = DB.get('childName', '');
        const birthday = DB.get('childBirthday', '');
        
        return `
        <div class="slide-in">
            <h2 class="text-xl font-bold text-gray-800 mb-4">ğŸ“Š ${ym} æœˆåº¦æ±‡æ€»</h2>
            
            <!-- å­©å­ä¿¡æ¯å¡ç‰‡ -->
            <div class="card p-4 mb-4 bg-gradient-to-r from-blue-50 to-purple-50">
                <div class="flex items-center justify-between">
                    <div>
                        <div class="text-lg font-bold text-gray-800">${childName || 'æœªè®¾ç½®å§“å'}</div>
                        <div class="text-sm text-gray-500">${birthday ? `ç”Ÿæ—¥: ${birthday}` : 'æœªè®¾ç½®ç”Ÿæ—¥'} ${age !== null ? `Â· ${age}å²` : ''}</div>
                    </div>
                    ${State.role === 'parent' ? `<button onclick="showChildSettings()" class="px-3 py-1 bg-white rounded-lg text-sm text-blue-600">è®¾ç½®</button>` : ''}
                </div>
                ${age !== null ? `
                <div class="mt-2 pt-2 border-t border-gray-200">
                    <div class="text-xs text-gray-500">å¹´åº¦é¢åº¦å€æ•°: <span class="font-bold text-amber-600">Ã—${DB.getYearlyMultiplier().toFixed(1)}</span> (${age}å²Ã·10+1)</div>
                    <div class="text-xs text-gray-500">å¹´åº¦æ€»é¢åº¦: <span class="font-bold text-green-600">${DB.getYearlyQuota()} åˆ†</span></div>
                </div>` : ''}
            </div>
            
            <div class="card p-4 mb-4">
                <table class="w-full text-sm">
                    <tr class="border-b"><td class="py-2 text-gray-600">æœŸåˆä½™é¢</td><td class="py-2 text-right font-bold">${sum.opening}</td></tr>
                    <tr class="border-b bg-green-50"><td class="py-2 text-gray-600">A1 å‘¨ä»»åŠ¡</td><td class="py-2 text-right font-bold text-green-600">+${sum.a1}</td></tr>
                    <tr class="border-b bg-green-50"><td class="py-2 text-gray-600">A1 é‡Œç¨‹ç¢‘å¥–é‡‘ï¼ˆæœ¬æœˆç¡®è®¤ï¼‰</td><td class="py-2 text-right font-bold text-green-600">+${sum.milestoneBonuses}</td></tr>
<tr class="border-b bg-green-50"><td class="py-2 text-gray-600">A2 æ¯æ—¥å¿…åš</td><td class="py-2 text-right font-bold ${sum.a2 >= 0 ? 'text-green-600' : 'text-red-600'}">${sum.a2 >= 0 ? '+' : ''}${sum.a2}</td></tr>
                    <tr class="border-b bg-green-50"><td class="py-2 text-gray-600">A3 é¢å¤–åŠ åˆ†</td><td class="py-2 text-right font-bold text-green-600">+${sum.a3}</td></tr>
                    <tr class="border-b bg-yellow-50"><td class="py-2 text-gray-600">B è±å…ç§¯åˆ†</td><td class="py-2 text-right font-bold text-yellow-600">+${sum.b}</td></tr>
                    <tr class="border-b bg-purple-50"><td class="py-2 text-gray-600">ğŸ´ æƒ…ç»ªè¿”è¿˜</td><td class="py-2 text-right font-bold text-purple-600">+${sum.emotionRefund}</td></tr>
                    <tr class="border-b bg-blue-50"><td class="py-2 text-gray-600">âœ¨ å¼¥è¡¥è¿”è¿˜</td><td class="py-2 text-right font-bold text-blue-600">+${sum.remedyRefund}</td></tr>
                    <tr class="border-b bg-red-50"><td class="py-2 text-gray-600">D æ‰£åˆ†</td><td class="py-2 text-right font-bold text-red-600">-${sum.d}</td></tr>
                    <tr class="border-b bg-red-50"><td class="py-2 text-gray-600">E å…‘æ¢</td><td class="py-2 text-right font-bold text-red-600">-${sum.e}</td></tr>
                    <tr class="bg-primary/10"><td class="py-3 font-bold">æœŸæœ«ä½™é¢</td><td class="py-3 text-right font-bold text-xl text-primary">${sum.closing}</td></tr>
                </table>
            </div>

            <!-- é¡¹ç›®å®Œæˆç»Ÿè®¡ -->
            ${(() => {
                const dailyStats = StatsHelper.dailyTaskStats(ym);
                const a3 = StatsHelper.a3Stats(ym);
                const ded = StatsHelper.deductionStats(ym);
                const tstats = StatsHelper.taskStats(ym);
                const red = StatsHelper.redemptionStats(ym);
                const yearlyUsed = Engine.getYearlyUsed();
                const yearlyQuota = DB.getYearlyQuota();

                const dailyTable = `
                    <div class="card p-4 mb-4">
                        <div class="flex items-center justify-between mb-3">
                            <div class="font-bold text-gray-800">âœ… æ¯æ—¥å¿…åšå®Œæˆæƒ…å†µ</div>
                            <div class="text-xs text-gray-500">ä»…ç»Ÿè®¡å·²ç¡®è®¤å¤©æ•°ï¼š${dailyStats.totalDays}å¤©</div>
                        </div>
                        <table class="w-full text-sm">
                            <tr class="border-b text-gray-500">
                                <td class="py-2">é¡¹ç›®</td>
                                <td class="py-2 text-right">å®Œæˆ</td>
                                <td class="py-2 text-right">éƒ¨åˆ†</td>
                                <td class="py-2 text-right">æœªå®Œ</td>
                                <td class="py-2 text-right">å®Œæˆç‡</td>
                            </tr>
                            ${dailyStats.items.map(it => {
                                const rate = it.total ? Math.round(100*it.done/it.total) : 0;
                                const extra = it.key==='wakeUp' ? ` <span class="text-xs text-gray-400">(å‡†æ—¶${it.ontime}/è¿Ÿåˆ°${it.late})</span>` : '';
                                return `<tr class="border-b">
                                    <td class="py-2 text-gray-700">${it.icon} ${it.label}${extra}</td>
                                    <td class="py-2 text-right font-bold text-green-600">${it.done}</td>
                                    <td class="py-2 text-right text-yellow-600">${it.partial}</td>
                                    <td class="py-2 text-right text-red-600">${it.incomplete}</td>
                                    <td class="py-2 text-right font-bold">${rate}%</td>
                                </tr>`;
                            }).join('')}
                        </table>
                        <div class="text-xs text-gray-500 mt-2">è¯´æ˜ï¼šèµ·åºŠâ€œè¿Ÿåˆ°â€æŒ‰æ‰“å¡æ—¶é—´ä¸å½“å¤©(å·¥ä½œæ—¥/å‘¨æœ«)æˆªæ­¢æ—¶é—´è‡ªåŠ¨åˆ¤æ–­ã€‚</div>
                    </div>
                `;

                const a3Card = `
                    <div class="card p-4 mb-4">
                        <div class="font-bold text-gray-800 mb-2">â• A3 é¢å¤–åŠ åˆ†ç»“æ„</div>
                        <div class="text-sm text-gray-600 mb-3">åŸå§‹ç´¯è®¡ï¼ˆæœªè€ƒè™‘å‘¨ä¸Šé™å°é¡¶ï¼‰ï¼š${a3.rawTotal} åˆ†ï¼›æœ¬æœˆå®é™…å…¥è´¦ A3ï¼š${sum.a3} åˆ†</div>
                        <div class="grid grid-cols-2 gap-2 text-sm">
                            <div class="p-2 bg-green-50 rounded">ğŸ“– å­¦ä¹ çªç ´ï¼š<span class="font-bold">${a3.learningExtra}</span></div>
                            <div class="p-2 bg-blue-50 rounded">ğŸƒ ä¹ æƒ¯åŸºçŸ³ï¼š<span class="font-bold">${a3.habitExtra}</span></div>
                            <div class="p-2 bg-pink-50 rounded">ğŸ’– å“æ ¼é—ªå…‰ï¼š<span class="font-bold">${a3.characterExtra}</span></div>
                            <div class="p-2 bg-purple-50 rounded">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ å®¶åº­è´¡çŒ®ï¼š<span class="font-bold">${a3.familyExtra}</span></div>
                            <div class="p-2 bg-amber-50 rounded col-span-2">ğŸ å®¶é•¿æ¿€åŠ±ï¼š<span class="font-bold">${a3.parentExtra}</span></div>
                        </div>
                        <div class="text-xs text-gray-500 mt-2">è¯´æ˜ï¼šå®é™…å…¥è´¦ä¼šæŒ‰â€œæ¯å‘¨ä¸Šé™â€å°é¡¶ï¼Œå› æ­¤å¯èƒ½å°äºåŸå§‹ç´¯è®¡ã€‚</div>
                    </div>
                `;

                const dedCard = `
                    <div class="card p-4 mb-4">
                        <div class="font-bold text-gray-800 mb-2">â– D æ‰£åˆ†åŸå› ç»Ÿè®¡</div>
                        <div class="text-sm text-gray-600 mb-3">æœ¬æœˆå·²ç¡®è®¤æ‰£åˆ†åˆè®¡ï¼š<span class="font-bold text-red-600">${ded.total}</span> åˆ†</div>
                        ${ded.items.length===0 ? '<div class="text-gray-400 text-sm">æš‚æ— æ‰£åˆ†è®°å½•</div>' : `
                        <table class="w-full text-sm">
                            <tr class="border-b text-gray-500">
                                <td class="py-2">åŸå› </td>
                                <td class="py-2 text-right">æ¬¡æ•°</td>
                                <td class="py-2 text-right">æ‰£åˆ†</td>
                            </tr>
                            ${ded.items.slice(0,8).map(it => `
                                <tr class="border-b">
                                    <td class="py-2 ${it.isEmotion?'text-orange-700':'text-gray-700'}">${it.label}</td>
                                    <td class="py-2 text-right">${it.count}</td>
                                    <td class="py-2 text-right font-bold text-red-600">${it.pts}</td>
                                </tr>`).join('')}
                        </table>`}
                        <div class="text-xs text-gray-500 mt-2">è¯´æ˜ï¼šæƒ…ç»ªç±»æ‰£åˆ†ç”¨æ©™è‰²æ ‡è®°ï¼Œä¾¿äºåŒºåˆ†â€œæƒ…ç»ªç®¡ç†â€ä¸â€œåŸåˆ™æ€§é—®é¢˜â€ã€‚</div>
                    </div>
                `;

                const taskCard = `
                    <div class="card p-4 mb-4">
                        <div class="font-bold text-gray-800 mb-2">ğŸ“š å‘¨/æœˆ/å­£/å¹´ä»»åŠ¡å®Œæˆæƒ…å†µ</div>
                        <table class="w-full text-sm mb-3">
                            <tr class="border-b text-gray-500">
                                <td class="py-2">å‘¨æœŸ</td>
                                <td class="py-2 text-right">å·²ç¡®è®¤</td>
                                <td class="py-2 text-right">éƒ¨åˆ†</td>
                                <td class="py-2 text-right">æœªå®Œ</td>
                                <td class="py-2 text-right">ç§¯åˆ†</td>
                            </tr>
                            ${tstats.perPeriod.map(p => `
                                <tr class="border-b">
                                    <td class="py-2 text-gray-700">${p.label}</td>
                                    <td class="py-2 text-right text-green-600 font-bold">${p.done}</td>
                                    <td class="py-2 text-right text-yellow-600">${p.partial}</td>
                                    <td class="py-2 text-right text-red-600">${p.incomplete}</td>
                                    <td class="py-2 text-right font-bold">${p.pts}</td>
                                </tr>`).join('')}
                        </table>
                        <div class="text-sm text-gray-600 mb-2">æœ¬æœˆç§‘ç›®æ˜ç»†ï¼ˆå‘¨+æœˆåˆè®¡ï¼‰ï¼š</div>
                        <div class="space-y-2">
                            ${tstats.perSubject.map(ps => `
                                <div class="p-2 bg-gray-50 rounded flex items-center justify-between">
                                    <div>${ps.subject.icon} ${ps.subject.name} <span class="text-xs text-gray-400">(å®Œ${ps.done}/éƒ¨${ps.partial}/æœª${ps.incomplete})</span></div>
                                    <div class="font-bold">${ps.pts}</div>
                                </div>`).join('')}
                        </div>
                        <div class="text-xs text-gray-500 mt-2">è¯´æ˜ï¼šä»»åŠ¡ç§¯åˆ†=åŸºç¡€åˆ†Ã—éš¾åº¦ç³»æ•°ï¼›è‹¥æœªå®Œæˆï¼Œä¼šæŒ‰â€œæœªå®ŒæˆåŸå› â€äº§ç”Ÿæ‰£åˆ†ã€‚</div>
                    </div>
                `;

                const redCard = `
                    <div class="card p-4 mb-4 quota-card">
                        <div class="font-bold text-gray-800 mb-2">ğŸ›ï¸ å…‘æ¢ä¸å¹´åº¦é¢åº¦</div>
                        <div class="text-sm text-gray-700 mb-2">æœ¬æœˆå·²å…‘æ¢ï¼š<span class="font-bold">${red.total}</span> åˆ†</div>
                        ${red.byCat.length===0 ? '<div class="text-gray-500 text-sm mb-3">æœ¬æœˆæš‚æ— å…‘æ¢</div>' : `
                        <div class="grid grid-cols-2 gap-2 text-sm mb-3">
                            ${red.byCat.slice(0,6).map(c => `<div class="p-2 bg-white/60 rounded">${c.name}ï¼š<span class="font-bold">${c.pts}</span></div>`).join('')}
                        </div>`}
                        <div class="text-sm text-gray-700">å¹´åº¦å·²ç”¨é¢åº¦ï¼š<span class="font-bold text-amber-700">${yearlyUsed}</span> / ${yearlyQuota} åˆ†ï¼ˆå‰©ä½™ ${Math.max(0, yearlyQuota-yearlyUsed)}ï¼‰</div>
                        <div class="text-xs text-gray-600 mt-2">è¯´æ˜ï¼šå¹´åº¦é¢åº¦æŒ‰å¹´é¾„å€æ•°è®¡ç®—ï¼›è¾¾åˆ°å¹´åº¦é¢åº¦åï¼Œå»ºè®®ä¼˜å…ˆå…‘æ¢â€œé•¿æœŸä»·å€¼ç±»â€å¥–åŠ±ã€‚</div>
                    </div>
                `;

                return dailyTable + a3Card + dedCard + taskCard + redCard;
            })()}

            
            ${State.role === 'parent' ? `
            <div class="space-y-3">
                <button onclick="showChildSettings()" class="w-full card py-3 text-pink-600 font-medium">ğŸ‘¶ å­©å­ä¿¡æ¯è®¾ç½®</button>
                <button onclick="setInitBal()" class="w-full card py-3 text-blue-600 font-medium">ğŸ’° è®¾ç½®æœŸåˆä½™é¢</button>
                <button onclick="showCheckinSettings()" class="w-full card py-3 text-purple-600 font-medium">â° æ‰“å¡æ—¶é—´è§„åˆ™</button>
                <button onclick="changePwd()" class="w-full card py-3 text-purple-600 font-medium">ğŸ” ä¿®æ”¹å¯†ç </button>
                <button onclick="showSyncModal()" class="w-full card py-3 text-green-600 font-medium">ğŸ”„ æ•°æ®åŒæ­¥</button>
                <button onclick="exportData()" class="w-full card py-3 text-gray-700 font-medium">ğŸ“¤ å¯¼å‡ºJSON</button>
                <button onclick="importData()" class="w-full card py-3 text-gray-700 font-medium">ğŸ“¥ å¯¼å…¥JSON</button>
                <button onclick="resetData()" class="w-full card py-3 text-red-600 font-medium">ğŸ—‘ï¸ é‡ç½®æ•°æ®</button>
            </div>` : ''}
        </div>`;
    }

    // å­©å­ä¿¡æ¯è®¾ç½®
    function showChildSettings() {
        const childName = DB.get('childName', '');
        const birthday = DB.get('childBirthday', '');
        showModal(`
            <div class="card p-4 w-full max-w-sm" onclick="event.stopPropagation()">
                <h3 class="text-lg font-bold mb-4">ğŸ‘¶ å­©å­ä¿¡æ¯è®¾ç½®</h3>
                <div class="mb-3">
                    <label class="block text-sm text-gray-600 mb-1">å­©å­å§“å</label>
                    <input type="text" id="childNameInput" class="w-full border rounded px-3 py-2" placeholder="è¾“å…¥å­©å­å§“å" value="${childName}">
                </div>
                <div class="mb-3">
                    <label class="block text-sm text-gray-600 mb-1">å­©å­ç”Ÿæ—¥</label>
                    <input type="date" id="childBirthdayInput" class="w-full border rounded px-3 py-2" value="${birthday}">
                </div>
                <div class="bg-amber-50 rounded-lg p-3 mb-3">
                    <div class="text-sm text-amber-800 font-medium">ğŸ“Œ å¹´åº¦é¢åº¦è®¡ç®—è§„åˆ™</div>
                    <div class="text-xs text-amber-600 mt-1">
                        åŸºç¡€é¢åº¦: ${BASE_YEARLY_QUOTA} åˆ†/å¹´<br>
                        å€æ•° = å¹´é¾„ Ã· 10 + 1<br>
                        ä¾‹å¦‚: 8å² â†’ Ã—1.8 = ${Math.round(BASE_YEARLY_QUOTA * 1.8)}åˆ†<br>
                        21å² â†’ Ã—2.1 = ${Math.round(BASE_YEARLY_QUOTA * 2.1)}åˆ†
                    </div>
                </div>
                <div class="flex space-x-3 mt-4">
                    <button onclick="hideModal()" class="flex-1 py-3 bg-gray-100 rounded-xl">å–æ¶ˆ</button>
                    <button onclick="saveChildSettings()" class="flex-1 py-3 btn-primary rounded-xl">ä¿å­˜</button>
                </div>
            </div>
        `);
    }
    
    function saveChildSettings() {
        // æ³¨æ„ï¼šå¦‚æœå…ˆå¼¹å‡ºå¯†ç æ¡†ï¼Œä¼šè¦†ç›–å½“å‰â€œå­©å­ä¿¡æ¯â€æ¨¡æ€æ¡†ï¼Œå¯¼è‡´è¯»ä¸åˆ°è¾“å…¥æ¡†å€¼
        const name = document.getElementById('childNameInput')?.value?.trim() || '';
        const birthday = document.getElementById('childBirthdayInput')?.value || '';
        showPwdModal('ä¿å­˜éœ€è¦å¯†ç ', () => {
            DB.set('childName', name);
            DB.set('childBirthday', birthday);
            alert('âœ… å­©å­ä¿¡æ¯å·²ä¿å­˜');
            render();
        });
    }

    function setInitBal() {
        showPwdModal('è®¾ç½®éœ€è¦å¯†ç ', () => {
            const current = DB.get('initialBalance', 0);
            const val = prompt(`è®¾ç½®æœŸåˆä½™é¢ï¼ˆå½“å‰: ${current}ï¼‰:`, current);
            if (val !== null) { DB.set('initialBalance', parseInt(val) || 0); alert('âœ… å·²è®¾ç½®'); render(); }
        });
    }
    
    function showCheckinSettings() {
        const wakeUpTask = CONFIG.dailyTasks.find(t => t.key === 'wakeUp');
        const customSettings = DB.get('wakeUpSettings', null);
        const currentWeekday = customSettings?.weekday || wakeUpTask?.deadlines?.weekday || '07:00';
        const currentWeekend = customSettings?.weekend || wakeUpTask?.deadlines?.weekend || '08:30';
        const validRange = customSettings?.validRange || wakeUpTask?.validTimeRange || { weekday: { earliest: '05:00', latest: '12:00' }, weekend: { earliest: '05:00', latest: '12:00' } };
        
        showModal(`
            <div class="card p-4 w-full max-w-md" onclick="event.stopPropagation()">
                <h3 class="text-lg font-bold mb-4">â° èµ·åºŠæ‰“å¡æ—¶é—´è§„åˆ™</h3>
                
                <div class="mb-4">
                    <div class="text-sm font-medium text-gray-700 mb-2">å·¥ä½œæ—¥ (å‘¨ä¸€è‡³å‘¨äº”)</div>
                    <div class="grid grid-cols-3 gap-2">
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">æœ€æ—©æ‰“å¡</label>
                            <input type="time" id="wkdEarliest" class="w-full border rounded px-2 py-1 text-sm" value="${validRange.weekday?.earliest || '05:00'}">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">æˆªæ­¢æ—¶é—´</label>
                            <input type="time" id="wkdDeadline" class="w-full border rounded px-2 py-1 text-sm" value="${currentWeekday}">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">æœ€æ™šæ‰“å¡</label>
                            <input type="time" id="wkdLatest" class="w-full border rounded px-2 py-1 text-sm" value="${validRange.weekday?.latest || '12:00'}">
                        </div>
                    </div>
                </div>
                
                <div class="mb-4">
                    <div class="text-sm font-medium text-gray-700 mb-2">å‘¨æœ« (å‘¨å…­ã€å‘¨æ—¥)</div>
                    <div class="grid grid-cols-3 gap-2">
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">æœ€æ—©æ‰“å¡</label>
                            <input type="time" id="wkndEarliest" class="w-full border rounded px-2 py-1 text-sm" value="${validRange.weekend?.earliest || '05:00'}">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">æˆªæ­¢æ—¶é—´</label>
                            <input type="time" id="wkndDeadline" class="w-full border rounded px-2 py-1 text-sm" value="${currentWeekend}">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">æœ€æ™šæ‰“å¡</label>
                            <input type="time" id="wkndLatest" class="w-full border rounded px-2 py-1 text-sm" value="${validRange.weekend?.latest || '12:00'}">
                        </div>
                    </div>
                </div>
                
                <div class="bg-yellow-50 rounded-lg p-3 mb-3">
                    <div class="text-sm text-yellow-800">ğŸ’¡ è®¾ç½®è¯´æ˜</div>
                    <div class="text-xs text-yellow-700 mt-1">
                        â€¢ æœ€æ—©æ‰“å¡ï¼šé˜²æ­¢å‡Œæ™¨ä¹±æ‰“å¡<br>
                        â€¢ æˆªæ­¢æ—¶é—´ï¼šè¶…è¿‡æ­¤æ—¶é—´è§†ä¸ºè¿Ÿåˆ°<br>
                        â€¢ æœ€æ™šæ‰“å¡ï¼šè¶…è¿‡åå½“æ—¥æ— æ³•æ‰“å¡
                    </div>
                </div>
                
                <div class="bg-red-50 rounded-lg p-3 mb-3">
                    <div class="font-medium text-red-800 mb-2">âš ï¸ è¿Ÿåˆ°æ‰£åˆ†è§„åˆ™</div>
                    <div class="text-xs text-red-600 space-y-1">
                        <div>â€¢ è¿Ÿåˆ°15åˆ†é’Ÿ: <span class="font-bold">-1åˆ†</span></div>
                        <div>â€¢ è¿Ÿåˆ°30åˆ†é’Ÿ: <span class="font-bold">-2åˆ†</span></div>
                        <div>â€¢ è¿Ÿåˆ°1å°æ—¶: <span class="font-bold">-3åˆ†</span></div>
                        <div>â€¢ è¿Ÿåˆ°2å°æ—¶ä»¥ä¸Š: <span class="font-bold">-4åˆ†</span></div>
                    </div>
                </div>
                
                <div class="flex space-x-3">
                    <button onclick="hideModal()" class="flex-1 py-3 bg-gray-100 rounded-xl">å–æ¶ˆ</button>
                    <button onclick="saveCheckinSettings()" class="flex-1 py-3 btn-primary rounded-xl">ä¿å­˜è®¾ç½®</button>
                </div>
            </div>
        `);
    }

    function saveCheckinSettings() {
        const wkdDeadline = document.getElementById('wkdDeadline')?.value || '07:00';
        const wkndDeadline = document.getElementById('wkndDeadline')?.value || '08:30';
        const wkdEarliest = document.getElementById('wkdEarliest')?.value || '05:00';
        const wkdLatest = document.getElementById('wkdLatest')?.value || '12:00';
        const wkndEarliest = document.getElementById('wkndEarliest')?.value || '05:00';
        const wkndLatest = document.getElementById('wkndLatest')?.value || '12:00';
        
        showPwdModal('ä¿å­˜éœ€è¦å¯†ç ', () => {
            const settings = {
                weekday: wkdDeadline,
                weekend: wkndDeadline,
                validRange: {
                    weekday: { earliest: wkdEarliest, latest: wkdLatest },
                    weekend: { earliest: wkndEarliest, latest: wkndLatest }
                }
            };
            DB.set('wakeUpSettings', settings);
            hideModal();
            alert('âœ… èµ·åºŠæ‰“å¡æ—¶é—´è§„åˆ™å·²ä¿å­˜');
            render();
        });
    }

    function changePwd() {
        showModal(`
            <div class="card p-6 w-80" onclick="event.stopPropagation()">
                <h3 class="text-lg font-bold text-center mb-4">ğŸ” ä¿®æ”¹å¯†ç </h3>
                <input type="password" id="oldPwd" class="w-full border rounded px-3 py-2 mb-3" placeholder="å½“å‰å¯†ç ">
                <input type="password" id="newPwd" class="w-full border rounded px-3 py-2 mb-3" placeholder="æ–°å¯†ç ">
                <input type="password" id="confirmPwd" class="w-full border rounded px-3 py-2 mb-4" placeholder="ç¡®è®¤æ–°å¯†ç ">
                <div class="flex space-x-3">
                    <button onclick="hideModal()" class="flex-1 py-3 bg-gray-100 rounded-xl">å–æ¶ˆ</button>
                    <button onclick="doChangePwd()" class="flex-1 py-3 btn-primary rounded-xl">ç¡®è®¤</button>
                </div>
            </div>
        `);
    }

    function doChangePwd() {
        if (document.getElementById('oldPwd')?.value !== DB.pwd()) { alert('âŒ å½“å‰å¯†ç é”™è¯¯'); return; }
        const newP = document.getElementById('newPwd')?.value;
        if (newP !== document.getElementById('confirmPwd')?.value) { alert('âŒ ä¸¤æ¬¡ä¸ä¸€è‡´'); return; }
        if (newP.length < 4) { alert('âŒ è‡³å°‘4ä½'); return; }
        DB.set('pwd', newP);
        hideModal();
        alert('âœ… å¯†ç å·²ä¿®æ”¹');
    }

    function resetData() {
        showPwdModal('é‡ç½®éœ€è¦å¯†ç ', () => {
            if (confirm('âš ï¸ ç¡®å®šé‡ç½®æ‰€æœ‰æ•°æ®ï¼Ÿ')) {
                Object.keys(localStorage).filter(k => k.startsWith('fp45_')).forEach(k => localStorage.removeItem(k));
                State.role = null;
                alert('âœ… å·²é‡ç½®');
                render();
            }
        });
    }

    function exportData() {
        const blob = new Blob([JSON.stringify(DB.exportAll(), null, 2)], { type: 'application/json' });
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `family_points_${DB.today()}.json`; a.click();
    }

    function importData() {
        const input = document.createElement('input'); input.type = 'file'; input.accept = '.json';
        input.onchange = (e) => {
            const file = e.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => { try { if (DB.importAll(JSON.parse(ev.target.result))) { alert('âœ… å¯¼å…¥æˆåŠŸ'); render(); } else alert('âŒ æ ¼å¼é”™è¯¯'); } catch { alert('âŒ å¯¼å…¥å¤±è´¥'); } };
            reader.readAsText(file);
        };
        input.click();
    }

    // ==================== æ•°æ®åŒæ­¥ ====================
// è¯´æ˜ï¼šå·²æ”¹ä¸ºâ€œå†…ç½®åŒæ­¥ç  + ä¸¤ä¸ªæŒ‰é’®ï¼ˆä¸Šä¼ /æ‹‰å–ï¼‰â€ï¼Œé¿å…â€˜ä¸€é”®åŒæ­¥â€™å¯¼è‡´åŒæ–¹äº’ç›¸è¦†ç›–ã€‚
// - ã€ä¸Šä¼ åˆ°äº‘ã€‘ï¼šæŠŠæœ¬æœºæ•°æ®è¦†ç›–å†™å…¥äº‘ç«¯ï¼ˆäº‘ç«¯ä»¥æœ¬æœºä¸ºå‡†ï¼‰
// - ã€ä»äº‘æ‹‰å–ã€‘ï¼šæŠŠäº‘ç«¯æ•°æ®å¯¼å…¥åˆ°æœ¬æœºï¼ˆæœ¬æœºä»¥äº‘ç«¯ä¸ºå‡†ï¼‰
// å»ºè®®æµç¨‹ï¼š
// 1) å…ˆåœ¨Aè®¾å¤‡ç‚¹ã€ä¸Šä¼ åˆ°äº‘ã€‘ï¼›
// 2) å†åœ¨Bè®¾å¤‡ç‚¹ã€ä»äº‘æ‹‰å–ã€‘ï¼›
// 3) è‹¥Bè®¾å¤‡ä¹Ÿæ”¹è¿‡ï¼Œå†åå‘æ“ä½œä¸€æ¬¡ã€‚

// å†…ç½®åŒæ­¥ç ï¼ˆåŒä¸€å¥—é¡µé¢çš„æ‰€æœ‰è®¾å¤‡å…±äº«åŒä¸€äº‘ç«¯æ•°æ®ï¼‰
const FIXED_SYNC_FAMILY_ID = 'xzh20260116abcdef1234567890abcdef1234567890abcdef1234567890abcd';
const FIXED_SYNC_KEY = FIXED_SYNC_FAMILY_ID;

// äº‘ç«¯åœ°å€ï¼ˆç”¨äº file:// æˆ–è·¨åŸŸéƒ¨ç½²ï¼‰ã€‚é»˜è®¤ä½¿ç”¨å½“å‰ç«™ç‚¹ originï¼›ä¹Ÿå¯åœ¨åŒæ­¥å¼¹çª—ä¸­æ‰‹åŠ¨è®¾ç½®ã€‚
const SYNC_BASE_KEY = 'fp45_sync_base';
function normalizeBase(u){
  if(!u) return '';
  u = String(u).trim();
  if(!u) return '';
  // å»æ‰æœ«å°¾æ–œæ 
  u = u.replace(/\/+$/,'');
  return u;
}
function getSyncBase(){
  const saved = normalizeBase(localStorage.getItem(SYNC_BASE_KEY));
  // file:// ä¸‹ location.origin ä¸º 'null'ï¼Œæ­¤æ—¶ä¼˜å…ˆä½¿ç”¨æ‰‹åŠ¨é…ç½®
  const origin = (location && location.origin && location.origin !== 'null') ? normalizeBase(location.origin) : '';
  return saved || origin;
}
function setSyncBase(u){
  const v = normalizeBase(u);
  if(v) localStorage.setItem(SYNC_BASE_KEY, v);
  else localStorage.removeItem(SYNC_BASE_KEY);
  return v;
}
function ensureSyncBase(){
  const base = getSyncBase();
  if(base) return base;
  // ä»…åœ¨ file:// æˆ– origin ä¸å¯ç”¨æ—¶æç¤º
  const hint = `å½“å‰é¡µé¢ä¸æ˜¯é€šè¿‡æœåŠ¡å™¨è®¿é—®ï¼ˆä¾‹å¦‚ file:// æœ¬åœ°æ‰“å¼€ï¼‰ï¼Œæ— æ³•ä½¿ç”¨ /api/syncã€‚

è¯·åœ¨ä¸‹é¢è¾“å…¥äº‘ç«¯åœ°å€ï¼Œä¾‹å¦‚ï¼š
http://154.21.90.244
æˆ–ä½ è‡ªå·±çš„åŸŸåï¼ˆå¿…é¡»æ˜¯æä¾› /api/sync çš„é‚£å°æœåŠ¡å™¨ï¼‰ã€‚`;
  const u = prompt(hint, 'http://154.21.90.244');
  const v = setSyncBase(u || '');
  return v;
}


function showSyncModal() {
    const baseNow = getSyncBase();
    const originOk = (location && location.origin && location.origin !== 'null');
    const baseHint = originOk ? 'ï¼ˆé»˜è®¤åŒç«™ç‚¹ï¼Œå¯ä¸å¡«ï¼‰' : 'ï¼ˆæœ¬åœ°æ‰“å¼€å¿…é¡»å¡«å†™ï¼‰';

    showModal(`
        <div class="card p-5 w-full max-w-sm" onclick="event.stopPropagation()">
            <h3 class="text-lg font-bold text-center mb-3">ğŸ”„ æ•°æ®åŒæ­¥</h3>

            <div class="bg-yellow-50 rounded-xl p-4 text-sm text-yellow-800 leading-relaxed">
                <div class="font-bold mb-2">äº‘ç«¯åŒæ­¥ï¼ˆå†…ç½®åŒæ­¥ç ï¼‰</div>
                <div>â€¢ <b>ä¸Šä¼ åˆ°äº‘</b>ï¼šç”¨<b>æœ¬æœº</b>è¦†ç›–äº‘ç«¯</div>
                <div>â€¢ <b>ä»äº‘æ‹‰å–</b>ï¼šç”¨<b>äº‘ç«¯</b>è¦†ç›–æœ¬æœº</div>
                <div class="mt-2 text-xs text-yellow-700">æç¤ºï¼šä¸¤å°è®¾å¤‡éƒ½æ”¹è¿‡æ—¶ï¼Œè¯·å…ˆç¡®å®šå“ªå°æ˜¯â€œæœ€ç»ˆç‰ˆâ€ï¼Œå†æŒ‰é¡ºåºä¸Šä¼ /æ‹‰å–ã€‚</div>
            </div>

            <div class="mt-4">
                <div class="text-sm font-medium mb-2">äº‘ç«¯åœ°å€ ${baseHint}</div>
                <input id="syncBaseInput" class="input w-full" placeholder="ä¾‹å¦‚ï¼šhttp://154.21.90.244" value="${baseNow || ''}" />
                <div class="text-xs text-gray-500 mt-2">è¯´æ˜ï¼šå¿…é¡»æ˜¯æä¾› <b>/api/sync/push</b> å’Œ <b>/api/sync/pull</b> çš„æœåŠ¡å™¨åœ°å€ï¼›åŒåŸŸéƒ¨ç½²åˆ™å¯ç•™ç©ºã€‚</div>
                <button class="w-full py-2 bg-gray-100 rounded-xl mt-3" onclick="(function(){ const v=setSyncBase(document.getElementById('syncBaseInput').value); alert(v?'âœ… å·²ä¿å­˜äº‘ç«¯åœ°å€ï¼š'+v:'âœ… å·²æ¸…é™¤äº‘ç«¯åœ°å€ï¼ˆä½¿ç”¨å½“å‰ç«™ç‚¹ï¼‰'); })()">ä¿å­˜äº‘ç«¯åœ°å€</button>
            </div>

            <div class="grid grid-cols-2 gap-3 mt-4">
                <button onclick="cloudUpload()" class="w-full py-3 btn-primary rounded-xl font-medium">â¬† ä¸Šä¼ åˆ°äº‘</button>
                <button onclick="cloudPull()" class="w-full py-3 btn-success rounded-xl font-medium">â¬‡ ä»äº‘æ‹‰å–</button>
            </div>

            <button onclick="hideModal()" class="w-full py-3 bg-gray-100 rounded-xl mt-3">å…³é—­</button>
        </div>
    `);
}

// äº‘åŒæ­¥æ‘˜è¦ï¼ˆç”¨äºé‚®ä»¶/æé†’ï¼‰
function buildSyncSummary() {
    const daily = DB.get('daily', {}) || {};
    const dailyDays = Object.keys(daily).length;
    const pendingDaily = Object.values(daily).filter(r => r && r.submitted && !r.confirmed).length;
    const pendingRedeem = (DB.get('redemptions', []) || []).filter(r => r && !r.confirmed && !r.rejected).length;
    const pendingReq = (DB.get('taskRequests', []) || []).filter(r => r && !r.resolved).length;
    const pendingAppeal = (DB.get('appeals', []) || []).filter(a => a && !a.resolved).length;
    const pendingRemedy = (DB.get('remedies', []) || []).filter(r => r && !r.confirmed && !r.rejected).length;
    const pendingCat = (DB.get('catChildReqs', []) || []).filter(r => r && !r.resolved).length;

    let pendingTaskEval = 0;
    const allTasks = DB.get('tasks', {}) || {};
    Object.values(allTasks).forEach(taskData => {
        Object.values(taskData || {}).forEach(t => {
            if (t && t.childSubmitted && !t.confirmed) pendingTaskEval++;
        });
    });

    const pendingTotal = pendingDaily + pendingRedeem + pendingReq + pendingAppeal + pendingRemedy + pendingCat + pendingTaskEval;

    return {
        dailyDays,
        pendingDaily,
        pendingRedeem,
        pendingReq,
        pendingAppeal,
        pendingRemedy,
        pendingCat,
        pendingTaskEval,
        pendingTotal
    };
}

async function cloudUpload() {
    const familyId = FIXED_SYNC_FAMILY_ID;
    const key = FIXED_SYNC_KEY;

    let localData;
    try {
        const role = (State && State.role) ? State.role : (DB.get('role','child') || 'child');
        const ev = {
            id: 'se_' + Math.random().toString(36).slice(2, 10) + '_' + Date.now().toString(36),
            ts: Date.now(),
            role: role === 'parent' ? 'parent' : 'child',
            summary: buildSyncSummary()
        };
        const events = (DB.get('syncEvents', []) || []).slice(0);
        events.push(ev);
        // åªä¿ç•™æœ€è¿‘50æ¡ï¼Œé¿å…æ— é™å¢å¤§
        DB.set('syncEvents', events.slice(-50));

        localData = DB.exportAll();
    } catch (e) {
        alert('âŒ æœ¬æœºæ•°æ®å¯¼å‡ºå¤±è´¥ï¼š' + (e?.message || e));
        return;
    }

    if (!confirm('ç¡®è®¤ã€ä¸Šä¼ åˆ°äº‘ã€‘å—ï¼Ÿ\n\nè¿™ä¼šç”¨ã€æœ¬æœºæ•°æ®ã€‘è¦†ç›–äº‘ç«¯ç‰ˆæœ¬ã€‚')) return;

    try {
        const payload = { familyId, key, ts: Date.now(), data: localData };
        const r = await fetch((ensureSyncBase()||'') + '/api/sync/push?familyId=' + encodeURIComponent(familyId), {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        if (!r.ok) {
            const t = await r.text().catch(()=> '');
            throw new Error(`HTTP ${r.status} ${t}`.trim());
        }
    } catch (e) {
        alert('âŒ ä¸Šä¼ å¤±è´¥ï¼š' + (e?.message || e) + '\n\næ’æŸ¥ï¼š1) äº‘ç«¯åœ°å€æ˜¯å¦æ­£ç¡®ï¼ˆåŒæ­¥å¼¹çª—å¯è®¾ç½®ï¼‰ï¼›2) æœåŠ¡å™¨æ˜¯å¦æœ‰ /api/sync/push æ¥å£ï¼›3) æ˜¯å¦è¢«æµè§ˆå™¨æ‹¦æˆªï¼ˆhttp/https æ··ç”¨æˆ–è·¨åŸŸ CORSï¼‰ã€‚');
        return;
    }

    hideModal();
    alert('âœ… ä¸Šä¼ æˆåŠŸï¼šäº‘ç«¯å·²æ›´æ–°ä¸ºæœ¬æœºç‰ˆæœ¬');
}

async function cloudPull() {
    const familyId = FIXED_SYNC_FAMILY_ID;
    const key = FIXED_SYNC_KEY;

    if (!confirm('ç¡®è®¤ã€ä»äº‘æ‹‰å–ã€‘å—ï¼Ÿ\n\nè¿™ä¼šç”¨ã€äº‘ç«¯æ•°æ®ã€‘è¦†ç›–æœ¬æœºå½“å‰æ•°æ®ã€‚\nå»ºè®®å…ˆåœ¨æœ¬æœºå¯¼å‡ºJSONå¤‡ä»½ã€‚')) return;

    let cloudData = null;
    try {
        const r = await fetch((ensureSyncBase()||'') + '/api/sync/pull?familyId=' + encodeURIComponent(familyId) + '&key=' + encodeURIComponent(key), { method: 'GET', cache: 'no-store' });
        if (r.status === 404) {
            cloudData = null;
        } else if (!r.ok) {
            const t = await r.text().catch(()=> '');
            throw new Error(`HTTP ${r.status} ${t}`.trim());
        } else {
            const j = await r.json().catch(() => ({}));
            cloudData = (j && j.data) || (j && j.payload && j.payload.data) || (j && j.result) || null;
        }
    } catch (e) {
        alert('âŒ æ‹‰å–å¤±è´¥ï¼š' + (e?.message || e) + '\n\næ’æŸ¥ï¼š1) äº‘ç«¯åœ°å€æ˜¯å¦æ­£ç¡®ï¼ˆåŒæ­¥å¼¹çª—å¯è®¾ç½®ï¼‰ï¼›2) æœåŠ¡å™¨æ˜¯å¦æœ‰ /api/sync/pull æ¥å£ï¼›3) æ˜¯å¦è¢«æµè§ˆå™¨æ‹¦æˆªï¼ˆhttp/https æ··ç”¨æˆ–è·¨åŸŸ CORSï¼‰ã€‚');
        return;
    }

    if (!cloudData) {
        alert('â„¹ï¸ äº‘ç«¯æš‚æ— æ•°æ®ï¼ˆè¿˜æ²¡æœ‰ä¸Šä¼ è¿‡ï¼‰ã€‚');
        return;
    }

    try {
        const ok = DB.importAll(cloudData);
        if (!ok) throw new Error('äº‘ç«¯æ•°æ®æ ¼å¼ä¸åŒ¹é…');
    } catch (e) {
        alert('âŒ å¯¼å…¥å¤±è´¥ï¼š' + (e?.message || e));
        return;
    }

    hideModal();
    render();
    alert('âœ… æ‹‰å–æˆåŠŸï¼šæœ¬æœºå·²æ›´æ–°ä¸ºäº‘ç«¯ç‰ˆæœ¬');
}

// ==================== å¾…å®¡æ‰¹ ====================


    function showPending() {
        const daily = DB.get('daily', {});
        const redemptions = DB.get('redemptions', []);
        const appeals = DB.get('appeals', []);
        const remedies = DB.get('remedies', []);
        const catChildReqs = DB.get('catChildReqs', []);
        const taskRequests = DB.get('taskRequests', []);

        const pDaily = Object.entries(daily).filter(([d, r]) => r.submitted && !r.confirmed);
        const pRed = redemptions.map((r, i) => ({...r, _idx: i})).filter(r => !r.confirmed && !r.rejected);
        const pAppeals = appeals.map((a, i) => ({...a, _idx: i})).filter(a => !a.resolved);
        const pRemedies = remedies.map((r, i) => ({...r, _idx: i})).filter(r => !r.confirmed && !r.rejected);
        const pCatReqs = catChildReqs.map((r, i) => ({...r, _idx: i})).filter(r => !r.resolved);
        const pTaskReqs = taskRequests.map((r, i) => ({...r, _idx: i})).filter(r => !r.resolved);

        // P0: ç»Ÿè®¡å­©å­æäº¤çš„ä»»åŠ¡å®ŒæˆæŠ¥å‘Šï¼ˆå¾…å®¶é•¿è¯„å®šï¼‰
        const pTaskSubs = [];
        const allTasks = DB.get('tasks', {});
        Object.entries(allTasks).forEach(([taskKey, taskData]) => {
            const parts = taskKey.split('_');
            const type = parts[0];
            const periodKey = parts.slice(1).join('_'); // å…¼å®¹periodKeyä¸­å«ä¸‹åˆ’çº¿
            Object.entries(taskData || {}).forEach(([subjectKey, t]) => {
                if (t && t.childSubmitted && !t.confirmed) {
                    const sub = CONFIG.subjects.find(s => s.key === subjectKey);
                    pTaskSubs.push({
                        type, periodKey, subjectKey,
                        subjectName: sub ? sub.name : subjectKey,
                        submittedAt: t.childSubmittedAt || 0
                    });
                }
            });
        });
        pTaskSubs.sort((a, b) => (b.submittedAt || 0) - (a.submittedAt || 0));

        function taskTypeLabel(k) {
            if (k === 'weekly') return 'å‘¨ä»»åŠ¡';
            if (k === 'monthly') return 'æœˆä»»åŠ¡';
            if (k === 'quarterly') return 'å­£åº¦ä»»åŠ¡';
            if (k === 'yearly') return 'å¹´åº¦ä»»åŠ¡';
            return k || 'ä»»åŠ¡';
        }


        // P1: è®¡ç®—ä½é£é™©æ‰“å¡æ•°é‡ï¼ˆ4é¡¹å…¨doneä¸”æ— æ‰£åˆ†ï¼‰
        const lowRiskDaily = pDaily.filter(([d, r]) => {
            const tasks = ['wakeUp', 'homework', 'organize', 'chore'];
            const allDone = tasks.every(t => r[t] === true || r[t] === 'done');
            const noDeduction = (r.deduction || 0) === 0;
            return allDone && noDeduction;
        });

                
        const headerPending = getPendingCount(); // é¡¶éƒ¨â€œå¾…å®¡â€å¾½æ ‡çš„ç»Ÿè®¡
        const computedPending = (pTaskSubs.length + pDaily.length + pRed.length + pAppeals.length + pRemedies.length + pCatReqs.length + pTaskReqs.length);
        const totalPending = computedPending;
showModal(`
            <div class="card p-4 w-full max-w-md max-h-[80vh] overflow-y-auto" onclick="event.stopPropagation()">
                <h3 class="text-lg font-bold mb-4">ğŸ“‹ å¾…å®¡æ‰¹</h3>

                ${headerPending !== computedPending ? `
                <div class="bg-red-50 border border-red-100 rounded-xl p-3 mb-4">
                    <div class="text-sm font-bold text-red-700">âš ï¸ å¾…å®¡ç»Ÿè®¡ä¸ä¸€è‡´</div>
                    <div class="text-xs text-red-600 mt-1">é¡¶éƒ¨æ˜¾ç¤ºï¼š${headerPending}ï¼Œæ­¤åˆ—è¡¨åˆè®¡ï¼š${computedPending}ã€‚</div>
                    <div class="text-xs text-gray-500 mt-1">å¯èƒ½åŸå› ï¼šåˆšå®Œæˆè¯„å®šä½†æœªåˆ·æ–°ã€æˆ–å¤šç«¯åŒæ­¥å»¶è¿Ÿã€‚</div>
                    <button onclick="(function(){ hideModal(false,{skipHistory:true,force:true}); render(); setTimeout(()=>showPending(), 60); })()" class="mt-2 w-full py-2 bg-white rounded-xl border">åˆ·æ–°ç»Ÿè®¡</button>
                </div>` : ''}



                
                
                ${pDaily.length > 0 ? `<div class="mb-4">
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="font-bold text-gray-600">ğŸ“… å¾…ç¡®è®¤æ¯æ—¥æ‰“å¡ (${pDaily.length})</h4>
                    </div>
                    ${pDaily.map(([d, r]) => `
                        <div class="card p-3 mb-2">
                            <div class="flex justify-between items-center">
                                <div>
                                    <div class="font-bold">${d}</div>
                                    <div class="text-xs text-gray-500">æäº¤æ—¶é—´ï¼š${r.submittedAt ? new Date(r.submittedAt).toLocaleString('zh-CN') : 'æœªçŸ¥'}</div>
                                </div>
                                <button onclick="hideModal(false,{skipHistory:true,force:true}); State.date='${d}'; render();" class="px-3 py-2 bg-green-600 text-white rounded-lg text-sm">å‰å¾€ç¡®è®¤</button>
                            </div>
                        </div>
                    `).join('')}
                </div>` : ''}

                ${pRed.length > 0 ? `<div class="mb-4">
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="font-bold text-gray-600">ğŸ å¾…ç¡®è®¤å…‘æ¢ (${pRed.length})</h4>
                    </div>
                    ${pRed.map(r => `
                        <div class="card p-3 mb-2">
                            <div class="flex justify-between items-start">
                                <div class="pr-3">
                                    <div class="font-bold">${r.catName || 'å…‘æ¢'} Â· ${r.item || ''}</div>
                                    <div class="text-xs text-gray-500 mt-1">æ¶ˆè€—ï¼š${r.pts || 0} åˆ† Â· ç”³è¯·æ—¶é—´ï¼š${r.createdAt ? new Date(r.createdAt).toLocaleString('zh-CN') : 'æœªçŸ¥'}</div>
                                </div>
                                <div class="flex gap-2 shrink-0">
                                    <button onclick="safeCall('approveRed',${r._idx});" class="px-3 py-2 bg-green-600 text-white rounded-lg text-sm">ç¡®è®¤</button>
                                    <button onclick="safeCall('doRejectRed',${r._idx});" class="px-3 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm">æ‹’ç»</button>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>` : ''}

                ${pAppeals.length > 0 ? `<div class="mb-4">
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="font-bold text-gray-600">ğŸ§¾ å¾…å¤„ç†ç”³è¯‰ (${pAppeals.length})</h4>
                    </div>
                    ${pAppeals.map(a => `
                        <div class="card p-3 mb-2">
                            <div class="flex justify-between items-start">
                                <div class="pr-3">
                                    <div class="font-bold">${a.subjectName || a.title || 'ç”³è¯‰'}</div>
                                    <div class="text-xs text-gray-500 mt-1">æäº¤æ—¶é—´ï¼š${a.createdAt ? new Date(a.createdAt).toLocaleString('zh-CN') : 'æœªçŸ¥'}</div>
                                    ${a.reason ? `<div class="text-xs text-gray-600 mt-1 whitespace-pre-wrap">ç†ç”±ï¼š${a.reason}</div>` : ''}
                                </div>
                                <div class="flex gap-2 shrink-0">
                                    <button onclick="safeCall('doApproveAppeal',${a._idx});" class="px-3 py-2 bg-green-600 text-white rounded-lg text-sm">é€šè¿‡</button>
                                    <button onclick="safeCall('doRejectAppeal',${a._idx});" class="px-3 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm">æ‹’ç»</button>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>` : ''}

                ${pRemedies.length > 0 ? `<div class="mb-4">
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="font-bold text-gray-600">ğŸ©¹ å¾…ç¡®è®¤è¡¥å¿ (${pRemedies.length})</h4>
                    </div>
                    ${pRemedies.map(r => `
                        <div class="card p-3 mb-2">
                            <div class="flex justify-between items-start">
                                <div class="pr-3">
                                    <div class="font-bold">${r.title || r.reason || 'è¡¥å¿'}</div>
                                    <div class="text-xs text-gray-500 mt-1">ç”³è¯·æ—¶é—´ï¼š${r.createdAt ? new Date(r.createdAt).toLocaleString('zh-CN') : 'æœªçŸ¥'}</div>
                                </div>
                                <div class="flex gap-2 shrink-0">
                                    <button onclick="safeCall('doConfirmRemedy',${r._idx});" class="px-3 py-2 bg-green-600 text-white rounded-lg text-sm">ç¡®è®¤</button>
                                    <button onclick="safeCall('doRejectRemedy',${r._idx});" class="px-3 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm">æ‹’ç»</button>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>` : ''}

                ${pCatReqs.length > 0 ? `<div class="mb-4">
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="font-bold text-gray-600">â• å¾…å®¡æ ¸è‡ªå®šä¹‰å¥–åŠ± (${pCatReqs.length})</h4>
                    </div>
                    ${pCatReqs.map(r => `
                        <div class="card p-3 mb-2">
                            <div class="flex justify-between items-start">
                                <div class="pr-3">
                                    <div class="font-bold">${r.catName || 'è‡ªå®šä¹‰å¥–åŠ±'} Â· ${r.item || ''}</div>
                                    <div class="text-xs text-gray-500 mt-1">å»ºè®®ï¼š${r.suggestedPts || 0} åˆ†</div>
                                    ${r.reason ? `<div class="text-xs text-gray-600 mt-1 whitespace-pre-wrap">ç†ç”±ï¼š${r.reason}</div>` : ''}
                                </div>
                                <div class="flex gap-2 shrink-0">
                                    <button onclick="safeCall('approveCatReq',${r._idx});" class="px-3 py-2 bg-green-600 text-white rounded-lg text-sm">é€šè¿‡</button>
                                    <button onclick="safeCall('doRejectCatReq',${r._idx});" class="px-3 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm">æ‹’ç»</button>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>` : ''}

${pTaskReqs.length > 0 ? `<div class="mb-4">
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="font-bold text-gray-600">ğŸ“ å¾…å®¡æ ¸ä»»åŠ¡ç”³è¯· (${pTaskReqs.length})</h4>
                    </div>
                    ${pTaskReqs.map(r => `
                        <div class="card p-3 mb-2">
                            <div class="flex justify-between items-start">
                                <div class="pr-3">
                                    <div class="font-bold">${r.subjectName || 'ä»»åŠ¡ç”³è¯·'}</div>
                                    <div class="text-xs text-gray-500 mt-1">${taskTypeLabel(r.type)} Â· ç”³è¯·æ—¶é—´ï¼š${r.createdAt ? new Date(r.createdAt).toLocaleString('zh-CN') : 'æœªçŸ¥'}</div>
                                    ${r.reason ? `<div class="text-xs text-gray-600 mt-1 whitespace-pre-wrap">åŸå› ï¼š${r.reason}</div>` : ''}
                                </div>
                                <div class="flex gap-2 shrink-0">
                                    <button onclick="safeCall('approveTaskReq',${r._idx});" class="px-3 py-2 bg-green-600 text-white rounded-lg text-sm">å®¡æ ¸</button>
                                    <button onclick="doRejectTaskReq(${r._idx});" class="px-3 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm">æ‹’ç»</button>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>` : ''}

${pTaskSubs.length > 0 ? `<div class="mb-4">
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="font-bold text-gray-600">ğŸ“¤ å¾…è¯„å®šä»»åŠ¡ (${pTaskSubs.length})</h4>
                    </div>
                    ${pTaskSubs.map(item => `
                        <div class="card p-3 mb-2">
                            <div class="flex justify-between items-center">
                                <div>
                                    <div class="font-bold">${item.subjectName}</div>
                                    <div class="text-xs text-gray-500">${taskTypeLabel(item.type)} Â· æäº¤æ—¶é—´ï¼š${item.submittedAt ? new Date(item.submittedAt).toLocaleString('zh-CN') : 'æœªçŸ¥'}</div>
                                </div>
                                <button onclick="(function(){ hideModal(false,{skipHistory:true,force:true}); evaluateTask('${item.type}','${item.periodKey}','${item.subjectKey}'); })()" class="px-3 py-2 bg-green-600 text-white rounded-lg text-sm">è¯„å®š</button>
                            </div>
                        </div>
                    `).join('')}
                </div>` : ''}

                
                ${totalPending === 0 ? '<div class=\"text-gray-400 text-center py-8\">æš‚æ— å¾…å®¡æ‰¹ âœ“</div>' : (pTaskReqs.length===0 && pTaskSubs.length===0 && pDaily.length===0 && pRed.length===0 && pAppeals.length===0 && pRemedies.length===0 && pCatReqs.length===0 ? `<div class=\"text-orange-600 text-center py-6\">å¾…å®¡ç»Ÿè®¡ä¸º ${totalPending}ï¼Œä½†å½“å‰ç‰ˆæœ¬æœªèƒ½è¯†åˆ«å…·ä½“æ¡ç›®ã€‚è¯·ç‚¹å³ä¸Šè§’åˆ·æ–°æˆ–åœ¨æ§åˆ¶å°æŸ¥çœ‹ DB æ•°æ®ã€‚</div>` : '')}
                
                <button onclick="updatePendingBadge(); hideModal(false,{skipHistory:true,force:true});" class="w-full mt-4 py-3 bg-gray-100 rounded-xl">å…³é—­</button>
            </div>
        `);
    
        updatePendingBadge();
}

    // P1: æ‰¹é‡é€šè¿‡ä½é£é™©æ¯æ—¥æ‰“å¡ï¼ˆ4é¡¹å…¨doneä¸”æ— æ‰£åˆ†ï¼‰
    function batchApproveDaily() {
        showPwdModal('æ‰¹é‡é€šè¿‡éœ€è¦å¯†ç ', () => {
            const daily = DB.get('daily', {});
            const tasks = ['wakeUp', 'homework', 'organize', 'chore'];
            let count = 0;
            let dates = [];
            
            Object.entries(daily).forEach(([d, r]) => {
                if (r.submitted && !r.confirmed) {
                    const allDone = tasks.every(t => r[t] === true || r[t] === 'done');
                    const noDeduction = (r.deduction || 0) === 0;
                    if (allDone && noDeduction) {
                        r.confirmed = true;
                        r.confirmedAt = new Date().toISOString();
                        r.confirmedAtLocal = formatYMD(new Date());
                        r.batchApproved = true; // æ ‡è®°ä¸ºæ‰¹é‡é€šè¿‡
                        count++;
                        dates.push(d);
                    }
                }
            });
            
            DB.set('daily', daily);
            
            if (count > 0) {
                addNotification('daily', 'æ‰¹é‡é€šè¿‡æ‰“å¡', `${count}å¤©æ‰“å¡è®°å½•å·²ç¡®è®¤ (${dates.slice(0,3).map(d => formatDate(d).split(' ')[0]).join('ã€')}${dates.length > 3 ? 'ç­‰' : ''})`, true);
            }
            
            alert(`âœ… å·²æ‰¹é‡é€šè¿‡ ${count} ä¸ªä½é£é™©æ‰“å¡è®°å½•`);
            render();
        });
    }

    function approveTaskReq(idx) {
        const requests = DB.get('taskRequests', []);
        const r = requests[idx];
        if (!r) return;

        showModal(`
            <div class="card p-4 w-full max-w-md" onclick="event.stopPropagation()">
                <h3 class="text-lg font-bold mb-4">âœ… æ‰¹å‡†ä»»åŠ¡ç”³è¯·</h3>
                
                <!-- é«˜éš¾åº¦æç¤ºåŒºåŸŸï¼ˆåŠ¨æ€æ˜¾ç¤ºï¼‰ -->
                <div id="approveHighDiffWarning" class="hidden bg-orange-100 text-orange-700 text-sm p-3 rounded-lg mb-4">
                    <div class="font-medium">âš ï¸ é«˜éš¾åº¦ä»»åŠ¡æç¤º</div>
                    <div id="approveHighDiffText" class="text-xs mt-1"></div>
                </div>
                
                <div class="bg-blue-50 p-3 rounded-lg mb-3">
                    <div class="font-medium">${r.subjectName}</div>
                    <div class="text-sm text-gray-600 mt-1 whitespace-pre-wrap">${r.description}</div>
                    <div class="text-xs text-gray-400 mt-2">${r.standard || 'æ— éªŒæ”¶æ ‡å‡†'}</div>
                </div>

                
                <div class="mb-3">
                    <label class="block text-sm text-gray-600 mb-2">éš¾åº¦æ ‡å‡†åŒ–ï¼ˆå››å› å­æ¨¡å‹è‡ªåŠ¨å»ºè®®ï¼Œå¯æ‰‹åŠ¨è¦†ç›–ï¼‰</label>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div>
                            <div class="text-xs text-gray-500 mb-1">ä»»åŠ¡ç±»å‹ï¼ˆç±»å‹ç³»æ•°ï¼‰</div>
                            <select id="approveType" class="w-full border rounded px-3 py-2" onchange="applyTaskTypeToDiff('approveType','approveDiff','approveTypeHint');checkApproveHighDiff()">
                                ${(CONFIG.taskTypes||[]).map(tt => `<option value="${tt.key}" ${(r.suggestedType||'practice')===tt.key ? 'selected' : ''}>${tt.label}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <div class="text-xs text-gray-500 mb-1">é¢„è®¡æ—¶é•¿ï¼ˆæ—¶é•¿ç³»æ•°ï¼‰</div>
                            <select id="approveDur" class="w-full border rounded px-3 py-2" onchange="applyTaskTypeToDiff('approveType','approveDiff','approveTypeHint');checkApproveHighDiff()">
                                ${(CONFIG.durationFactors||[]).map(d => `<option value="${d.key}" ${(r.suggestedDur||'m15_30')===d.key ? 'selected' : ''}>${d.label}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <div class="text-xs text-gray-500 mb-1">è¯æ®ç±»å‹ï¼ˆè¯æ®ç³»æ•°ï¼‰</div>
                            <select id="approveEvi" class="w-full border rounded px-3 py-2" onchange="applyTaskTypeToDiff('approveType','approveDiff','approveTypeHint');checkApproveHighDiff()">
                                ${(CONFIG.evidenceFactors||[]).map(e => `<option value="${e.key}" ${(r.suggestedEvi||'oral')===e.key ? 'selected' : ''}>${e.label}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <div class="text-xs text-gray-500 mb-1">æ–°é¢–åº¦ï¼ˆæ–°é¢–åº¦ç³»æ•°ï¼‰</div>
                            <select id="approveNov" class="w-full border rounded px-3 py-2" onchange="applyTaskTypeToDiff('approveType','approveDiff','approveTypeHint');checkApproveHighDiff()">
                                ${(CONFIG.noveltyFactors||[]).map(n => `<option value="${n.key}" ${(r.suggestedNov||'normal')===n.key ? 'selected' : ''}>${n.label}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                    <div id="approveTypeHint" class="text-xs text-gray-600 mt-2"></div>
                    <button onclick="applyTaskTypeToDiff('approveType','approveDiff','approveTypeHint');checkApproveHighDiff()" class="mt-2 w-full py-2 bg-gray-50 rounded-lg text-sm text-gray-700">æŒ‰å››å› å­åˆ·æ–°å»ºè®®å€æ•°</button>
                </div>


                <select id="approveDiff" class="w-full border rounded px-3 py-2" onchange="checkApproveHighDiff()">
                    ${CONFIG.difficulties.map(d => `<option value="${d.v}" ${r.suggestedDiff === d.v ? 'selected' : ''}>Ã—${d.v} ${d.label}</option>`).join('')}
                </select>
                <div class="flex space-x-3 mt-4">
                    <button onclick="hideModal()" class="flex-1 py-3 bg-gray-100 rounded-xl">å–æ¶ˆ</button>
                    <button onclick="execApproveTaskReq(${idx})" class="flex-1 py-3 btn-success rounded-xl">æ‰¹å‡†</button>
                </div>
            </div>
        `);
        setTimeout(() => { applyTaskTypeToDiff('approveType','approveDiff','approveTypeHint'); checkApproveHighDiff(); }, 50);
    }

    // æ£€æŸ¥å®¶é•¿å®¡æ‰¹ä»»åŠ¡æ—¶çš„é«˜éš¾åº¦æç¤º
    function checkApproveHighDiff() {
        const diff = parseFloat(document.getElementById('approveDiff')?.value) || 1.0;
        const evi = document.getElementById('approveEvi')?.value || 'oral';
        const warnEl = document.getElementById('approveHighDiffWarning');
        const textEl = document.getElementById('approveHighDiffText');
        if (!warnEl || !textEl) return;
        
        let warnings = [];
        
        if (diff >= 1.8 && ['none', 'oral'].includes(evi)) {
            warnings.push('éš¾åº¦ç³»æ•°â‰¥1.8æ—¶ï¼Œå¿…é¡»æä¾›å®è´¨è¯æ®ï¼ˆç…§ç‰‡/è§†é¢‘/ä½œå“ç­‰ï¼‰ï¼Œå½“å‰é€‰æ‹©å°†è¢«æ‹¦æˆª');
        }
        if (diff >= 2.5) {
            warnings.push('éš¾åº¦ç³»æ•°â‰¥2.5æ˜¯"è¶…é«˜éš¾åº¦"ï¼Œæ‰¹å‡†æ—¶éœ€è¦äºŒæ¬¡ç¡®è®¤');
        }
        
        if (warnings.length > 0) {
            warnEl.classList.remove('hidden');
            textEl.innerHTML = warnings.map(w => `â€¢ ${w}`).join('<br>');
        } else {
            warnEl.classList.add('hidden');
        }
    }


    function execApproveTaskReq(idx) {
        // å…ˆè¯»å–è¾“å…¥ï¼ˆå¦åˆ™å¯†ç æ¡†ä¼šè¦†ç›–å½“å‰æ¨¡æ€æ¡†ï¼Œå¯¼è‡´è¯»ä¸åˆ°å€¼ï¼‰
        const approvedDiff = parseFloat(document.getElementById('approveDiff')?.value) || null;
        const approvedType = document.getElementById('approveType')?.value || null;
        const approvedDur = document.getElementById('approveDur')?.value || null;
        const approvedEvi = document.getElementById('approveEvi')?.value || null;
        const approvedNov = document.getElementById('approveNov')?.value || null;

        const approvedCoeffRaw = (function(){
            const model = calcDifficultyModel(
                approvedType || 'practice',
                approvedDur || 'm15_30',
                approvedEvi || 'oral',
                approvedNov || 'normal'
            );
            return model.raw;
        })();

        // P0: é«˜éš¾åº¦ç³»æ•°å¼ºçº¦æŸ
        // è§„åˆ™1: ç³»æ•°>=1.8æ—¶ï¼Œè¯æ®ä¸å¾—ä¸º none/oral
        if (approvedDiff >= 1.8 && ['none', 'oral'].includes(approvedEvi)) {
            alert('âš ï¸ éš¾åº¦ç³»æ•°â‰¥1.8æ—¶ï¼Œå¿…é¡»æä¾›å®è´¨è¯æ®ï¼ˆç…§ç‰‡/è§†é¢‘/ä½œå“ç­‰ï¼‰ï¼Œä¸èƒ½ä»…ä¸ºå£å¤´è¯´æ˜');
            return;
        }
        // è§„åˆ™2: ç³»æ•°2.5~3.0éœ€äºŒæ¬¡ç¡®è®¤
        if (approvedDiff >= 2.5) {
            if (!confirm('âš ï¸ è¶…é«˜éš¾åº¦(Ã—' + approvedDiff + ')ä»»åŠ¡ï¼Œç¡®è®¤æ‰¹å‡†ï¼Ÿ\n\nè¿™æ˜¯"è¶…è¶Š/å°é¡¶"çº§åˆ«ï¼Œè¯·ç¡®ä¿ä»»åŠ¡ç¡®å®è¾¾åˆ°æ­¤éš¾åº¦ã€‚')) {
                return;
            }
        }

        showPwdModal('æ‰¹å‡†éœ€è¦å¯†ç ', () => {
            const requests = DB.get('taskRequests', []);
            const r = requests[idx];
            if (!r) return;

            const allTasks = DB.get('tasks', {});
            const taskKey = `${r.type}_${r.periodKey}`;
            if (!allTasks[taskKey]) allTasks[taskKey] = {};

            allTasks[taskKey][r.subjectKey] = {
                description: r.description,
                standard: r.standard || '',
                difficulty: approvedDiff || r.suggestedDiff,
                diffType: approvedType || r.suggestedType || 'practice',
                diffDur: approvedDur || r.suggestedDur || 'm15_30',
                diffEvi: approvedEvi || r.suggestedEvi || 'oral',
                diffNov: approvedNov || r.suggestedNov || 'normal',
                diffCoeffRaw: approvedCoeffRaw || r.suggestedCoeffRaw || null,
            };
            DB.set('tasks', allTasks);

            r.resolved = true;
            r.approved = true;
            r.resolvedAt = new Date().toISOString();
            DB.set('taskRequests', requests);

            // æ·»åŠ é€šçŸ¥
            const typeLabel = r.type === 'weekly' ? 'å‘¨ä»»åŠ¡' : r.type === 'monthly' ? 'æœˆä»»åŠ¡' : r.type === 'quarterly' ? 'å­£åº¦ä»»åŠ¡' : 'å¹´åº¦ä»»åŠ¡';
            addNotification('taskReq', 'ä»»åŠ¡ç”³è¯·å·²é€šè¿‡', `${r.subjectName}: ${r.description?.substring(0,30)}${r.description?.length>30?'...':''} (${typeLabel} Ã—${approvedDiff})`, true);

            alert('âœ… ä»»åŠ¡å·²æ‰¹å‡†å¹¶æ·»åŠ ');
            render();
        });
    }


    function doRejectTaskReq(idx) {
        const requests = DB.get('taskRequests', []);
        const r = requests[idx];
        if (!r) return;
        showModal(`
            <div class="card p-4 w-full max-w-sm" onclick="event.stopPropagation()">
                <h3 class="text-lg font-bold mb-4">âŒ æ‹’ç»ä»»åŠ¡ç”³è¯·</h3>
                <div class="bg-gray-50 p-3 rounded-lg mb-3 text-sm">
                    <div class="font-medium">${r.subjectName}</div>
                    <div class="text-gray-600">${r.description?.substring(0,50)}${r.description?.length>50?'...':''}</div>
                </div>
                <textarea id="rejectReason" class="w-full border rounded px-3 py-2" rows="2" placeholder="è¯·è¾“å…¥æ‹’ç»åŸå› ï¼ˆå¿…å¡«ï¼‰"></textarea>
                <div class="flex space-x-3 mt-4">
                    <button onclick="hideModal()" class="flex-1 py-3 bg-gray-100 rounded-xl">å–æ¶ˆ</button>
                    <button onclick="execRejectTaskReq(${idx})" class="flex-1 py-3 btn-danger rounded-xl">ç¡®è®¤æ‹’ç»</button>
                </div>
            </div>
        `);
    }

    function execRejectTaskReq(idx) {
        const reason = document.getElementById('rejectReason')?.value?.trim();
        if (!reason) { alert('è¯·å¡«å†™æ‹’ç»åŸå› '); return; }
        showPwdModal('æ‹’ç»éœ€è¦å¯†ç ', () => {
            const requests = DB.get('taskRequests', []);
            const r = requests[idx];
            if (r) {
                r.resolved = true;
                r.approved = false;
                r.resolvedAt = new Date().toISOString();
                r.rejectReason = reason;
                DB.set('taskRequests', requests);
                
                const typeLabel = r.type === 'weekly' ? 'å‘¨ä»»åŠ¡' : r.type === 'monthly' ? 'æœˆä»»åŠ¡' : r.type === 'quarterly' ? 'å­£åº¦ä»»åŠ¡' : 'å¹´åº¦ä»»åŠ¡';
                addNotification('taskReq', 'ä»»åŠ¡ç”³è¯·è¢«æ‹’ç»', `${r.subjectName}: ${r.description?.substring(0,30)}${r.description?.length>30?'...':''} (${typeLabel})`, false, reason);
                
                hideModal();
                alert('âŒ å·²æ‹’ç»');
                render();
            }
        });
    }

    function doConfirmRemedy(idx) {
        showPwdModal('ç¡®è®¤éœ€è¦å¯†ç ', () => {
            const remedies = DB.get('remedies', []);
            const r = remedies[idx];
            if (r) {
                r.confirmed = true;
                r.confirmedAt = new Date().toISOString();
                r.confirmedAtLocal = formatYMD(new Date());
                DB.set('remedies', remedies);
                
                addNotification('remedy', 'å¼¥è¡¥å·²ç¡®è®¤', `${r.action} (+${r.refundPoints}åˆ†)`, true);
                
                alert(`âœ… å·²ç¡®è®¤ï¼+${r.refundPoints}åˆ†`);
                render();
            }
        });
    }

    function doRejectRemedy(idx) {
        const remedies = DB.get('remedies', []);
        const r = remedies[idx];
        if (!r) return;
        showModal(`
            <div class="card p-4 w-full max-w-sm" onclick="event.stopPropagation()">
                <h3 class="text-lg font-bold mb-4">âŒ æ‹’ç»å¼¥è¡¥ç”³è¯·</h3>
                <div class="bg-gray-50 p-3 rounded-lg mb-3 text-sm">
                    <div class="font-medium">${r.action}</div>
                    <div class="text-gray-600">ç”³è¯·è¿”è¿˜ +${r.refundPoints}åˆ†</div>
                </div>
                <textarea id="rejectRemedyReason" class="w-full border rounded px-3 py-2" rows="2" placeholder="è¯·è¾“å…¥æ‹’ç»åŸå› ï¼ˆå¿…å¡«ï¼‰"></textarea>
                <div class="flex space-x-3 mt-4">
                    <button onclick="hideModal()" class="flex-1 py-3 bg-gray-100 rounded-xl">å–æ¶ˆ</button>
                    <button onclick="execRejectRemedy(${idx})" class="flex-1 py-3 btn-danger rounded-xl">ç¡®è®¤æ‹’ç»</button>
                </div>
            </div>
        `);
    }

    function execRejectRemedy(idx) {
        const reason = document.getElementById('rejectRemedyReason')?.value?.trim();
        if (!reason) { alert('è¯·å¡«å†™æ‹’ç»åŸå› '); return; }
        showPwdModal('æ‹’ç»éœ€è¦å¯†ç ', () => {
            const remedies = DB.get('remedies', []);
            const r = remedies[idx];
            if (r) {
                r.rejected = true;
                r.rejectedAt = new Date().toISOString();
                r.rejectReason = reason;
                DB.set('remedies', remedies);
                
                addNotification('remedy', 'å¼¥è¡¥ç”³è¯·è¢«æ‹’ç»', `${r.action}`, false, reason);
                
                hideModal();
                alert('âŒ å·²æ‹’ç»');
                render();
            }
        });
    }

    function doApproveAppeal(idx) {
        showPwdModal('é€šè¿‡éœ€è¦å¯†ç ', () => {
            const appeals = DB.get('appeals', []);
            const a = appeals[idx];
            if (!a) return;
            const daily = DB.get('daily', {});
            const r = daily[a.date] || {};
            if (r.deductionList && r.deductionList[a.dedIdx]) {
                r.deductionList.splice(a.dedIdx, 1);
                r.deduction = (r.deductionList || []).reduce((s, i) => s + (i.pts || 0), 0);
                daily[a.date] = r;
                DB.set('daily', daily);
            }
            a.resolved = true;
            a.approved = true;
            a.resolvedAt = new Date().toISOString();
            DB.set('appeals', appeals);
            
            addNotification('appeal', 'ç”³è¯‰å·²é€šè¿‡', `${a.dedLabel} æ‰£åˆ†å·²æ’¤é”€`, true);
            
            alert('âœ… ç”³è¯‰é€šè¿‡');
            render();
        });
    }

    function doRejectAppeal(idx) {
        const appeals = DB.get('appeals', []);
        const a = appeals[idx];
        if (!a) return;
        showModal(`
            <div class="card p-4 w-full max-w-sm" onclick="event.stopPropagation()">
                <h3 class="text-lg font-bold mb-4">âŒ é©³å›ç”³è¯‰</h3>
                <div class="bg-gray-50 p-3 rounded-lg mb-3 text-sm">
                    <div class="font-medium">${a.dedLabel}</div>
                    <div class="text-gray-600">ç”³è¯‰ç†ç”±: ${a.reason}</div>
                </div>
                <textarea id="rejectAppealReason" class="w-full border rounded px-3 py-2" rows="2" placeholder="è¯·è¾“å…¥é©³å›åŸå› ï¼ˆå¿…å¡«ï¼‰"></textarea>
                <div class="flex space-x-3 mt-4">
                    <button onclick="hideModal()" class="flex-1 py-3 bg-gray-100 rounded-xl">å–æ¶ˆ</button>
                    <button onclick="execRejectAppeal(${idx})" class="flex-1 py-3 btn-danger rounded-xl">ç¡®è®¤é©³å›</button>
                </div>
            </div>
        `);
    }

    function execRejectAppeal(idx) {
        const reason = document.getElementById('rejectAppealReason')?.value?.trim();
        if (!reason) { alert('è¯·å¡«å†™é©³å›åŸå› '); return; }
        showPwdModal('é©³å›éœ€è¦å¯†ç ', () => {
            const appeals = DB.get('appeals', []);
            const a = appeals[idx];
            if (a) {
                a.resolved = true;
                a.approved = false;
                a.resolvedAt = new Date().toISOString();
                a.rejectReason = reason;
                DB.set('appeals', appeals);
                
                addNotification('appeal', 'ç”³è¯‰è¢«é©³å›', `${a.dedLabel}`, false, reason);
                
                hideModal();
                alert('âŒ ç”³è¯‰é©³å›');
                render();
            }
        });
    }

    function formatDate(ds) {
        const d = new Date(ds);
        return `${d.getMonth() + 1}æœˆ${d.getDate()}æ—¥ ${['å‘¨æ—¥','å‘¨ä¸€','å‘¨äºŒ','å‘¨ä¸‰','å‘¨å››','å‘¨äº”','å‘¨å…­'][d.getDay()]}`;
    }

    // åˆå§‹åŒ–
    render();
    // Service Worker disabled to avoid iOS/Safari cache issues on single-file deployments
    if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js').catch(() => {});
  });
}
</script>
</body>
</html>
