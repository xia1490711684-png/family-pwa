<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="theme-color" content="#0b1220">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>ç”µè§†ç›´æ’­</title>
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="apple-touch-icon" href="apple-touch-icon.png">
  <style>
    :root {
      --bg: #0b1220;
      --card: #111b2e;
      --muted: #94a3b8;
      --text: #e5e7eb;
      --accent: #4ade80;
      --accent-dim: rgba(74, 222, 128, 0.15);
      --line: #1e293b;
      --danger: #f87171;
      --warning: #fbbf24;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html { background: var(--bg); }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, "PingFang SC", "Microsoft YaHei", sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding-bottom: env(safe-area-inset-bottom, 0);
    }

    header {
      position: sticky;
      top: 0;
      z-index: 100;
      background: rgba(11, 18, 32, 0.92);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--line);
      padding: 16px 16px 12px;
    }
    .header-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }
    h1 { font-size: 18px; font-weight: 650; letter-spacing: .2px; }
    .header-actions { display: flex; gap: 8px; }
    .icon-btn {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      border: 1px solid var(--line);
      background: var(--card);
      color: var(--text);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
    }
    .icon-btn:active { opacity: 0.7; }

    .search-row { display: flex; gap: 10px; }
    .search-input {
      flex: 1;
      padding: 10px 14px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: rgba(15, 23, 42, 0.8);
      color: var(--text);
      font-size: 15px;
      outline: none;
    }
    .search-input::placeholder { color: var(--muted); }
    .search-input:focus { border-color: var(--accent); }

    .filter-row {
      display: flex;
      gap: 8px;
      overflow-x: auto;
      padding: 12px 16px;
      margin: 0 -16px;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }
    .filter-row::-webkit-scrollbar { display: none; }
    .filter-chip {
      flex-shrink: 0;
      padding: 6px 14px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: var(--card);
      color: var(--muted);
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
      user-select: none;
    }
    .filter-chip.active { background: var(--accent-dim); border-color: var(--accent); color: var(--accent); }

    main { padding: 0 16px 24px; max-width: 1200px; margin: 0 auto; }

    .notice {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 14px 16px;
      margin: 16px 0;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.55;
      white-space: pre-wrap;
    }

    .section { margin-top: 18px; }
    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    .section-title { font-size: 13px; color: var(--muted); font-weight: 600; }
    .section-action { font-size: 12px; color: var(--accent); cursor: pointer; user-select:none; }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 12px;
    }

    .channel-card {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px;
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 14px;
      text-decoration: none;
      color: inherit;
      transition: all 0.2s;
    }
    .channel-card:active { transform: scale(0.98); opacity: 0.9; }
    .channel-card.disabled { opacity: 0.5; pointer-events: none; }

    .channel-logo {
      width: 44px;
      height: 44px;
      border-radius: 12px;
      background: rgba(15, 23, 42, 0.8);
      border: 1px solid var(--line);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      flex-shrink: 0;
      overflow: hidden;
    }
    .channel-logo img { width: 100%; height: 100%; object-fit: cover; }

    .channel-info { flex: 1; min-width: 0; }
    .channel-name {
      font-size: 15px;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-bottom: 4px;
    }
    .channel-meta {
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .channel-actions { display: flex; align-items: center; gap: 8px; flex-shrink: 0; }
    .fav-btn {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      border: none;
      background: transparent;
      color: var(--muted);
      cursor: pointer;
      font-size: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .fav-btn.active { color: var(--warning); }
    .play-badge {
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid rgba(74, 222, 128, 0.3);
      color: var(--accent);
      font-size: 12px;
      font-weight: 650;
    }

    .empty { text-align: center; padding: 48px 24px; color: var(--muted); }
    .empty-icon { font-size: 48px; margin-bottom: 16px; }
    .empty-text { font-size: 14px; line-height: 1.6; }

    footer {
      padding: 20px 16px;
      border-top: 1px solid var(--line);
      color: var(--muted);
      font-size: 12px;
      text-align: center;
    }
    footer code {
      background: rgba(15, 23, 42, 0.8);
      padding: 2px 6px;
      border-radius: 4px;
      border: 1px solid var(--line);
    }

    /* Modal */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.55);
      display: none;
      z-index: 999;
      padding: 18px;
      padding-top: calc(18px + env(safe-area-inset-top, 0));
      padding-bottom: calc(18px + env(safe-area-inset-bottom, 0));
    }
    .modal.show { display: block; }
    .modal-card {
      max-width: 860px;
      margin: 0 auto;
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0,0,0,.45);
    }
    .modal-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 16px;
      border-bottom: 1px solid var(--line);
      background: rgba(17, 27, 46, .7);
    }
    .modal-title { font-size: 14px; font-weight: 700; color: var(--text); }
    .modal-close {
      width: 34px;
      height: 34px;
      border-radius: 10px;
      border: 1px solid var(--line);
      background: transparent;
      color: var(--muted);
      cursor: pointer;
      font-size: 18px;
    }
    .modal-body { padding: 16px; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; }
    .field {
      flex: 1;
      min-width: 220px;
      background: rgba(15, 23, 42, 0.6);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 12px;
    }
    .field label { display:block; font-size: 12px; color: var(--muted); margin-bottom: 8px; }
    textarea {
      width: 100%;
      min-height: 160px;
      resize: vertical;
      border-radius: 10px;
      border: 1px solid var(--line);
      background: rgba(11, 18, 32, 0.8);
      color: var(--text);
      padding: 10px;
      font-size: 12px;
      outline: none;
    }
    input[type="text"], input[type="url"] {
      width: 100%;
      border-radius: 10px;
      border: 1px solid var(--line);
      background: rgba(11, 18, 32, 0.8);
      color: var(--text);
      padding: 10px;
      font-size: 13px;
      outline: none;
    }
    input[type="file"] { width: 100%; color: var(--muted); }

    .modal-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      padding: 14px 16px;
      border-top: 1px solid var(--line);
      background: rgba(17, 27, 46, .7);
    }
    .btn {
      padding: 10px 14px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: var(--bg);
      color: var(--text);
      cursor: pointer;
      font-size: 13px;
      font-weight: 650;
    }
    .btn:active { opacity: .7; }
    .btn.primary { background: var(--accent-dim); border-color: var(--accent); color: var(--accent); }
    .btn.danger { background: rgba(248,113,113,.12); border-color: rgba(248,113,113,.35); color: var(--danger); }

    .hint { color: var(--muted); font-size: 12px; line-height: 1.55; margin-top: 10px; white-space: pre-wrap; }

    /* Desktop: slightly closer to â€œç”µè§†å®¶â€ two-pane feel */
    @media (min-width: 980px) {
      .grid { grid-template-columns: repeat(auto-fill, minmax(360px, 1fr)); }
      header { padding-left: 22px; padding-right: 22px; }
      main { padding-left: 22px; padding-right: 22px; }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-top">
      <h1>ç”µè§†ç›´æ’­</h1>
      <div class="header-actions">
        <button class="icon-btn" id="importBtn" title="å¯¼å…¥æ’­æ”¾åˆ—è¡¨">â•</button>
        <button class="icon-btn" id="refreshBtn" title="åˆ·æ–°é¢‘é“">ğŸ”„</button>
        <button class="icon-btn" id="clearBadBtn" title="æ¸…ç†å¤±æ•ˆè®°å½•">ğŸ§¹</button>
      </div>
    </div>
    <div class="search-row">
      <input type="search" class="search-input" id="searchInput" placeholder="æœç´¢é¢‘é“ / åˆ†ç±» / å…³é”®è¯...">
    </div>
    <div class="filter-row" id="filterRow">
      <button class="filter-chip active" data-category="all">å…¨éƒ¨</button>
    </div>
  </header>

  <main>
    <div class="notice" id="notice" style="display:none;"></div>
    <div id="content"></div>
  </main>

  <footer>
    è¯´æ˜ï¼šæœ¬å·¥å…·æ”¯æŒæ’­æ”¾ <code>.m3u8</code>ï¼ˆHLSï¼‰ä¸æ‰“å¼€å®˜æ–¹ç›´æ’­ç½‘é¡µï¼ˆwebï¼‰ã€‚è¯·ä»…å¯¼å…¥ä½ æœ‰æƒè§‚çœ‹/è½¬è½½çš„ç›´æ’­æºã€‚
  </footer>

  <!-- Import Modal -->
  <div class="modal" id="importModal" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true">
      <div class="modal-head">
        <div class="modal-title">å¯¼å…¥æ’­æ”¾åˆ—è¡¨ï¼ˆm3u / m3u8ï¼‰</div>
        <button class="modal-close" id="importClose" title="å…³é—­">Ã—</button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="field">
            <label>æ–¹å¼ Aï¼šç²˜è´´ M3U å†…å®¹</label>
            <textarea id="m3uText" placeholder="#EXTM3U\n#EXTINF:-1 group-title=\"æˆ‘çš„å¯¼å…¥\",CCTV-13\nhttps://.../index.m3u8\n..."></textarea>
          </div>
          <div class="field">
            <label>æ–¹å¼ Bï¼šé€‰æ‹©æœ¬åœ° m3u/m3u8 æ–‡ä»¶</label>
            <input id="m3uFile" type="file" accept=".m3u,.m3u8,text/plain" />
            <div style="height:12px"></div>
            <label>æ–¹å¼ Cï¼šä» URL æ‹‰å–ï¼ˆéœ€è¦è¯¥ URL å…è®¸è·¨åŸŸ CORSï¼‰</label>
            <input id="m3uUrl" type="url" placeholder="https://example.com/list.m3u" />
            <div class="hint" id="importHint">å»ºè®®ï¼šä¼˜å…ˆå¯¼å…¥ä½ è‡ªå·±ç»´æŠ¤çš„è®¢é˜…æºï¼ˆè‡ªå»º/å®˜æ–¹/æˆæƒï¼‰ã€‚ç½‘é¡µç¯å¢ƒä¸‹ï¼Œå¾ˆå¤šéå®˜æ–¹æºä¼šå›  CORS æˆ– HTTPS æ··åˆå†…å®¹è€Œå¤±è´¥ã€‚

å¯¼å…¥åä¼šè‡ªåŠ¨åˆå¹¶åŒåé¢‘é“çš„å¤šçº¿è·¯ï¼Œå¹¶æ”¯æŒï¼šæ”¶è— / æœç´¢ / æœ€è¿‘è§‚çœ‹ / è‡ªåŠ¨æµ‹é€Ÿé€‰çº¿ / å¤±è´¥è‡ªåŠ¨åˆ‡çº¿ã€‚</div>
          </div>
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn primary" id="doImport">å¯¼å…¥å¹¶ä¿å­˜</button>
        <button class="btn" id="exportM3U">å¯¼å‡ºæˆ‘çš„å¯¼å…¥</button>
        <button class="btn danger" id="clearImport">æ¸…ç©ºæˆ‘çš„å¯¼å…¥</button>
        <div style="flex:1"></div>
        <button class="btn" id="close2">å…³é—­</button>
      </div>
    </div>
  </div>

<script>
(function() {
  'use strict';

  // ========== Storage Helpers ==========
  const Storage = {
    get(key, def = null) {
      try {
        const v = localStorage.getItem(key);
        return v ? JSON.parse(v) : def;
      } catch { return def; }
    },
    set(key, val) {
      try { localStorage.setItem(key, JSON.stringify(val)); } catch {}
    },
    del(key) {
      try { localStorage.removeItem(key); } catch {}
    }
  };

  const KEY_CUSTOM = 'tv_custom_channels';
  const KEY_FAV = 'tv_favorites';
  const KEY_RECENT = 'tv_recent';

  // ========== State ==========
  let channelsData = { notice: '', categories: [], channels: [] };
  let favorites = Storage.get(KEY_FAV, []);
  let recentIds = Storage.get(KEY_RECENT, []);
  let customChannels = Storage.get(KEY_CUSTOM, []);
  let currentCategory = 'all';
  let searchTerm = '';

  // ========== DOM ==========
  const $ = id => document.getElementById(id);
  const searchInput = $('searchInput');
  const filterRow = $('filterRow');
  const content = $('content');
  const notice = $('notice');
  const refreshBtn = $('refreshBtn');
  const clearBadBtn = $('clearBadBtn');
  const importBtn = $('importBtn');
  const importModal = $('importModal');
  const importClose = $('importClose');
  const close2 = $('close2');
  const doImport = $('doImport');
  const exportM3U = $('exportM3U');
  const clearImport = $('clearImport');
  const m3uText = $('m3uText');
  const m3uFile = $('m3uFile');
  const m3uUrl = $('m3uUrl');

  // ========== Utils ==========
  function escapeHtml(s) {
    return (s || '').replace(/[&<>"']/g, c => ({
      '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
    }[c]));
  }

  function normalizeText(s) {
    return String(s || '').trim();
  }

  function matchSearch(ch, term) {
    if (!term) return true;
    const t = term.toLowerCase();
    const fields = [
      ch.name || '',
      ch.category || '',
      ...(ch.tags || []),
      ch.region || ''
    ];
    return fields.some(f => String(f).toLowerCase().includes(t));
  }

  function safeId(input) {
    const base = String(input || 'channel').toLowerCase().replace(/[^a-z0-9\u4e00-\u9fa5]+/g, '_').replace(/^_+|_+$/g, '');
    const rand = Math.random().toString(16).slice(2, 8);
    return `custom_${base}_${rand}`;
  }

  // ========== M3U Parser ==========
  function parseM3U(text) {
    const lines = String(text || '').replace(/\r/g, '').split('\n');
    const items = [];
    let cur = null;

    for (let raw of lines) {
      const line = raw.trim();
      if (!line) continue;
      if (line.startsWith('#EXTM3U')) continue;

      if (line.startsWith('#EXTINF')) {
        // Example: #EXTINF:-1 tvg-name="xxx" group-title="News",Channel Name
        const comma = line.indexOf(',');
        const meta = comma >= 0 ? line.slice(0, comma) : line;
        const name = comma >= 0 ? line.slice(comma + 1).trim() : '';
        const attrs = {};
        const re = /(\w+(?:-\w+)*)="([^"]*)"/g;
        let m;
        while ((m = re.exec(meta)) !== null) {
          attrs[m[1]] = m[2];
        }
        cur = {
          name: attrs['tvg-name'] || name || 'æœªå‘½å',
          logo: attrs['tvg-logo'] || '',
          group: attrs['group-title'] || 'æˆ‘çš„å¯¼å…¥',
          url: ''
        };
        continue;
      }

      if (line.startsWith('#')) {
        // ignore other tags
        continue;
      }

      // url line
      if (cur) {
        cur.url = line;
        items.push(cur);
        cur = null;
      } else {
        // bare url line without EXTINF
        items.push({ name: 'æœªå‘½å', logo: '', group: 'æˆ‘çš„å¯¼å…¥', url: line });
      }
    }

    // merge same name+group into multi-sources
    const map = new Map();
    for (const it of items) {
      const key = `${it.group}__${it.name}`;
      if (!map.has(key)) {
        map.set(key, {
          id: safeId(it.name),
          name: normalizeText(it.name) || 'æœªå‘½å',
          category: normalizeText(it.group) || 'æˆ‘çš„å¯¼å…¥',
          logo: it.logo || '',
          sources: [],
          tags: ['å¯¼å…¥'],
          region: 'custom',
          order: 9999
        });
      }
      const ch = map.get(key);
      const n = ch.sources.length + 1;
      ch.sources.push({ label: `çº¿è·¯${n}`, url: it.url, priority: n });
      if (!ch.logo && it.logo) ch.logo = it.logo;
    }

    return Array.from(map.values());
  }

  function exportM3UText(channels) {
    const lines = ['#EXTM3U'];
    for (const ch of (channels || [])) {
      const group = ch.category || 'æˆ‘çš„å¯¼å…¥';
      const logo = ch.logo || '';
      const name = ch.name || 'æœªå‘½å';
      for (const src of (ch.sources || [])) {
        const url = src.url;
        if (!url) continue;
        const attrs = [];
        if (logo) attrs.push(`tvg-logo="${logo}"`);
        if (group) attrs.push(`group-title="${group}"`);
        attrs.push(`tvg-name="${name}"`);
        lines.push(`#EXTINF:-1 ${attrs.join(' ')},${name}`);
        lines.push(url);
      }
    }
    return lines.join('\n');
  }

  function downloadText(filename, text) {
    const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    setTimeout(() => {
      URL.revokeObjectURL(a.href);
      a.remove();
    }, 0);
  }

  // ========== Merge Channels ==========
  function getMergedData(baseData) {
    const merged = {
      notice: baseData.notice || '',
      categories: Array.isArray(baseData.categories) ? baseData.categories.slice() : [],
      channels: Array.isArray(baseData.channels) ? baseData.channels.slice() : []
    };

    // prepend custom channels
    if (Array.isArray(customChannels) && customChannels.length) {
      for (const ch of customChannels) {
        merged.channels.unshift(ch);
        if (ch.category && !merged.categories.includes(ch.category)) merged.categories.push(ch.category);
      }
    }

    // ensure "æˆ‘çš„å¯¼å…¥" exists
    if (!merged.categories.includes('æˆ‘çš„å¯¼å…¥')) merged.categories.push('æˆ‘çš„å¯¼å…¥');

    return merged;
  }

  // ========== Render ==========
  function renderFilters() {
    const cats = ['all', ...(channelsData.categories || [])];
    channelsData.channels.forEach(ch => {
      if (ch.category && !cats.includes(ch.category)) cats.push(ch.category);
    });

    filterRow.innerHTML = cats.map(cat => {
      const label = cat === 'all' ? 'å…¨éƒ¨' : cat;
      const active = currentCategory === cat ? 'active' : '';
      return `<button class="filter-chip ${active}" data-category="${escapeHtml(cat)}">${escapeHtml(label)}</button>`;
    }).join('');
  }

  function getFilteredChannels() {
    return channelsData.channels.filter(ch => {
      if (ch.disabled) return false;
      if (currentCategory !== 'all' && ch.category !== currentCategory) return false;
      if (!matchSearch(ch, searchTerm)) return false;
      return true;
    });
  }

  function renderChannelCard(ch, showFav = true) {
    const isFav = favorites.includes(ch.id);
    const hasSource = ch.sources && ch.sources.length > 0 && ch.sources[0].url;
    const disabled = !hasSource ? 'disabled' : '';
    const sourceCount = ch.sources ? ch.sources.length : 0;
    const metaText = sourceCount > 1
      ? `${ch.category || 'æœªåˆ†ç±»'} Â· ${sourceCount}æ¡çº¿è·¯`
      : (ch.category || 'æœªåˆ†ç±»');

    const logoContent = ch.logo
      ? `<img src="${escapeHtml(ch.logo)}" alt="" onerror="this.parentElement.textContent='ğŸ“º'">`
      : 'ğŸ“º';

    return `
      <div class="channel-card ${disabled}" data-id="${escapeHtml(ch.id)}">
        <div class="channel-logo">${logoContent}</div>
        <div class="channel-info">
          <div class="channel-name">${escapeHtml(ch.name)}</div>
          <div class="channel-meta">${escapeHtml(metaText)}</div>
        </div>
        <div class="channel-actions">
          ${showFav ? `<button class="fav-btn ${isFav ? 'active' : ''}" data-fav="${escapeHtml(ch.id)}" title="${isFav ? 'å–æ¶ˆæ”¶è—' : 'æ”¶è—'}">${isFav ? 'â˜…' : 'â˜†'}</button>` : ''}
          <span class="play-badge">${hasSource ? 'æ’­æ”¾' : 'æ— æº'}</span>
        </div>
      </div>
    `;
  }

  function renderSection(title, channels, action = null, showFav = true) {
    if (!channels.length) return '';
    return `
      <div class="section">
        <div class="section-header">
          <span class="section-title">${escapeHtml(title)}ï¼ˆ${channels.length}ï¼‰</span>
          ${action ? `<span class="section-action" data-action="${action.key}">${action.label}</span>` : ''}
        </div>
        <div class="grid">
          ${channels.map(ch => renderChannelCard(ch, showFav)).join('')}
        </div>
      </div>
    `;
  }

  function render() {
    const filtered = getFilteredChannels();

    const favChannels = !searchTerm && currentCategory === 'all'
      ? channelsData.channels.filter(ch => favorites.includes(ch.id) && !ch.disabled)
      : [];

    const recentChannels = !searchTerm && currentCategory === 'all'
      ? recentIds.slice(0, 8)
          .map(id => channelsData.channels.find(ch => ch.id === id))
          .filter(ch => ch && !ch.disabled && !favorites.includes(ch.id))
      : [];

    const grouped = new Map();
    filtered.forEach(ch => {
      if (favChannels.some(f => f.id === ch.id)) return;
      if (recentChannels.some(r => r.id === ch.id)) return;

      const cat = ch.category || 'æœªåˆ†ç»„';
      if (!grouped.has(cat)) grouped.set(cat, []);
      grouped.get(cat).push(ch);
    });

    let html = '';

    if (favChannels.length) {
      html += renderSection('â­ æ”¶è—', favChannels, { key: 'clearFav', label: 'æ¸…ç©º' }, true);
    }

    if (recentChannels.length) {
      html += renderSection('ğŸ• æœ€è¿‘è§‚çœ‹', recentChannels, { key: 'clearRecent', label: 'æ¸…ç©º' }, true);
    }

    const catOrder = new Map();
    (channelsData.categories || []).forEach((c, i) => catOrder.set(c, i));
    const sortedCats = Array.from(grouped.keys()).sort((a, b) => {
      const ai = catOrder.has(a) ? catOrder.get(a) : 9999;
      const bi = catOrder.has(b) ? catOrder.get(b) : 9999;
      if (ai !== bi) return ai - bi;
      return String(a).localeCompare(String(b), 'zh-Hans-CN');
    });

    for (const cat of sortedCats) {
      const chs = grouped.get(cat) || [];
      chs.sort((x, y) => (x.order ?? 9999) - (y.order ?? 9999));
      html += renderSection(cat, chs);
    }

    if (!favChannels.length && !recentChannels.length && !grouped.size) {
      html = `
        <div class="empty">
          <div class="empty-icon">ğŸ“¡</div>
          <div class="empty-text">
            ${searchTerm ? 'æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„é¢‘é“' : 'æš‚æ— é¢‘é“'}<br>
            ç‚¹å‡»å³ä¸Šè§’ â• å¯¼å…¥ä½ çš„ m3u/m3u8 æ’­æ”¾åˆ—è¡¨
          </div>
        </div>
      `;
    }

    content.innerHTML = html;
  }

  // ========== Events ==========
  function toggleFavorite(id) {
    const idx = favorites.indexOf(id);
    if (idx >= 0) favorites.splice(idx, 1);
    else favorites.unshift(id);
    Storage.set(KEY_FAV, favorites);
    render();
  }

  function addToRecent(id) {
    recentIds = recentIds.filter(x => x !== id);
    recentIds.unshift(id);
    if (recentIds.length > 25) recentIds = recentIds.slice(0, 25);
    Storage.set(KEY_RECENT, recentIds);
  }

  function handleCardClick(e) {
    const card = e.target.closest('.channel-card');
    if (!card || card.classList.contains('disabled')) return;

    const favBtn = e.target.closest('.fav-btn');
    if (favBtn) {
      e.preventDefault();
      e.stopPropagation();
      toggleFavorite(favBtn.dataset.fav);
      return;
    }

    const id = card.dataset.id;
    if (id) {
      addToRecent(id);
      window.location.href = `player.html?id=${encodeURIComponent(id)}`;
    }
  }

  function handleFilterClick(e) {
    const chip = e.target.closest('.filter-chip');
    if (!chip) return;
    currentCategory = chip.dataset.category;
    renderFilters();
    render();
  }

  function handleSectionAction(e) {
    const action = e.target.dataset.action;
    if (action === 'clearFav') {
      if (confirm('ç¡®å®šæ¸…ç©ºæ‰€æœ‰æ”¶è—ï¼Ÿ')) {
        favorites = [];
        Storage.set(KEY_FAV, favorites);
        render();
      }
    } else if (action === 'clearRecent') {
      if (confirm('ç¡®å®šæ¸…ç©ºæœ€è¿‘è§‚çœ‹ï¼Ÿ')) {
        recentIds = [];
        Storage.set(KEY_RECENT, recentIds);
        render();
      }
    }
  }

  // ========== Modal ==========
  function openModal() {
    importModal.classList.add('show');
    importModal.setAttribute('aria-hidden', 'false');
  }
  function closeModal() {
    importModal.classList.remove('show');
    importModal.setAttribute('aria-hidden', 'true');
  }

  importBtn.addEventListener('click', openModal);
  importClose.addEventListener('click', closeModal);
  close2.addEventListener('click', closeModal);
  importModal.addEventListener('click', (e) => {
    if (e.target === importModal) closeModal();
  });

  // Load file into textarea
  m3uFile.addEventListener('change', async () => {
    const f = m3uFile.files && m3uFile.files[0];
    if (!f) return;
    try {
      const txt = await f.text();
      m3uText.value = txt;
    } catch {
      alert('è¯»å–æ–‡ä»¶å¤±è´¥ã€‚');
    }
  });

  async function fetchText(url) {
    const res = await fetch(url, { cache: 'no-store' });
    if (!res.ok) throw new Error('HTTP ' + res.status);
    return await res.text();
  }

  doImport.addEventListener('click', async () => {
    try {
      let txt = normalizeText(m3uText.value);
      const url = normalizeText(m3uUrl.value);
      if (!txt && url) {
        txt = await fetchText(url);
      }
      if (!txt) {
        alert('è¯·ç²˜è´´å†…å®¹ã€é€‰æ‹©æ–‡ä»¶æˆ–å¡«å†™å¯è®¿é—®çš„ URLã€‚');
        return;
      }

      const imported = parseM3U(txt);
      if (!imported.length) {
        alert('æ²¡æœ‰è§£æåˆ°ä»»ä½•é¢‘é“ï¼ˆè¯·ç¡®è®¤æ˜¯ m3u/m3u8 æ ¼å¼ï¼‰ã€‚');
        return;
      }

      // Merge into customChannels: merge by (name+category)
      const keyOf = (c) => `${c.category || ''}__${c.name || ''}`;
      const map = new Map();
      (customChannels || []).forEach(c => map.set(keyOf(c), c));

      for (const c of imported) {
        const k = keyOf(c);
        if (!map.has(k)) {
          map.set(k, c);
        } else {
          // merge sources
          const exist = map.get(k);
          const urls = new Set((exist.sources || []).map(s => s.url));
          for (const s of (c.sources || [])) {
            if (s.url && !urls.has(s.url)) {
              exist.sources = exist.sources || [];
              exist.sources.push({ label: `çº¿è·¯${exist.sources.length + 1}`, url: s.url, priority: exist.sources.length + 1 });
              urls.add(s.url);
            }
          }
          if (!exist.logo && c.logo) exist.logo = c.logo;
        }
      }

      customChannels = Array.from(map.values());
      Storage.set(KEY_CUSTOM, customChannels);
      alert(`å¯¼å…¥å®Œæˆï¼š${imported.length} ä¸ªé¢‘é“ï¼ˆå·²åˆå¹¶å»é‡ï¼‰`);
      await loadChannels(true);
      closeModal();
    } catch (e) {
      alert('å¯¼å…¥å¤±è´¥ï¼š' + (e && e.message ? e.message : String(e)));
    }
  });

  exportM3U.addEventListener('click', () => {
    const txt = exportM3UText(customChannels || []);
    downloadText('my_import.m3u', txt);
  });

  clearImport.addEventListener('click', async () => {
    if (!confirm('ç¡®å®šæ¸…ç©ºâ€œæˆ‘çš„å¯¼å…¥â€ï¼Ÿï¼ˆä¸ä¼šå½±å“æ”¶è—/æœ€è¿‘ï¼‰')) return;
    customChannels = [];
    Storage.del(KEY_CUSTOM);
    await loadChannels(true);
    alert('å·²æ¸…ç©ºã€‚');
  });

  // ========== Load Data ==========
  async function loadChannels(bust = false) {
    try {
      const url = './channels.json' + (bust ? `?t=${Date.now()}` : '');
      const res = await fetch(url, { cache: 'no-store' });
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const base = await res.json();

      customChannels = Storage.get(KEY_CUSTOM, []);
      channelsData = getMergedData(base);

      if (channelsData.notice) {
        notice.style.display = '';
        notice.textContent = channelsData.notice;
      } else {
        notice.style.display = 'none';
      }

      renderFilters();
      render();
    } catch (err) {
      notice.style.display = '';
      notice.textContent = 'é¢‘é“åˆ—è¡¨åŠ è½½å¤±è´¥ï¼š' + err.message;
      content.innerHTML = `
        <div class="empty">
          <div class="empty-icon">âš ï¸</div>
          <div class="empty-text">
            æ— æ³•åŠ è½½é¢‘é“åˆ—è¡¨<br>
            è¯·ç¡®è®¤ channels.json æ–‡ä»¶å­˜åœ¨ä¸”æ ¼å¼æ­£ç¡®
          </div>
        </div>
      `;
    }
  }

  // ========== Service Worker ==========
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js').catch(() => {});
  }

  // ========== Init ==========
  searchInput.addEventListener('input', () => {
    searchTerm = searchInput.value.trim();
    render();
  });

  filterRow.addEventListener('click', handleFilterClick);
  content.addEventListener('click', handleCardClick);
  content.addEventListener('click', handleSectionAction);
  refreshBtn.addEventListener('click', () => loadChannels(true));

  clearBadBtn.addEventListener('click', () => {
    if (confirm('ç¡®å®šæ¸…ç†â€œå¤±æ•ˆçº¿è·¯â€è®°å½•ï¼Ÿæ¸…ç†åä¼šé‡æ–°å°è¯•æ‰€æœ‰çº¿è·¯ã€‚')) {
      try { localStorage.removeItem('tv_bad_sources'); } catch {}
      alert('å·²æ¸…ç†ã€‚');
    }
  });

  loadChannels(false);
})();
</script>
</body>
</html>
