<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0b1220" />
  <title>ç”µè§†ç›´æ’­ - é¢‘é“åˆ—è¡¨</title>

  <link rel="manifest" href="manifest.webmanifest">
  <link rel="apple-touch-icon" href="apple-touch-icon.png">

  <style>
    :root{--bg:#0b1220;--card:#111b2e;--muted:#94a3b8;--text:#e5e7eb;--acc:#4ade80;--line:#20304a}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"PingFang SC","Microsoft YaHei",sans-serif;background:var(--bg);color:var(--text)}
    header{padding:18px 16px;border-bottom:1px solid var(--line);background:rgba(11,18,32,.95);position:sticky;top:0;backdrop-filter:blur(8px)}
    h1{font-size:18px;margin:0 0 10px 0}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    input[type="search"]{flex:1;min-width:220px;padding:12px 12px;border-radius:12px;border:1px solid var(--line);background:#0f172a;color:var(--text);outline:none}
    button{padding:12px 12px;border-radius:12px;border:1px solid var(--line);background:#0f172a;color:var(--text);cursor:pointer}
    button:hover{border-color:#2b3b5d}
    main{padding:16px;max-width:980px;margin:0 auto}
    .notice{border:1px solid var(--line);background:var(--card);border-radius:14px;padding:12px 12px;margin:0 0 14px 0;color:var(--muted);font-size:13px;line-height:1.4}
    .group{margin:18px 0 10px 0;color:var(--muted);font-size:13px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px}
    .item{border:1px solid var(--line);background:var(--card);border-radius:14px;padding:14px;display:flex;gap:12px;align-items:center}
    .badge{width:42px;height:42px;border-radius:12px;background:#0f172a;display:flex;align-items:center;justify-content:center;border:1px solid var(--line);font-size:18px}
    .meta{flex:1;min-width:0}
    .name{font-size:15px;margin:0 0 4px 0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .sub{font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    a.play{color:inherit;text-decoration:none}
    .pill{margin-left:auto;font-size:12px;color:var(--acc);border:1px solid rgba(74,222,128,.35);padding:6px 10px;border-radius:999px}
    footer{padding:18px 16px;color:var(--muted);font-size:12px;border-top:1px solid var(--line)}
    code{background:#0f172a;padding:2px 6px;border-radius:6px;border:1px solid var(--line)}
  </style>
</head>
<body>
  <header>
    <h1>ç”µè§†ç›´æ’­</h1>
    <div class="row">
      <input id="q" type="search" placeholder="æœç´¢é¢‘é“/åˆ†ç»„â€¦" />
      <button id="reload" title="é‡æ–°åŠ è½½é¢‘é“åˆ—è¡¨">åˆ·æ–°</button>
      <button id="installBtn" style="display:none" title="å®‰è£…åˆ°æ¡Œé¢">å®‰è£…</button>
    </div>
  </header>

  <main>
    <div id="notice" class="notice" style="display:none"></div>
    <div id="container"></div>
  </main>

  <footer>
    è¯´æ˜ï¼šæœ¬å·¥å…·åªè´Ÿè´£æ’­æ”¾ <code>.m3u8</code>ï¼ˆHLSï¼‰é“¾æ¥ã€‚è¯·ä»…æ·»åŠ ä½ æœ‰æƒè§‚çœ‹/è½¬è½½çš„ç›´æ’­æºã€‚
  </footer>

<script>
  // PWA install
  let deferredPrompt = null;
  const installBtn = document.getElementById('installBtn');
  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    installBtn.style.display = '';
  });
  installBtn.addEventListener('click', async () => {
    if (!deferredPrompt) return;
    deferredPrompt.prompt();
    await deferredPrompt.userChoice;
    deferredPrompt = null;
    installBtn.style.display = 'none';
  });

  // SW register
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js').catch(()=>{});
  }

  const q = document.getElementById('q');
  const reloadBtn = document.getElementById('reload');
  const container = document.getElementById('container');
  const notice = document.getElementById('notice');

  let raw = {notice:'', channels:[]};

  function esc(s){return (s||'').replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]));}

  function groupBy(arr, key){
    const m = new Map();
    for (const it of arr) {
      const k = (it[key] || 'æœªåˆ†ç»„').trim();
      if (!m.has(k)) m.set(k, []);
      m.get(k).push(it);
    }
    return m;
  }

  function render(){
    const term = q.value.trim().toLowerCase();
    const list = raw.channels
      .filter(x => x && (x.name||x.group||x.url))
      .filter(x => {
        if (!term) return true;
        return (x.name||'').toLowerCase().includes(term)
          || (x.group||'').toLowerCase().includes(term)
          || (x.url||'').toLowerCase().includes(term);
      });

    const grouped = groupBy(list, 'group');
    container.innerHTML = '';

    for (const [g, items] of grouped.entries()) {
      const h = document.createElement('div');
      h.className = 'group';
      h.textContent = g + `ï¼ˆ${items.length}ï¼‰`;
      container.appendChild(h);

      const grid = document.createElement('div');
      grid.className = 'grid';

      for (const ch of items) {
        const url = (ch.url || '').trim();
        const disabled = !url;
        const a = document.createElement('a');
        a.className = 'play';
        a.href = disabled ? 'javascript:void(0)' : `./player.html?name=${encodeURIComponent(ch.name||'é¢‘é“')}&url=${encodeURIComponent(url)}`;

        const card = document.createElement('div');
        card.className = 'item';
        card.style.opacity = disabled ? '0.55' : '1';

        const badge = document.createElement('div');
        badge.className = 'badge';
        badge.textContent = 'ğŸ“º';

        const meta = document.createElement('div');
        meta.className = 'meta';
        meta.innerHTML = `<div class="name">${esc(ch.name||'æœªå‘½å')}</div><div class="sub">${esc(url||'æœªé…ç½®æ’­æ”¾åœ°å€')}</div>`;

        const pill = document.createElement('div');
        pill.className = 'pill';
        pill.textContent = disabled ? 'æœªé…ç½®' : 'æ’­æ”¾';

        card.appendChild(badge);
        card.appendChild(meta);
        card.appendChild(pill);
        a.appendChild(card);
        grid.appendChild(a);
      }

      container.appendChild(grid);
    }

    if (list.length === 0) {
      container.innerHTML = '<div class="notice">æ²¡æœ‰åŒ¹é…çš„é¢‘é“ã€‚ä½ å¯ä»¥ç¼–è¾‘ <code>channels.json</code> æ·»åŠ ä½ è‡ªå·±çš„ HLSï¼ˆ.m3u8ï¼‰é“¾æ¥ã€‚</div>';
    }
  }

  async function loadChannels(bust=false){
    const u = './channels.json' + (bust ? `?t=${Date.now()}` : '');
    const res = await fetch(u, {cache:'no-store'});
    raw = await res.json();
    if (raw.notice) {
      notice.style.display = '';
      notice.textContent = raw.notice;
    } else {
      notice.style.display = 'none';
    }
    render();
  }

  q.addEventListener('input', render);
  reloadBtn.addEventListener('click', () => loadChannels(true));

  loadChannels(false).catch(() => {
    notice.style.display = '';
    notice.textContent = 'é¢‘é“åˆ—è¡¨åŠ è½½å¤±è´¥ï¼ˆç¦»çº¿æˆ–æ–‡ä»¶ç¼ºå¤±ï¼‰ã€‚è¯·ç¡®è®¤ channels.json å­˜åœ¨ã€‚';
  });
</script>
</body>
</html>
