<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="theme-color" content="#0b1220">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>ç”µè§†ç›´æ’­</title>
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="apple-touch-icon" href="apple-touch-icon.png">
  <style>
    :root {
      --bg: #0b1220;
      --card: #111b2e;
      --muted: #94a3b8;
      --text: #e5e7eb;
      --accent: #4ade80;
      --accent-dim: rgba(74, 222, 128, 0.15);
      --line: #1e293b;
      --danger: #f87171;
      --warning: #fbbf24;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html { background: var(--bg); }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, "PingFang SC", "Microsoft YaHei", sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding-bottom: env(safe-area-inset-bottom, 0);
    }

    /* Header */
    header {
      position: sticky;
      top: 0;
      z-index: 100;
      background: rgba(11, 18, 32, 0.92);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--line);
      padding: 16px 16px 12px;
    }
    .header-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }
    h1 { font-size: 20px; font-weight: 600; }
    .header-actions {
      display: flex;
      gap: 8px;
    }
    .icon-btn {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      border: 1px solid var(--line);
      background: var(--card);
      color: var(--text);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
    }
    .icon-btn:active { opacity: 0.7; }

    /* Search */
    .search-row {
      display: flex;
      gap: 10px;
    }
    .search-input {
      flex: 1;
      padding: 10px 14px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: rgba(15, 23, 42, 0.8);
      color: var(--text);
      font-size: 15px;
      outline: none;
    }
    .search-input::placeholder { color: var(--muted); }
    .search-input:focus { border-color: var(--accent); }

    /* Category Filter */
    .filter-row {
      display: flex;
      gap: 8px;
      overflow-x: auto;
      padding: 12px 16px;
      margin: 0 -16px;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }
    .filter-row::-webkit-scrollbar { display: none; }
    .filter-chip {
      flex-shrink: 0;
      padding: 6px 14px;
      border-radius: 20px;
      border: 1px solid var(--line);
      background: var(--card);
      color: var(--muted);
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .filter-chip.active {
      background: var(--accent-dim);
      border-color: var(--accent);
      color: var(--accent);
    }

    /* Main Content */
    main {
      padding: 0 16px 24px;
      max-width: 1200px;
      margin: 0 auto;
    }

    /* Notice */
    .notice {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 14px 16px;
      margin: 16px 0;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.5;
    }

    /* Section */
    .section {
      margin-top: 20px;
    }
    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }
    .section-title {
      font-size: 14px;
      color: var(--muted);
      font-weight: 500;
    }
    .section-action {
      font-size: 12px;
      color: var(--accent);
      cursor: pointer;
    }

    /* Channel Grid */
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 12px;
    }

    /* Channel Card */
    .channel-card {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px;
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 14px;
      text-decoration: none;
      color: inherit;
      transition: all 0.2s;
    }
    .channel-card:active {
      transform: scale(0.98);
      opacity: 0.9;
    }
    .channel-card.disabled {
      opacity: 0.5;
      pointer-events: none;
    }

    .channel-logo {
      width: 44px;
      height: 44px;
      border-radius: 12px;
      background: rgba(15, 23, 42, 0.8);
      border: 1px solid var(--line);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      flex-shrink: 0;
      overflow: hidden;
    }
    .channel-logo img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .channel-info {
      flex: 1;
      min-width: 0;
    }
    .channel-name {
      font-size: 15px;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-bottom: 4px;
    }
    .channel-meta {
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .channel-actions {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-shrink: 0;
    }
    .fav-btn {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      border: none;
      background: transparent;
      color: var(--muted);
      cursor: pointer;
      font-size: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .fav-btn.active { color: var(--warning); }
    .play-badge {
      padding: 6px 12px;
      border-radius: 20px;
      border: 1px solid rgba(74, 222, 128, 0.3);
      color: var(--accent);
      font-size: 12px;
      font-weight: 500;
    }

    /* Empty State */
    .empty {
      text-align: center;
      padding: 48px 24px;
      color: var(--muted);
    }
    .empty-icon { font-size: 48px; margin-bottom: 16px; }
    .empty-text { font-size: 14px; line-height: 1.6; }

    /* Footer */
    footer {
      padding: 20px 16px;
      border-top: 1px solid var(--line);
      color: var(--muted);
      font-size: 12px;
      text-align: center;
    }
    footer code {
      background: rgba(15, 23, 42, 0.8);
      padding: 2px 6px;
      border-radius: 4px;
      border: 1px solid var(--line);
    }

    /* Install Banner */
    .install-banner {
      display: none;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 16px;
      padding-bottom: calc(16px + env(safe-area-inset-bottom, 0));
      background: var(--card);
      border-top: 1px solid var(--line);
      z-index: 200;
    }
    .install-banner.show { display: block; }
    .install-content {
      display: flex;
      align-items: center;
      gap: 12px;
      max-width: 600px;
      margin: 0 auto;
    }
    .install-text {
      flex: 1;
      font-size: 13px;
    }
    .install-btn {
      padding: 10px 20px;
      border-radius: 10px;
      border: none;
      background: var(--accent);
      color: #000;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }
    .install-close {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      border: 1px solid var(--line);
      background: transparent;
      color: var(--muted);
      cursor: pointer;
      font-size: 18px;
    }
  </style>
</head>
<body>
  <header>
    <div class="header-top">
      <h1>ğŸ“º ç”µè§†ç›´æ’­</h1>
      <div class="header-actions">
        <button class="icon-btn" id="refreshBtn" title="åˆ·æ–°é¢‘é“">ğŸ”„</button>
      </div>
    </div>
    <div class="search-row">
      <input type="search" class="search-input" id="searchInput" placeholder="æœç´¢é¢‘é“ã€åˆ†ç±»ã€å…³é”®è¯...">
    </div>
    <div class="filter-row" id="filterRow">
      <button class="filter-chip active" data-category="all">å…¨éƒ¨</button>
    </div>
  </header>

  <main>
    <div class="notice" id="notice" style="display:none;"></div>
    <div id="content"></div>
  </main>

  <footer>
    è¯´æ˜ï¼šæœ¬å·¥å…·åªè´Ÿè´£æ’­æ”¾ <code>.m3u8</code>ï¼ˆHLSï¼‰é“¾æ¥ã€‚è¯·ä»…æ·»åŠ ä½ æœ‰æƒè§‚çœ‹/è½¬è½½çš„ç›´æ’­æºã€‚
  </footer>

  <div class="install-banner" id="installBanner">
    <div class="install-content">
      <div class="install-text">æ·»åŠ åˆ°ä¸»å±å¹•ï¼Œè·å¾—æ›´å¥½ä½“éªŒ</div>
      <button class="install-btn" id="installBtn">å®‰è£…</button>
      <button class="install-close" id="installClose">Ã—</button>
    </div>
  </div>

<script>
(function() {
  'use strict';

  // ========== Storage Helpers ==========
  const Storage = {
    get(key, def = null) {
      try {
        const v = localStorage.getItem(key);
        return v ? JSON.parse(v) : def;
      } catch { return def; }
    },
    set(key, val) {
      try { localStorage.setItem(key, JSON.stringify(val)); } catch {}
    }
  };

  // ========== State ==========
  let channelsData = { notice: '', categories: [], channels: [] };
  let favorites = Storage.get('tv_favorites', []);
  let recentIds = Storage.get('tv_recent', []);
  let currentCategory = 'all';
  let searchTerm = '';

  // ========== DOM ==========
  const $ = id => document.getElementById(id);
  const searchInput = $('searchInput');
  const filterRow = $('filterRow');
  const content = $('content');
  const notice = $('notice');
  const refreshBtn = $('refreshBtn');
  const installBanner = $('installBanner');
  const installBtn = $('installBtn');
  const installClose = $('installClose');

  // ========== Utils ==========
  function escapeHtml(s) {
    return (s || '').replace(/[&<>"']/g, c => ({
      '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
    }[c]));
  }

  function matchSearch(ch, term) {
    if (!term) return true;
    const t = term.toLowerCase();
    const fields = [
      ch.name || '',
      ch.category || '',
      ...(ch.tags || []),
      ch.region || ''
    ];
    return fields.some(f => f.toLowerCase().includes(t));
  }

  // ========== Render ==========
  function renderFilters() {
    const cats = ['all', ...(channelsData.categories || [])];
    // Add any category from channels that's not in the list
    channelsData.channels.forEach(ch => {
      if (ch.category && !cats.includes(ch.category)) {
        cats.push(ch.category);
      }
    });

    filterRow.innerHTML = cats.map(cat => {
      const label = cat === 'all' ? 'å…¨éƒ¨' : cat;
      const active = currentCategory === cat ? 'active' : '';
      return `<button class="filter-chip ${active}" data-category="${escapeHtml(cat)}">${escapeHtml(label)}</button>`;
    }).join('');
  }

  function getFilteredChannels() {
    return channelsData.channels.filter(ch => {
      if (ch.disabled) return false;
      if (currentCategory !== 'all' && ch.category !== currentCategory) return false;
      if (!matchSearch(ch, searchTerm)) return false;
      return true;
    });
  }

  function renderChannelCard(ch, showFav = true) {
    const isFav = favorites.includes(ch.id);
    const hasSource = ch.sources && ch.sources.length > 0 && ch.sources[0].url;
    const disabled = !hasSource ? 'disabled' : '';
    const sourceCount = ch.sources ? ch.sources.length : 0;
    const metaText = sourceCount > 1 
      ? `${ch.category || 'æœªåˆ†ç±»'} Â· ${sourceCount}æ¡çº¿è·¯`
      : (ch.category || 'æœªåˆ†ç±»');

    const logoContent = ch.logo 
      ? `<img src="${escapeHtml(ch.logo)}" alt="" onerror="this.parentElement.textContent='ğŸ“º'">`
      : 'ğŸ“º';

    return `
      <div class="channel-card ${disabled}" data-id="${escapeHtml(ch.id)}">
        <div class="channel-logo">${logoContent}</div>
        <div class="channel-info">
          <div class="channel-name">${escapeHtml(ch.name)}</div>
          <div class="channel-meta">${escapeHtml(metaText)}</div>
        </div>
        <div class="channel-actions">
          ${showFav ? `<button class="fav-btn ${isFav ? 'active' : ''}" data-fav="${escapeHtml(ch.id)}" title="${isFav ? 'å–æ¶ˆæ”¶è—' : 'æ”¶è—'}">${isFav ? 'â˜…' : 'â˜†'}</button>` : ''}
          <span class="play-badge">${hasSource ? 'æ’­æ”¾' : 'æ— æº'}</span>
        </div>
      </div>
    `;
  }

  function renderSection(title, channels, action = null, showFav = true) {
    if (!channels.length) return '';
    return `
      <div class="section">
        <div class="section-header">
          <span class="section-title">${escapeHtml(title)}ï¼ˆ${channels.length}ï¼‰</span>
          ${action ? `<span class="section-action" data-action="${action.key}">${action.label}</span>` : ''}
        </div>
        <div class="grid">
          ${channels.map(ch => renderChannelCard(ch, showFav)).join('')}
        </div>
      </div>
    `;
  }

  function render() {
    const filtered = getFilteredChannels();
    
    // Favorites (only when showing all and no search)
    const favChannels = !searchTerm && currentCategory === 'all'
      ? channelsData.channels.filter(ch => favorites.includes(ch.id) && !ch.disabled)
      : [];

    // Recent (only when showing all and no search)
    const recentChannels = !searchTerm && currentCategory === 'all'
      ? recentIds.slice(0, 5)
          .map(id => channelsData.channels.find(ch => ch.id === id))
          .filter(ch => ch && !ch.disabled && !favorites.includes(ch.id))
      : [];

    // Grouped by category
    const grouped = new Map();
    filtered.forEach(ch => {
      // Skip if already in favorites or recent
      if (favChannels.some(f => f.id === ch.id)) return;
      if (recentChannels.some(r => r.id === ch.id)) return;
      
      const cat = ch.category || 'æœªåˆ†ç»„';
      if (!grouped.has(cat)) grouped.set(cat, []);
      grouped.get(cat).push(ch);
    });

    let html = '';

    // Favorites section
    if (favChannels.length) {
      html += renderSection('â­ æ”¶è—', favChannels, { key: 'clearFav', label: 'æ¸…ç©º' }, true);
    }

    // Recent section
    if (recentChannels.length) {
      html += renderSection('ğŸ• æœ€è¿‘è§‚çœ‹', recentChannels, { key: 'clearRecent', label: 'æ¸…ç©º' }, true);
    }

    // Category groups
    for (const [cat, chs] of grouped.entries()) {
      html += renderSection(cat, chs);
    }

    // Empty state
    if (!favChannels.length && !recentChannels.length && !grouped.size) {
      html = `
        <div class="empty">
          <div class="empty-icon">ğŸ“¡</div>
          <div class="empty-text">
            ${searchTerm ? 'æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„é¢‘é“' : 'æš‚æ— é¢‘é“'}<br>
            ç¼–è¾‘ <code>channels.json</code> æ·»åŠ ä½ çš„ HLS ç›´æ’­æº
          </div>
        </div>
      `;
    }

    content.innerHTML = html;
  }

  // ========== Events ==========
  function handleCardClick(e) {
    const card = e.target.closest('.channel-card');
    if (!card || card.classList.contains('disabled')) return;

    // Check if clicked on fav button
    const favBtn = e.target.closest('.fav-btn');
    if (favBtn) {
      e.preventDefault();
      e.stopPropagation();
      const id = favBtn.dataset.fav;
      toggleFavorite(id);
      return;
    }

    // Navigate to player
    const id = card.dataset.id;
    if (id) {
      addToRecent(id);
      window.location.href = `player.html?id=${encodeURIComponent(id)}`;
    }
  }

  function handleFilterClick(e) {
    const chip = e.target.closest('.filter-chip');
    if (!chip) return;
    currentCategory = chip.dataset.category;
    renderFilters();
    render();
  }

  function handleSectionAction(e) {
    const action = e.target.dataset.action;
    if (action === 'clearFav') {
      if (confirm('ç¡®å®šæ¸…ç©ºæ‰€æœ‰æ”¶è—ï¼Ÿ')) {
        favorites = [];
        Storage.set('tv_favorites', favorites);
        render();
      }
    } else if (action === 'clearRecent') {
      if (confirm('ç¡®å®šæ¸…ç©ºæœ€è¿‘è§‚çœ‹ï¼Ÿ')) {
        recentIds = [];
        Storage.set('tv_recent', recentIds);
        render();
      }
    }
  }

  function toggleFavorite(id) {
    const idx = favorites.indexOf(id);
    if (idx >= 0) {
      favorites.splice(idx, 1);
    } else {
      favorites.unshift(id);
    }
    Storage.set('tv_favorites', favorites);
    render();
  }

  function addToRecent(id) {
    recentIds = recentIds.filter(x => x !== id);
    recentIds.unshift(id);
    if (recentIds.length > 20) recentIds = recentIds.slice(0, 20);
    Storage.set('tv_recent', recentIds);
  }

  // ========== Load Data ==========
  async function loadChannels(bust = false) {
    try {
      const url = './channels.json' + (bust ? `?t=${Date.now()}` : '');
      const res = await fetch(url, { cache: 'no-store' });
      if (!res.ok) throw new Error('HTTP ' + res.status);
      channelsData = await res.json();
      
      // Normalize
      if (!channelsData.channels) channelsData.channels = [];
      if (!channelsData.categories) channelsData.categories = [];

      // Show notice
      if (channelsData.notice) {
        notice.style.display = '';
        notice.textContent = channelsData.notice;
      } else {
        notice.style.display = 'none';
      }

      renderFilters();
      render();
    } catch (err) {
      notice.style.display = '';
      notice.textContent = 'é¢‘é“åˆ—è¡¨åŠ è½½å¤±è´¥ï¼š' + err.message;
      content.innerHTML = `
        <div class="empty">
          <div class="empty-icon">âš ï¸</div>
          <div class="empty-text">
            æ— æ³•åŠ è½½é¢‘é“åˆ—è¡¨<br>
            è¯·ç¡®è®¤ channels.json æ–‡ä»¶å­˜åœ¨ä¸”æ ¼å¼æ­£ç¡®
          </div>
        </div>
      `;
    }
  }

  // ========== PWA Install ==========
  let deferredPrompt = null;
  window.addEventListener('beforeinstallprompt', e => {
    e.preventDefault();
    deferredPrompt = e;
    installBanner.classList.add('show');
  });

  installBtn.addEventListener('click', async () => {
    if (!deferredPrompt) return;
    deferredPrompt.prompt();
    const { outcome } = await deferredPrompt.userChoice;
    deferredPrompt = null;
    installBanner.classList.remove('show');
  });

  installClose.addEventListener('click', () => {
    installBanner.classList.remove('show');
  });

  // ========== Service Worker ==========
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js').catch(() => {});
  }

  // ========== Init ==========
  searchInput.addEventListener('input', () => {
    searchTerm = searchInput.value.trim();
    render();
  });

  filterRow.addEventListener('click', handleFilterClick);
  content.addEventListener('click', handleCardClick);
  content.addEventListener('click', handleSectionAction);
  refreshBtn.addEventListener('click', () => loadChannels(true));

  loadChannels(false);
})();
</script>
</body>
</html>
