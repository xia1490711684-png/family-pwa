<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="theme-color" content="#0b1220">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>ç”µè§†ç›´æ’­</title>
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="apple-touch-icon" href="apple-touch-icon.png">
  <style>
    :root{
      --bg:#0b1220;--panel:#0f172a;--card:#111b2e;--muted:#94a3b8;--text:#e5e7eb;
      --accent:#4ade80;--accent-dim:rgba(74,222,128,.14);--line:#1e293b;--danger:#f87171;--warning:#fbbf24;
      --shadow:0 10px 30px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%;background:var(--bg);color:var(--text)}
    body{font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","Segoe UI",Roboto,"PingFang SC","Microsoft YaHei",sans-serif;}

    /* Top bar */
    header{
      position:sticky;top:0;z-index:1000;
      background:rgba(11,18,32,.92);
      backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);
      border-bottom:1px solid var(--line);
      padding:12px 14px calc(12px + env(safe-area-inset-top, 0));
    }
    .topbar{display:flex;align-items:center;gap:10px}
    .brand{display:flex;align-items:center;gap:10px;min-width:0}
    .brand h1{font-size:16px;font-weight:750;letter-spacing:.2px;white-space:nowrap}
    .brand .sub{font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .topbar .grow{flex:1}

    .search{
      width:min(520px,100%);
      display:flex;align-items:center;gap:10px;
      background:rgba(15,23,42,.76);
      border:1px solid var(--line);
      border-radius:12px;
      padding:8px 10px;
    }
    .search input{
      flex:1;border:none;background:transparent;color:var(--text);
      font-size:14px;outline:none;
    }
    .search input::placeholder{color:var(--muted)}

    .btn{
      height:36px;padding:0 12px;border-radius:10px;
      border:1px solid var(--line);background:var(--card);
      color:var(--text);cursor:pointer;
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
      font-size:13px;user-select:none;
    }
    .btn:active{opacity:.75}
    .btn.primary{background:var(--accent-dim);border-color:rgba(74,222,128,.4);color:var(--accent)}
    .btn.icon{width:36px;padding:0}

    /* Layout */
    .app{
      height:calc(100% - 60px);
      display:flex;
      overflow:hidden;
    }
    .side{
      width:360px;min-width:320px;max-width:420px;
      border-right:1px solid var(--line);
      background:linear-gradient(180deg, rgba(17,27,46,.65), rgba(17,27,46,.2));
      display:flex;flex-direction:column;
    }
    .side-head{padding:14px;border-bottom:1px solid var(--line)}
    .chips{display:flex;gap:8px;overflow:auto;padding-top:12px;scrollbar-width:none}
    .chips::-webkit-scrollbar{display:none}
    .chip{flex:0 0 auto;padding:6px 12px;border-radius:999px;border:1px solid var(--line);background:rgba(15,23,42,.6);color:var(--muted);font-size:12px;cursor:pointer}
    .chip.active{background:var(--accent-dim);border-color:rgba(74,222,128,.6);color:var(--accent)}

    .channel-list{flex:1;overflow:auto;padding:10px 10px 18px}
    .group-title{font-size:12px;color:var(--muted);font-weight:700;margin:10px 6px}

    .item{
      display:flex;align-items:center;gap:12px;
      padding:12px;
      border:1px solid var(--line);
      border-radius:14px;
      background:rgba(15,23,42,.55);
      margin:8px 4px;
      cursor:pointer;
      transition:transform .12s,opacity .12s;
    }
    .item:active{transform:scale(.99);opacity:.88}
    .logo{width:42px;height:42px;border-radius:12px;border:1px solid var(--line);background:rgba(15,23,42,.75);overflow:hidden;display:flex;align-items:center;justify-content:center;font-size:18px;flex:0 0 auto}
    .logo img{width:100%;height:100%;object-fit:cover}
    .meta{flex:1;min-width:0}
    .name{font-size:14px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .desc{margin-top:4px;font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .tags{display:flex;gap:6px;margin-top:6px;flex-wrap:wrap}
    .tag{font-size:11px;color:var(--muted);border:1px solid rgba(148,163,184,.25);padding:2px 8px;border-radius:999px}

    .item-actions{display:flex;flex-direction:column;gap:8px;align-items:flex-end;flex:0 0 auto}
    .fav{width:28px;height:28px;border-radius:9px;border:1px solid var(--line);background:rgba(11,18,32,.65);color:var(--muted);cursor:pointer;display:flex;align-items:center;justify-content:center}
    .fav.active{color:var(--warning)}
    .open{padding:6px 10px;border-radius:999px;border:1px solid rgba(74,222,128,.35);background:rgba(74,222,128,.08);color:var(--accent);font-size:12px;font-weight:750}

    /* Workspace */
    .work{flex:1;display:flex;flex-direction:column;min-width:0;background:radial-gradient(1000px 600px at 30% -10%, rgba(74,222,128,.09), transparent 55%), var(--bg)}

    .tabbar{
      display:flex;align-items:center;gap:8px;
      padding:10px 12px;
      border-bottom:1px solid var(--line);
      overflow:auto;scrollbar-width:none;
    }
    .tabbar::-webkit-scrollbar{display:none}

    .tab{
      flex:0 0 auto;
      display:flex;align-items:center;gap:8px;
      padding:8px 10px;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(17,27,46,.55);
      color:var(--muted);
      cursor:pointer;
      user-select:none;
      max-width:340px;
    }
    .tab.active{background:rgba(74,222,128,.10);border-color:rgba(74,222,128,.35);color:var(--text)}
    .tab .dot{width:8px;height:8px;border-radius:999px;background:rgba(148,163,184,.55)}
    .tab.active .dot{background:var(--accent)}
    .tab .tname{font-size:13px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:220px}
    .tab .x{width:22px;height:22px;border-radius:8px;border:1px solid var(--line);background:rgba(11,18,32,.55);color:var(--muted);display:flex;align-items:center;justify-content:center}
    .tab .x:active{opacity:.7}

    .work-body{flex:1;position:relative;overflow:hidden}
    .frame{
      position:absolute;inset:0;
      width:100%;height:100%;border:0;
      background:#000;
      display:none;
    }
    .frame.active{display:block}

    .empty{
      height:100%;display:flex;align-items:center;justify-content:center;
      color:var(--muted);padding:24px;text-align:center;line-height:1.7;
    }
    .empty .box{
      max-width:560px;
      border:1px solid var(--line);
      background:rgba(17,27,46,.35);
      border-radius:16px;
      padding:18px 16px;
      box-shadow:var(--shadow);
    }
    .empty .title{color:var(--text);font-weight:800;margin-bottom:10px}

    /* Drawer for mobile */
    .drawer-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;z-index:1200}
    .drawer-backdrop.show{display:block}
    .drawer{
      position:fixed;top:0;bottom:0;left:0;
      width:min(92vw, 420px);
      background:var(--panel);
      border-right:1px solid var(--line);
      transform:translateX(-102%);
      transition:transform .22s ease;
      z-index:1300;
      display:flex;flex-direction:column;
      box-shadow:var(--shadow);
    }
    .drawer.show{transform:translateX(0)}
    .drawer header{position:sticky;top:0;background:rgba(15,23,42,.92);border-bottom:1px solid var(--line);padding:12px 12px calc(12px + env(safe-area-inset-top,0))}

    /* Modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.58);display:none;align-items:center;justify-content:center;z-index:2000;padding:18px}
    .modal-backdrop.show{display:flex}
    .modal{width:min(720px, 100%);background:var(--panel);border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow);overflow:hidden}
    .modal-head{display:flex;align-items:center;justify-content:space-between;padding:14px 14px;border-bottom:1px solid var(--line)}
    .modal-title{font-size:14px;font-weight:800}
    .modal-body{padding:14px}
    textarea{width:100%;min-height:210px;resize:vertical;border-radius:14px;border:1px solid var(--line);background:rgba(11,18,32,.7);color:var(--text);padding:12px;font-size:13px;outline:none}
    textarea:focus{border-color:rgba(74,222,128,.55)}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .hint{margin-top:10px;color:var(--muted);font-size:12px;line-height:1.6;white-space:pre-wrap}

    /* Responsive */
    @media (max-width: 980px){
      .app{height:calc(100% - 60px)}
      .side{display:none}
      .work{width:100%}
      .brand .sub{display:none}
    }
  </style>
</head>
<body>
<header>
  <div class="topbar">
    <div class="brand">
      <button class="btn icon" id="openDrawerBtn" title="é¢‘é“">â‰¡</button>
      <div style="min-width:0">
        <h1>ç”µè§†ç›´æ’­</h1>
        <div class="sub" id="subline">ä¸­æ–‡ä¼˜å…ˆ Â· å¤šæ ‡ç­¾åˆ‡æ¢ Â· æ”¯æŒå¯¼å…¥</div>
      </div>
    </div>

    <div class="grow"></div>

    <div class="search" aria-label="æœç´¢é¢‘é“">
      <span style="color:var(--muted);font-size:14px">âŒ•</span>
      <input id="searchInput" placeholder="æœç´¢é¢‘é“ / åˆ†ç±»" autocomplete="off" />
    </div>

    <button class="btn" id="favViewBtn" title="åªçœ‹æ”¶è—">â˜… æ”¶è—</button>
    <button class="btn" id="recentViewBtn" title="æœ€è¿‘æ’­æ”¾">â± æœ€è¿‘</button>
    <button class="btn primary" id="importBtn" title="å¯¼å…¥æ’­æ”¾åˆ—è¡¨">ï¼‹ å¯¼å…¥</button>
    <button class="btn" id="clearBadBtn" title="æ¸…ç†å¤±æ•ˆè®°å½•">ğŸ§¹</button>
  </div>
</header>

<div class="app">
  <aside class="side" id="sidePane">
    <div class="side-head">
      <div class="chips" id="chips"></div>
    </div>
    <div class="channel-list" id="channelList"></div>
  </aside>

  <section class="work">
    <div class="tabbar" id="tabBar"></div>
    <div class="work-body" id="workBody">
      <div class="empty" id="emptyState">
        <div class="box">
          <div class="title">åƒç”µè§†å®¶ä¸€æ ·â€œéšå¼€éšå…³ã€éšæ—¶åˆ‡æ¢â€</div>
          <div>ä»å·¦ä¾§é€‰æ‹©é¢‘é“ï¼Œä¼šåœ¨è¿™é‡Œä»¥â€œæ ‡ç­¾é¡µâ€æ–¹å¼æ‰“å¼€ã€‚ä½ å¯ä»¥åŒæ—¶æ‰“å¼€å¤šä¸ªç›´æ’­/ç½‘é¡µï¼Œéšæ—¶åˆ‡æ¢ã€å…³é—­ã€‚</div>
          <div style="margin-top:10px">æç¤ºï¼šå¾ˆå¤šé¢‘é“æ›´é€‚åˆç”¨â€œå®˜æ–¹ç½‘é¡µæ–¹å¼â€æ‰“å¼€ï¼ˆä¸èµ°å†…ç½®æ’­æ”¾å™¨ï¼‰ï¼Œæœ¬åº”ç”¨ä¼šè‡ªåŠ¨å…œåº•å¹¶æä¾›å¤–éƒ¨æ‰“å¼€ã€‚</div>
        </div>
      </div>
    </div>
  </section>
</div>

<!-- Mobile drawer -->
<div class="drawer-backdrop" id="drawerBackdrop"></div>
<div class="drawer" id="drawer">
  <header>
    <div class="topbar" style="padding:0">
      <div class="brand" style="gap:8px">
        <button class="btn icon" id="closeDrawerBtn" title="å…³é—­">â†</button>
        <div style="min-width:0">
          <h1 style="font-size:15px">é¢‘é“åˆ—è¡¨</h1>
          <div class="sub" style="display:block">ä¸­æ–‡ä¼˜å…ˆ Â· æ”¯æŒå¯¼å…¥</div>
        </div>
      </div>
      <div class="grow"></div>
    </div>
  </header>
  <div class="side-head">
    <div class="chips" id="chipsMobile"></div>
  </div>
  <div class="channel-list" id="channelListMobile"></div>
</div>

<!-- Import modal -->
<div class="modal-backdrop" id="modalBackdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-label="å¯¼å…¥æ’­æ”¾åˆ—è¡¨">
    <div class="modal-head">
      <div class="modal-title">å¯¼å…¥æ’­æ”¾åˆ—è¡¨ï¼ˆm3u / m3u8ï¼‰</div>
      <button class="btn icon" id="closeModalBtn" title="å…³é—­">Ã—</button>
    </div>
    <div class="modal-body">
      <div class="hint">è¯´æ˜ï¼šæœ¬å·¥å…·æ”¯æŒæ’­æ”¾ <code>.m3u8</code>ï¼ˆHLSï¼‰ä¸æ‰“å¼€å®˜æ–¹ç›´æ’­ç½‘é¡µï¼ˆwebï¼‰ã€‚
è¯·ä»…å¯¼å…¥ä½ æœ‰æƒè§‚çœ‹/è½¬è½½çš„ç›´æ’­æºã€‚

å¯¼å…¥åå°†è‡ªåŠ¨åˆå¹¶åŒåé¢‘é“çš„å¤šçº¿è·¯ï¼Œå¹¶æ”¯æŒï¼šæ”¶è— / æœç´¢ / æœ€è¿‘ / å¤šæ ‡ç­¾åˆ‡æ¢ / è‡ªåŠ¨æµ‹é€Ÿ / å¤±è´¥è‡ªåŠ¨åˆ‡çº¿ã€‚</div>
      <div class="row" style="margin-top:12px">
        <button class="btn" id="pickFileBtn">é€‰æ‹© m3u æ–‡ä»¶</button>
        <input type="file" id="fileInput" accept=".m3u,.m3u8,.txt" style="display:none" />
        <button class="btn" id="loadFromUrlBtn">ä»è®¢é˜… URL åŠ è½½</button>
        <button class="btn" id="exportM3UBtn">å¯¼å‡ºæˆ‘çš„å¯¼å…¥</button>
        <button class="btn" id="clearImportBtn" style="border-color:rgba(248,113,113,.35);color:var(--danger)">æ¸…ç©ºå¯¼å…¥</button>
      </div>
      <textarea id="m3uText" placeholder="#EXTM3U\n#EXTINF:-1 group-title=\"æˆ‘çš„å¯¼å…¥\",é¢‘é“åç§°\nhttps://.../index.m3u8\n#EXTINF:-1 group-title=\"æˆ‘çš„å¯¼å…¥\",CCTV-13ï¼ˆç½‘é¡µï¼‰\nweb:https://tv.cctv.com/live/cctv13/m/\n"></textarea>
      <div class="row">
        <button class="btn primary" id="doImportBtn">å¯¼å…¥å¹¶ä¿å­˜</button>
      </div>
      <div class="hint" id="importHint">å»ºè®®ï¼šå¦‚æœä½ é‡åˆ°å¤§é‡â€œæ’­ä¸äº†â€ï¼Œä¼˜å…ˆå¯¼å…¥â€œå®˜æ–¹ç›´æ’­ç½‘é¡µâ€é“¾æ¥ï¼ˆç”¨ <code>web:</code> å‰ç¼€ï¼‰ï¼Œå¹¶ç”¨æœ¬åº”ç”¨çš„å¤šæ ‡ç­¾æ–¹å¼æ‰“å¼€ï¼›
å¦‚æœæ˜¯ m3u8 æºï¼Œè¯·å°½é‡ä½¿ç”¨ httpsï¼Œå¹¶ä¸ºåŒä¸€é¢‘é“é…ç½® 2â€“3 æ¡ä¸åŒçº¿è·¯ã€‚</div>
    </div>
  </div>
</div>

<script>
  // -------------------- Storage keys --------------------
  const KEY_FAV = 'tv_favorites_v2';
  const KEY_RECENT = 'tv_recent_v2';
  const KEY_IMPORTED = 'tv_imported_v2';
  const KEY_OPEN = 'tv_open_tabs_v1';
  const KEY_BAD = 'tv_bad_sources_v1';

  // -------------------- State --------------------
  let baseData = null;
  let categories = [];
  let currentCategory = 'å…¨éƒ¨';
  let onlyFav = false;
  let onlyRecent = false;
  let searchTerm = '';
  let favSet = new Set(loadJSON(KEY_FAV, []));
  let recentList = loadJSON(KEY_RECENT, []);
  let importedData = loadJSON(KEY_IMPORTED, { channels: [] });
  let openTabs = loadJSON(KEY_OPEN, []); // [{sid,name,logo,category,ts}]

  // -------------------- DOM --------------------
  const chips = document.getElementById('chips');
  const chipsMobile = document.getElementById('chipsMobile');
  const channelList = document.getElementById('channelList');
  const channelListMobile = document.getElementById('channelListMobile');
  const searchInput = document.getElementById('searchInput');
  const favViewBtn = document.getElementById('favViewBtn');
  const recentViewBtn = document.getElementById('recentViewBtn');
  const importBtn = document.getElementById('importBtn');
  const clearBadBtn = document.getElementById('clearBadBtn');
  const tabBar = document.getElementById('tabBar');
  const workBody = document.getElementById('workBody');
  const emptyState = document.getElementById('emptyState');

  const drawer = document.getElementById('drawer');
  const drawerBackdrop = document.getElementById('drawerBackdrop');
  const openDrawerBtn = document.getElementById('openDrawerBtn');
  const closeDrawerBtn = document.getElementById('closeDrawerBtn');

  const modalBackdrop = document.getElementById('modalBackdrop');
  const closeModalBtn = document.getElementById('closeModalBtn');
  const pickFileBtn = document.getElementById('pickFileBtn');
  const fileInput = document.getElementById('fileInput');
  const loadFromUrlBtn = document.getElementById('loadFromUrlBtn');
  const exportM3UBtn = document.getElementById('exportM3UBtn');
  const clearImportBtn = document.getElementById('clearImportBtn');
  const m3uText = document.getElementById('m3uText');
  const doImportBtn = document.getElementById('doImportBtn');

  // -------------------- Utilities --------------------
  function loadJSON(key, fallback){
    try{ const v = localStorage.getItem(key); return v ? JSON.parse(v) : fallback; }catch{ return fallback; }
  }
  function saveJSON(key, obj){
    localStorage.setItem(key, JSON.stringify(obj));
  }
  function esc(str){
    return String(str||'').replace(/[&<>\"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',"'":'&#39;'}[s]));
  }
  function hashId(s){
    let h=2166136261; s=String(s||'');
    for(let i=0;i<s.length;i++){ h ^= s.charCodeAt(i); h = Math.imul(h, 16777619); }
    return 'c'+(h>>>0).toString(16);
  }

  function normalizeSource(url){
    const u = String(url||'').trim();
    if (!u) return null;
    if (u.startsWith('web:')) return { type: 'web', url: u.slice(4).trim() };
    if (u.startsWith('youtube:')) return { type: 'youtube', url: u };
    if (u.endsWith('.m3u8') || u.includes('.m3u8?')) return { type: 'hls', url: u };
    // fallback: treat as web
    return { type: 'web', url: u };
  }

  function addToRecent(ch){
    const item = { id: ch.id, name: ch.name, logo: ch.logo || '', category: ch.category || ch.group || '', ts: Date.now() };
    recentList = recentList.filter(x => x.id !== item.id);
    recentList.unshift(item);
    recentList = recentList.slice(0, 60);
    saveJSON(KEY_RECENT, recentList);
  }

  function toggleFav(id){
    if (favSet.has(id)) favSet.delete(id); else favSet.add(id);
    saveJSON(KEY_FAV, Array.from(favSet));
  }

  // -------------------- Data loading --------------------
  async function loadBase(){
    const res = await fetch('./channels.json', { cache: 'no-store' });
    baseData = await res.json();
    mergeData();
  }

  function mergeData(){
    const all = [];

    // built-in
    for (const cat of (baseData?.categories || [])){
      for (const ch of (cat.channels || [])){
        const sources = (ch.sources || []).map(s => normalizeSource(s.url || s)).filter(Boolean);
        all.push({
          id: ch.id || hashId((ch.name||'') + '|' + (cat.name||'')),
          name: ch.name,
          category: cat.name,
          group: cat.name,
          logo: ch.logo || '',
          desc: ch.desc || '',
          sources
        });
      }
    }

    // imported
    for (const ch of (importedData?.channels || [])){
      const sources = (ch.sources || []).map(s => normalizeSource(s.url || s)).filter(Boolean);
      all.push({
        id: ch.id || hashId('imp|' + (ch.name||'')),
        name: ch.name,
        category: ch.group || 'æˆ‘çš„å¯¼å…¥',
        group: ch.group || 'æˆ‘çš„å¯¼å…¥',
        logo: ch.logo || '',
        desc: ch.desc || '',
        sources
      });
    }

    // categories list
    const catSet = new Set();
    for (const ch of all) catSet.add(ch.group);
    categories = ['å…¨éƒ¨', ...Array.from(catSet)];

    // store flattened
    window.__ALL_CHANNELS__ = all;

    renderAll();
    hydrateTabs();
  }

  // -------------------- Rendering --------------------
  function renderChips(){
    const make = (container) => {
      container.innerHTML = categories.map(c => `<div class="chip ${c===currentCategory?'active':''}" data-cat="${esc(c)}">${esc(c)}</div>`).join('');
      container.querySelectorAll('.chip').forEach(el => {
        el.addEventListener('click', () => {
          currentCategory = el.dataset.cat;
          onlyRecent = false;
          onlyFav = false;
          syncViewButtons();
          renderAll();
        });
      });
    };
    make(chips);
    make(chipsMobile);
  }

  function syncViewButtons(){
    favViewBtn.classList.toggle('primary', onlyFav);
    recentViewBtn.classList.toggle('primary', onlyRecent);
  }

  function filteredChannels(){
    let list = window.__ALL_CHANNELS__ || [];
    if (currentCategory !== 'å…¨éƒ¨') list = list.filter(c => c.group === currentCategory);
    if (onlyFav) list = list.filter(c => favSet.has(c.id));
    if (onlyRecent) {
      const set = new Set(recentList.map(x => x.id));
      list = list.filter(c => set.has(c.id)).sort((a,b) => (recentList.findIndex(x=>x.id===a.id)) - (recentList.findIndex(x=>x.id===b.id)));
    }
    if (searchTerm){
      const q = searchTerm.toLowerCase();
      list = list.filter(c => (c.name||'').toLowerCase().includes(q) || (c.group||'').toLowerCase().includes(q));
    }
    return list;
  }

  function renderChannelList(container){
    const list = filteredChannels();
    if (!list.length){
      container.innerHTML = `<div class="empty"><div class="box"><div class="title">æš‚æ— åŒ¹é…é¢‘é“</div><div>å¯å°è¯•ï¼šå–æ¶ˆç­›é€‰ã€åˆ‡æ¢åˆ†ç±»ã€æˆ–å¯¼å…¥ä½ çš„ m3u æ’­æ”¾åˆ—è¡¨ã€‚</div></div></div>`;
      return;
    }

    // group by group
    const map = new Map();
    for (const ch of list){
      const k = ch.group || 'å…¶ä»–';
      if (!map.has(k)) map.set(k, []);
      map.get(k).push(ch);
    }

    const groups = Array.from(map.keys());
    container.innerHTML = groups.map(g => {
      const items = map.get(g).map(ch => {
        const isFav = favSet.has(ch.id);
        const t = [];
        if (ch.sources?.some(s=>s.type==='hls')) t.push('HLS');
        if (ch.sources?.some(s=>s.type==='web')) t.push('ç½‘é¡µ');
        return `
          <div class="item" data-id="${esc(ch.id)}">
            <div class="logo">${ch.logo ? `<img src="${esc(ch.logo)}" alt="">` : 'ğŸ“º'}</div>
            <div class="meta">
              <div class="name">${esc(ch.name)}</div>
              <div class="desc">${esc(ch.desc || g)}</div>
              <div class="tags">${t.map(x=>`<span class="tag">${esc(x)}</span>`).join('')}</div>
            </div>
            <div class="item-actions">
              <button class="fav ${isFav?'active':''}" data-fav="${esc(ch.id)}" title="æ”¶è—">â˜…</button>
              <div class="open">æ‰“å¼€</div>
            </div>
          </div>
        `;
      }).join('');
      return `<div class="group"><div class="group-title">${esc(g)}</div>${items}</div>`;
    }).join('');

    container.querySelectorAll('[data-fav]').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        toggleFav(btn.dataset.fav);
        renderAll();
      });
    });

    container.querySelectorAll('.item').forEach(el => {
      el.addEventListener('click', () => {
        const id = el.dataset.id;
        const ch = (window.__ALL_CHANNELS__||[]).find(x=>x.id===id);
        if (!ch) return;
        openChannelAsTab(ch);
        addToRecent(ch);
        renderAll();
        closeDrawer();
      });
    });
  }

  function renderAll(){
    renderChips();
    renderChannelList(channelList);
    renderChannelList(channelListMobile);
    renderTabs();
  }

  // -------------------- Tabs / Workspace --------------------
  function ensureFrame(sid){
    let f = document.getElementById('frame_'+sid);
    if (f) return f;
    f = document.createElement('iframe');
    f.className = 'frame';
    f.id = 'frame_'+sid;
    f.allow = 'autoplay; encrypted-media; picture-in-picture; fullscreen';
    f.referrerPolicy = 'no-referrer';
    f.src = './player.html?sid=' + encodeURIComponent(sid);
    workBody.appendChild(f);
    return f;
  }

  function selectTab(sid){
    // activate tab
    openTabs.forEach(t => t.active = (t.sid === sid));
    saveJSON(KEY_OPEN, openTabs);

    // show frame
    for (const t of openTabs){
      const f = ensureFrame(t.sid);
      f.classList.toggle('active', t.sid === sid);
    }
    emptyState.style.display = openTabs.length ? 'none' : 'flex';
    renderTabs();
  }

  function renderTabs(){
    if (!openTabs.length){
      tabBar.innerHTML = `<div class="tab" style="opacity:.6;cursor:default"><span class="dot"></span><span class="tname">æœªæ‰“å¼€é¢‘é“</span></div>`;
      emptyState.style.display = 'flex';
      // hide any frames
      workBody.querySelectorAll('.frame').forEach(f=>f.remove());
      return;
    }
    emptyState.style.display = 'none';

    tabBar.innerHTML = openTabs.map(t => {
      return `
        <div class="tab ${t.active?'active':''}" data-sid="${esc(t.sid)}">
          <span class="dot"></span>
          <span class="tname">${esc(t.name)}</span>
          <span class="x" data-close="${esc(t.sid)}">Ã—</span>
        </div>
      `;
    }).join('');

    tabBar.querySelectorAll('.tab').forEach(el => {
      el.addEventListener('click', (e) => {
        const sid = el.dataset.sid;
        if (!sid) return;
        // close click
        const close = e.target?.dataset?.close;
        if (close){
          e.stopPropagation();
          closeTab(close);
          return;
        }
        selectTab(sid);
      });
    });

    // ensure frames exist
    for (const t of openTabs){
      ensureFrame(t.sid);
    }
  }

  function closeTab(sid){
    const idx = openTabs.findIndex(t=>t.sid===sid);
    if (idx < 0) return;
    openTabs.splice(idx,1);
    saveJSON(KEY_OPEN, openTabs);
    // remove frame
    const f = document.getElementById('frame_'+sid);
    if (f) f.remove();
    // remove channel cache
    try{ localStorage.removeItem('tv_channel_' + sid); }catch{}

    // select another
    if (openTabs.length){
      const next = openTabs[Math.max(0, idx-1)] || openTabs[0];
      next.active = true;
      selectTab(next.sid);
    } else {
      renderTabs();
    }
  }

  function hydrateTabs(){
    // Ensure at least one active
    if (openTabs.length && !openTabs.some(t=>t.active)) openTabs[0].active = true;
    saveJSON(KEY_OPEN, openTabs);

    // create frames
    for (const t of openTabs){
      ensureFrame(t.sid);
    }
    const active = openTabs.find(t=>t.active);
    if (active) selectTab(active.sid); else renderTabs();
  }

  function openChannelAsTab(ch){
    // sid must be unique per open instance. If channel already open, just focus.
    const existing = openTabs.find(t => t.cid === ch.id);
    if (existing){
      selectTab(existing.sid);
      return;
    }

    const sid = 's_' + hashId(ch.id + '|' + Date.now());
    const tab = { sid, cid: ch.id, name: ch.name, logo: ch.logo || '', category: ch.group || '', ts: Date.now(), active: true };

    // deactivate others
    openTabs.forEach(t => t.active = false);
    openTabs.unshift(tab);
    saveJSON(KEY_OPEN, openTabs);

    // store channel for player
    const payload = {
      sid,
      id: ch.id,
      name: ch.name,
      category: ch.group || '',
      logo: ch.logo || '',
      desc: ch.desc || '',
      sources: ch.sources || []
    };
    saveJSON('tv_channel_' + sid, payload);

    ensureFrame(sid);
    selectTab(sid);
  }

  // -------------------- Drawer --------------------
  function openDrawer(){
    drawerBackdrop.classList.add('show');
    drawer.classList.add('show');
  }
  function closeDrawer(){
    drawerBackdrop.classList.remove('show');
    drawer.classList.remove('show');
  }

  // -------------------- Import / Export --------------------
  function openModal(){
    modalBackdrop.classList.add('show');
    modalBackdrop.setAttribute('aria-hidden','false');
  }
  function closeModal(){
    modalBackdrop.classList.remove('show');
    modalBackdrop.setAttribute('aria-hidden','true');
  }

  function parseM3U(text){
    const lines = String(text||'').split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
    const out = [];
    let current = null;

    const attrRe = /(\w+(?:-\w+)*)="([^"]*)"/g;

    for (const line of lines){
      if (line.startsWith('#EXTINF')){
        const comma = line.indexOf(',');
        const meta = comma >= 0 ? line.slice(0, comma) : line;
        const name = comma >= 0 ? line.slice(comma+1).trim() : '';

        const attrs = {};
        let m;
        while ((m = attrRe.exec(meta))){
          attrs[m[1]] = m[2];
        }

        current = {
          name: name || attrs['tvg-name'] || 'æœªå‘½å',
          group: attrs['group-title'] || 'æˆ‘çš„å¯¼å…¥',
          logo: attrs['tvg-logo'] || '',
          sources: []
        };
        continue;
      }

      if (line.startsWith('#')) continue;

      // url line
      if (current){
        const src = normalizeSource(line);
        if (src) current.sources.push(src);
        out.push(current);
        current = null;
      }
    }
    return out;
  }

  function mergeImported(channels){
    const map = new Map();
    for (const ch of (importedData.channels || [])){
      map.set(ch.name, ch);
    }
    for (const ch of channels){
      const existing = map.get(ch.name);
      if (!existing){
        map.set(ch.name, {
          id: hashId('imp|' + ch.name),
          name: ch.name,
          group: ch.group || 'æˆ‘çš„å¯¼å…¥',
          logo: ch.logo || '',
          sources: ch.sources || []
        });
      } else {
        // merge sources unique
        const seen = new Set((existing.sources||[]).map(s => (s.type||'') + '|' + (s.url||'')));
        for (const s of (ch.sources||[])){
          const key = (s.type||'') + '|' + (s.url||'');
          if (!seen.has(key)){
            existing.sources.push(s);
            seen.add(key);
          }
        }
        if (!existing.logo && ch.logo) existing.logo = ch.logo;
        if (!existing.group && ch.group) existing.group = ch.group;
      }
    }
    importedData.channels = Array.from(map.values());
    saveJSON(KEY_IMPORTED, importedData);
  }

  function exportImportedAsM3U(){
    const chans = importedData.channels || [];
    let text = '#EXTM3U\n';
    for (const ch of chans){
      const group = ch.group || 'æˆ‘çš„å¯¼å…¥';
      const logo = ch.logo || '';
      // each channel line per source
      for (const s of (ch.sources||[])){
        const url = s.type === 'web' ? ('web:' + s.url) : (s.type === 'youtube' ? s.url : s.url);
        text += `#EXTINF:-1 group-title="${group}" tvg-logo="${logo}",${ch.name}\n${url}\n`;
      }
    }
    const blob = new Blob([text], {type:'text/plain;charset=utf-8'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'my_imported.m3u';
    a.click();
    setTimeout(()=>URL.revokeObjectURL(a.href), 1500);
  }

  async function loadM3UFromUrl(){
    const url = prompt('è¾“å…¥è®¢é˜… URLï¼ˆè¿”å›å†…å®¹åº”ä¸º m3u æ–‡æœ¬ï¼‰');
    if (!url) return;
    try{
      const res = await fetch(url, { cache: 'no-store' });
      const txt = await res.text();
      m3uText.value = txt;
    } catch (e){
      alert('åŠ è½½å¤±è´¥ï¼š' + (e?.message || e));
    }
  }

  // -------------------- Events --------------------
  searchInput.addEventListener('input', () => {
    searchTerm = searchInput.value.trim();
    renderAll();
  });

  favViewBtn.addEventListener('click', () => {
    onlyFav = !onlyFav;
    onlyRecent = false;
    syncViewButtons();
    renderAll();
  });

  recentViewBtn.addEventListener('click', () => {
    onlyRecent = !onlyRecent;
    onlyFav = false;
    syncViewButtons();
    renderAll();
  });

  importBtn.addEventListener('click', openModal);
  closeModalBtn.addEventListener('click', closeModal);
  modalBackdrop.addEventListener('click', (e)=>{ if (e.target === modalBackdrop) closeModal(); });

  pickFileBtn.addEventListener('click', ()=>fileInput.click());
  fileInput.addEventListener('change', async () => {
    const f = fileInput.files?.[0];
    if (!f) return;
    const txt = await f.text();
    m3uText.value = txt;
    fileInput.value = '';
  });

  loadFromUrlBtn.addEventListener('click', loadM3UFromUrl);

  doImportBtn.addEventListener('click', () => {
    const txt = m3uText.value;
    const parsed = parseM3U(txt);
    if (!parsed.length){
      alert('æœªè§£æåˆ°æœ‰æ•ˆé¢‘é“ã€‚è¯·ç¡®è®¤ m3u æ ¼å¼æ˜¯å¦æ­£ç¡®ã€‚');
      return;
    }
    mergeImported(parsed);
    mergeData();
    closeModal();
    alert('å·²å¯¼å…¥å¹¶ä¿å­˜ï¼š' + parsed.length + ' æ¡è®°å½•ï¼ˆåŒåé¢‘é“å·²è‡ªåŠ¨åˆå¹¶å¤šçº¿è·¯ï¼‰');
  });

  exportM3UBtn.addEventListener('click', exportImportedAsM3U);

  clearImportBtn.addEventListener('click', () => {
    if (!confirm('ç¡®å®šæ¸…ç©ºâ€œæˆ‘çš„å¯¼å…¥â€ï¼Ÿ')) return;
    importedData = { channels: [] };
    saveJSON(KEY_IMPORTED, importedData);
    mergeData();
  });

  clearBadBtn.addEventListener('click', () => {
    if (!confirm('æ¸…ç†è¿‘æœŸå¤±æ•ˆè®°å½•ï¼Ÿæ¸…ç†åä¼šé‡æ–°å°è¯•æ‰€æœ‰çº¿è·¯ã€‚')) return;
    localStorage.removeItem(KEY_BAD);
    alert('å·²æ¸…ç†ã€‚');
  });

  openDrawerBtn.addEventListener('click', openDrawer);
  closeDrawerBtn.addEventListener('click', closeDrawer);
  drawerBackdrop.addEventListener('click', closeDrawer);

  // Messages from player frames
  window.addEventListener('message', (ev) => {
    const msg = ev.data;
    if (!msg || typeof msg !== 'object') return;
    if (msg.type === 'closeTab' && msg.sid){
      closeTab(msg.sid);
    }
    if (msg.type === 'focusTab' && msg.sid){
      selectTab(msg.sid);
    }
    if (msg.type === 'openedExternal' && msg.sid){
      // keep tab, just mark active
      selectTab(msg.sid);
    }
    if (msg.type === 'openDrawer') {
      openDrawer();
      if (msg.sid) selectTab(msg.sid);
    }
  });

  // -------------------- Service worker --------------------
  if ('serviceWorker' in navigator){
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw.js').catch(()=>{});
    });
  }

  // Boot
  (async () => {
    try{
      await loadBase();
      syncViewButtons();
    } catch (e){
      console.error(e);
      channelList.innerHTML = `<div class="empty"><div class="box"><div class="title">åŠ è½½å¤±è´¥</div><div>æ— æ³•åŠ è½½ channels.jsonï¼Œè¯·æ£€æŸ¥éƒ¨ç½²æ˜¯å¦å®Œæ•´ã€‚</div></div></div>`;
    }
  })();
</script>
</body>
</html>
